<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>分类: 程序员 - 雾非雾的情思</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="雾非雾的情思"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="雾非雾的情思"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="雾非雾的情思"><meta property="og:url" content="http://www.mspring.org/"><meta property="og:site_name" content="雾非雾的情思"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://www.mspring.org/img/og_image.png"><meta property="article:author" content="雾非雾的情思"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.mspring.org"},"headline":"雾非雾的情思","image":["http://www.mspring.org/img/og_image.png"],"author":{"@type":"Person","name":"雾非雾的情思"},"description":null}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="雾非雾的情思" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="http://file.mspring.org/images/blog/avatar.jpg" alt="雾非雾的情思" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a><a class="navbar-item" href="/links">友链</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Github" href="https://github.com/gaoyoubo"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">分类</a></li><li class="is-active"><a href="#" aria-current="page">程序员</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-10T10:08:18.000Z" title="6/10/2021, 10:08:18 AM">2021-06-10</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约115个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/10/%E6%89%B9%E9%87%8F%E6%8B%89%E5%8F%96%E4%BB%A3%E7%A0%81/">批量拉取代码</a></h1><div class="content"><blockquote>
<p>场景：目录中有多个git项目，想要更新批量拉取一下这些项目的最新代码。</p>
</blockquote>
<p>实现如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="keyword">for</span> dir <span class="keyword">in</span> $(ls -d */); <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$dir</span></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="string">&quot;.git&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        branch=$(git symbolic-ref --short -q HEAD)</span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$branch</span>&quot;</span> != <span class="string">&quot;master&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;skip <span class="variable">$dir</span> branch: <span class="variable">$branch</span>&quot;</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;dir:<span class="variable">$dir</span> branch: <span class="variable">$branch</span>&quot;</span></span><br><span class="line">            git pull origin <span class="variable">$branch</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">cd</span> ..</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>扫码目录下的所有项目，如果发现当前项目在master分支，那么pull一下代码。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-22T14:04:19.000Z" title="3/22/2021, 2:04:19 PM">2021-03-22</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约197个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/22/MacOS%E5%AE%89%E8%A3%85PHP/">MacOS安装PHP</a></h1><div class="content"><blockquote>
<p>偶然的机会需要用一下PHP，记录下安装方式。本身mac系统是自带php的，但是自带的修改起来及其不方便，不好安装扩展。所以直接使用brew安装。</p>
</blockquote>
<h2 id="brew安装php"><a href="#brew安装php" class="headerlink" title="brew安装php"></a>brew安装php</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">brew search php  使用此命令搜索可用的PHP版本</span><br><span class="line">brew install php@7.3.21 使用此命令安装指定版本的php</span><br><span class="line">brew install brew-php-switcher 安装php多版本切换工具</span><br><span class="line">brew-php-switcher 7.3.21 切换PHP版本到7.3.21（需要brew安装多个版本）</span><br></pre></td></tr></table></figure>

<h2 id="安装PHP扩展"><a href="#安装PHP扩展" class="headerlink" title="安装PHP扩展"></a>安装PHP扩展</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pecl version 查看版本信息</span><br><span class="line">pecl help 可以查看命令帮助</span><br><span class="line">pecl search redis  搜索可以安装的扩展信息</span><br><span class="line">pecl install redis 安装扩展</span><br><span class="line">pecl install http://pecl.php.net/get/redis-4.2.0.tgz 安装指定版本扩展</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-19T16:53:42.000Z" title="1/19/2021, 4:53:42 PM">2021-01-19</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">4 分钟读完 (大约591个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/19/mac-iterm2-rz%E4%B8%8Esz%E7%9A%84%E5%8A%9F%E8%83%BD/">mac iterm2 rz与sz的功能</a></h1><div class="content"><p>本文主要介绍<code>mac</code>环境下使用<code>iterm2</code>的<code>rz sz</code>功能的安装流程。</p>
<h2 id="1-安装lrzsz"><a href="#1-安装lrzsz" class="headerlink" title="1. 安装lrzsz"></a>1. 安装lrzsz</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install lrzsz</span><br></pre></td></tr></table></figure>

<h2 id="2-安装执行脚本"><a href="#2-安装执行脚本" class="headerlink" title="2. 安装执行脚本"></a>2. 安装执行脚本</h2><p>将<code>iterm2-send-zmodem.sh</code>和<code>iterm2-recv-zmodem.sh</code>保存到<code>/usr/local/bin</code>目录下。</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/RobberPhex/iterm2-zmodem/master/iterm2-send-zmodem.sh">iterm2-send-zmodem.sh</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"># Author: Matt Mastracci (matthew@mastracci.com)</span><br><span class="line"># AppleScript from http:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;4309087&#x2F;cancel-button-on-osascript-in-a-bash-script</span><br><span class="line"># licensed under cc-wiki with attribution required </span><br><span class="line"># Remainder of script public domain</span><br><span class="line"></span><br><span class="line">osascript -e &#39;tell application &quot;iTerm2&quot; to version&#39; &gt; &#x2F;dev&#x2F;null 2&gt;&amp;1 &amp;&amp; NAME&#x3D;iTerm2 || NAME&#x3D;iTerm</span><br><span class="line">if [[ $NAME &#x3D; &quot;iTerm&quot; ]]; then</span><br><span class="line">    FILE&#x3D;$(osascript -e &#39;tell application &quot;iTerm&quot; to activate&#39; -e &#39;tell application &quot;iTerm&quot; to set thefile to choose file with prompt &quot;Choose a file to send&quot;&#39; -e &quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;)</span><br><span class="line">else</span><br><span class="line">    FILE&#x3D;$(osascript -e &#39;tell application &quot;iTerm2&quot; to activate&#39; -e &#39;tell application &quot;iTerm2&quot; to set thefile to choose file with prompt &quot;Choose a file to send&quot;&#39; -e &quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;)</span><br><span class="line">fi</span><br><span class="line">if [[ $FILE &#x3D; &quot;&quot; ]]; then</span><br><span class="line">    echo Cancelled.</span><br><span class="line">    # Send ZModem cancel</span><br><span class="line">    echo -e \\x18\\x18\\x18\\x18\\x18</span><br><span class="line">    sleep 1</span><br><span class="line">    echo</span><br><span class="line">    echo \# Cancelled transfer</span><br><span class="line">else</span><br><span class="line">    &#x2F;usr&#x2F;local&#x2F;bin&#x2F;sz &quot;$FILE&quot; --escape --binary --bufsize 4096</span><br><span class="line">    sleep 1</span><br><span class="line">    echo</span><br><span class="line">    echo \# Received &quot;$FILE&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/RobberPhex/iterm2-zmodem/master/iterm2-recv-zmodem.sh">iterm2-recv-zmodem.sh</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"># Author: Matt Mastracci (matthew@mastracci.com)</span><br><span class="line"># AppleScript from http:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;4309087&#x2F;cancel-button-on-osascript-in-a-bash-script</span><br><span class="line"># licensed under cc-wiki with attribution required </span><br><span class="line"># Remainder of script public domain</span><br><span class="line"></span><br><span class="line">osascript -e &#39;tell application &quot;iTerm2&quot; to version&#39; &gt; &#x2F;dev&#x2F;null 2&gt;&amp;1 &amp;&amp; NAME&#x3D;iTerm2 || NAME&#x3D;iTerm</span><br><span class="line">if [[ $NAME &#x3D; &quot;iTerm&quot; ]]; then</span><br><span class="line">    FILE&#x3D;$(osascript -e &#39;tell application &quot;iTerm&quot; to activate&#39; -e &#39;tell application &quot;iTerm&quot; to set thefile to choose folder with prompt &quot;Choose a folder to place received files in&quot;&#39; -e &quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;)</span><br><span class="line">else</span><br><span class="line">    FILE&#x3D;$(osascript -e &#39;tell application &quot;iTerm2&quot; to activate&#39; -e &#39;tell application &quot;iTerm2&quot; to set thefile to choose folder with prompt &quot;Choose a folder to place received files in&quot;&#39; -e &quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;)</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ $FILE &#x3D; &quot;&quot; ]]; then</span><br><span class="line">    echo Cancelled.</span><br><span class="line">    # Send ZModem cancel</span><br><span class="line">    echo -e \\x18\\x18\\x18\\x18\\x18</span><br><span class="line">    sleep 1</span><br><span class="line">    echo</span><br><span class="line">    echo \# Cancelled transfer</span><br><span class="line">else</span><br><span class="line">    cd &quot;$FILE&quot;</span><br><span class="line">    &#x2F;usr&#x2F;local&#x2F;bin&#x2F;rz --rename --escape --binary --bufsize 4096 </span><br><span class="line">    sleep 1</span><br><span class="line">    echo</span><br><span class="line">    echo</span><br><span class="line">    echo \# Sent \-\&gt; $FILE</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h2 id="3-赋予这两个文件可执行权限"><a href="#3-赋予这两个文件可执行权限" class="headerlink" title="3. 赋予这两个文件可执行权限"></a>3. 赋予这两个文件可执行权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;iterm2-*</span><br></pre></td></tr></table></figure>

<h2 id="4-设置Iterm2的Tirgger特性"><a href="#4-设置Iterm2的Tirgger特性" class="headerlink" title="4. 设置Iterm2的Tirgger特性"></a>4. 设置Iterm2的Tirgger特性</h2><p>设置Iterm2的Tirgger特性，profiles-&gt;default-&gt;editProfiles-&gt;Advanced中的Tirgger</p>
<p>添加两条trigger，分别设置 Regular expression，Action，Parameters，Instant如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Regular expression: rz waiting to receive.\*\*B0100</span><br><span class="line">Action: Run Silent Coprocess</span><br><span class="line">Parameters: &#x2F;usr&#x2F;local&#x2F;bin&#x2F;iterm2-send-zmodem.sh</span><br><span class="line">Instant: checked</span><br><span class="line"></span><br><span class="line">Regular expression: \*\*B00000000000000</span><br><span class="line">Action: Run Silent Coprocess</span><br><span class="line">Parameters: &#x2F;usr&#x2F;local&#x2F;bin&#x2F;iterm2-recv-zmodem.sh</span><br><span class="line">Instant: checked</span><br></pre></td></tr></table></figure>

<p>示例图：</p>
<p><img src="https://raw.githubusercontent.com/aikuyun/iterm2-zmodem/master/imgs/01.png"></p>
<h2 id="5-使用"><a href="#5-使用" class="headerlink" title="5. 使用"></a>5. 使用</h2><ul>
<li>上传文件：rz</li>
<li>下载文件：sz + file</li>
</ul>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.robberphex.com/use-zmodem-at-macos/">https://www.robberphex.com/use-zmodem-at-macos/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/RobberPhex/iterm2-zmodem">https://github.com/RobberPhex/iterm2-zmodem</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-10-27T16:26:31.000Z" title="10/27/2020, 4:26:31 PM">2020-10-27</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约168个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/10/27/%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E5%8E%8B%E7%BC%A9%E5%9B%BE%E7%89%87/">在命令行中压缩图片</a></h1><div class="content"><p>今天有需求将一些非常大的图片压缩一下，本来想自己写代码进行压缩的，但是觉得这是一个非常常见的需求，应该有现成的解决方案，于是Google了一下，找到了这两个工具：jpegoptim、optipng</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><strong>我是在MacOS中安装的，Linux上应该也有这个两个工具，请自行摸索</strong></p>
<p>我使用的是<code>brew</code>进行安装，命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install jpegoptim</span><br><span class="line">brew install optipng</span><br></pre></td></tr></table></figure>


<h2 id="jpegoptim-使用"><a href="#jpegoptim-使用" class="headerlink" title="jpegoptim 使用"></a>jpegoptim 使用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 压缩</span></span><br><span class="line">jpegoptim file.jpg</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定大小压缩</span></span><br><span class="line">jpegoptim --size=1024k file.jpg</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 移除Exif信息</span></span><br><span class="line">jpegoptim --strip-exif file.jpg</span><br></pre></td></tr></table></figure>

<h2 id="optipng-使用"><a href="#optipng-使用" class="headerlink" title="optipng 使用"></a>optipng 使用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">optipng file.png</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-03-07T13:10:00.000Z" title="3/7/2020, 1:10:00 PM">2020-03-07</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约154个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/03/07/AndroidStudio%E8%BF%9E%E6%8E%A5mumu%E6%A8%A1%E6%8B%9F%E5%99%A8%E6%96%B9%E6%B3%95/">AndroidStudio连接mumu模拟器方法</a></h1><div class="content"><p>启动mumu模拟器之后在设备列表中找不到模拟器，于是在网上搜索了下教程。</p>
<p>有个教程提供一下方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb connect 127.0.0.1:7555 </span><br></pre></td></tr></table></figure>

<p>附模拟器端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">夜神模拟器：adb connect 127.0.0.1:62001</span><br><span class="line">逍遥安卓模拟器：adb connect 127.0.0.1:21503</span><br><span class="line">天天模拟器：adb connect 127.0.0.1:6555 </span><br><span class="line">海马玩模拟器：adb connect 127.0.0.1:53001</span><br><span class="line">网易MUMU模拟器：adb connect 127.0.0.1:7555</span><br><span class="line">原生模拟器：adb connect (你的IP地址)：5555</span><br></pre></td></tr></table></figure>

<p>但是这个方法在mac下好像不还用，于是又找到另外一种方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb kill-server &amp;&amp; adb server &amp;&amp; adb shell</span><br></pre></td></tr></table></figure>

<p>这个方法终于生效。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-12-25T10:56:15.000Z" title="12/25/2019, 10:56:15 AM">2019-12-25</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">3 分钟读完 (大约405个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/12/25/Centos%E5%AE%89%E8%A3%85mariadb-server/">Centos安装mariadb-server</a></h1><div class="content"><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install mariadb-server</span><br></pre></td></tr></table></figure>

<p><em>注意：安装之后初始密码为空</em></p>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb <span class="comment">#启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb <span class="comment">#设置开机启动</span></span><br><span class="line">systemctl restart mariadb <span class="comment">#重新启动</span></span><br></pre></td></tr></table></figure>

<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>执行命令<code>mysql_secure_installation</code>进行初始化，过程中会让你设置<code>root</code>密码等信息，自己按照提示一步步来即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@iZj6chtv8h63huh6sbynuiZ ~]# mysql_secure_installation</span><br><span class="line"></span><br><span class="line">NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB</span><br><span class="line">      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!</span><br><span class="line"></span><br><span class="line">In order to log into MariaDB to secure it, we&#39;ll need the current</span><br><span class="line">password for the root user.  If you&#39;ve just installed MariaDB, and</span><br><span class="line">you haven&#39;t set the root password yet, the password will be blank,</span><br><span class="line">so you should just press enter here.</span><br><span class="line"></span><br><span class="line">Enter current password for root (enter for none):</span><br><span class="line">OK, successfully used password, moving on...</span><br><span class="line"></span><br><span class="line">Setting the root password ensures that nobody can log into the MariaDB</span><br><span class="line">root user without the proper authorisation.</span><br><span class="line"></span><br><span class="line">Set root password? [Y&#x2F;n] Y</span><br><span class="line">New password:</span><br><span class="line">Re-enter new password:</span><br><span class="line">Password updated successfully!</span><br><span class="line">Reloading privilege tables..</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">By default, a MariaDB installation has an anonymous user, allowing anyone</span><br><span class="line">to log into MariaDB without having to have a user account created for</span><br><span class="line">them.  This is intended only for testing, and to make the installation</span><br><span class="line">go a bit smoother.  You should remove them before moving into a</span><br><span class="line">production environment.</span><br><span class="line"></span><br><span class="line">Remove anonymous users? [Y&#x2F;n] Y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Normally, root should only be allowed to connect from &#39;localhost&#39;.  This</span><br><span class="line">ensures that someone cannot guess at the root password from the network.</span><br><span class="line"></span><br><span class="line">Disallow root login remotely? [Y&#x2F;n] Y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">By default, MariaDB comes with a database named &#39;test&#39; that anyone can</span><br><span class="line">access.  This is also intended only for testing, and should be removed</span><br><span class="line">before moving into a production environment.</span><br><span class="line"></span><br><span class="line">Remove test database and access to it? [Y&#x2F;n] Y</span><br><span class="line"> - Dropping test database...</span><br><span class="line"> ... Success!</span><br><span class="line"> - Removing privileges on test database...</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Reloading the privilege tables will ensure that all changes made so far</span><br><span class="line">will take effect immediately.</span><br><span class="line"></span><br><span class="line">Reload privilege tables now? [Y&#x2F;n] Y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Cleaning up...</span><br><span class="line"></span><br><span class="line">All done!  If you&#39;ve completed all of the above steps, your MariaDB</span><br><span class="line">installation should now be secure.</span><br><span class="line"></span><br><span class="line">Thanks for using MariaDB!</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-12-24T14:39:06.000Z" title="12/24/2019, 2:39:06 PM">2019-12-24</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">3 分钟读完 (大约496个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/12/24/shadowsocks-go-%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85/">shadowsocks go 一键安装</a></h1><div class="content"><h2 id="本脚本适用环境："><a href="#本脚本适用环境：" class="headerlink" title="本脚本适用环境："></a>本脚本适用环境：</h2><p>系统支持：CentOS，Debian，Ubuntu<br>内存要求：≥128M<br>日期：2015年08月01日</p>
<h2 id="关于本脚本："><a href="#关于本脚本：" class="headerlink" title="关于本脚本："></a>关于本脚本：</h2><p>一键安装 go 版的 shadowsocks 最新版本 1.1.4。据说 go 版本有 buff 。与 python 版不同的是，其客户端程序能使用多个服务端配置，本脚本安装的是服务端程序。作者默认推荐 aes-128-cfb 加密，基于一致性，脚本使用了 aes-256-cfb 加密方式。</p>
<h2 id="默认配置："><a href="#默认配置：" class="headerlink" title="默认配置："></a>默认配置：</h2><p>服务器端口：自己设定（如不设定，默认为 8989）<br>客户端端口：1080<br>密码：自己设定（如不设定，默认为teddysun.com）</p>
<h2 id="客户端下载："><a href="#客户端下载：" class="headerlink" title="客户端下载："></a>客户端下载：</h2><p><a target="_blank" rel="noopener" href="http://sourceforge.net/projects/shadowsocksgui/files/dist/">http://sourceforge.net/projects/shadowsocksgui/files/dist/</a></p>
<h2 id="使用方法："><a href="#使用方法：" class="headerlink" title="使用方法："></a>使用方法：</h2><p>使用root用户登录，运行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate https://raw.githubusercontent.com/iMeiji/shadowsocks_install/master/shadowsocks-go.sh</span><br><span class="line">chmod +x shadowsocks-go.sh</span><br><span class="line">./shadowsocks-go.sh 2&gt;&amp;1 | tee shadowsocks-go.log</span><br></pre></td></tr></table></figure>

<h2 id="安装完成后，脚本提示如下："><a href="#安装完成后，脚本提示如下：" class="headerlink" title="安装完成后，脚本提示如下："></a>安装完成后，脚本提示如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Congratulations, shadowsocks-go install completed!</span><br><span class="line">Your Server IP:your_server_ip</span><br><span class="line">Your Server Port:your_server_port</span><br><span class="line">Your Password:your_password</span><br><span class="line">Your Local Port:1080</span><br><span class="line">Your Encryption Method:aes-256-cfb</span><br><span class="line"></span><br><span class="line">Welcome to visit:http:&#x2F;&#x2F;teddysun.com&#x2F;392.html</span><br><span class="line">Enjoy it!</span><br></pre></td></tr></table></figure>

<h2 id="卸载方法："><a href="#卸载方法：" class="headerlink" title="卸载方法："></a>卸载方法：</h2><p>使用 root 用户登录，运行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./shadowsocks-go.sh uninstall</span><br></pre></td></tr></table></figure>

<h2 id="其他事项："><a href="#其他事项：" class="headerlink" title="其他事项："></a>其他事项：</h2><p>客户端配置的参考链接：<a target="_blank" rel="noopener" href="http://teddysun.com/339.html">http://teddysun.com/339.html</a><br>安装完成后即已后台启动 shadowsocks-go ，运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;init.d&#x2F;shadowsocks status</span><br></pre></td></tr></table></figure>

<p>可以查看 shadowsocks-go 进程是否已经启动。<br>本脚本安装完成后，已将 shadowsocks-go 加入开机自启动。</p>
<h2 id="使用命令："><a href="#使用命令：" class="headerlink" title="使用命令："></a>使用命令：</h2><p>启动：<code>/etc/init.d/shadowsocks start</code><br>停止：<code>/etc/init.d/shadowsocks stop</code><br>重启：<code>/etc/init.d/shadowsocks restart</code><br>状态：<code>/etc/init.d/shadowsocks status</code></p>
<p>多用户多端口配置文件 sample（2015年01月08日）：<br>配置文件路径：vi /etc/shadowsocks/config.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;port_password&quot;</span>:&#123;</span><br><span class="line">         <span class="attr">&quot;8989&quot;</span>:<span class="string">&quot;password0&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;9001&quot;</span>:<span class="string">&quot;password1&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;9002&quot;</span>:<span class="string">&quot;password2&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;9003&quot;</span>:<span class="string">&quot;password3&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;9004&quot;</span>:<span class="string">&quot;password4&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;method&quot;</span>:<span class="string">&quot;aes-256-cfb&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span>:<span class="number">600</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考链接：<br><a target="_blank" rel="noopener" href="https://github.com/shadowsocks/shadowsocks-go">https://github.com/shadowsocks/shadowsocks-go</a><br><a target="_blank" rel="noopener" href="https://github.com/iMeiji/shadowsocks_install/wiki/shadowsocks-go-%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85">https://github.com/iMeiji/shadowsocks_install/wiki/shadowsocks-go-%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-12-16T15:20:57.000Z" title="12/16/2019, 3:20:57 PM">2019-12-16</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约66个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/12/16/MySql%E5%AF%BC%E5%87%BA%E6%8C%87%E5%AE%9A%E5%88%97%E7%9A%84%E6%95%B0%E6%8D%AE/">MySql导出指定列的数据</a></h1><div class="content"><p>MySql导出整库或者指定表的数据使用<code>mysqldump</code>命令即可，但是导出表中指定列的数据就需要用到下面命令了，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456 database_name -e &quot;SELECT name from t_xxx where type = 3 INTO OUTFILE&#x27;/data/xxx.sql&#x27;&quot;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-11-28T09:42:04.000Z" title="11/28/2019, 9:42:04 AM">2019-11-28</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约250个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/11/28/xxx-is-not-in-the-sudoers-file%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">xxx is not in the sudoers file解决方法</a></h1><div class="content"><p>用sudo时提示”xxx is not in the sudoers file. This incident will be reported.其中XXX是你的用户名，也就是你的用户名没有权限使用sudo,我们只要修改一下/etc/sudoers文件就行了。下面是修改方法：</p>
<ol>
<li>进入超级用户模式。也就是输入”su -“,系统会让你输入超级用户密码，输入密码后就进入了超级用户模式。（当然，你也可以直接用root用）</li>
<li>添加文件的写权限。也就是输入命令<code>chmod u+w /etc/sudoers</code>。</li>
<li>编辑/etc/sudoers文件。也就是输入命令<code>vim /etc/sudoers</code>,输入”i”进入编辑模式，找到这一 行：<code>root ALL=(ALL) ALL</code>在起下面添加<code>xxx ALL=(ALL) ALL</code>(这里的xxx是你的用户名)，然后保存（就是先按一 下Esc键，然后输入”:wq”）退出。</li>
<li>撤销文件的写权限。也就是输入命令<code>chmod u-w /etc/sudoers</code>。 </li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-11-13T17:52:29.000Z" title="11/13/2019, 5:52:29 PM">2019-11-13</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">5 分钟读完 (大约737个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/11/13/Use-Go-Channels-as-Promises-and-Async-Await/">Use Go Channels as Promises and Async/Await</a></h1><div class="content"><p>原文地址：<a target="_blank" rel="noopener" href="https://levelup.gitconnected.com/use-go-channels-as-promises-and-async-await-ee62d93078ec">https://levelup.gitconnected.com/use-go-channels-as-promises-and-async-await-ee62d93078ec</a></p>
<p>If you’ve ever programmed with <em>Javascript</em>, you definitely know about <code>Promise</code> and <code>async</code>/<code>await</code>. <em>C#</em>, *Java, Python, *and some other programming languages apply the same pattern but with other names such as <code>Task</code> or <code>Future</code>.</p>
<p>On the contrary, Go doesn’t follow the pattern at all. Instead, it introduces <code>goroutines</code> and <code>channels</code>. However, it isn’t difficult to replicate the pattern with <code>goroutines</code> and <code>channels</code>.</p>
<hr>
<h1 id="Single-async-await"><a href="#Single-async-await" class="headerlink" title="Single async/await"></a>Single async/await</h1><p>First, let’s experiment with a simple use case: <code>await</code> a result from an <code>async</code> function.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Javascript.</span><br><span class="line"></span><br><span class="line">const longRunningTask &#x3D; async () &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; Simulate a workload.</span><br><span class="line">    sleep(3000)</span><br><span class="line">    return Math.floor(Math.random() * Math.floor(100))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const r &#x3D; await longRunningTask()</span><br><span class="line">console.log(r)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Go.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">        <span class="string">&quot;math/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">longRunningTask</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">int32</span></span> &#123;</span><br><span class="line">	r := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int32</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(r)</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// Simulate a workload.</span></span><br><span class="line">		time.Sleep(time.Second * <span class="number">3</span>)</span><br><span class="line">		r &lt;- rand.Int31n(<span class="number">100</span>)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := &lt;-longRunningTask()</span><br><span class="line">	fmt.Println(r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Single async/await in Javascript vs. Golang</p>
<p>To declare an “async” function in Go:</p>
<ul>
<li>The return type is <code>&lt;-chan ReturnType</code>.</li>
<li>Within the function, create a channel by <code>make(chan ReturnType)</code> and return the created channel at the end of the function.</li>
<li>Start an anonymous goroutine by <code>go func() &#123;...&#125;</code> and implement the function’s logic inside that anonymous function.</li>
<li>Return the result by sending the value to channel.</li>
<li>At the beginning of the anonymous function, add <code>defer close(r)</code> to close the channel once done.</li>
</ul>
<p>To “await” the result, simply read the value from channel by <code>v := &lt;- fn()</code>.</p>
<hr>
<h1 id="Promise-all"><a href="#Promise-all" class="headerlink" title="Promise.all()"></a>Promise.all()</h1><p>It’s very common that we start multiple async tasks then wait for all of them to finish and gather their results. Doing that is quite simple in both Javascript and Golang.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Javascript.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> longRunningTask = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// Simulate a workload.</span></span><br><span class="line">    sleep(<span class="number">3000</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="built_in">Math</span>.floor(<span class="number">100</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> [a, b, c] = <span class="keyword">await</span> <span class="built_in">Promise</span>.all(longRunningTask(), longRunningTask(), longRunningTask())</span><br><span class="line"><span class="built_in">console</span>.log(a, b, c)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Go.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">        <span class="string">&quot;math/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">longRunningTask</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">int32</span></span> &#123;</span><br><span class="line">	r := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int32</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(r)</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// Simulate a workload.</span></span><br><span class="line">		time.Sleep(time.Second * <span class="number">3</span>)</span><br><span class="line">		r &lt;- rand.Int31n(<span class="number">100</span>)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	aCh, bCh, cCh := longRunningTask(), longRunningTask(), longRunningTask()</span><br><span class="line">	a, b, c := &lt;-aCh, &lt;-bCh, &lt;-cCh</span><br><span class="line">	</span><br><span class="line">	fmt.Println(a, b, c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We have to do it in 2 lines of code and introduce 3 more variables, but it’s clean and simple enough.</p>
<p>We can not do <code>&lt;-longRun(), &lt;-longRun(), &lt;-longRun()</code>, which will <code>longRun()</code> one by one instead all in once.</p>
<hr>
<h1 id="Promise-race"><a href="#Promise-race" class="headerlink" title="Promise.race()"></a>Promise.race()</h1><p>Sometimes, a piece of data can be received from several sources to avoid high latencies, or there’re cases that multiple results are generated but they’re equivalent and the only first response is consumed. This first-response-win pattern, therefore, is quite popular. Achieving that in both Javascript and Go is very simple.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Javascript.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> one = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// Simulate a workload.</span></span><br><span class="line">    sleep(<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="built_in">Math</span>.floor(<span class="number">2000</span>)))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> two = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// Simulate a workload.</span></span><br><span class="line">    sleep(<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="built_in">Math</span>.floor(<span class="number">1000</span>)))</span><br><span class="line">    sleep(<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="built_in">Math</span>.floor(<span class="number">1000</span>)))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> r = <span class="keyword">await</span> <span class="built_in">Promise</span>.race(one(), two())</span><br><span class="line"><span class="built_in">console</span>.log(r)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Go.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;math/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">one</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">int32</span></span> &#123;</span><br><span class="line">	r := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int32</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(r)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Simulate a workload.</span></span><br><span class="line">		time.Sleep(time.Millisecond * time.Duration(rand.Int63n(<span class="number">2000</span>)))</span><br><span class="line">		r &lt;- <span class="number">1</span></span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">two</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">int32</span></span> &#123;</span><br><span class="line">	r := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int32</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(r)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Simulate a workload.</span></span><br><span class="line">		time.Sleep(time.Millisecond * time.Duration(rand.Int63n(<span class="number">1000</span>)))</span><br><span class="line">		time.Sleep(time.Millisecond * time.Duration(rand.Int63n(<span class="number">1000</span>)))</span><br><span class="line">		r &lt;- <span class="number">2</span></span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> r <span class="keyword">int32</span></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> r = &lt;-one():</span><br><span class="line">	<span class="keyword">case</span> r = &lt;-two():</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>select-case</code> is the pattern that Go designed specifically for racing channel operations. We can even do more stuff within each case, but we’re focusing only on the result so we just leave them all empty.</p>
<hr>
<h1 id="Promise-then-and-Promise-catch"><a href="#Promise-then-and-Promise-catch" class="headerlink" title="Promise.then() and Promise.catch()"></a>Promise.then() and Promise.catch()</h1><p>Because Go’s error propagation model is very different from Javascript, there’s any clean way to replicate <code>Promise.then()</code> and <code>Promise.catch()</code>. In Go, error is returned along with return values instead of being thrown as exception. Therefore, if your function can fail, you can consider changing your return <code>&lt;-chan ReturnType</code> into <code>&lt;-chan ReturnAndErrorType</code>, which is a struct holding both the result and error.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-10-22T16:35:08.000Z" title="10/22/2019, 4:35:08 PM">2019-10-22</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">5 分钟读完 (大约812个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/10/22/SpringBoot%E4%B8%AD%E7%BB%9F%E4%B8%80%E5%8C%85%E8%A3%85%E5%93%8D%E5%BA%94/">SpringBoot中统一包装响应</a></h1><div class="content"><p>SpringBoot 中可以基于 <code>ControllerAdvice</code> 和 <code>HttpMessageConverter</code> 实现对数据返回的包装。</p>
<p>实现如下，先来写一个 <code>POJO</code> 来定义一下返回格式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.demo.common.exception.base.ErrorCode;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code = HttpStatus.OK.value();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String msg = <span class="string">&quot;success&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(<span class="keyword">int</span> code, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(<span class="keyword">int</span> code, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(ErrorCode errorCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = errorCode.getCode();</span><br><span class="line">        <span class="keyword">this</span>.msg = errorCode.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(ErrorCode errorCode, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = errorCode.getCode();</span><br><span class="line">        <span class="keyword">this</span>.msg = errorCode.getMessage();</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里用到了<code>lombok</code>，<code>lombok</code>的使用介绍不在本文范围内。</p>
</blockquote>
<p>用一个 <code>ResponseBodyAdvice</code> 类的实现包装 <code>Controller</code> 的返回值：</p>
<p>以下是我以前的实现方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.demo.common.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormatResponseBodyAdvice</span> <span class="keyword">implements</span> <span class="title">ResponseBodyAdvice</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(FormatResponseBodyAdvice.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter returnType, Class converterType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">beforeBodyWrite</span><span class="params">(Object body, MethodParameter returnType, MediaType selectedContentType, Class selectedConverterType, ServerHttpRequest request, ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Object wrapperBody = body;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(body <span class="keyword">instanceof</span> Response)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (body <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                    wrapperBody = objectMapper.writeValueAsString(<span class="keyword">new</span> Response&lt;&gt;(body));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    wrapperBody = <span class="keyword">new</span> Response&lt;&gt;(body);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;request uri path: &#123;&#125;, format response body error&quot;</span>, request.getURI().getPath(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wrapperBody;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为什么要对返回类型是 <code>String</code> 时进行特殊处理呢？因为如果直接返回 <code>new Response&lt;&gt;(body)</code> 的话，在使用时返回 <code>String</code> 类型的话，会报类型转换异常，当时也没有理解什么原因导致的，所以最后使用了 <code>jackson</code> 对 <code>Response</code> 又做了一次序列化。</p>
<p>今天找到了导致这个异常的原因：</p>
<blockquote>
<p>因为在所有的 <code>HttpMessageConverter</code> 实例集合中，<code>StringHttpMessageConverter</code> 要比其它的 <code>Converter</code> 排得靠前一些。我们需要将处理 <code>Object</code> 类型的 <code>HttpMessageConverter</code> 放得靠前一些，这可以在 <code>Configuration</code> 类中完成：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfiguration</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">        converters.add(<span class="number">0</span>, <span class="keyword">new</span> MappingJackson2HttpMessageConverter());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后 <code>FormatResponseBodyAdvice</code> 就可以修改为如下实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServletServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormatResponseBodyAdvice</span> <span class="keyword">implements</span> <span class="title">ResponseBodyAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter returnType, Class converterType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">beforeBodyWrite</span><span class="params">(Object body, MethodParameter returnType, MediaType selectedContentType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  Class selectedConverterType, ServerHttpRequest request, ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(body <span class="keyword">instanceof</span> Response)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Response&lt;&gt;(body);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> body;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比之前的实现方式优雅了很多而且不用再处理 <code>jackson</code> 的异常了。</p>
<p>写一个 <code>Controller</code> 来尝试一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello world!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求这个端点得到结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">&quot;msg&quot;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: <span class="string">&quot;hello world!&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明我们的配置是成功的，同时可以在相应头中看到：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content-type: application/json;charset=UTF-8</span><br></pre></td></tr></table></figure>

<p>如果是之前的实现方式，这里的值就是：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content-type: html/text</span><br></pre></td></tr></table></figure>

<p>也不太符合 <code>restful</code> 规范。</p>
<p>转载自：<a target="_blank" rel="noopener" href="https://jpanj.com/2018/SpringBoot-%E4%B8%AD%E7%BB%9F%E4%B8%80%E5%8C%85%E8%A3%85%E5%93%8D%E5%BA%94/">https://jpanj.com/2018/SpringBoot-%E4%B8%AD%E7%BB%9F%E4%B8%80%E5%8C%85%E8%A3%85%E5%93%8D%E5%BA%94/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-09-03T12:00:19.000Z" title="9/3/2019, 12:00:19 PM">2019-09-03</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约49个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/09/03/Git%E6%B8%85%E7%90%86%E5%8E%86%E5%8F%B2%E6%8F%90%E4%BA%A4%E8%AE%B0%E5%BD%95/">Git清理历史提交记录</a></h1><div class="content"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. Checkout</span></span><br><span class="line"></span><br><span class="line">   git checkout --orphan latest_branch</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. Add all the files</span></span><br><span class="line"></span><br><span class="line">   git add -A</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. Commit the changes</span></span><br><span class="line"></span><br><span class="line">   git commit -am &quot;commit message&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. Delete the branch</span></span><br><span class="line"></span><br><span class="line">   git branch -D master</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. Rename the current branch to master</span></span><br><span class="line"></span><br><span class="line">   git branch -m master</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6. Finally, force update your repository</span></span><br><span class="line"></span><br><span class="line">   git push -f origin master</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-09-03T09:46:59.000Z" title="9/3/2019, 9:46:59 AM">2019-09-03</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约213个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/09/03/HexoClient1-3-3%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/">HexoClient1.3.3版本发布</a></h1><div class="content"><h2 id="更新内容"><a href="#更新内容" class="headerlink" title="更新内容"></a>更新内容</h2><ul>
<li>加上一个启动失败的错误引导。</li>
<li>修复<code>好博客导航</code>数据没有分页的问题。</li>
<li>修改<code>好博客导航</code>页面布局，页面更美观。</li>
</ul>
<h2 id="扫码进群交流"><a href="#扫码进群交流" class="headerlink" title="扫码进群交流"></a>扫码进群交流</h2><p><img src="http://file.mspring.org/images/blog/Fhw8IjouYG3cPjVDN5NBogBqxd2K" alt="image.png"></p>
<h2 id="功能预览"><a href="#功能预览" class="headerlink" title="功能预览"></a>功能预览</h2><p><img src="http://file.mspring.org/images/blog/FsrXnCJWLcBk3Pfv3uzRI-XaV8FP" alt="image.png"><br><img src="http://file.mspring.org/images/blog/Fiw4MmJIqsSAqst2sAr-DizUD6kd" alt="image.png"></p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>下载地址：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases/tag/v1.3.1">https://github.com/gaoyoubo/hexo-client/releases/tag/v1.3.1</a></li>
<li>使用帮助：<a href="https://www.mspring.org/2018/11/29/HexoClient%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/">https://www.mspring.org/2018/11/29/HexoClient%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/</a></li>
<li>提交问题：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/new">https://github.com/gaoyoubo/hexo-client/issues/new</a></li>
<li>Github: <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client">https://github.com/gaoyoubo/hexo-client</a></li>
<li>Gitee: <a target="_blank" rel="noopener" href="https://gitee.com/gaoyoubo/hexo-client">https://gitee.com/gaoyoubo/hexo-client</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-08-12T14:43:10.000Z" title="8/12/2019, 2:43:10 PM">2019-08-12</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约184个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/08/12/HexoClient1-3-1%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/">HexoClient1.3.1版本发布</a></h1><div class="content"><h2 id="更新内容"><a href="#更新内容" class="headerlink" title="更新内容"></a>更新内容</h2><ul>
<li>修复检查更新提示错误。<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/64">#64</a></li>
<li>修复Windows系统下的一个样式错误。<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/65">#65</a></li>
</ul>
<h2 id="功能预览"><a href="#功能预览" class="headerlink" title="功能预览"></a>功能预览</h2><p><img src="http://file.mspring.org/images/blog/FsrXnCJWLcBk3Pfv3uzRI-XaV8FP" alt="image.png"><br><img src="http://file.mspring.org/images/blog/Fiw4MmJIqsSAqst2sAr-DizUD6kd" alt="image.png"></p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>下载地址：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases/tag/v1.3.1">https://github.com/gaoyoubo/hexo-client/releases/tag/v1.3.1</a></li>
<li>使用帮助：<a href="https://www.mspring.org/2018/11/29/HexoClient%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/">https://www.mspring.org/2018/11/29/HexoClient%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/</a></li>
<li>提交问题：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/new">https://github.com/gaoyoubo/hexo-client/issues/new</a></li>
<li>Github: <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client">https://github.com/gaoyoubo/hexo-client</a></li>
<li>Gitee: <a target="_blank" rel="noopener" href="https://gitee.com/gaoyoubo/hexo-client">https://gitee.com/gaoyoubo/hexo-client</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-08-02T13:30:52.000Z" title="8/2/2019, 1:30:52 PM">2019-08-02</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约204个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/08/02/HexoClient1-3-0%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/">HexoClient1.3.0版本发布</a></h1><div class="content"><h2 id="更新内容"><a href="#更新内容" class="headerlink" title="更新内容"></a>更新内容</h2><ul>
<li>修复阿里云oss图片上传后url不正确的问题。<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/60">#60</a></li>
<li>支持一键调用<code>hexo generate -d</code>命令发布文章，thanks <a target="_blank" rel="noopener" href="https://github.com/EVINK">EVINK</a><br><img src="http://file.mspring.org/images/blog/FkefJrKFFG3yQp6lumRbJujUgDlr" alt="image.png"></li>
</ul>
<h2 id="功能预览"><a href="#功能预览" class="headerlink" title="功能预览"></a>功能预览</h2><p><img src="http://file.mspring.org/images/blog/FsrXnCJWLcBk3Pfv3uzRI-XaV8FP" alt="image.png"><br><img src="http://file.mspring.org/images/blog/Fiw4MmJIqsSAqst2sAr-DizUD6kd" alt="image.png"></p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>下载地址：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases/tag/v1.3.0">https://github.com/gaoyoubo/hexo-client/releases/tag/v1.3.0</a></li>
<li>使用帮助：<a href="https://www.mspring.org/2018/11/29/HexoClient%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/">https://www.mspring.org/2018/11/29/HexoClient%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/</a></li>
<li>提交问题：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/new">https://github.com/gaoyoubo/hexo-client/issues/new</a></li>
<li>Github: <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client">https://github.com/gaoyoubo/hexo-client</a></li>
<li>Gitee: <a target="_blank" rel="noopener" href="https://gitee.com/gaoyoubo/hexo-client">https://gitee.com/gaoyoubo/hexo-client</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-22T12:33:47.000Z" title="7/22/2019, 12:33:47 PM">2019-07-22</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 小时读完 (大约22463个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/22/Go-%E8%AF%AD%E8%A8%80%E5%AE%9E%E6%88%98-%E7%BC%96%E5%86%99%E5%8F%AF%E7%BB%B4%E6%8A%A4-Go-%E8%AF%AD%E8%A8%80%E4%BB%A3%E7%A0%81%E5%BB%BA%E8%AE%AE/">Go 语言实战:  编写可维护 Go 语言代码建议</a></h1><div class="content"><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>大家好,我在接下来的两个会议中的目标是向大家提供有关编写 Go 代码最佳实践的建议。</p>
<p>这是一个研讨会形式的演讲，不会有幻灯片,而是直接从文档开始。</p>
<blockquote>
<p>贴士: 在这里有最新的文章链接<br><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a></p>
</blockquote>
<h2 id="编者的话"><a href="#编者的话" class="headerlink" title="编者的话"></a>编者的话</h2><ul>
<li>终于翻译完了 Dave 大神的这一篇《<strong>Go 语言最佳实践</strong>》</li>
<li>耗时两周的空闲时间</li>
<li>翻译的同时也对 Go 语言的开发与实践有了更深层次的了解</li>
<li>有兴趣的同学可以翻阅 Dave 的另一篇博文<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0aebd9618300">《<strong>SOLID Go 语言设计</strong>》</a>(第六章节也会提到)</li>
<li>同时在这里也推荐一个 Telegram Docker 群组(分享/交流): <a target="_blank" rel="noopener" href="https://t.me/dockertutorial">https://t.me/dockertutorial</a></li>
</ul>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="1-指导原则"><a href="#1-指导原则" class="headerlink" title="1. 指导原则"></a>1. 指导原则</h3><p>如果我要谈论任何编程语言的最佳实践，我需要一些方法来定义“什么是最佳”。如果你昨天来到我的主题演讲，你会看到 Go 团队负责人 Russ Cox 的这句话：</p>
<blockquote>
<p>Software engineering is what happens to programming when you add time and other programmers. (软件工程就是你和其他程序员花费时间在编程上所发生的事情。)<br>   — Russ Cox</p>
</blockquote>
<p>Russ 作出了软件编程与软件工程的区分。 前者是你自己写的一个程序。 后者是很多人会随着时间的推移而开发的产品。 工程师们来来去去，团队会随着时间增长与缩小，需求会发生变化，功能会被添加，错误也会得到修复。 这是软件工程的本质。</p>
<p>我可能是这个房间里 Go 最早的用户之一，<del>但要争辩说我的资历给我的看法更多是假的</del>。相反，今天我要提的建议是基于我认为的 Go 语言本身的指导原则：</p>
<ol>
<li>简单性</li>
<li>可读性</li>
<li>生产力</li>
</ol>
<blockquote>
<p>注意:<br>你会注意到我没有说性能或并发。 有些语言比 Go 语言快一点，但它们肯定不像 Go 语言那么简单。 有些语言使并发成为他们的最高目标，但它们并不具有可读性及生产力。<br>性能和并发是重要的属性，但不如简单性，可读性和生产力那么重要。</p>
</blockquote>
<h4 id="1-1-简单性"><a href="#1-1-简单性" class="headerlink" title="1.1. 简单性"></a>1.1. 简单性</h4><p>我们为什么要追求简单？ 为什么 Go 语言程序的简单性很重要？</p>
<p>我们都曾遇到过这样的情况: “我不懂这段代码”，不是吗？ 我们都做过这样的项目:你害怕做出改变，因为你担心它会破坏程序的另一部分; 你不理解的部分，不知道如何修复。</p>
<p>这就是复杂性。 复杂性把可靠的软件中变成不可靠。 复杂性是杀死软件项目的罪魁祸首。</p>
<p>简单性是 Go 语言的最高目标。 无论我们编写什么程序，我们都应该同意这一点:它们很简单。</p>
<h4 id="1-2-可读性"><a href="#1-2-可读性" class="headerlink" title="1.2. 可读性"></a>1.2. 可读性</h4><blockquote>
<p>Readability is essential for maintainability.<br> (可读性对于可维护性是至关重要的。)<br>    — Mark Reinhold (2018 JVM 语言高层会议)</p>
</blockquote>
<p>为什么 Go 语言的代码可读性是很重要的？我们为什么要争取可读性？</p>
<blockquote>
<p>Programs must be written for people to read, and only incidentally for machines to execute. (程序应该被写来让人们阅读，只是顺便为了机器执行。)<br> — Hal Abelson 与 Gerald Sussman (计算机程序的结构与解释)</p>
</blockquote>
<p>可读性很重要，因为所有软件不仅仅是 Go 语言程序，都是由人类编写的，供他人阅读。执行软件的计算机则是次要的。</p>
<p>代码的读取次数比写入次数多。一段代码在其生命周期内会被读取数百次，甚至数千次。</p>
<blockquote>
<p>The most important skill for a programmer is the ability to effectively communicate ideas. (程序员最重要的技能是有效沟通想法的能力。)<br>  — Gastón Jorquera <a href="(https://gaston.life/books/effective-programming/)">[1]</a></p>
</blockquote>
<p>可读性是能够理解程序正在做什么的关键。如果你无法理解程序正在做什么，那你希望如何维护它？如果软件无法维护，那么它将被重写;最后这可能是你的公司最后一次投资 Go 语言。</p>
<p><del>如果你正在为自己编写一个程序，也许它只需要运行一次，或者你是唯一一个曾经看过它的人，然后做任何对你有用的事。</del>但是，如果是一个不止一个人会贡献编写的软件，或者在很长一段时间内需求、功能或者环境会改变，那么你的目标必须是你的程序可被维护。</p>
<p>编写可维护代码的第一步是确保代码可读。</p>
<h4 id="1-3-生产力"><a href="#1-3-生产力" class="headerlink" title="1.3. 生产力"></a>1.3. 生产力</h4><blockquote>
<p>Design is the art of arranging code to work today, and be changeable forever. (设计是安排代码到工作的艺术，并且永远可变。)<br>— Sandi Metz</p>
</blockquote>
<p>我要强调的最后一个基本原则是生产力。开发人员的工作效率是一个庞大的主题，但归结为此; 你花多少时间做有用的工作，而不是等待你的工具或迷失在一个外国的代码库里。 Go 程序员应该觉得他们可以通过 Go 语言完成很多工作。</p>
<p>有人开玩笑说， Go 语言是在等待 C++ 语言程序编译时设计的。快速编译是 Go 语言的一个关键特性，也是吸引新开发人员的关键工具。虽然编译速度仍然是一个持久的战场，但可以说，在其他语言中需要几分钟的编译，在 Go 语言中只需几秒钟。这有助于 Go 语言开发人员感受到与使用动态语言的同行一样的高效，而且没有那些语言固有的可靠性问题。</p>
<p>对于开发人员生产力问题更为基础的是，Go 程序员意识到编写代码是为了阅读，因此将读代码的行为置于编写代码的行为之上。Go 语言甚至通过工具和自定义强制执行所有代码以特定样式格式化。这就消除了项目中学习特定格式的摩擦，并帮助发现错误，因为它们看起来不正确。</p>
<p>Go 程序员不会花费整天的时间来调试不可思议的编译错误。他们也不会将浪费时间在复杂的构建脚本或在生产中部署代码。最重要的是，他们不用花费时间来试图了解他们的同事所写的内容。</p>
<p>当他们说语言必须扩展时，Go 团队会谈论生产力。</p>
<h3 id="2-标识符"><a href="#2-标识符" class="headerlink" title="2. 标识符"></a>2. 标识符</h3><p>我们要讨论的第一个主题是标识符。 标识符是一个用来表示名称的花哨单词; 变量的名称，函数的名称，方法的名称，类型的名称，包的名称等。</p>
<blockquote>
<p>Poor naming is symptomatic of poor design. (命名不佳是设计不佳的症状。)<br>  — Dave Cheney</p>
</blockquote>
<p>鉴于 Go 语言的语法有限，我们为程序选择的名称对我们程序的可读性产生了非常大的影响。 可读性是良好代码的定义质量，因此选择好名称对于 Go 代码的可读性至关重要。</p>
<h4 id="2-1-选择标识符是为了清晰，而不是简洁"><a href="#2-1-选择标识符是为了清晰，而不是简洁" class="headerlink" title="2.1. 选择标识符是为了清晰，而不是简洁"></a>2.1. 选择标识符是为了清晰，而不是简洁</h4><blockquote>
<p>Obvious code is important. What you can do in one line you should do in three.<br> (清晰的代码很重要。在一行可以做的你应当分三行做。(<code>if/else</code> 吗?))<br>— Ukiah Smith</p>
</blockquote>
<p> Go 语言不是为了单行而优化的语言。  Go 语言不是为了最少行程序而优化的语言。我们没有优化源代码的大小，也没有优化输入所需的时间。</p>
<blockquote>
<p>Good naming is like a good joke. If you have to explain it, it’s not funny.<br> (好的命名就像一个好笑话。如果你必须解释它，那就不好笑了。)<br>— Dave Cheney</p>
</blockquote>
<p>清晰的关键是在 Go 语言程序中我们选择的标识名称。让我们谈一谈所谓好的名字：</p>
<ul>
<li><p><strong>好的名字很简洁。</strong> 好的名字不一定是最短的名字，但好的名字不会浪费在无关的东西上。好名字具有高的信噪比。</p>
</li>
<li><p><strong>好的名字是描述性的。</strong> 好的名字会描述变量或常量的应用，而不是它们的内容。好的名字应该描述函数的结果或方法的行为，而不是它们的操作。好的名字应该描述包的目的而非它的内容。描述东西越准确的名字就越好。</p>
</li>
<li><p><strong>好的名字应该是可预测的。</strong> 你能够从名字中推断出使用方式。<del>这是选择描述性名称的功能，但它也遵循传统。</del>这是 Go 程序员在谈到习惯用语时所谈论的内容。</p>
</li>
</ul>
<p>让我们深入讨论以下这些属性。</p>
<h4 id="2-2-标识符长度"><a href="#2-2-标识符长度" class="headerlink" title="2.2. 标识符长度"></a>2.2. 标识符长度</h4><p>有时候人们批评 Go 语言推荐短变量名的风格。正如 Rob Pike 所说，“ Go 程序员想要正确的长度的标识符”。 <a target="_blank" rel="noopener" href="https://www.lysator.liu.se/c/pikestyle.html">[1]</a></p>
<p>Andrew Gerrand 建议通过对某些事物使用更长的标识，向读者表明它们具有更高的重要性。</p>
<blockquote>
<p>The greater the distance between a name’s declaration and its uses, the longer the name should be. (名字的声明与其使用之间的距离越大，名字应该越长。)<br> — Andrew Gerrand <a target="_blank" rel="noopener" href="https://talks.golang.org/2014/names.slide#4">[2]</a></p>
</blockquote>
<p>由此我们可以得出一些指导方针：</p>
<ul>
<li>短变量名称在声明和上次使用之间的距离很短时效果很好。</li>
<li>长变量名称需要证明自己的合理性; 名称越长，需要提供的价值越高。冗长的名称与页面上的重量相比，信号量较小。</li>
<li>请勿在变量名称中包含类型名称。</li>
<li>常量应该描述它们持有的值，而不是该如何使用。</li>
<li>对于循环和分支使用单字母变量，参数和返回值使用单个字，函数和包级别声明使用多个单词</li>
<li>方法、接口和包使用单个词。</li>
<li>请记住，包的名称是调用者用来引用名称的一部分，因此要好好利用这一点。</li>
</ul>
<p>我们来举个栗子:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">	Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AverageAge returns the average age of people.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AverageAge</span><span class="params">(people []Person)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(people) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> count, sum <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">for</span> _, p := <span class="keyword">range</span> people &#123;</span><br><span class="line">		sum += p.Age</span><br><span class="line">		count += <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sum / count</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在此示例中，变量 <code>p</code> 的在第 <code>10</code> 行被声明并且也只在接下来的一行中被引用。 <code>p</code> 在执行函数期间存在时间很短。如果要了解 <code>p</code> 的作用只需阅读两行代码。</p>
<p>相比之下，<code>people</code> 在函数第 <code>7</code> 行参数中被声明。<code>sum</code> 和 <code>count</code> 也是如此，他们用了更长的名字。读者必须查看更多的行数来定位它们，因此他们名字更为独特。</p>
<p>我可以选择 <code>s</code> 替代 <code>sum</code> 以及 <code>c</code>（或可能是 <code>n</code>）替代 <code>count</code>，但是这样做会将程序中的所有变量份量降低到同样的级别。我可以选择 <code>p</code> 来代替 <code>people</code>，但是用什么来调用 <code>for ... range</code> 迭代变量。如果用 <code>person</code> 的话看起来很奇怪，因为循环迭代变量的生命时间很短，其名字的长度超出了它的值。</p>
<blockquote>
<p>贴士:<br>与使用段落分解文档的方式一样用空行来分解函数。 在 <code>AverageAge</code> 中，按顺序共有三个操作。 第一个是前提条件，检查 <code>people</code> 是否为空，第二个是 <code>sum</code> 和 <code>count</code> 的累积，最后是平均值的计算。</p>
</blockquote>
<h4 id="2-2-1-上下文是关键"><a href="#2-2-1-上下文是关键" class="headerlink" title="2.2.1. 上下文是关键"></a>2.2.1. 上下文是关键</h4><p>重要的是要意识到关于命名的大多数建议都是需要考虑上下文的。 我想说这是一个原则，而不是一个规则。</p>
<p>两个标识符 <code>i</code> 和 <code>index</code> 之间有什么区别。 我们不能断定一个就比另一个好，例如</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> index := <span class="number">0</span>; index &lt; <span class="built_in">len</span>(s); index++ &#123;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从根本上说，上面的代码更具有可读性</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我认为它不是，因为就此事而论, <code>i</code> 和 <code>index</code> 的范围很大可能上仅限于 for 循环的主体，后者的额外冗长性(指 <code>index</code>)几乎没有增加对于程序的理解。</p>
<p>但是，哪些功能更具可读性？</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SNMP)</span> <span class="title">Fetch</span><span class="params">(oid []<span class="keyword">int</span>, index <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span></span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SNMP)</span> <span class="title">Fetch</span><span class="params">(o []<span class="keyword">int</span>, i <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span></span><br></pre></td></tr></table></figure>

<p>在此示例中，<code>oid</code> 是 <code>SNMP</code> 对象 <code>ID</code> 的缩写，因此将其缩短为 <code>o</code> 意味着程序员必须要将文档中常用符号转换为代码中较短的符号。 类似地将 <code>index</code> 替换成 <code>i</code>，模糊了 <code>i</code> 所代表的含义，因为在 <code>SNMP</code> 消息中，每个 <code>OID</code> 的子值称为索引。</p>
<blockquote>
<p>贴士: 在同一声明中长和短形式的参数不能混搭。</p>
</blockquote>
<h4 id="2-3-不要用变量类型命名你的变量"><a href="#2-3-不要用变量类型命名你的变量" class="headerlink" title="2.3. 不要用变量类型命名你的变量"></a>2.3. 不要用变量类型命名你的变量</h4><p>你不应该用变量的类型来命名你的变量, 就像您不会将宠物命名为“狗”和“猫”。 出于同样的原因，您也不应在变量名字中包含类型的名字。</p>
<p>变量的名称应描述其内容，而不是内容的类型。 例如：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> usersMap <span class="keyword">map</span>[<span class="keyword">string</span>]*User</span><br></pre></td></tr></table></figure>
<p>这个声明有什么好处？ 我们可以看到它是一个 <code>map</code>，它与 <code>*User</code> 类型有关。 但是 <code>usersMap</code> 是一个 <code>map</code>，而 Go 语言是一种静态类型的语言，如果没有定义变量,不会让我们意外地使用到它，因此 <code>Map</code> 后缀是多余的。</p>
<p>接下来, 如果我们像这样来声明其他变量：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	companiesMap <span class="keyword">map</span>[<span class="keyword">string</span>]*Company</span><br><span class="line">	productsMap <span class="keyword">map</span>[<span class="keyword">string</span>]*Products</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>usersMap</code>，<code>companiesMap</code> 和 <code>productsMap</code> 三个 <code>map</code> 类型变量，所有映射字符串都是不同的类型。 我们知道它们是 <code>map</code>，我们也知道我们不能使用其中一个来代替另一个 - 如果我们在需要 <code>map[string]*User</code> 的地方尝试使用 <code>companiesMap</code>, 编译器将抛出错误异常。 在这种情况下，很明显变量中 <code>Map</code> 后缀并没有提高代码的清晰度，它只是增加了要输入的额外样板代码。</p>
<p>我的建议是避免使用任何类似变量类型的后缀。</p>
<blockquote>
<p>贴士:<br>如果 <code>users</code> 的描述性都不够用，那么 <code>usersMap</code> 也不会。</p>
</blockquote>
<p>此建议也适用于函数参数。 例如：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteConfig</span><span class="params">(w io.Writer, config *Config)</span></span></span><br></pre></td></tr></table></figure>
<p>命名 <code>*Config</code> 参数 <code>config</code> 是多余的。 我们知道它是 <code>*Config</code> 类型，就是这样。</p>
<p>在这种情况下，如果变量的生命周期足够短，请考虑使用 <code>conf</code> 或 <code>c</code>。</p>
<p>如果有更多的 <code>*Config</code>，那么将它们称为 <code>original</code> 和 <code>updated</code> 比 <code>conf1</code> 和 <code>conf2</code> 会更具描述性，因为前者不太可能被互相误解。</p>
<blockquote>
<p>贴士:<br>不要让包名窃取好的变量名。<br>导入标识符的名称包括其包名称。 例如，<code>context</code> 包中的 <code>Context</code> 类型将被称为 <code>context.Context</code>。 这使得无法将 <code>context</code> 用作包中的变量或类型。</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteLog</span><span class="params">(context context.Context, message <span class="keyword">string</span>)</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面的栗子将会编译出错。 这就是为什么 <code>context.Context</code> 类型的通常的本地声明是 <code>ctx</code>，例如：</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteLog</span><span class="params">(ctx context.Context, message <span class="keyword">string</span>)</span></span></span><br></pre></td></tr></table></figure>

<h4 id="2-4-使用一致的命名方式"><a href="#2-4-使用一致的命名方式" class="headerlink" title="2.4. 使用一致的命名方式"></a>2.4. 使用一致的命名方式</h4><p>一个好名字的另一个属性是它应该是可预测的。 在第一次遇到该名字时读者就能够理解名字的使用。 当他们遇到常见的名字时，他们应该能够认为自从他们上次看到它以来它没有改变意义。</p>
<p>例如，如果您的代码在处理数据库请确保每次出现参数时，它都具有相同的名称。 与其使用 <code>d * sql.DB</code>，<code>dbase * sql.DB</code>，<code>DB * sql.DB</code> 和 <code>database * sql.DB</code> 的组合，倒不如统一使用:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db *sql.DB</span><br></pre></td></tr></table></figure>
<p>这样做使读者更为熟悉; 如果你看到<code>db</code>，你知道它就是 <code>*sql.DB</code> 并且它已经在本地声明或者由调用者为你提供。</p>
<p>类似地，对于方法接收器: 在该类型的每个方法上使用相同的接收者名称。 在这种类型的方法内部可以使读者更容易使用。</p>
<blockquote>
<p>注意:<br>Go 语言中的短接收者名称惯例与目前提供的建议不一致。 这只是早期做出的选择之一，已经成为首选的风格，就像使用 <code>CamelCase</code> 而不是 <code>snake_case</code> 一样。</p>
</blockquote>
<blockquote>
<p>贴士:<br>Go 语言样式规定接收器具有单个字母名称或从其类型派生的首字母缩略词。 你可能会发现接收器的名称有时会与方法中参数的名称冲突。 在这种情况下，请考虑将参数名称命名稍长，并且不要忘记一致地使用此新参数名称。</p>
</blockquote>
<p>最后，某些单字母变量传统上与循环和计数相关联。 例如，<code>i</code>，<code>j</code> 和 <code>k</code> 通常是简单 <code>for</code> 循环的循环归纳变量。<code>n</code> 通常与计数器或累加器相关联。<code>v</code> 是通用编码函数中值的常用简写，<code>k</code> 通常用于 <code>map</code> 的键，<code>s</code> 通常用作字符串类型参数的简写。</p>
<p>与上面的 <code>db</code> 示例一样，程序员认为 <code>i</code> 是一个循环归纳变量。 如果确保 <code>i</code> 始终是循环变量，而且不在 <code>for</code> 循环之外的其他地方中使用。 当读者遇到一个名为 <code>i</code> 或 <code>j</code> 的变量时，他们知道循环就在附近。</p>
<blockquote>
<p>贴士:<br>如果你发现自己有如此多的嵌套循环，<code>i</code>，<code>j</code> 和 <code>k</code> 变量都无法满足时，这个时候可能就是需要将函数分解成更小的函数。</p>
</blockquote>
<h4 id="2-5-使用一致的声明样式"><a href="#2-5-使用一致的声明样式" class="headerlink" title="2.5. 使用一致的声明样式"></a>2.5. 使用一致的声明样式</h4><p>Go 至少有六种不同的方式来声明变量</p>
<ul>
<li><code>var x int = 1</code></li>
<li><code>var x = 1</code></li>
<li><code>var x int; x = 1</code></li>
<li><code>var x = int(1)</code></li>
<li><code>x := 1</code></li>
</ul>
<p>我确信还有更多我没有想到的。 这可能是 Go 语言的设计师意识到的一个错误，但现在改变它为时已晚。 通过所有这些不同的方式来声明变量，我们如何避免每个 Go 程序员选择自己的风格？</p>
<p>我想就如何在程序中声明变量提出建议。 这是我尽可能使用的风格。</p>
<ul>
<li><p><strong>声明变量但没有初始化时，请使用 <code>var</code>。</strong> 当声明变量稍后将在函数中初始化时，请使用 <code>var</code> 关键字。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> players <span class="keyword">int</span>    <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> things []Thing <span class="comment">// an empty slice of Things</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> thing Thing    <span class="comment">// empty Thing struct</span></span><br><span class="line">json.Unmarshall(reader, &amp;thing)</span><br></pre></td></tr></table></figure>
<p><code>var</code> 表示此变量已被声明为指定类型的零值。 这也与使用 <code>var</code> 而不是短声明语法在包级别声明变量的要求一致 - 尽管我稍后会说你根本不应该使用包级变量。</p>
</li>
<li><p><strong>在声明和初始化时，使用 <code>:=</code>。</strong> 在同时声明和初始化变量时，也就是说我们不会将变量初始化为零值，我建议使用短变量声明。 这使得读者清楚地知道 <code>:=</code> 左侧的变量是初始化过的。</p>
</li>
</ul>
<p>为了解释原因，让我们看看前面的例子，但这次是初始化每个变量：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> players <span class="keyword">int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> things []Thing = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> thing *Thing = <span class="built_in">new</span>(Thing)</span><br><span class="line">json.Unmarshall(reader, thing)</span><br></pre></td></tr></table></figure>
<p>在第一个和第三个例子中，因为在 Go 语言中没有从一种类型到另一种类型的自动转换; 赋值运算符左侧的类型必须与右侧的类型相同。 编译器可以从右侧的类型推断出声明的变量的类型，上面的例子可以更简洁地写为：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> players = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> things []Thing = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> thing = <span class="built_in">new</span>(Thing)</span><br><span class="line">json.Unmarshall(reader, thing)</span><br></pre></td></tr></table></figure>
<p>我们将 <code>players</code> 初始化为 <code>0</code>，但这是多余的，因为 <code>0</code> 是 <code>players</code> 的零值。 因此，要明确地表示使用零值, 我们将上面例子改写为:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> players <span class="keyword">int</span></span><br></pre></td></tr></table></figure>
<p>第二个声明如何？ 我们不能省略类型而写作:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> things = <span class="literal">nil</span></span><br></pre></td></tr></table></figure>
<p>因为 <code>nil</code> 没有类型。 <a target="_blank" rel="noopener" href="https://speakerdeck.com/campoy/understanding-nil">[2]</a>相反，我们有一个选择，如果我们要使用切片的零值则写作:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> things []Thing</span><br></pre></td></tr></table></figure>
<p>或者我们要创建一个有零元素的切片则写作:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var things &#x3D; make([]Thing, 0)</span><br></pre></td></tr></table></figure>
<p>如果我们想要后者那么这不是切片的零值，所以我们应该向读者说明我们通过使用简短的声明形式做出这个选择：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">things := <span class="built_in">make</span>([]Thing, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>这告诉读者我们已选择明确初始化事物。</p>
<p>下面是第三个声明，</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> thing = <span class="built_in">new</span>(Thing)</span><br></pre></td></tr></table></figure>
<p>既是初始化了变量又引入了一些 Go 程序员不喜欢的 <code>new</code> 关键字的罕见用法。 如果我们用推荐地简短声明语法，那么就变成了:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thing := <span class="built_in">new</span>(Thing)</span><br></pre></td></tr></table></figure>
<p>这清楚地表明 <code>thing</code> 被初始化为 <code>new(Thing)</code> 的结果 - 一个指向 <code>Thing</code> 的指针 - 但依旧我们使用了 <code>new</code> 地罕见用法。 我们可以通过使用紧凑的文字结构初始化形式来解决这个问题，</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thing := &amp;Thing&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>与 <code>new(Thing)</code> 相同，这就是为什么一些 Go 程序员对重复感到不满。 然而，这意味着我们使用指向 <code>Thing&#123;&#125;</code> 的指针初始化了 <code>thing</code>，也就是 <code>Thing</code> 的零值。</p>
<p>相反，我们应该认识到 <code>thing</code> 被声明为零值，并使用地址运算符将 <code>thing</code> 的地址传递给 <code>json.Unmarshall</code></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> thing Thing</span><br><span class="line">json.Unmarshall(reader, &amp;thing)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>贴士:<br>当然，任何经验法则，都有例外。 例如，有时两个变量密切相关，这样写会很奇怪:</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> min <span class="keyword">int</span></span><br><span class="line">max := <span class="number">1000</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果这样声明可能更具可读性</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">min, max := <span class="number">0</span>, <span class="number">1000</span></span><br></pre></td></tr></table></figure>

<p>综上所述：</p>
<p>在没有初始化的情况下声明变量时，请使用 <code>var</code> 语法。</p>
<p>声明并初始化变量时，请使用 <code>:=</code>。</p>
<blockquote>
<p>贴士:<br>使复杂的声明显而易见。<br>当事情变得复杂时，它看起来就会很复杂。例如</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> length <span class="keyword">uint32</span> = <span class="number">0x80</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里 <code>length</code> 可能要与特定数字类型的库一起使用，并且 <code>length</code> 明确选择为 <code>uint32</code> 类型而不是短声明形式：</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">length := <span class="keyword">uint32</span>(<span class="number">0x80</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在第一个例子中，我故意违反了规则, 使用 <code>var</code> 声明带有初始化变量的。 这个决定与我的常用的形式不同，这给读者一个线索,告诉他们一些不寻常的事情将会发生。</p>
</blockquote>
<h4 id="2-6-成为团队合作者"><a href="#2-6-成为团队合作者" class="headerlink" title="2.6. 成为团队合作者"></a>2.6. 成为团队合作者</h4><p>我谈到了软件工程的目标，即编写可读及可维护的代码。 因此，您可能会将大部分职业生涯用于你不是唯一作者的项目。 我在这种情况下的建议是遵循项目自身风格。</p>
<p>在文件中间更改样式是不和谐的。 即使不是你喜欢的方式，对于维护而言一致性比你的个人偏好更有价值。 我的经验法则是: 如果它通过了 <code>gofmt</code>，那么通常不值得再做代码审查。</p>
<blockquote>
<p>贴士:<br>如果要在代码库中进行重命名，请不要将其混合到另一个更改中。 如果有人使用 <code>git bisect</code>，他们不想通过数千行重命名来查找您更改的代码。</p>
</blockquote>
<h3 id="3-注释"><a href="#3-注释" class="headerlink" title="3. 注释"></a>3. 注释</h3><p>在我们继续讨论更大的项目之前，我想花几分钟时间谈论一下注释。</p>
<blockquote>
<p>Good code has lots of comments, bad code requires lots of comments.<br>(好的代码有很多注释，坏代码需要很多注释。)<br> — Dave Thomas and Andrew Hunt (The Pragmatic Programmer)</p>
</blockquote>
<p>注释对 Go 语言程序的可读性非常重要。 注释应该做的三件事中的一件：</p>
<ol>
<li>注释应该解释其作用。</li>
<li>注释应该解释其如何做的。</li>
<li>注释应该解释其原因。</li>
</ol>
<p>第一种形式是公共符号注释的理想选择：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Open opens the named file for reading.</span></span><br><span class="line"><span class="comment">// If successful, methods on the returned file can be used for reading.</span></span><br></pre></td></tr></table></figure>
<p>第二种形式非常适合在方法中注释：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// queue all dependant actions</span></span><br><span class="line"><span class="keyword">var</span> results []<span class="keyword">chan</span> error</span><br><span class="line"><span class="keyword">for</span> _, dep := <span class="keyword">range</span> a.Deps &#123;</span><br><span class="line">        results = <span class="built_in">append</span>(results, execute(seen, dep))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三种形式是独一无二的，因为它不会取代前两种形式，但与此同时它并不能代替前两种形式。 此形式的注解用以解释代码的外部因素。 这些因素脱离上下文后通常很难理解，此注释的为了提供这种上下文。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &amp;v2.Cluster_CommonLbConfig&#123;</span><br><span class="line">	<span class="comment">// Disable HealthyPanicThreshold</span></span><br><span class="line">        HealthyPanicThreshold: &amp;envoy_type.Percent&#123;</span><br><span class="line">        	Value: <span class="number">0</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在此示例中，无法清楚地明白 <code>HealthyPanicThreshold</code> 设置为零百分比的效果。 需要注释 <code>0</code> 值将禁用 <code>panic</code> 阀值。</p>
<h4 id="3-1-关于变量和常量的注释应描述其内容而非其目的"><a href="#3-1-关于变量和常量的注释应描述其内容而非其目的" class="headerlink" title="3.1. 关于变量和常量的注释应描述其内容而非其目的"></a>3.1. 关于变量和常量的注释应描述其内容而非其目的</h4><p>我之前谈过，变量或常量的名称应描述其目的。 向变量或常量添加注释时，该注释应描述变量内容，而不是变量目的。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> randomNumber = <span class="number">6</span> <span class="comment">// determined from an unbiased die</span></span><br></pre></td></tr></table></figure>
<p>在此示例中，注释描述了为什么 <code>randomNumber</code> 被赋值为6，以及6来自哪里。 注释没有描述 <code>randomNumber</code> 的使用位置。 还有更多的栗子：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    StatusContinue           = <span class="number">100</span> <span class="comment">// RFC 7231, 6.2.1</span></span><br><span class="line">    StatusSwitchingProtocols = <span class="number">101</span> <span class="comment">// RFC 7231, 6.2.2</span></span><br><span class="line">    StatusProcessing         = <span class="number">102</span> <span class="comment">// RFC 2518, 10.1</span></span><br><span class="line"></span><br><span class="line">    StatusOK                 = <span class="number">200</span> <span class="comment">// RFC 7231, 6.3.1</span></span><br></pre></td></tr></table></figure>
<p>在HTTP的上下文中，数字 <code>100</code> 被称为 <code>StatusContinue</code>，如 RFC 7231 第 6.2.1 节中所定义。</p>
<blockquote>
<p>贴士:<br>对于没有初始值的变量，注释应描述谁负责初始化此变量。</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sizeCalculationDisabled indicates whether it is safe</span></span><br><span class="line"><span class="comment">// to calculate Types&#x27; widths and alignments. See dowidth.</span></span><br><span class="line"><span class="keyword">var</span> sizeCalculationDisabled <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里的注释让读者知道 <code>dowidth</code> 函数负责维护 <code>sizeCalculationDisabled</code> 的状态。</p>
<p><strong>隐藏在众目睽睽下</strong><br>这个提示来自Kate Gregory<a target="_blank" rel="noopener" href="https://www.infoq.com/articles/API-Design-Joshua-Bloch">[3]</a>。有时你会发现一个更好的变量名称隐藏在注释中。</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry of SQL drivers</span></span><br><span class="line"><span class="keyword">var</span> registry = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*sql.Driver)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注释是由作者添加的，因为 <code>registry</code> 没有充分解释其目的 - 它是一个注册表，但注册的是什么？</p>
<p>通过将变量重命名为 <code>sqlDrivers</code>，现在可以清楚地知道此变量的目的是保存SQL驱动程序。</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sqlDrivers = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*sql.Driver)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>之前的注释就是多余的，可以删除。</p>
</blockquote>
<h4 id="3-2-公共符号始终要注释"><a href="#3-2-公共符号始终要注释" class="headerlink" title="3.2. 公共符号始终要注释"></a>3.2. 公共符号始终要注释</h4><p><code>godoc</code> 是包的文档，所以应该始终为包中声明的每个公共符号 —​ 变量、常量、函数以及方法添加注释。</p>
<p>以下是 <code>Google Style</code> 指南中的两条规则:</p>
<ul>
<li>任何既不明显也不简短的公共功能必须予以注释。</li>
<li>无论长度或复杂程度如何，对库中的任何函数都必须进行注释<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ioutil</span><br><span class="line"></span><br><span class="line"><span class="comment">// ReadAll reads from r until an error or EOF and returns the data it read.</span></span><br><span class="line"><span class="comment">// A successful call returns err == nil, not err == EOF. Because ReadAll is</span></span><br><span class="line"><span class="comment">// defined to read from src until EOF, it does not treat an EOF from Read</span></span><br><span class="line"><span class="comment">// as an error to be reported.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadAll</span><span class="params">(r io.Reader)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span></span><br></pre></td></tr></table></figure>
这条规则有一个例外; 您不需要注释实现接口的方法。 具体不要像下面这样做：<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Read implements the io.Reader interface</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *FileReader)</span> <span class="title">Read</span><span class="params">(buf []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span></span><br></pre></td></tr></table></figure>
这个注释什么也没说。 它没有告诉你这个方法做了什么，更糟糕是它告诉你去看其他地方的文档。 在这种情况下，我建议完全删除该注释。</li>
</ul>
<p>这是 <code>io</code> 包中的一个例子</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LimitReader returns a Reader that reads from r</span></span><br><span class="line"><span class="comment">// but stops with EOF after n bytes.</span></span><br><span class="line"><span class="comment">// The underlying implementation is a *LimitedReader.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LimitReader</span><span class="params">(r Reader, n <span class="keyword">int64</span>)</span> <span class="title">Reader</span></span> &#123; <span class="keyword">return</span> &amp;LimitedReader&#123;r, n&#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A LimitedReader reads from R but limits the amount of</span></span><br><span class="line"><span class="comment">// data returned to just N bytes. Each call to Read</span></span><br><span class="line"><span class="comment">// updates N to reflect the new amount remaining.</span></span><br><span class="line"><span class="comment">// Read returns EOF when N &lt;= 0 or when the underlying R returns EOF.</span></span><br><span class="line"><span class="keyword">type</span> LimitedReader <span class="keyword">struct</span> &#123;</span><br><span class="line">	R Reader <span class="comment">// underlying reader</span></span><br><span class="line">	N <span class="keyword">int64</span>  <span class="comment">// max bytes remaining</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LimitedReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> l.N &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, EOF</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">int64</span>(<span class="built_in">len</span>(p)) &gt; l.N &#123;</span><br><span class="line">		p = p[<span class="number">0</span>:l.N]</span><br><span class="line">	&#125;</span><br><span class="line">	n, err = l.R.Read(p)</span><br><span class="line">	l.N -= <span class="keyword">int64</span>(n)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请注意，<code>LimitedReader</code> 的声明就在使用它的函数之前，而 <code>LimitedReader.Read</code> 的声明遵循 <code>LimitedReader</code> 本身的声明。 尽管 <code>LimitedReader.Read</code> 本身没有文档，但它清楚地表明它是 <code>io.Reader</code> 的一个实现。</p>
<blockquote>
<p>贴士:<br>在编写函数之前，请编写描述函数的注释。 如果你发现很难写出注释，那么这就表明你将要编写的代码很难理解。</p>
</blockquote>
<h4 id="3-2-1-不要注释不好的代码，将它重写"><a href="#3-2-1-不要注释不好的代码，将它重写" class="headerlink" title="3.2.1. 不要注释不好的代码，将它重写"></a>3.2.1. 不要注释不好的代码，将它重写</h4><blockquote>
<p>Don’t comment bad code — rewrite it<br>   — Brian Kernighan</p>
</blockquote>
<p>粗劣的代码的注释高亮显示是不够的。 如果你遇到其中一条注释，则应提出问题，以提醒您稍后重构。 只要技术债务数额已知，它是可以忍受的。</p>
<p>标准库中的惯例是注意到它的人用 <code>TODO(username)</code> 的样式来注释。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TODO(dfc) this is O(N^2), find a faster way to do this.</span></span><br></pre></td></tr></table></figure>
<p>注释 <code>username</code> 不是该人承诺要解决该问题，但在解决问题时他们可能是最好的人选。 其他项目使用 <code>TODO</code> 与日期或问题编号来注释。</p>
<h4 id="3-2-2-与其注释一段代码，不如重构它"><a href="#3-2-2-与其注释一段代码，不如重构它" class="headerlink" title="3.2.2. 与其注释一段代码，不如重构它"></a>3.2.2. 与其注释一段代码，不如重构它</h4><blockquote>
<p>Good code is its own best documentation. As you’re about to add a comment, ask yourself, ‘How can I improve the code so that this comment isn’t needed?’ Improve the code and then document it to make it even clearer.<br>好的代码是最好的文档。 在即将添加注释时，请问下自己，“如何改进代码以便不需要此注释？’ 改进代码使其更清晰。<br> — Steve McConnell</p>
</blockquote>
<p>函数应该只做一件事。 如果你发现自己在注释一段与函数的其余部分无关的代码，请考虑将其提取到它自己的函数中。</p>
<p>除了更容易理解之外，较小的函数更易于隔离测试，将代码隔离到函数中，其名称可能是所需的所有文档。</p>
<h3 id="4-包的设计"><a href="#4-包的设计" class="headerlink" title="4. 包的设计"></a>4. 包的设计</h3><blockquote>
<p>Write shy code - modules that don’t reveal anything unnecessary to other modules and that don’t rely on other modules’ implementations.<br>编写谨慎的代码 - 不向其他模块透露任何不必要的模块，并且不依赖于其他模块的实现。<br> — Dave Thomas</p>
</blockquote>
<p>每个 Go 语言的包实际上都是它一个小小的 Go 语言程序。 正如函数或方法的实现对调用者而言并不重要一样，包的公共API-其函数、方法以及类型的实现对于调用者来说也并不重要。</p>
<p>一个好的 Go 语言包应该具有低程度的源码级耦合，这样，随着项目的增长，对一个包的更改不会跨代码库级联。 这些世界末日的重构严格限制了代码库的变化率以及在该代码库中工作的成员的生产率。</p>
<p>在本节中，我们将讨论如何设计包，包括包的名称，命名类型以及编写方法和函数的技巧。</p>
<h4 id="4-1-一个好的包从它的名字开始"><a href="#4-1-一个好的包从它的名字开始" class="headerlink" title="4.1. 一个好的包从它的名字开始"></a>4.1. 一个好的包从它的名字开始</h4><p>编写一个好的 Go 语言包从包的名称开始。将你的包名用一个词来描述它。</p>
<p>正如我在上一节中谈到变量的名称一样，包的名称也非常重要。我遵循的经验法则不是“我应该在这个包中放入什么类型的？”。相反，我要问是“该包提供的服务是什么？”通常这个问题的答案不是“这个包提供 <code>X</code> 类型”，而是“这个包提供 <code>HTTP</code>”。</p>
<blockquote>
<p>贴士:<br>以包所提供的内容来命名，而不是它包含的内容。</p>
</blockquote>
<h4 id="4-1-1-好的包名应该是唯一的。"><a href="#4-1-1-好的包名应该是唯一的。" class="headerlink" title="4.1.1. 好的包名应该是唯一的。"></a>4.1.1. 好的包名应该是唯一的。</h4><p>在项目中，每个包名称应该是唯一的。包的名称应该描述其目的的建议很容易理解 - 如果你发现有两个包需要用相同名称，它可能是:</p>
<ol>
<li>包的名称太通用了。</li>
<li>该包与另一个类似名称的包重叠了。在这种情况下，您应该检查你的设计，或考虑合并包。</li>
</ol>
<h4 id="4-2-避免使用类似-base，common-或-util-的包名称"><a href="#4-2-避免使用类似-base，common-或-util-的包名称" class="headerlink" title="4.2. 避免使用类似 base，common 或 util 的包名称"></a>4.2. 避免使用类似 <code>base</code>，<code>common</code> 或 <code>util</code> 的包名称</h4><p>不好的包名的常见情况是 <code>utility</code> 包。这些包通常是随着时间的推移一些帮助程序和工具类的包。由于这些包包含各种不相关的功能，因此很难根据包提供的内容来描述它们。这通常会导致包的名称来自包含的内容 - <code>utilities</code>。</p>
<p>像 <code>utils</code> 或 <code>helper</code> 这样的包名称通常出现在较大的项目中，这些项目已经开发了深层次包的结构，并且希望在不遇到导入循环的情况下共享 <code>helper</code> 函数。通过将 <code>utility </code> 程序函数提取到新的包中，导入循环会被破坏，但由于该包源于项目中的设计问题，因此其包名称不反映其目的，仅反映其为了打破导入循环。</p>
<p>我建议改进 <code>utils</code> 或 <code>helpers</code> 包的名称是分析它们的调用位置，如果可能的话，将相关的函数移动到调用者的包中。即使这涉及复制一些 <code>helper</code> 程序代码，这也比在两个程序包之间引入导入依赖项更好。</p>
<blockquote>
<p>[A little] duplication is far cheaper than the wrong abstraction.<br>([一点点]重复比错误的抽象的性价比高很多。)<br> — Sandy Metz</p>
</blockquote>
<p>在使用 <code>utility</code> 程序的情况下，最好选多个包，每个包专注于单个方面，而不是选单一的整体包。</p>
<blockquote>
<p>贴士:<br>使用复数形式命名 <code>utility</code> 包。例如 <code>strings</code> 来处理字符串。</p>
</blockquote>
<p>当两个或多个实现共有的功能或客户端和服务器的常见类型被重构为单独的包时，通常会找到名称类似于 <code>base</code> 或 <code>common</code> 的包。我相信解决方案是减少包的数量，将客户端，服务器和公共代码组合到一个以包的功能命名的包中。</p>
<p>例如，<code>net/http</code> 包没有 <code>client</code> 和 <code>server</code> 的分包，而是有一个 <code>client.go</code> 和 <code>server.go</code> 文件，每个文件都有各自的类型，还有一个 <code>transport.go</code> 文件，用于公共消息传输代码。</p>
<blockquote>
<p>贴士:<br><strong>标识符的名称包括其包名称。</strong><br>重要的是标识符的名称包括其包的名称。</p>
<ul>
<li>当由另一个包引用时，<code>net/http</code> 包中的 Get 函数变为 <code>http.Get</code>。</li>
<li>当导入到其他包中时，<code>strings</code> 包中的 <code>Reader</code> 类型变为 <code>strings.Reader</code>。</li>
<li><code>net</code> 包中的 <code>Error</code> 接口显然与网络错误有关。</li>
</ul>
</blockquote>
<h4 id="4-3-尽早-return-而不是深度嵌套"><a href="#4-3-尽早-return-而不是深度嵌套" class="headerlink" title="4.3. 尽早 return 而不是深度嵌套"></a>4.3. 尽早 <code>return</code> 而不是深度嵌套</h4><p>由于 Go 语言的控制流不使用 <code>exception</code>，因此不需要为 <code>try</code> 和 <code>catch</code> 块提供顶级结构而深度缩进代码。Go 语言代码不是成功的路径越来越深地嵌套到右边，而是以一种风格编写，其中随着函数的进行，成功路径继续沿着屏幕向下移动。 我的朋友 Mat Ryer 将这种做法称为“视线”编码。<a target="_blank" rel="noopener" href="https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88">[4]</a></p>
<p>这是通过使用 <code>guard clauses</code> 来实现的; 在进入函数时是具有断言前提条件的条件块。 这是一个来自 <code>bytes</code> 包的例子:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">UnreadRune</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> b.lastRead &lt;= opInvalid &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;bytes.Buffer: UnreadRune: previous operation was not a successful ReadRune&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> b.off &gt;= <span class="keyword">int</span>(b.lastRead) &#123;</span><br><span class="line">		b.off -= <span class="keyword">int</span>(b.lastRead)</span><br><span class="line">	&#125;</span><br><span class="line">	b.lastRead = opInvalid</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入 <code>UnreadRune</code> 后，将检查 <code>b.lastRead</code> 的状态，如果之前的操作不是 <code>ReadRune</code>，则会立即返回错误。 之后，函数的其余部分继续进行 <code>b.lastRead</code> 大于 <code>opInvalid</code> 的断言。</p>
<p>与没有 <code>guard clause</code> 的相同函数进行比较，</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">UnreadRune</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> b.lastRead &gt; opInvalid &#123;</span><br><span class="line">		<span class="keyword">if</span> b.off &gt;= <span class="keyword">int</span>(b.lastRead) &#123;</span><br><span class="line">			b.off -= <span class="keyword">int</span>(b.lastRead)</span><br><span class="line">		&#125;</span><br><span class="line">		b.lastRead = opInvalid</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> errors.New(<span class="string">&quot;bytes.Buffer: UnreadRune: previous operation was not a successful ReadRune&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最常见的执行成功的情况是嵌套在第一个if条件内，成功的退出条件是 <code>return nil</code>，而且必须通过仔细匹配大括号来发现。 函数的最后一行是返回一个错误，并且被调用者必须追溯到匹配的左括号，以了解何时执行到此点。</p>
<p>对于读者和维护程序员来说，这更容易出错，因此 Go 语言更喜欢使用 <code>guard clauses</code> 并尽早返回错误。</p>
<h4 id="4-4-让零值更有用"><a href="#4-4-让零值更有用" class="headerlink" title="4.4. 让零值更有用"></a>4.4. 让零值更有用</h4><p>假设变量没有初始化，每个变量声明都会自动初始化为与零内存的内容相匹配的值。 这就是零值。 值的类型决定了其零值; 对于数字类型，它为 <code>0</code>，对于指针类型为 <code>nil</code>，<code>slices</code>、<code>map</code> 和 <code>channel</code> 同样是 <code>nil</code>。</p>
<p>始终设置变量为已知默认值的属性对于程序的安全性和正确性非常重要，并且可以使 Go 语言程序更简单、更紧凑。 这就是 Go 程序员所说的“给你的结构一个有用的零值”。</p>
<p>对于 <code>sync.Mutex</code> 类型。<code>sync.Mutex</code> 包含两个未公开的整数字段，它们用来表示互斥锁的内部状态。 每当声明 <code>sync.Mutex</code> 时，其字段会被设置为 <code>0</code> 初始值。<code>sync.Mutex</code> 利用此属性来编写，使该类型可直接使用而无需初始化。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyInt <span class="keyword">struct</span> &#123;</span><br><span class="line">	mu  sync.Mutex</span><br><span class="line">	val <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> i MyInt</span><br><span class="line"></span><br><span class="line">	<span class="comment">// i.mu is usable without explicit initialisation.</span></span><br><span class="line">	i.mu.Lock()</span><br><span class="line">	i.val++</span><br><span class="line">	i.mu.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另一个利用零值的类型是 <code>bytes.Buffer</code>。您可以声明 <code>bytes.Buffer</code> 然后就直接写入而无需初始化。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> b bytes.Buffer</span><br><span class="line">	b.WriteString(<span class="string">&quot;Hello, world!\n&quot;</span>)</span><br><span class="line">	io.Copy(os.Stdout, &amp;b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>切片的一个有用属性是它们的零值 <code>nil</code>。如果我们看一下切片运行时 <code>header</code> 的定义就不难理解:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">        array *[...]T <span class="comment">// pointer to the underlying array</span></span><br><span class="line">        <span class="built_in">len</span>   <span class="keyword">int</span></span><br><span class="line">        <span class="built_in">cap</span>   <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此结构的零值意味着 <code>len</code> 和 <code>cap</code> 的值为 <code>0</code>，而 <code>array</code>（指向保存切片的内容数组的指针）将为 <code>nil</code>。这意味着你不需要 <code>make</code> 切片，你只需声明它即可。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// s := make([]string, 0)</span></span><br><span class="line">	<span class="comment">// s := []string&#123;&#125;</span></span><br><span class="line">	<span class="keyword">var</span> s []<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="string">&quot;world&quot;</span>)</span><br><span class="line">	fmt.Println(strings.Join(s, <span class="string">&quot; &quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意:<br><code>var s []string</code> 类似于它上面的两条注释行，但并不完全相同。值为 <code>nil</code> 的切片与具有零长度的切片就可以来相互比较。以下代码将输出 <code>false</code>。</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> s1 = []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">var</span> s2 []<span class="keyword">string</span></span><br><span class="line">	fmt.Println(reflect.DeepEqual(s1, s2))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>nil pointers</code> – 未初始化的指针变量的一个有用属性是你可以在具有 <code>nil</code> 值的类型上调用方法。它可以简单地用于提供默认值。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">	path <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Config)</span> <span class="title">Path</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;/usr/home&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> c.path</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> c1 *Config</span><br><span class="line">	<span class="keyword">var</span> c2 = &amp;Config&#123;</span><br><span class="line">		path: <span class="string">&quot;/export&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(c1.Path(), c2.Path())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-5-避免包级别状态"><a href="#4-5-避免包级别状态" class="headerlink" title="4.5. 避免包级别状态"></a>4.5. 避免包级别状态</h4><p>编写可维护程序的关键是它们应该是松散耦合的 - 对一个程序包的更改应该很少影响另一个不直接依赖于第一个程序包的程序包。</p>
<p>在 Go 语言中有两种很好的方法可以实现松散耦合</p>
<ol>
<li>使用接口来描述函数或方法所需的行为。</li>
<li>避免使用全局状态。</li>
</ol>
<p>在 Go 语言中，我们可以在函数或方法范围以及包范围内声明变量。当变量是公共的时，给定一个以大写字母开头的标识符，那么它的范围对于整个程序来说实际上是全局的 - 任何包都可以随时观察该变量的类型和内容。</p>
<p>可变全局状态引入程序的独立部分之间的紧密耦合，因为全局变量成为程序中每个函数的不可见参数！如果该变量的类型发生更改，则可以破坏依赖于全局变量的任何函数。如果程序的另一部分更改了该变量，则可以破坏依赖于全局变量状态的任何函数。</p>
<p>如果要减少全局变量所带来的耦合，</p>
<ol>
<li>将相关变量作为字段移动到需要它们的结构上。</li>
<li>使用接口来减少行为与实现之间的耦合。</li>
</ol>
<h3 id="5-项目结构"><a href="#5-项目结构" class="headerlink" title="5. 项目结构"></a>5. 项目结构</h3><p>我们来谈谈如何将包组合到项目中。 通常一个项目是一个 <code>git</code> 仓库，但在未来 Go 语言开发人员会交替地使用 <code>module</code> 和 <code>project</code>。</p>
<p>就像一个包，每个项目都应该有一个明确的目的。 如果你的项目是一个库，它应该提供一件事，比如 <code>XML</code> 解析或记录。 您应该避免在一个包实现多个目的，这将有助于避免成为 <code>common</code> 库。</p>
<blockquote>
<p>贴士:<br>据我的经验，<code>common</code> 库最终会与其最大的调用者紧密相连，在没有升级该库与最大调用者的情况下是很难修复的，还会带来了许多无关的更改以及API破坏。</p>
</blockquote>
<p>如果你的项目是应用程序，如 <code>Web</code> 应用程序，<code>Kubernetes</code> 控制器等，那么项目中可能有一个或多个 <code>main</code> 程序包。 例如，我编写的 <code>Kubernetes</code> 控制器有一个 <code>cmd/contour</code> 包，既可以作为部署到 <code>Kubernetes</code> 集群的服务器，也可以作为调试目的的客户端。</p>
<h4 id="5-1-考虑更少，更大的包"><a href="#5-1-考虑更少，更大的包" class="headerlink" title="5.1. 考虑更少，更大的包"></a>5.1. 考虑更少，更大的包</h4><p>对于从其他语言过渡到 Go 语言的程序员来说，我倾向于在代码审查中提到的一件事是他们会过度使用包。</p>
<p>Go 语言没有提供有关可见性的详细方法; Java有 <code>public</code>、<code>protected</code>、<code>private</code> 以及隐式 <code>default</code> 的访问修饰符。 没有 <code>C++</code> 的 <code>friend</code> 类概念。</p>
<p>在 Go 语言中，我们只有两个访问修饰符，<code>public</code> 和 <code>private</code>，由标识符的第一个字母的大小写表示。 如果标识符是公共的，则其名称以大写字母开头，该标识符可用于任何其他 Go 语言包的引用。</p>
<blockquote>
<p>注意:<br>你可能会听到人们说 <code>exported</code> 与 <code>not exported</code>, 跟 <code>public</code> 和 <code>private</code> 是同义词。</p>
</blockquote>
<p>鉴于包的符号的访问有限控件，Go 程序员应遵循哪些实践来避免创建过于复杂的包层次结构？</p>
<blockquote>
<p>贴士:<br>除 <code>cmd/</code> 和 <code>internal/</code> 之外的每个包都应包含一些源代码。</p>
</blockquote>
<p>我的建议是选择更少，更大的包。 你应该做的是不创建新的程序包。 这将导致太多类型被公开，为你的包创建一个宽而浅的API。</p>
<p>以下部分将更为详细地探讨这一建议。</p>
<blockquote>
<p>贴士:<br>来自 <code>Java</code>？<br>如果您来自 <code>Java</code> 或 <code>C#</code>，请考虑这一经验法则 – <code>Java</code> 包相当于单个 <code>.go</code> 源文件。 - Go 语言包相当于整个 <code>Maven</code> 模块或 <code>.NET</code> 程序集。</p>
</blockquote>
<h4 id="5-1-1-通过-import-语句将代码排列到文件中"><a href="#5-1-1-通过-import-语句将代码排列到文件中" class="headerlink" title="5.1.1. 通过 import 语句将代码排列到文件中"></a>5.1.1. 通过 <code>import</code> 语句将代码排列到文件中</h4><p>如果你按照包提供的内容来安排你的程序包，是否需要对 Go 包中的文件也执行相同的操作？什么时候应该将 <code>.go</code> 文件拆分成多个文件？什么时候应该考虑整合 <code>.go</code> 文件？</p>
<p>以下是我的经验法则：</p>
<ul>
<li>开始时使用一个 <code>.go</code> 文件。为该文件指定与文件夹名称相同的名称。例如: <code>package http</code> 应放在名为 <code>http</code> 的目录中名为 <code>http.go</code> 的文件中。</li>
<li>随着包的增长，您可能决定将各种职责任务拆分为不同的文件。例如：<code>messages.go</code> 包含 <code>Request</code> 和 <code>Response</code> 类型，<code>client.go</code> 包含 <code>Client</code> 类型，<code>server.go</code>包含 <code>Server</code> 类型。</li>
<li>如果你的文件中 <code>import</code> 的声明类似，请考虑将它们组合起来。或者确定 <code>import</code> 集之间的差异并移动它们。</li>
<li>不同的文件应该负责包的不同区域。<code>messages.go</code> 可能负责网络的 <code>HTTP</code> 请求和响应，<code>http.go</code> 可能包含底层网络处理逻辑，<code>client.go</code> 和 <code>server.go</code> 实现 <code>HTTP</code> 业务逻辑请求的实现或路由等等。</li>
</ul>
<blockquote>
<p>贴士: 首选名词为源文件命名。</p>
</blockquote>
<blockquote>
<p>注意:<br>Go编译器并行编译每个包。 在一个包中，编译器并行编译每个函数（方法只是 Go 语言中函数的另一种写法）。 更改包中代码的布局不会影响编译时间。</p>
</blockquote>
<h4 id="5-1-2-优先内部测试再到外部测试"><a href="#5-1-2-优先内部测试再到外部测试" class="headerlink" title="5.1.2. 优先内部测试再到外部测试"></a>5.1.2. 优先内部测试再到外部测试</h4><p><code>go tool</code> 支持在两个地方编写 <code>testing</code> 包测试。假设你的包名为 <code>http2</code>，您可以编写 <code>http2_test.go</code> 文件并使用包 <code>http2</code> 声明。这样做会编译 <code>http2_test.go</code> 中的代码，就像它是 <code>http2</code> 包的一部分一样。这就是内部测试。</p>
<p><code>go tool</code> 还支持一个特殊的包声明，以 <code>test</code> 为结尾，即 <code>package http_test</code>。这允许你的测试文件与代码一起存放在同一个包中，但是当编译时这些测试不是包的代码的一部分，它们存在于自己的包中。就像调用另一个包的代码一样来编写测试。这被称为外部测试。</p>
<p>我建议在编写单元测试时使用内部测试。这样你就可以直接测试每个函数或方法，避免外部测试干扰。</p>
<p>但是，你应该将 <code>Example</code> 测试函数放在外部测试文件中。这确保了在 <code>godoc</code> 中查看时，示例具有适当的包名前缀并且可以轻松地进行复制粘贴。</p>
<blockquote>
<p>贴士:<br><code>避免复杂的包层次结构，抵制应用分类法</code><br>Go 语言包的层次结构对于 <code>go tool</code> 没有任何意义除了下一节要说的。 例如，<code>net/http</code> 包不是一个子包或者 <code>net</code> 包的子包。</p>
<p>如果在项目中创建了不包含 <code>.go</code> 文件的中间目录，则可能无法遵循此建议。</p>
</blockquote>
<h4 id="5-1-3-使用-internal-包来减少公共API"><a href="#5-1-3-使用-internal-包来减少公共API" class="headerlink" title="5.1.3. 使用 internal 包来减少公共API"></a>5.1.3. 使用 <code>internal</code> 包来减少公共API</h4><p>如果项目包含多个包，可能有一些公共的函数，这些函数旨在供项目中的其他包使用，但不打算成为项目的公共API的一部分。 如果你发现是这种情况，那么 <code>go tool</code> 会识别一个特殊的文件夹名称 - 而非包名称 - <code>internal/</code> 可用于放置对项目公开的代码，但对其他项目是私有的。</p>
<p>要创建此类包，请将其放在名为 <code>internal/</code> 的目录中，或者放在名为 <code>internal/</code> 的目录的子目录中。 当 <code>go</code> 命令在其路径中看到导入包含 <code>internal</code> 的包时，它会验证执行导入的包是否位于 <code>internal</code> 目录。</p>
<p>例如，<code>.../a/b/c/internal/d/e/f</code> 的包只能通过以 <code>.../a/b/c/</code> 为根目录的代码被导入。 它无法通过 <code>.../a/b/g</code> 或任何其他仓库中的代码导入。<a target="_blank" rel="noopener" href="https://golang.org/doc/go1.4#internalpackages">[5]</a></p>
<h4 id="5-2-确保-main-包内容尽可能的少"><a href="#5-2-确保-main-包内容尽可能的少" class="headerlink" title="5.2. 确保 main 包内容尽可能的少"></a>5.2. 确保 <code>main</code> 包内容尽可能的少</h4><p><code>main</code> 函数和 <code>main</code> 包的内容应尽可能少。 这是因为 <code>main.main</code> 充当单例; 程序中只能有一个 <code>main</code> 函数，包括 <code>tests</code>。</p>
<p>因为 <code>main.main</code> 是一个单例，假设 <code>main</code> 函数中需要执行很多事情,<code>main.main</code> 只会在 <code>main.main</code> 或 <code>main.init</code> 中调用它们并且只调用一次。 这使得为 <code>main.main</code> 编写代码测试变得很困难，因此你应该将所有业务逻辑从 <code>main</code> 函数中移出，最好是从 <code>main</code> 包中移出。</p>
<blockquote>
<p>贴士:<br><code>main</code> 应该做解析 <code>flags</code>，开启数据库连接、开启日志等，然后将执行交给更高一级的对象。</p>
</blockquote>
<h3 id="6-API-设计"><a href="#6-API-设计" class="headerlink" title="6. API 设计"></a>6. API 设计</h3><p>我今天要给出的最后一条建议是设计, 我认为也是最重要的。</p>
<p>到目前为止我提出的所有建议都是建议。 这些是我尝试编写 Go 语言的方式，但我不打算在代码审查中拼命推广。</p>
<p>但是，在审查 API 时, 我就不会那么宽容了。 这是因为到目前为止我所谈论的所有内容都是可以修复而且不会破坏向后兼容性; 它们在很大程度上是实现的细节。</p>
<p>当涉及到软件包的公共 API 时，在初始设计中投入大量精力是值得的，因为稍后更改该设计对于已经使用 API 的人来说会是破坏性的。</p>
<h4 id="6-1-设计难以被误用的-API"><a href="#6-1-设计难以被误用的-API" class="headerlink" title="6.1. 设计难以被误用的 API"></a>6.1. 设计难以被误用的 API</h4><blockquote>
<p>APIs should be easy to use and hard to misuse.<br>(API 应该易于使用且难以被误用)<br> — Josh Bloch <a target="_blank" rel="noopener" href="https://www.infoq.com/articles/API-Design-Joshua-Bloch">[3]</a></p>
</blockquote>
<p>如果你从这个演讲中带走任何东西，那应该是 Josh Bloch 的建议。 如果一个 API 很难用于简单的事情，那么 API 的每次调用都会很复杂。 当 API 的实际调用很复杂时，它就会便得不那么明显，而且会更容易被忽视。</p>
<h4 id="6-1-1-警惕采用几个相同类型参数的函数"><a href="#6-1-1-警惕采用几个相同类型参数的函数" class="headerlink" title="6.1.1. 警惕采用几个相同类型参数的函数"></a>6.1.1. 警惕采用几个相同类型参数的函数</h4><p>简单, 但难以正确使用的 API 是采用两个或更多相同类型参数的 API。 让我们比较两个函数签名：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Max</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyFile</span><span class="params">(to, from <span class="keyword">string</span>)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
<p>这两个函数有什么区别？ 显然，一个返回两个数字最大的那个，另一个是复制文件，但这不重要。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Max(<span class="number">8</span>, <span class="number">10</span>) <span class="comment">// 10</span></span><br><span class="line">Max(<span class="number">10</span>, <span class="number">8</span>) <span class="comment">// 10</span></span><br></pre></td></tr></table></figure>

<p><code>Max</code> 是可交换的; 参数的顺序无关紧要。 无论是 8 比 10 还是 10 比 8，最大的都是 10。</p>
<p>但是，却不适用于 <code>CopyFile</code>。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CopyFile(<span class="string">&quot;/tmp/backup&quot;</span>, <span class="string">&quot;presentation.md&quot;</span>)</span><br><span class="line">CopyFile(<span class="string">&quot;presentation.md&quot;</span>, <span class="string">&quot;/tmp/backup&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这些声明中哪一个备份了 <code>presentation.md</code>，哪一个用上周的版本覆盖了 <code>presentation.md</code>？ 没有文档，你无法分辨。 如果没有查阅文档，代码审查员也无法知道你写对了顺序。</p>
<p>一种可能的解决方案是引入一个 <code>helper</code> 类型，它会负责如何正确地调用 <code>CopyFile</code>。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Source <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(src Source)</span> <span class="title">CopyTo</span><span class="params">(dest <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> CopyFile(dest, <span class="keyword">string</span>(src))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> from Source = <span class="string">&quot;presentation.md&quot;</span></span><br><span class="line">	from.CopyTo(<span class="string">&quot;/tmp/backup&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这种方式，<code>CopyFile</code> 总是能被正确调用 - 还可以通过单元测试 - 并且可以被设置为私有，进一步降低了误用的可能性。</p>
<blockquote>
<p>贴士: 具有多个相同类型参数的API难以正确使用。</p>
</blockquote>
<h4 id="6-2-为其默认用例设计-API"><a href="#6-2-为其默认用例设计-API" class="headerlink" title="6.2. 为其默认用例设计 API"></a>6.2. 为其默认用例设计 API</h4><p>几年前，我就对 <code>functional options</code><a target="_blank" rel="noopener" href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html">[7]</a> 进行过讨论<a target="_blank" rel="noopener" href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis">[6]</a>，使 API 更易用于默认用例。</p>
<p>本演讲的主旨是你应该为常见用例设计 API。 另一方面， API 不应要求调用者提供他们不在乎参数。</p>
<h4 id="6-2-1-不鼓励使用-nil-作为参数"><a href="#6-2-1-不鼓励使用-nil-作为参数" class="headerlink" title="6.2.1. 不鼓励使用 nil 作为参数"></a>6.2.1. 不鼓励使用 <code>nil</code> 作为参数</h4><p>本章开始时我建议是不要强迫提供给 API 的调用者他们不在乎的参数。 这就是我要说的为默认用例设计 API。</p>
<p>这是 <code>net/http</code> 包中的一个例子</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> http</span><br><span class="line"></span><br><span class="line"><span class="comment">// ListenAndServe listens on the TCP network address addr and then calls</span></span><br><span class="line"><span class="comment">// Serve with handler to handle requests on incoming connections.</span></span><br><span class="line"><span class="comment">// Accepted connections are configured to enable TCP keep-alives.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The handler is typically nil, in which case the DefaultServeMux is used.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ListenAndServe always returns a non-nil error.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListenAndServe</span><span class="params">(addr <span class="keyword">string</span>, handler Handler)</span> <span class="title">error</span></span> &#123;</span><br></pre></td></tr></table></figure>
<p><code>ListenAndServe</code> 有两个参数，一个用于监听传入连接的 <code>TCP</code> 地址，另一个用于处理 <code>HTTP</code> 请求的 <code>http.Handler</code>。<code>Serve</code> 允许第二个参数为 <code>nil</code>，需要注意的是调用者通常会传递 <code>nil</code>，表示他们想要使用 <code>http.DefaultServeMux</code> 作为隐含参数。</p>
<p>现在，<code>Serve</code> 的调用者有两种方式可以做同样的事情。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, http.DefaultServeMux)</span><br></pre></td></tr></table></figure>
<p>两者完全相同。</p>
<p>这种 <code>nil</code> 行为是病毒式的。 <code>http</code> 包也有一个 <code>http.Serve</code> 帮助类，你可以合理地想象一下 <code>ListenAndServe</code> 是这样构建的</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListenAndServe</span><span class="params">(addr <span class="keyword">string</span>, handler Handler)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	l, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, addr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> l.Close()</span><br><span class="line">	<span class="keyword">return</span> Serve(l, handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为 <code>ListenAndServe</code> 允许调用者为第二个参数传递 <code>nil</code>，所以 <code>http.Serve</code> 也支持这种行为。 事实上，<code>http.Serve</code> 实现了如果 <code>handler</code> 是<code>nil</code>，使用 <code>DefaultServeMux</code> 的逻辑。 参数可为 <code>nil</code> 可能会导致调用者认为他们可以为两个参数都使用 <code>nil</code>。 像下面这样:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.Serve(<span class="literal">nil</span>, <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>
<p>会导致 <code>panic</code>。</p>
<blockquote>
<p>贴士:<br>不要在同一个函数签名中混合使用可为 <code>nil</code> 和不能为 <code>nil</code> 的参数。</p>
</blockquote>
<p><code>http.ListenAndServe</code> 的作者试图在常见情况下让使用 API 的用户更轻松些，但很可能会让该程序包更难以被安全地使用。</p>
<p>使用 <code>DefaultServeMux</code> 或使用 <code>nil</code> 没有什么区别。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> root = http.Dir(<span class="string">&quot;/htdocs&quot;</span>)</span><br><span class="line">http.Handle(<span class="string">&quot;/&quot;</span>, http.FileServer(root))</span><br><span class="line">http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>
<p>对比</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> root = http.Dir(<span class="string">&quot;/htdocs&quot;</span>)</span><br><span class="line">http.Handle(<span class="string">&quot;/&quot;</span>, http.FileServer(root))</span><br><span class="line">http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, http.DefaultServeMux)</span><br></pre></td></tr></table></figure>
<p>这种混乱值得拯救吗？</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> root = http.Dir(<span class="string">&quot;/htdocs&quot;</span>)</span><br><span class="line">mux := http.NewServeMux()</span><br><span class="line">http.Handle(<span class="string">&quot;/&quot;</span>, http.FileServer(root))</span><br><span class="line">http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, mux)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>贴士: 认真考虑 <code>helper</code> 函数会节省不少时间。 清晰要比简洁好。</p>
</blockquote>
<blockquote>
<p>贴士:<br><code>避免公共 API 使用测试参数</code><br>避免在公开的 API 上使用仅在测试范围上不同的值。 相反，使用 <code>Public wrappers</code> 隐藏这些参数，使用辅助方式来设置测试范围中的属性。</p>
</blockquote>
<h4 id="6-2-2-首选可变参数函数而非-T-参数"><a href="#6-2-2-首选可变参数函数而非-T-参数" class="headerlink" title="6.2.2. 首选可变参数函数而非 []T 参数"></a>6.2.2. 首选可变参数函数而非 <code>[]T</code> 参数</h4><p>编写一个带有切片参数的函数或方法是很常见的。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ShutdownVMs</span><span class="params">(ids []<span class="keyword">string</span>)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
<p>这只是我编的一个例子，但它与我所写的很多代码相同。 这里的问题是他们假设他们会被调用于多个条目。 但是很多时候这些类型的函数只用一个参数调用，为了满足函数参数的要求，它必须打包到一个切片内。</p>
<p>另外，因为 <code>ids</code> 参数是切片，所以你可以将一个空切片或 <code>nil</code> 传递给该函数，编译也没什么错误。 但是这会增加额外的测试负载，因为你应该涵盖这些情况在测试中。</p>
<p>举一个这类 API 的例子，最近我重构了一条逻辑，要求我设置一些额外的字段，如果一组参数中至少有一个非零。 逻辑看起来像这样：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> svc.MaxConnections &gt; <span class="number">0</span> || svc.MaxPendingRequests &gt; <span class="number">0</span> || svc.MaxRequests &gt; <span class="number">0</span> || svc.MaxRetries &gt; <span class="number">0</span> &#123;</span><br><span class="line">	<span class="comment">// apply the non zero parameters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 <code>if</code> 语句变得很长，我想将签出的逻辑拉入其自己的函数中。 这就是我提出的：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// anyPostive indicates if any value is greater than zero.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">anyPositive</span><span class="params">(values ...<span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> values &#123;</span><br><span class="line">		<span class="keyword">if</span> v &gt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就能够向读者明确内部块的执行条件：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> anyPositive(svc.MaxConnections, svc.MaxPendingRequests, svc.MaxRequests, svc.MaxRetries) &#123;</span><br><span class="line">        <span class="comment">// apply the non zero parameters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是 <code>anyPositive</code> 还存在一个问题，有人可能会这样调用它:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> anyPositive() &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>在这种情况下，<code>anyPositive</code> 将返回 <code>false</code>，因为它不会执行迭代而是立即返回 <code>false</code>。对比起如果 <code>anyPositive</code> 在没有传递参数时返回 <code>true</code>, 这还不算世界上最糟糕的事情。</p>
<p>然而，如果我们可以更改 <code>anyPositive</code> 的签名以强制调用者应该传递至少一个参数，那会更好。我们可以通过组合正常和可变参数来做到这一点，如下所示：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// anyPostive indicates if any value is greater than zero.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">anyPositive</span><span class="params">(first <span class="keyword">int</span>, rest ...<span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> first &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> rest &#123;</span><br><span class="line">		<span class="keyword">if</span> v &gt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在不能使用少于一个参数来调用 <code>anyPositive</code>。</p>
<h4 id="6-3-让函数定义它们所需的行为"><a href="#6-3-让函数定义它们所需的行为" class="headerlink" title="6.3. 让函数定义它们所需的行为"></a>6.3. 让函数定义它们所需的行为</h4><p>假设我需要编写一个将 <code>Document</code> 结构保存到磁盘的函数的任务。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Save writes the contents of doc to the file f.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Save</span><span class="params">(f *os.File, doc *Document)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
<p>我可以指定这个函数 <code>Save</code>，它将 <code>*os.File</code> 作为写入 <code>Document</code> 的目标。但这样做会有一些问题</p>
<p><code>Save</code> 的签名排除了将数据写入网络位置的选项。假设网络存储可能在以后成为需求，则此功能的签名必须改变，从而影响其所有调用者。</p>
<p><code>Save</code> 测试起来也很麻烦，因为它直接操作磁盘上的文件。因此，为了验证其操作，测试时必须在写入文件后再读取该文件的内容。</p>
<p>而且我必须确保 <code>f</code> 被写入临时位置并且随后要将其删除。</p>
<p><code>*os.File</code> 还定义了许多与 <code>Save</code> 无关的方法，比如读取目录并检查路径是否是符号链接。 如果 <code>Save</code> 函数的签名只用 <code>*os.File</code> 的相关内容，那将会很有用。</p>
<p>我们能做什么 ？</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Save writes the contents of doc to the supplied</span></span><br><span class="line"><span class="comment">// ReadWriterCloser.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Save</span><span class="params">(rwc io.ReadWriteCloser, doc *Document)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
<p>使用 <code>io.ReadWriteCloser</code>，我们可以应用<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99">接口隔离原则</a>来重新定义 <code>Save</code> 以获取更通用文件形式。</p>
<p>通过此更改，任何实现 <code>io.ReadWriteCloser</code> 接口的类型都可以替换以前的 <code>*os.File</code>。</p>
<p>这使 <code>Save</code> 在其应用程序中更广泛，并向 <code>Save</code> 的调用者阐明 <code>*os.File</code> 类型的哪些方法与其操作有关。</p>
<p>而且，<code>Save</code> 的作者也不可以在 <code>*os.File</code> 上调用那些不相关的方法，因为它隐藏在 <code>io.ReadWriteCloser</code> 接口后面。</p>
<p>但我们可以进一步采用<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99">接口隔离原则</a>。</p>
<p>首先，如果 <code>Save</code> 遵循<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8D%95%E4%B8%80%E5%8A%9F%E8%83%BD%E5%8E%9F%E5%88%99">单一功能原则</a>，它不可能读取它刚刚写入的文件来验证其内容 - 这应该是另一段代码的功能。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Save writes the contents of doc to the supplied</span></span><br><span class="line"><span class="comment">// WriteCloser.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Save</span><span class="params">(wc io.WriteCloser, doc *Document)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
<p>因此，我们可以将我们传递给 <code>Save</code> 的接口的规范缩小到只写和关闭。</p>
<p>其次，通过向 <code>Save</code> 提供一个关闭其流的机制，使其看起来仍然像一个文件，这就提出了在什么情况下关闭 <code>wc</code> 的问题。</p>
<p>可能 <code>Save</code> 会无条件地调用 <code>Close</code>，或者在成功的情况下调用 <code>Close</code>。</p>
<p>这给 <code>Save</code> 的调用者带来了问题，因为它可能希望在写入文档后将其他数据写入流。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Save writes the contents of doc to the supplied</span></span><br><span class="line"><span class="comment">// Writer.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Save</span><span class="params">(w io.Writer, doc *Document)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
<p>一个更好的解决方案是重新定义 <code>Save</code> 仅使用 <code>io.Writer</code>，它只负责将数据写入流。</p>
<p>将<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99">接口隔离原则</a>应用于我们的 <code>Save</code> 功能，同时, 就需求而言, 得出了最具体的一个函数 - 它只需要一个可写的东西 - 并且它的功能最通用，现在我们可以使用 <code>Save</code> 将我们的数据保存到实现 <code>io.Writer</code> 的任何事物中。</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0aebd9618300">[译注: 不理解设计原则部分的同学可以阅读 Dave 大神的另一篇《Go 语言 SOLID 设计》]</a></p>
<h3 id="7-错误处理"><a href="#7-错误处理" class="headerlink" title="7. 错误处理"></a>7. 错误处理</h3><p>我已经给出了几个关于错误处理的演示文稿<a target="_blank" rel="noopener" href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">[8]</a>，并在我的博客上写了很多关于错误处理的文章。我在昨天的会议上也讲了很多关于错误处理的内容，所以在这里不再赘述。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://dave.cheney.net/2014/12/24/inspecting-errors">https://dave.cheney.net/2014/12/24/inspecting-errors</a></li>
<li><a target="_blank" rel="noopener" href="https://dave.cheney.net/2016/04/07/constant-errors">https://dave.cheney.net/2016/04/07/constant-errors</a></li>
</ul>
<p>相反，我想介绍与错误处理相关的两个其他方面。</p>
<h4 id="7-1-通过消除错误来消除错误处理"><a href="#7-1-通过消除错误来消除错误处理" class="headerlink" title="7.1. 通过消除错误来消除错误处理"></a>7.1. 通过消除错误来消除错误处理</h4><p>如果你昨天在我的演讲中，我谈到了改进错误处理的提案。但是你知道有什么比改进错误处理的语法更好吗？那就是根本不需要处理错误。</p>
<blockquote>
<p>注意:<br>我不是说“删除你的错误处理”。我的建议是，修改你的代码，这样就不用处理错误了。</p>
</blockquote>
<p>本节从 John Ousterhout 最近的著作“软件设计哲学”<a target="_blank" rel="noopener" href="https://www.amazon.com/Philosophy-Software-Design-John-Ousterhout/dp/1732102201">[9]</a>中汲取灵感。该书的其中一章是“定义不存在的错误”。我们将尝试将此建议应用于 Go 语言。</p>
<h4 id="7-1-1-计算行数"><a href="#7-1-1-计算行数" class="headerlink" title="7.1.1. 计算行数"></a>7.1.1. 计算行数</h4><p>让我们编写一个函数来计算文件中的行数。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CountLines</span><span class="params">(r io.Reader)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		br    = bufio.NewReader(r)</span><br><span class="line">		lines <span class="keyword">int</span></span><br><span class="line">		err   error</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		_, err = br.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">		lines++</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != io.EOF &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> lines, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于我们遵循前面部分的建议，<code>CountLines</code> 需要一个 <code>io.Reader</code>，而不是一个 <code>*File</code>；它的任务是调用者为我们想要计算的内容提供 <code>io.Reader</code>。</p>
<p>我们构造一个 <code>bufio.Reader</code>，然后在一个循环中调用 <code>ReadString</code> 方法，递增计数器直到我们到达文件的末尾，然后我们返回读取的行数。</p>
<p>至少这是我们想要编写的代码，但是这个函数由于需要错误处理而变得更加复杂。 例如，有这样一个奇怪的结构:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_, err = br.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">lines++</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在检查错误之前增加了行数，这样做看起来很奇怪。</p>
<p>我们必须以这种方式编写它的原因是，如果在遇到换行符之前就读到文件结束，则 <code>ReadString</code> 将返回错误。如果文件中没有换行符，同样会出现这种情况。</p>
<p>为了解决这个问题，我们重新排列逻辑增来加行数，然后查看是否需要退出循环。</p>
<blockquote>
<p>注意:<br>这个逻辑仍然不完美，你能发现错误吗？</p>
</blockquote>
<p>但是我们还没有完成检查错误。当 <code>ReadString</code> 到达文件末尾时，预期它会返回 <code>io.EOF</code>。<code>ReadString</code> 需要某种方式在没有什么可读时来停止。因此，在我们将错误返回给 <code>CountLine</code> 的调用者之前，我们需要检查错误是否是 <code>io.EOF</code>，如果不是将其错误返回，否则我们返回 <code>nil</code> 说一切正常。</p>
<p>我认为这是 Russ Cox 观察到错误处理可能会模​​糊函数操作的一个很好的例子。我们来看一个改进的版本。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CountLines</span><span class="params">(r io.Reader)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	sc := bufio.NewScanner(r)</span><br><span class="line">	lines := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> sc.Scan() &#123;</span><br><span class="line">		lines++</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> lines, sc.Err()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个改进的版本从 <code>bufio.Reader</code> 切换到 <code>bufio.Scanner</code>。</p>
<p>在 <code>bufio.Scanner</code> 内部使用 <code>bufio.Reader</code>，但它添加了一个很好的抽象层，它有助于通过隐藏 <code>CountLines</code> 的操作来消除错误处理。</p>
<blockquote>
<p>注意:<br><code>bufio.Scanner</code> 可以扫描任何模式，但默认情况下它会查找换行符。</p>
</blockquote>
<p>如果扫描程序匹配了一行文本并且没有遇到错误，则 <code>sc.Scan()</code> 方法返回 <code>true</code> 。因此，只有当扫描仪的缓冲区中有一行文本时，才会调用 <code>for</code> 循环的主体。这意味着我们修改后的 <code>CountLines</code> 正确处理没有换行符的情况，并且还处理文件为空的情况。</p>
<p>其次，当 <code>sc.Scan</code> 在遇到错误时返回 <code>false</code>，我们的 <code>for</code> 循环将在到达文件结尾或遇到错误时退出。<code>bufio.Scanner</code> 类型会记住遇到的第一个错误，一旦我们使用 <code>sc.Err()</code> 方法退出循环，我们就可以获取该错误。</p>
<p>最后， <code>sc.Err()</code> 负责处理 <code>io.EOF</code> 并在达到文件末尾时将其转换为 <code>nil</code>，而不会遇到其他错误。</p>
<blockquote>
<p>贴士:<br>当遇到难以忍受的错误处理时，请尝试将某些操作提取到辅助程序类型中。</p>
</blockquote>
<h4 id="7-1-2-WriteResponse"><a href="#7-1-2-WriteResponse" class="headerlink" title="7.1.2. WriteResponse"></a>7.1.2. WriteResponse</h4><p>我的第二个例子受到了 <code>Errors are values</code> 博客文章<a target="_blank" rel="noopener" href="https://blog.golang.org/errors-are-values">[10]</a>的启发。</p>
<p>在本章前面我们已经看过处理打开、写入和关闭文件的示例。错误处理是存在的，但是接收范围内的，因为操作可以封装在诸如 <code>ioutil.ReadFile</code> 和 <code>ioutil.WriteFile</code> 之类的辅助程序中。但是，在处理底层网络协议时，有必要使用 <code>I/O</code> 原始的错误处理来直接构建响应，这样就可能会变得重复。看一下构建 <code>HTTP</code> 响应的 <code>HTTP</code> 服务器的这个片段。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Header <span class="keyword">struct</span> &#123;</span><br><span class="line">	Key, Value <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Status <span class="keyword">struct</span> &#123;</span><br><span class="line">	Code   <span class="keyword">int</span></span><br><span class="line">	Reason <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteResponse</span><span class="params">(w io.Writer, st Status, headers []Header, body io.Reader)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	_, err := fmt.Fprintf(w, <span class="string">&quot;HTTP/1.1 %d %s\r\n&quot;</span>, st.Code, st.Reason)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, h := <span class="keyword">range</span> headers &#123;</span><br><span class="line">		_, err := fmt.Fprintf(w, <span class="string">&quot;%s: %s\r\n&quot;</span>, h.Key, h.Value)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> _, err := fmt.Fprint(w, <span class="string">&quot;\r\n&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_, err = io.Copy(w, body)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，我们使用 <code>fmt.Fprintf</code> 构造状态码并检查错误。 然后对于每个标题，我们写入键值对，每次都检查错误。 最后，我们使用额外的 <code>\r\n</code> 终止标题部分，检查错误之后将响应主体复制到客户端。 最后，虽然我们不需要检查 <code>io.Copy</code> 中的错误，但我们需要将 <code>io.Copy</code> 返回的两个返回值形式转换为 <code>WriteResponse</code> 的单个返回值。</p>
<p>这里很多重复性的工作。 我们可以通过引入一个包装器类型 <code>errWriter</code> 来使其更容易。</p>
<p><code>errWriter</code> 实现 <code>io.Writer</code> 接口，因此可用于包装现有的 <code>io.Writer</code>。 <code>errWriter</code> 写入传递给其底层 <code>writer</code>，直到检测到错误。 从此时起，它会丢弃任何写入并返回先前的错误。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> errWriter <span class="keyword">struct</span> &#123;</span><br><span class="line">	io.Writer</span><br><span class="line">	err error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *errWriter)</span> <span class="title">Write</span><span class="params">(buf []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> e.err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, e.err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> n <span class="keyword">int</span></span><br><span class="line">	n, e.err = e.Writer.Write(buf)</span><br><span class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteResponse</span><span class="params">(w io.Writer, st Status, headers []Header, body io.Reader)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	ew := &amp;errWriter&#123;Writer: w&#125;</span><br><span class="line">	fmt.Fprintf(ew, <span class="string">&quot;HTTP/1.1 %d %s\r\n&quot;</span>, st.Code, st.Reason)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, h := <span class="keyword">range</span> headers &#123;</span><br><span class="line">		fmt.Fprintf(ew, <span class="string">&quot;%s: %s\r\n&quot;</span>, h.Key, h.Value)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Fprint(ew, <span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">	io.Copy(ew, body)</span><br><span class="line">	<span class="keyword">return</span> ew.err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 <code>errWriter</code> 应用于 <code>WriteResponse</code> 可以显着提高代码的清晰度。 每个操作不再需要自己做错误检查。 通过检查 <code>ew.err</code> 字段，将错误报告移动到函数末尾，从而避免转换从 <code>io.Copy</code> 的两个返回值。</p>
<h4 id="7-2-错误只处理一次"><a href="#7-2-错误只处理一次" class="headerlink" title="7.2. 错误只处理一次"></a>7.2. 错误只处理一次</h4><p>最后，我想提一下你应该只处理错误一次。 处理错误意味着检查错误值并做出单一决定。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WriteAll writes the contents of buf to the supplied writer.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteAll</span><span class="params">(w io.Writer, buf []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">        w.Write(buf)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你做出的决定少于一个，则忽略该错误。 正如我们在这里看到的那样， <code>w.WriteAll</code> 的错误被丢弃。</p>
<p>但是，针对单个错误做出多个决策也是有问题的。 以下是我经常遇到的代码。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteAll</span><span class="params">(w io.Writer, buf []<span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	_, err := w.Write(buf)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">&quot;unable to write:&quot;</span>, err) <span class="comment">// annotated error goes to log file</span></span><br><span class="line">		<span class="keyword">return</span> err                           <span class="comment">// unannotated error returned to caller</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在此示例中，如果在 <code>w.Write</code> 期间发生错误，则会写入日志文件，注明错误发生的文件与行数，并且错误也会返回给调用者，调用者可能会记录该错误并将其返回到上一级，一直回到程序的顶部。</p>
<p>调用者可能正在做同样的事情</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteConfig</span><span class="params">(w io.Writer, conf *Config)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	buf, err := json.Marshal(conf)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;could not marshal config: %v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := WriteAll(w, buf); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">&quot;could not write config: %v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此你在日志文件中得到一堆重复的内容，</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unable to write: io.EOF</span><br><span class="line">could not write config: io.EOF</span><br></pre></td></tr></table></figure>
<p>但在程序的顶部，虽然得到了原始错误，但没有相关内容。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">err := WriteConfig(f, &amp;conf)</span><br><span class="line">fmt.Println(err) <span class="comment">// io.EOF</span></span><br></pre></td></tr></table></figure>
<p>我想深入研究这一点，因为作为个人偏好, 我并没有看到 <code>logging</code> 和返回的问题。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteConfig</span><span class="params">(w io.Writer, conf *Config)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	buf, err := json.Marshal(conf)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;could not marshal config: %v&quot;</span>, err)</span><br><span class="line">		<span class="comment">// oops, forgot to return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := WriteAll(w, buf); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">&quot;could not write config: %v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很多问题是程序员忘记从错误中返回。正如我们之前谈到的那样，Go 语言风格是使用  <code>guard clauses</code>  以及检查前提条件作为函数进展并提前返回。</p>
<p>在这个例子中，作者检查了错误，记录了它，但忘了返回。这就引起了一个微妙的错误。</p>
<p>Go 语言中的错误处理规定，如果出现错误，你不能对其他返回值的内容做出任何假设。由于 <code>JSON</code> 解析失败，<code>buf</code> 的内容未知，可能它什么都没有，但更糟的是它可能包含解析的 <code>JSON</code> 片段部分。</p>
<p>由于程序员在检查并记录错误后忘记返回，因此损坏的缓冲区将传递给 <code>WriteAll</code>，这可能会成功，因此配置文件将被错误地写入。但是，该函数会正常返回，并且发生问题的唯一日志行是有关 <code>JSON</code> 解析错误，而与写入配置失败有关。</p>
<h4 id="7-2-1-为错误添加相关内容"><a href="#7-2-1-为错误添加相关内容" class="headerlink" title="7.2.1. 为错误添加相关内容"></a>7.2.1. 为错误添加相关内容</h4><p>发生错误的原因是作者试图在错误消息中添加 <code>context</code> 。 他们试图给自己留下一些线索，指出错误的根源。</p>
<p>让我们看看使用 <code>fmt.Errorf</code> 的另一种方式。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteConfig</span><span class="params">(w io.Writer, conf *Config)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	buf, err := json.Marshal(conf)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;could not marshal config: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := WriteAll(w, buf); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;could not write config: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteAll</span><span class="params">(w io.Writer, buf []<span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	_, err := w.Write(buf)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;write failed: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过将注释与返回的错误组合起来，就更难以忘记错误的返回来避免意外继续。</p>
<p>如果写入文件时发生 <code>I/O</code> 错误，则 <code>error</code> 的 <code>Error()</code> 方法会报告以下类似的内容;</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">could not write config: write failed: input/output error</span><br></pre></td></tr></table></figure>

<h4 id="7-2-2-使用-github-com-pkg-errors-包装-errors"><a href="#7-2-2-使用-github-com-pkg-errors-包装-errors" class="headerlink" title="7.2.2. 使用 github.com/pkg/errors 包装 errors"></a>7.2.2. 使用 <code>github.com/pkg/errors</code> 包装 <code>errors</code></h4><p><code>fmt.Errorf</code> 模式适用于注释错误 <code>message</code>，但这样做的代价是模糊了原始错误的类型。 我认为将错误视为不透明值对于松散耦合的软件非常重要，因此如果你使用错误值做的唯一事情是原始错误的类型应该无关紧要的面孔</p>
<ol>
<li>检查它是否为 <code>nil</code>。</li>
<li>输出或记录它。</li>
</ol>
<p>但是在某些情况下，我认为它们并不常见，您需要恢复原始错误。 在这种情况下，使用类似我的 <code>errors</code> 包来注释这样的错误, 如下</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFile</span><span class="params">(path <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">	f, err := os.Open(path)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">&quot;open failed&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">	buf, err := ioutil.ReadAll(f)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">&quot;read failed&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> buf, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadConfig</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">	home := os.Getenv(<span class="string">&quot;HOME&quot;</span>)</span><br><span class="line">	config, err := ReadFile(filepath.Join(home, <span class="string">&quot;.settings.xml&quot;</span>))</span><br><span class="line">	<span class="keyword">return</span> config, errors.WithMessage(err, <span class="string">&quot;could not read config&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	_, err := ReadConfig()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在报告的错误就是 <code>K＆D</code> <a target="_blank" rel="noopener" href="http://www.gopl.io/">[11]</a>样式错误，</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">could not read config: open failed: open /Users/dfc/.settings.xml: no such file or directory</span><br></pre></td></tr></table></figure>
<p>并且错误值保留对原始原因的引用。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	_, err := ReadConfig()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;original error: %T %v\n&quot;</span>, errors.Cause(err), errors.Cause(err))</span><br><span class="line">		fmt.Printf(<span class="string">&quot;stack trace:\n%+v\n&quot;</span>, err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，你可以恢复原始错误并打印堆栈跟踪;</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">original error: *os.PathError open /Users/dfc/.settings.xml: no such file or directory</span><br><span class="line">stack trace:</span><br><span class="line">open /Users/dfc/.settings.xml: no such file or directory</span><br><span class="line">open failed</span><br><span class="line">main.ReadFile</span><br><span class="line">        /Users/dfc/devel/practical-<span class="keyword">go</span>/src/errors/readfile2.<span class="keyword">go</span>:<span class="number">16</span></span><br><span class="line">main.ReadConfig</span><br><span class="line">        /Users/dfc/devel/practical-<span class="keyword">go</span>/src/errors/readfile2.<span class="keyword">go</span>:<span class="number">29</span></span><br><span class="line">main.main</span><br><span class="line">        /Users/dfc/devel/practical-<span class="keyword">go</span>/src/errors/readfile2.<span class="keyword">go</span>:<span class="number">35</span></span><br><span class="line">runtime.main</span><br><span class="line">        /Users/dfc/<span class="keyword">go</span>/src/runtime/proc.<span class="keyword">go</span>:<span class="number">201</span></span><br><span class="line">runtime.goexit</span><br><span class="line">        /Users/dfc/<span class="keyword">go</span>/src/runtime/asm_amd64.s:<span class="number">1333</span></span><br><span class="line">could not read config</span><br></pre></td></tr></table></figure>
<p>使用 <code>errors</code> 包，你可以以人和机器都可检查的方式向错误值添加上下文。 如果昨天你来听我的演讲，你会知道这个库在被移植到即将发布的 Go 语言版本的标准库中。</p>
<h3 id="8-并发"><a href="#8-并发" class="headerlink" title="8. 并发"></a>8. 并发</h3><p>由于 Go 语言的并发功能，经常被选作项目编程语言。 Go 语言团队已经竭尽全力以廉价（在硬件资源方面）和高性能来实现并发，但是 Go 语言的并发功能也可以被用来编写性能不高同时也不太可靠的代码。在结尾，我想留下一些建议，以避免 Go 语言的并发功能带来的一些陷阱。</p>
<p>Go 语言以 <code>channels</code> 以及 <code>select</code> 和 <code>go</code> 语句来支持并发。如果你已经从书籍或培训课程中正式学习了 Go 语言，你可能已经注意到并发部分始终是这些课程的最后一部分。这个研讨会也没有什么不同，我选择最后覆盖并发，好像它是 Go 程序员应该掌握的常规技能的额外补充。</p>
<p>这里有一个二分法; Go 语言的最大特点是简单、轻量级的并发模型。作为一种产品，我们的语言几乎只推广这个功能。另一方面，有一种说法认为并发使用起来实际上并不容易，否则作者不会把它作为他们书中的最后一章，我们也不会遗憾地来回顾其形成过程。</p>
<p>本节讨论了 Go 语言的并发功能的“坑”。</p>
<h4 id="8-1-保持自己忙碌或做自己的工作"><a href="#8-1-保持自己忙碌或做自己的工作" class="headerlink" title="8.1. 保持自己忙碌或做自己的工作"></a>8.1. 保持自己忙碌或做自己的工作</h4><p>这个程序有什么问题？</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(w, <span class="string">&quot;Hello, GopherCon SG&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该程序实现了我们的预期，它提供简单的 Web 服务。 然而，它同时也做了其他事情，它在无限循环中浪费 CPU 资源。 这是因为 <code>main</code> 的最后一行上的 <code>for &#123;&#125;</code> 将阻塞 <code>main goroutine</code>，因为它不执行任何 IO、等待锁定、发送或接收通道数据或以其他方式与调度器通信。</p>
<p>由于 Go 语言运行时主要是协同调度，该程序将在单个 CPU 上做无效地旋转，并可能最终实时锁定。</p>
<p>我们如何解决这个问题？ 这是一个建议。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;runtime&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(w, <span class="string">&quot;Hello, GopherCon SG&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		runtime.Gosched()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这看起来很愚蠢，但这是我看过的一种常见解决方案。 这是不了解潜在问题的症状。</p>
<p>现在，如果你有更多的经验，你可能会写这样的东西。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(w, <span class="string">&quot;Hello, GopherCon SG&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>空的 <code>select</code> 语句将永远阻塞。 这是一个有用的属性，因为现在我们不再调用 <code>runtime.GoSched()</code> 而耗费整个 CPU。 但是这也只是治疗了症状，而不是病根。</p>
<p>我想向你提出另一种你可能在用的解决方案。 与其在 <code>goroutine</code> 中运行 <code>http.ListenAndServe</code>，会给我们留下处理 <code>main goroutine</code> 的问题，不如在 <code>main goroutine</code> 本身上运行 <code>http.ListenAndServe</code>。</p>
<blockquote>
<p>贴士:<br>如果 Go 语言程序的 <code>main.main</code> 函数返回，无论程序在一段时间内启动的其他 <code>goroutine</code> 在做什么, Go 语言程序会无条件地退出。</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(w, <span class="string">&quot;Hello, GopherCon SG&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以这是我的第一条建议：如果你的 <code>goroutine</code> 在得到另一个结果之前无法取得进展，那么让自己完成此工作而不是委托给其他 <code>goroutine</code> 会更简单。</p>
<p>这通常会消除将结果从 <code>goroutine</code> 返回到其启动程序所需的大量状态跟踪和通道操作。</p>
<blockquote>
<p>贴士:<br>许多 Go 程序员过度使用 <code>goroutine</code>，特别是刚开始时。与生活中的所有事情一样，适度是成功的关键。</p>
</blockquote>
<h4 id="8-2-将并发性留给调用者"><a href="#8-2-将并发性留给调用者" class="headerlink" title="8.2. 将并发性留给调用者"></a>8.2. 将并发性留给调用者</h4><p>以下两个 API 有什么区别？</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ListDirectory returns the contents of dir.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListDirectory</span><span class="params">(dir <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">string</span>, error)</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ListDirectory returns a channel over which</span></span><br><span class="line"><span class="comment">// directory entries will be published. When the list</span></span><br><span class="line"><span class="comment">// of entries is exhausted, the channel will be closed.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListDirectory</span><span class="params">(dir <span class="keyword">string</span>)</span> <span class="title">chan</span> <span class="title">string</span></span></span><br></pre></td></tr></table></figure>
<p>首先，最明显的不同: 第一个示例将目录读入切片然后返回整个切片，如果出错则返回错误。这是同步发生的，<code>ListDirectory</code> 的调用者会阻塞，直到读取了所有目录条目。根据目录的大小，这可能需要很长时间，并且可能会分配大量内存来构建目录条目。</p>
<p>让我们看看第二个例子。 这个示例更像是 Go 语言风格，<code>ListDirectory</code> 返回一个通道，通过该通道传递目录条目。当通道关闭时，表明没有更多目录条目。由于在 <code>ListDirectory</code> 返回后发生了通道的填充，<code>ListDirectory</code> 可能会启动一个 <code>goroutine</code> 来填充通道。</p>
<blockquote>
<p>注意:<br>第二个版本实际上不必使用 Go 协程; 它可以分配一个足以保存所有目录条目而不阻塞的通道，填充通道，关闭它，然后将通道返回给调用者。但这样做不太现实，因为会消耗大量内存来缓冲通道中的所有结果。</p>
</blockquote>
<p>通道版本的 <code>ListDirectory</code> 还有两个问题：</p>
<ul>
<li>通过使用关闭通道作为没有其他项目要处理的信号，在中途遇到了错误时, <code>ListDirectory</code> 无法告诉调用者通过通道返回的项目集是否完整。调用者无法区分空目录和读取目录的错误。两者都导致从 <code>ListDirectory</code> 返回的通道立即关闭。</li>
<li>调用者必须持续从通道中读取，直到它被关闭，因为这是调用者知道此通道的是否停止的唯一方式。这是对 <code>ListDirectory</code> 使用的严重限制，即使可能已经收到了它想要的答案，调用者也必须花时间从通道中读取。就中型到大型目录的内存使用而言，它可能更有效，但这种方法并不比原始的基于切片的方法快。</li>
</ul>
<p>以上两种实现所带来的问题的解决方案是使用回调，该回调是在执行时在每个目录条目的上下文中调用函数。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListDirectory</span><span class="params">(dir <span class="keyword">string</span>, fn <span class="keyword">func</span>(<span class="keyword">string</span>)</span>)</span></span><br></pre></td></tr></table></figure>
<p>毫不奇怪，这就是 <code>filepath.WalkDir</code> 函数的工作方式。</p>
<blockquote>
<p>贴士:<br>如果你的函数启动了 <code>goroutine</code>，你必须为调用者提供一种明确停止 <code>goroutine</code> 的方法。 把异步执行函数的决定留给该函数的调用者通常会更容易些。</p>
</blockquote>
<h4 id="8-3-永远不要启动一个停止不了的-goroutine。"><a href="#8-3-永远不要启动一个停止不了的-goroutine。" class="headerlink" title="8.3. 永远不要启动一个停止不了的 goroutine。"></a>8.3. 永远不要启动一个停止不了的 goroutine。</h4><p>前面的例子显示当一个任务时没有必要时使用 <code>goroutine</code>。但使用 Go 语言的原因之一是该语言提供的并发功能。实际上，很多情况下你希望利用硬件中可用的并行性。为此，你必须使用 <code>goroutines</code>。</p>
<p>这个简单的应用程序在两个不同的端口上提供 <code>http</code> 服务，端口 <code>8080</code> 用于应用程序服务，端口 <code>8001</code> 用于访问 <code>/debug/pprof</code> 终端。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	_ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mux := http.NewServeMux()</span><br><span class="line">	mux.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(resp http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(resp, <span class="string">&quot;Hello, QCon!&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">go</span> http.ListenAndServe(<span class="string">&quot;127.0.0.1:8001&quot;</span>, http.DefaultServeMux) <span class="comment">// debug</span></span><br><span class="line">	http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, mux)                       <span class="comment">// app traffic</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然这个程序不是很复杂，但它代表了真实应用程序的基础。</p>
<p>该应用程序存在一些问题，因为它随着应用程序的增长而显露出来，所以我们现在来解决其中的一些问题。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serveApp</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mux := http.NewServeMux()</span><br><span class="line">	mux.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(resp http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(resp, <span class="string">&quot;Hello, QCon!&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, mux)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serveDebug</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.ListenAndServe(<span class="string">&quot;127.0.0.1:8001&quot;</span>, http.DefaultServeMux)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> serveDebug()</span><br><span class="line">	serveApp()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过将 <code>serveApp</code> 和 <code>serveDebug</code> 处理程序分解成为它们自己的函数，我们将它们与 <code>main.main</code> 分离。 也遵循了上面的建议，并确保 <code>serveApp</code> 和 <code>serveDebug</code> 将它们的并发性留给调用者。</p>
<p>但是这个程序存在一些可操作性问题。 如果 <code>serveApp</code> 返回，那么 <code>main.main</code> 将返回，导致程序关闭并由你使用的进程管理器来重新启动。</p>
<blockquote>
<p>贴士:<br>正如 Go 语言中的函数将并发性留给调用者一样，应用程序应该将监视其状态和检测是否重启的工作留给另外的程序来做。 不要让你的应用程序负责重新启动自己，最好从应用程序外部处理该过程。</p>
</blockquote>
<p>然而，<code>serveDebug</code> 是在一个单独的 <code>goroutine</code> 中运行的，返回后该 <code>goroutine</code> 将退出，而程序的其余部分继续。 由于 <code>/debug</code> 处理程序已停止工作很久，因此操作人员不会很高兴发现他们无法在你的应用程序中获取统计信息。</p>
<p>我们想要确保的是，如果任何负责提供此应用程序的 <code>goroutine</code> 停止，我们将关闭该应用程序。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serveApp</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mux := http.NewServeMux()</span><br><span class="line">	mux.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(resp http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(resp, <span class="string">&quot;Hello, QCon!&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, mux); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serveDebug</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;127.0.0.1:8001&quot;</span>, http.DefaultServeMux); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> serveDebug()</span><br><span class="line">	<span class="keyword">go</span> serveApp()</span><br><span class="line">	<span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在 <code>serverApp</code> 和 <code>serveDebug</code> 检查从 <code>ListenAndServe</code> 返回的错误，并在需要时调用 <code>log.Fatal</code>。因为两个处理程序都在 <code>goroutine</code> 中运行，所以我们将 <code>main goroutine</code> 停在 <code>select&#123;&#125;</code> 中。</p>
<p>这种方法存在许多问题：</p>
<ol>
<li>如果 <code>ListenAndServer</code> 返回 <code>nil</code> 错误，则不会调用 <code>log.Fatal</code>，并且该端口上的 HTTP 服务将在不停止应用程序的情况下关闭。</li>
<li><code>log.Fatal</code> 调用 <code>os.Exit</code>，它将无条件地退出程序; <code>defer</code> 不会被调用，其他 <code>goroutines</code> 也不会被通知关闭，程序就停止了。 这使得编写这些函数的测试变得困难。</li>
</ol>
<blockquote>
<p>贴士:<br>只在 <code>main.main</code> 或 <code>init</code> 函数中的使用 <code>log.Fatal</code>。</p>
</blockquote>
<p>我们真正想要的是任何错误发送回 <code>goroutine</code> 的调用者，以便它可以知道 <code>goroutine</code> 停止的原因，可以干净地关闭程序进程。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serveApp</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	mux := http.NewServeMux()</span><br><span class="line">	mux.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(resp http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(resp, <span class="string">&quot;Hello, QCon!&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, mux)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serveDebug</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> http.ListenAndServe(<span class="string">&quot;127.0.0.1:8001&quot;</span>, http.DefaultServeMux)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	done := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">2</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		done &lt;- serveDebug()</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		done &lt;- serveApp()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">cap</span>(done); i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> err := &lt;-done; err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;error: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以使用通道来收集 <code>goroutine</code> 的返回状态。通道的大小等于我们想要管理的 <code>goroutine</code> 的数量，这样发送到 <code>done</code> 通道就不会阻塞，因为这会阻止 <code>goroutine</code> 的关闭，导致它泄漏。</p>
<p>由于没有办法安全地关闭 <code>done</code> 通道，我们不能使用 <code>for range</code> 来循环通道直到获取所有 <code>goroutine</code> 发来的报告，而是循环我们开启的多个 <code>goroutine</code>，即通道的容量。</p>
<p>现在我们有办法等待每个 <code>goroutine</code> 干净地退出并记录他们遇到的错误。所需要的只是一种从第一个 <code>goroutine</code> 转发关闭信号到其他 <code>goroutine</code> 的方法。</p>
<p>事实证明，要求 <code>http.Server</code> 关闭是有点牵扯的，所以我将这个逻辑转给辅助函数。<code>serve</code> 助手使用一个地址和 <code>http.Handler</code>，类似于 <code>http.ListenAndServe</code>，还有一个 <code>stop</code> 通道，我们用它来触发 <code>Shutdown</code> 方法。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serve</span><span class="params">(addr <span class="keyword">string</span>, handler http.Handler, stop &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	s := http.Server&#123;</span><br><span class="line">		Addr:    addr,</span><br><span class="line">		Handler: handler,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		&lt;-stop <span class="comment">// wait for stop signal</span></span><br><span class="line">		s.Shutdown(context.Background())</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s.ListenAndServe()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serveApp</span><span class="params">(stop &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	mux := http.NewServeMux()</span><br><span class="line">	mux.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(resp http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(resp, <span class="string">&quot;Hello, QCon!&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> serve(<span class="string">&quot;0.0.0.0:8080&quot;</span>, mux, stop)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serveDebug</span><span class="params">(stop &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> serve(<span class="string">&quot;127.0.0.1:8001&quot;</span>, http.DefaultServeMux, stop)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	done := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">2</span>)</span><br><span class="line">	stop := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		done &lt;- serveDebug(stop)</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		done &lt;- serveApp(stop)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> stopped <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">cap</span>(done); i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> err := &lt;-done; err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;error: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !stopped &#123;</span><br><span class="line">			stopped = <span class="literal">true</span></span><br><span class="line">			<span class="built_in">close</span>(stop)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，每次我们在 <code>done</code> 通道上收到一个值时，我们关闭 <code>stop</code> 通道，这会导致在该通道上等待的所有 <code>goroutine</code> 关闭其 <code>http.Server</code>。 这反过来将导致其余所有的 <code>ListenAndServe</code> <code>goroutines</code> 返回。 一旦我们开启的所有 <code>goroutine</code> 都停止了，<code>main.main</code> 就会返回并且进程会干净地停止。</p>
<blockquote>
<p>贴士:<br>自己编写这种逻辑是重复而微妙的。 参考下这个包: <a target="_blank" rel="noopener" href="https://github.com/heptio/workgroup">https://github.com/heptio/workgroup</a>，它会为你完成大部分工作。</p>
</blockquote>
<hr>
<blockquote>
<p>**引用: **</p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_1">1</a>. <a target="_blank" rel="noopener" href="https://gaston.life/books/effective-programming/">https://gaston.life/books/effective-programming/</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_2">2</a>. <a target="_blank" rel="noopener" href="https://talks.golang.org/2014/names.slide#4">https://talks.golang.org/2014/names.slide#4</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_3">3</a>. <a target="_blank" rel="noopener" href="https://www.infoq.com/articles/API-Design-Joshua-Bloch">https://www.infoq.com/articles/API-Design-Joshua-Bloch</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_1">1</a>. <a target="_blank" rel="noopener" href="https://www.lysator.liu.se/c/pikestyle.html">https://www.lysator.liu.se/c/pikestyle.html</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_2">2</a>. <a target="_blank" rel="noopener" href="https://speakerdeck.com/campoy/understanding-nil">https://speakerdeck.com/campoy/understanding-nil</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_3">3</a>. <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Ic2y6w8lMPA">https://www.youtube.com/watch?v=Ic2y6w8lMPA</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_4">4</a>. <a target="_blank" rel="noopener" href="https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88">https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_5">5</a>. <a target="_blank" rel="noopener" href="https://golang.org/doc/go1.4#internalpackages">https://golang.org/doc/go1.4#internalpackages</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_6">6</a>. <a target="_blank" rel="noopener" href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis">https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_7">7</a>. <a target="_blank" rel="noopener" href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html">https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_8">8</a>. <a target="_blank" rel="noopener" href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_9">9</a>. <a target="_blank" rel="noopener" href="https://www.amazon.com/Philosophy-Software-Design-John-Ousterhout/dp/1732102201">https://www.amazon.com/Philosophy-Software-Design-John-Ousterhout/dp/1732102201</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_10">10</a>. <a target="_blank" rel="noopener" href="https://blog.golang.org/errors-are-values">https://blog.golang.org/errors-are-values</a></p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_11">11</a>. <a target="_blank" rel="noopener" href="http://www.gopl.io/">http://www.gopl.io/</a></p>
</blockquote>
<hr>
<p><strong>原文链接：</strong><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html">Practical Go: Real world advice for writing maintainable Go programs</a></p>
<ul>
<li><em>如有翻译有误或者不理解的地方，请评论指正</em></li>
<li><em>待更新的译注之后会做进一步修改翻译</em></li>
<li><em>翻译：<a target="_blank" rel="noopener" href="https://github.com/llitfkitfk">田浩</a></em></li>
<li><em>邮箱：<a href="mailto:&#108;&#x6c;&#x69;&#x74;&#x66;&#107;&#x69;&#116;&#x66;&#107;&#64;&#103;&#109;&#97;&#105;&#x6c;&#46;&#x63;&#111;&#x6d;">&#108;&#x6c;&#x69;&#x74;&#x66;&#107;&#x69;&#116;&#x66;&#107;&#64;&#103;&#109;&#97;&#105;&#x6c;&#46;&#x63;&#111;&#x6d;</a></em></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-22T12:32:02.000Z" title="7/22/2019, 12:32:02 PM">2019-07-22</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约202个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/22/HexoClient1-2-9%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/">HexoClient1.2.9版本发布</a></h1><div class="content"><h2 id="本次更新内容"><a href="#本次更新内容" class="headerlink" title="本次更新内容"></a>本次更新内容</h2><ul>
<li>支持草稿功能</li>
<li>支持检查更新功能</li>
<li>修复创建文章时<code>ctrl+s</code>多次保存会生成多篇文章的问题</li>
<li>修复选中分类、标签展示之后从其他页面切换回来选中状态丢失的问题</li>
</ul>
<h2 id="功能预览"><a href="#功能预览" class="headerlink" title="功能预览"></a>功能预览</h2><p><img src="http://file.mspring.org/images/blog/FpVFNRfqb1r8SL8WmWPwrZwNqE2M" alt="QQ20190124111534.png"></p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>下载地址：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.9">https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.9</a></li>
<li>使用帮助：<a href="https://www.mspring.org/2018/11/29/HexoClient%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/">https://www.mspring.org/2018/11/29/HexoClient%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/</a></li>
<li>提交问题：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/new">https://github.com/gaoyoubo/hexo-client/issues/new</a></li>
<li>Github: <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client">https://github.com/gaoyoubo/hexo-client</a></li>
<li>Gitee: <a target="_blank" rel="noopener" href="https://gitee.com/gaoyoubo/hexo-client">https://gitee.com/gaoyoubo/hexo-client</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-19T14:47:44.000Z" title="7/19/2019, 2:47:44 PM">2019-07-19</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">8 分钟读完 (大约1241个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/19/%E5%8D%8F%E5%90%8C%E8%BF%87%E6%BB%A4%E5%92%8C%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AE%B9%E6%8E%A8%E8%8D%90%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F/">协同过滤和基于内容推荐有什么区别？</a></h1><div class="content"><h2 id="根据数据源的不同推荐引擎可以分为三类"><a href="#根据数据源的不同推荐引擎可以分为三类" class="headerlink" title="根据数据源的不同推荐引擎可以分为三类"></a>根据数据源的不同推荐引擎可以分为三类</h2><p>1、基于人口的统计学推荐(Demographic-based Recommendation)</p>
<p>2、基于内容的推荐(Content-based Recommendation)</p>
<p>3、基于协同过滤的推荐(Collaborative Filtering-based Recommendation)</p>
<h2 id="基于内容的推荐："><a href="#基于内容的推荐：" class="headerlink" title="基于内容的推荐："></a>基于内容的推荐：</h2><p>根据物品或内容的元数据，发现物品或内容的相关性，然后基于用户以前的喜好记录推荐给用户相似的物品，如图所示：<br><img src="/images/2019/07/19/8b119020-a9f0-11e9-ab4b-e97b4c79a69c.png" alt="image.png"><br>上图给出了基于内容推荐的一个典型的例子，电影推荐系统，首先我们需要对电影的元数据有一个建模，这里只简单的描述了一下电影的类型；然后通过电影的元数据发现电影间的相似度，因为类型都是“爱情，浪漫”电影 A 和 C 被认为是相似的电影（当然，只根据类型是不够的，要得到更好的推荐，我们还可以考虑电影的导演，演员等等）；最后实现推荐，对于用户 A，他喜欢看电影 A，那么系统就可以给他推荐类似的电影 C。</p>
<h2 id="而基于协同过滤推荐又分为以下三类："><a href="#而基于协同过滤推荐又分为以下三类：" class="headerlink" title="而基于协同过滤推荐又分为以下三类："></a>而基于协同过滤推荐又分为以下三类：</h2><p>(1)基于用户的协同过滤推荐(User-based Collaborative Filtering Recommendation)</p>
<p>基于用户的协同过滤推荐算法先使用统计技术寻找与目标用户有相同喜好的邻居，然后根据目标用户的邻居的喜好产生向目标用户的推荐。基本原理就是利用用户访问行为的相似性来互相推荐用户可能感兴趣的资源，如图所示：<br><img src="/images/2019/07/19/b1cf7880-a9f0-11e9-ab4b-e97b4c79a69c.png" alt="image.png"><br>上图示意出基于用户的协同过滤推荐机制的基本原理，假设用户 A 喜欢物品 A、物品 C，用户 B 喜欢物品 B，用户 C 喜欢物品 A 、物品 C 和物品 D；从这些用户的历史喜好信息中，我们可以发现用户 A 和用户 C 的口味和偏好是比较类似的，同时用户 C 还喜欢物品 D，那么我们可以推断用户 A 可能也喜欢物品 D，因此可以将物品 D 推荐给用户 A。</p>
<p>(2)基于项目的协同过滤推荐(Item-based Collaborative Filtering Recommendation)</p>
<p>根据所有用户对物品或者信息的评价，发现物品和物品之间的相似度，然后根据用户的历史偏好信息将类似的物品推荐给该用户，如图所示：<br><img src="/images/2019/07/19/d0cc83e0-a9f0-11e9-ab4b-e97b4c79a69c.png" alt="image.png"><br>上图表明基于项目的协同过滤推荐的基本原理，用户A喜欢物品A和物品C，用户B喜欢物品A、物品B和物品C，用户C喜欢物品A，从这些用户的历史喜好中可以认为物品A与物品C比较类似，喜欢物品A的都喜欢物品C，基于这个判断用户C可能也喜欢物品C，所以推荐系统将物品C推荐给用户C。</p>
<p>(3)基于模型的协同过滤推荐(Model-based Collaborative Filtering Recommendation)</p>
<p>基模型的协同过滤推荐就是基于样本的用户喜好信息，训练一个推荐模型，然后根据实时的用户喜好的信息进行预测推荐。</p>
<h2 id="综上所述："><a href="#综上所述：" class="headerlink" title="综上所述："></a>综上所述：</h2><p>基于内容的推荐只考虑了对象的本身性质，将对象按标签形成集合，如果你消费集合中的一个则向你推荐集合中的其他对象；</p>
<p>基于协同过滤的推荐算法，充分利用集体智慧，即在大量的人群的行为和数据中收集答案，以帮助我们对整个人群得到统计意义上的结论，推荐的个性化程度高，基于以下两个出发点：(1)兴趣相近的用户可能会对同样的东西感兴趣；(2)用户可能较偏爱与其已购买的东西相类似的商品。也就是说考虑进了用户的历史习惯，对象客观上不一定相似，但由于人的行为可以认为其主观上是相似的，就可以产生推荐了。</p>
<p>以上答案只是参考IBM官网资料<a href="https://link.zhihu.com/?target=http://www.ibm.com/developerworks/cn/web/1103_zhaoct_recommstudy1/index.html">探索推荐引擎内部的秘密，第 1 部分: 推荐引擎初探</a>，然后结合其他资料理解总结的，如有更好意见谢谢分享。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-16T19:18:06.000Z" title="7/16/2019, 7:18:06 PM">2019-07-16</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约203个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/16/HexoClient-1-2-8%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/">HexoClient 1.2.8版本发布</a></h1><div class="content"><h2 id="本次更新内容"><a href="#本次更新内容" class="headerlink" title="本次更新内容"></a>本次更新内容</h2><ul>
<li>feature：新增阿里云oss图床支持 <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/50">https://github.com/gaoyoubo/hexo-client/issues/50</a></li>
<li>feature：新增Google Analytics支持，只会搜集用户页面点击数据，请放心使用。代码更改详见：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/commit/2679449ab20fd04d094f238f0b6053bffdebdb3e">https://github.com/gaoyoubo/hexo-client/commit/2679449ab20fd04d094f238f0b6053bffdebdb3e</a></li>
</ul>
<h2 id="功能预览"><a href="#功能预览" class="headerlink" title="功能预览"></a>功能预览</h2><p><img src="http://file.mspring.org/images/blog/FpVFNRfqb1r8SL8WmWPwrZwNqE2M" alt="QQ20190124111534.png"></p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>下载地址：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.8">https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.8</a></li>
<li>使用帮助：<a href="https://www.mspring.org/2018/11/29/HexoClient%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/">https://www.mspring.org/2018/11/29/HexoClient%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/</a></li>
<li>提交问题：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/new">https://github.com/gaoyoubo/hexo-client/issues/new</a></li>
<li>Github: <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client">https://github.com/gaoyoubo/hexo-client</a></li>
<li>Gitee: <a target="_blank" rel="noopener" href="https://gitee.com/gaoyoubo/hexo-client">https://gitee.com/gaoyoubo/hexo-client</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-15T16:23:19.000Z" title="7/15/2019, 4:23:19 PM">2019-07-15</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">3 分钟读完 (大约504个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/15/Golang%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Golang并发编程</a></h1><div class="content"><p>Go语言的并发是基于 goroutine 的，goroutine 类似于线程，但并非线程。可以将 goroutine 理解为一种虚拟线程。Go语言运行时会参与调度 goroutine，并将 goroutine 合理地分配到每个 CPU 中，最大限度地使用CPU性能。</p>
<p>Go 程序从 main 包的 main() 函数开始，在程序启动时，Go 程序就会为 main() 函数创建一个默认的 goroutine。</p>
<p><img src="https://i.loli.net/2019/07/15/5d2c2e4fe2f4d88322.jpg"></p>
<p>下面我们来看一个例子，在线演示：<a target="_blank" rel="noopener" href="https://play.golang.org/p/U9U-qjuY0t1">https://play.golang.org/p/U9U-qjuY0t1</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建一个goroutine</span></span><br><span class="line">	<span class="keyword">go</span> runing()</span><br><span class="line">	<span class="comment">// 创建一个匿名的goroutine</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;喜特:&quot;</span> + time.Now().String())</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里sleep一下是因为main方法如果执行完了，main该程序创建的所有goroutine都会退出</span></span><br><span class="line">	time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runing</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;法克:&quot;</span> + time.Now().String())</span><br><span class="line">	time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">法克:<span class="number">2009</span><span class="number">-11</span><span class="number">-10</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">00</span> +<span class="number">0000</span> UTC m=+<span class="number">0.000000001</span></span><br><span class="line">喜特:<span class="number">2009</span><span class="number">-11</span><span class="number">-10</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">00</span> +<span class="number">0000</span> UTC m=+<span class="number">0.000000001</span></span><br></pre></td></tr></table></figure>

<p>执行结果说明fuck函数中的sleep三秒并没有影响<code>喜特</code>的输出。</p>
<p>如果说 goroutine 是Go语言程序的并发体的话，那么 channel 就是它们之间的通信机制。一个 channel 是一个通信机制，它可以让一个 goroutine 通过它给另一个 goroutine 发送值信息。每个 channel 都有一个特殊的类型，也就是 channel 可发送数据的类型。一个可以发送 int 类型数据的 channel 一般写为 chan int。</p>
<p>下面我们利用goroutine+channel来实现一个生产消费者模型，示例代码如下，在线执行：<a target="_blank" rel="noopener" href="https://play.golang.org/p/lqUBugLdU-I">https://play.golang.org/p/lqUBugLdU-I</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建一个通道</span></span><br><span class="line">	channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int64</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 异步去生产</span></span><br><span class="line">	<span class="keyword">go</span> producer(channel)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 数据消费</span></span><br><span class="line">	consumer(channel)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">producer</span><span class="params">(channel <span class="keyword">chan</span>&lt;- <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">// 将数据写入通道</span></span><br><span class="line">		channel &lt;- time.Now().Unix()</span><br><span class="line">		<span class="comment">// 睡1秒钟</span></span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consumer</span><span class="params">(channel &lt;-<span class="keyword">chan</span> <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		timestamp := &lt;-channel</span><br><span class="line">		fmt.Println(timestamp)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出为如下：(每秒钟打印一次)</span><br><span class="line"><span class="number">1257894000</span></span><br><span class="line"><span class="number">1257894001</span></span><br><span class="line"><span class="number">1257894002</span></span><br><span class="line"><span class="number">1257894003</span></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-15T16:22:22.000Z" title="7/15/2019, 4:22:22 PM">2019-07-15</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约234个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/15/Golang%E6%8C%87%E9%92%88%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%80%BC%E7%B1%BB%E5%9E%8B/">Golang指针类型和值类型</a></h1><div class="content"><p>Java中值类型和引用类型都是定死的，int、double、float、long、byte、short、char、boolean为值类型，其他的都是引用类型，而Go语言中却不是这样。</p>
<p>在Go语言中：</p>
<ul>
<li><code>&amp;</code>表示取地址，例如你有一个变量<code>a</code>那么<code>&amp;a</code>就是变量<code>a</code>在内存中的地址，对于Golang指针也是有类型的，比如a是一个string那么&amp;a是一个string的指针类型，在Go里面叫&amp;string。</li>
<li><code>*</code>表示取值，接上面的例子，假设你定义<code>b := &amp;a</code> 如果你打印<code>b</code>，那么输出的是<code>&amp;a</code>的内存地址，如果要取值，那么需要使用：<code>*b</code></li>
</ul>
<p>下面我们来看下例子，在线运行：<a target="_blank" rel="noopener" href="https://play.golang.org/p/jxAKyVMjnoy">https://play.golang.org/p/jxAKyVMjnoy</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	a := <span class="string">&quot;123&quot;</span></span><br><span class="line">	b := &amp;a</span><br><span class="line"></span><br><span class="line">	fmt.Println(a)</span><br><span class="line">	fmt.Println(b)</span><br><span class="line">	fmt.Println(*b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果为：</span><br><span class="line"><span class="number">123</span></span><br><span class="line"><span class="number">0x40c128</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-15T16:20:11.000Z" title="7/15/2019, 4:20:11 PM">2019-07-15</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">13 分钟读完 (大约1908个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/15/Java%E7%A8%8B%E5%BA%8F%E5%91%98Go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8%E7%AE%80%E4%BB%8B/">Java程序员Go语言入门简介</a></h1><div class="content"><h2 id="为什么是Go语言"><a href="#为什么是Go语言" class="headerlink" title="为什么是Go语言"></a>为什么是Go语言</h2><ul>
<li>类C的语法，这意味着Java、C#、JavaScript程序员能很快的上手</li>
<li>有自己的垃圾回收机制</li>
<li>跨平台、编译即可执行无需安装依赖环境</li>
<li>支持反射</li>
</ul>
<h2 id="Go语言简介"><a href="#Go语言简介" class="headerlink" title="Go语言简介"></a>Go语言简介</h2><p>Go 语言（或 Golang）起源于 2007 年，并在 2009 年正式对外发布。Go 是非常年轻的一门语言，它的主要目标是“兼具Python等动态语言的开发速度和 C/C++ 等编译型语言的性能与安全性”。</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><table>
<thead>
<tr>
<th>数据类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>bool</td>
<td>布尔</td>
</tr>
<tr>
<td>string</td>
<td>字符串</td>
</tr>
<tr>
<td>int</td>
<td>uint8,uint16,uint32,uint64,int8,int16,int32,int64</td>
</tr>
<tr>
<td>float</td>
<td>float32,float64</td>
</tr>
<tr>
<td>byte</td>
<td>byte</td>
</tr>
</tbody></table>
<p>参考：<a target="_blank" rel="noopener" href="https://www.runoob.com/go/go-data-types.html">https://www.runoob.com/go/go-data-types.html</a></p>
<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><h3 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h3><p>在线运行示例：<a target="_blank" rel="noopener" href="https://play.golang.org/p/-4RylAqUV36">https://play.golang.org/p/-4RylAqUV36</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> name <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">  name = <span class="string">&quot;world&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;hello &quot;</span> + name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来执行一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go run main.go <span class="comment"># main.go 为刚刚创建的那个文件的名称</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hello world</span></span><br></pre></td></tr></table></figure>

<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><h4 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h4><p>在线运行示例：<a target="_blank" rel="noopener" href="https://play.golang.org/p/zPqCkRZgrgp">https://play.golang.org/p/zPqCkRZgrgp</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> name <span class="keyword">string</span>   <span class="comment">// 声明</span></span><br><span class="line">	name = <span class="string">&quot;gaoyoubo&quot;</span> <span class="comment">// 赋值</span></span><br><span class="line">	fmt.Println(name)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> age <span class="keyword">int</span> = <span class="number">18</span> <span class="comment">// 声明并赋值</span></span><br><span class="line">	fmt.Println(age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="类型推断"><a href="#类型推断" class="headerlink" title="类型推断"></a>类型推断</h4><p>在线运行示例：<a target="_blank" rel="noopener" href="https://play.golang.org/p/0My8veBvtJ8">https://play.golang.org/p/0My8veBvtJ8</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	name := <span class="string">&quot;gaoyoubo&quot;</span></span><br><span class="line">	fmt.Println(name)</span><br><span class="line"></span><br><span class="line">	age := <span class="number">18</span></span><br><span class="line">	fmt.Println(age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><ul>
<li>函数可以有多个返回值</li>
<li>隐式的指定函数是private还是public，函数首字母大写的为public、小写的为private</li>
<li>没有类似Java中的<code>try cache</code>、<code>throw</code>，Go语言是通过将<code>error</code>作为返回值来处理异常。</li>
<li>不支持重载</li>
</ul>
<p>下面我们通过一个示例来了解一下，在线运行示例：<a target="_blank" rel="noopener" href="https://play.golang.org/p/PYy3ueuPFS6">https://play.golang.org/p/PYy3ueuPFS6</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log1()</span><br><span class="line"></span><br><span class="line">	log2(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line"></span><br><span class="line">	ret1 := add1(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">	fmt.Println(<span class="string">&quot;add1 result:&quot;</span> + strconv.Itoa(ret1))</span><br><span class="line"></span><br><span class="line">	ret2, err := Add2(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Add2 result:&quot;</span> + strconv.Itoa(ret2))</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Add2 error&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 私有、无入参、无返回值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">log1</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;execute func log1&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 私有、入参、无返回值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">log2</span><span class="params">(msg <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;execute func log2:&quot;</span> + msg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 私有、两个入参、一个返回值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add1</span><span class="params">(count1, count2 <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	total := count1 + count2</span><br><span class="line">	fmt.Println(<span class="string">&quot;execute func add3, result=&quot;</span> + strconv.Itoa(total))</span><br><span class="line">	<span class="keyword">return</span> total</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Public、两个入参、多个返回值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add2</span><span class="params">(count1, count2 <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> count1 &lt; <span class="number">1</span> || count2 &lt; <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;数量不能小于1&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	total := count1 + count2</span><br><span class="line">	<span class="keyword">return</span> total, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该示例输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">execute func log1</span><br><span class="line">execute func log2:hello world</span><br><span class="line">execute func add3, result&#x3D;2</span><br><span class="line">add1 result:2</span><br><span class="line">Add2 error 数量不能小于1</span><br></pre></td></tr></table></figure>

<p>但函数有多个返回值的时候，有时你只关注其中一个返回值，这种情况下你可以将其他的返回值赋值给空白符：<code>_</code>，如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_, err := Add2(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  fmt.Println(err)</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>

<p>空白符特殊在于实际上返回值并没有赋值，所以你可以随意将不同类型的值赋值给他，而不会由于类型不同而报错。</p>
<h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><p>Go语言不是像Java那样的面向对象的语言，他没有对象和继承的概念。也没有<code>class</code>的概念。在Go语言中有个概念叫做结构体（<code>struct</code>），结构体和Java中的<code>class</code>比较类似。下面我们定义一个结构体：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name   <span class="keyword">string</span></span><br><span class="line">	Gender <span class="keyword">string</span></span><br><span class="line">	Age    <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面我们定义了一个结构体<code>User</code>，并为该结构体分别设置了三个公有属性：Name/Gender/Age，下面我们来创建一个User对象。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user := User&#123;</span><br><span class="line">	Name:   <span class="string">&quot;hahaha&quot;</span>,</span><br><span class="line">	Gender: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">	Age:    <span class="number">18</span>, <span class="comment">// 值得一提的是，最后的逗号是必须的，否则编译器会报错，这就是go的设计哲学之一，要求强一致性。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结构体的属性可以在结构体内直接声明，那么如何为结构体声明函数（即Java中的方法）呢，我们来看下下面的示例：在线运行示例：<a target="_blank" rel="noopener" href="https://play.golang.org/p/01_cTu0RzdH">https://play.golang.org/p/01_cTu0RzdH</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name   <span class="keyword">string</span></span><br><span class="line">	Gender <span class="keyword">string</span></span><br><span class="line">	Age    <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义User的成员方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">addAge</span><span class="params">()</span></span> &#123;</span><br><span class="line">	u.Age = u.Age + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	user := User&#123;</span><br><span class="line">		Name:   <span class="string">&quot;哈&quot;</span>, <span class="comment">// 名称</span></span><br><span class="line">		Gender: <span class="string">&quot;男&quot;</span>, <span class="comment">// 性别</span></span><br><span class="line">		Age:    <span class="number">18</span>,  <span class="comment">// 值得一提的是，最后的逗号是必须的，否则编译器会报错，这就是go的设计哲学之一，要求强一致性。</span></span><br><span class="line">	&#125;</span><br><span class="line">	user.addAge()</span><br><span class="line">	fmt.Println(user.Age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="指针类型和值类型"><a href="#指针类型和值类型" class="headerlink" title="指针类型和值类型"></a>指针类型和值类型</h3><p>Java中值类型和引用类型都是定死的，int、double、float、long、byte、short、char、boolean为值类型，其他的都是引用类型，而Go语言中却不是这样。</p>
<p>在Go语言中：</p>
<ul>
<li><code>&amp;</code>表示取地址，例如你有一个变量<code>a</code>那么<code>&amp;a</code>就是变量<code>a</code>在内存中的地址，对于Golang指针也是有类型的，比如a是一个string那么&amp;a是一个string的指针类型，在Go里面叫&amp;string。</li>
<li><code>*</code>表示取值，接上面的例子，假设你定义<code>b := &amp;a</code> 如果你打印<code>b</code>，那么输出的是<code>&amp;a</code>的内存地址，如果要取值，那么需要使用：<code>*b</code></li>
</ul>
<p>下面我们来看下例子，在线运行：<a target="_blank" rel="noopener" href="https://play.golang.org/p/jxAKyVMjnoy">https://play.golang.org/p/jxAKyVMjnoy</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	a := <span class="string">&quot;123&quot;</span></span><br><span class="line">	b := &amp;a</span><br><span class="line"></span><br><span class="line">	fmt.Println(a)</span><br><span class="line">	fmt.Println(b)</span><br><span class="line">	fmt.Println(*b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果为：</span><br><span class="line"><span class="number">123</span></span><br><span class="line"><span class="number">0x40c128</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>

<h3 id="并发编程"><a href="#并发编程" class="headerlink" title="并发编程"></a>并发编程</h3><p>Go语言的并发是基于 goroutine 的，goroutine 类似于线程，但并非线程。可以将 goroutine 理解为一种虚拟线程。Go语言运行时会参与调度 goroutine，并将 goroutine 合理地分配到每个 CPU 中，最大限度地使用CPU性能。</p>
<p>Go 程序从 main 包的 main() 函数开始，在程序启动时，Go 程序就会为 main() 函数创建一个默认的 goroutine。</p>
<p><img src="/images/2019/07/15/55b6ace0-a6d9-11e9-8437-8fc3aa44f6bd.jpg"></p>
<p>下面我们来看一个例子（在线演示：<a target="_blank" rel="noopener" href="https://play.golang.org/p/U9U-qjuY0t1%EF%BC%89">https://play.golang.org/p/U9U-qjuY0t1）</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建一个goroutine</span></span><br><span class="line">	<span class="keyword">go</span> runing()</span><br><span class="line">	<span class="comment">// 创建一个匿名的goroutine</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;喜特:&quot;</span> + time.Now().String())</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里sleep一下是因为main方法如果执行完了，main该程序创建的所有goroutine都会退出</span></span><br><span class="line">	time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runing</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;法克:&quot;</span> + time.Now().String())</span><br><span class="line">	time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">法克:<span class="number">2009</span><span class="number">-11</span><span class="number">-10</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">00</span> +<span class="number">0000</span> UTC m=+<span class="number">0.000000001</span></span><br><span class="line">喜特:<span class="number">2009</span><span class="number">-11</span><span class="number">-10</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">00</span> +<span class="number">0000</span> UTC m=+<span class="number">0.000000001</span></span><br></pre></td></tr></table></figure>

<p>执行结果说明fuck函数中的sleep三秒并没有影响<code>喜特</code>的输出。</p>
<p>如果说 goroutine 是Go语言程序的并发体的话，那么 channel 就是它们之间的通信机制。一个 channel 是一个通信机制，它可以让一个 goroutine 通过它给另一个 goroutine 发送值信息。每个 channel 都有一个特殊的类型，也就是 channel 可发送数据的类型。一个可以发送 int 类型数据的 channel 一般写为 chan int。</p>
<p>下面我们利用goroutine+channel来实现一个生产消费者模型，示例代码如下：（在线执行：<a target="_blank" rel="noopener" href="https://play.golang.org/p/lqUBugLdU-I%EF%BC%89">https://play.golang.org/p/lqUBugLdU-I）</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建一个通道</span></span><br><span class="line">	channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int64</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 异步去生产</span></span><br><span class="line">	<span class="keyword">go</span> producer(channel)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 数据消费</span></span><br><span class="line">	consumer(channel)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">producer</span><span class="params">(channel <span class="keyword">chan</span>&lt;- <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">// 将数据写入通道</span></span><br><span class="line">		channel &lt;- time.Now().Unix()</span><br><span class="line">		<span class="comment">// 睡1秒钟</span></span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consumer</span><span class="params">(channel &lt;-<span class="keyword">chan</span> <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		timestamp := &lt;-channel</span><br><span class="line">		fmt.Println(timestamp)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出为如下：(每秒钟打印一次)</span><br><span class="line"><span class="number">1257894000</span></span><br><span class="line"><span class="number">1257894001</span></span><br><span class="line"><span class="number">1257894002</span></span><br><span class="line"><span class="number">1257894003</span></span><br></pre></td></tr></table></figure>


<h2 id="Java程序员觉得不好用的地方"><a href="#Java程序员觉得不好用的地方" class="headerlink" title="Java程序员觉得不好用的地方"></a>Java程序员觉得不好用的地方</h2><ul>
<li>异常处理</li>
<li>没有泛型</li>
<li>不支持多态、重载</li>
<li>不支持注解（但是他的struct中的属性支持<code>tag</code>）</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/go/go-tutorial.html">https://www.runoob.com/go/go-tutorial.html</a></li>
<li><a target="_blank" rel="noopener" href="https://books.studygolang.com/the-little-go-book_ZH_CN/">https://books.studygolang.com/the-little-go-book_ZH_CN/</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-02T13:23:45.000Z" title="7/2/2019, 1:23:45 PM">2019-07-02</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约84个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/02/Git%E5%88%A0%E9%99%A4%E8%BF%9C%E7%A8%8Btag/">Git删除远程tag</a></h1><div class="content"><p>删除本地tag很简单，直接：<code>git tag -d tagname</code> 但是我们这样删除之后远程标签其实并未删除，通过以下方式可以删除远程标签。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 假设标签名称为：v1.0.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除本地标签</span></span><br><span class="line">git tag -d v1.0.0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除远程标签</span></span><br><span class="line">git push origin :refs/tags/v1.0.0</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-06-24T11:00:49.000Z" title="6/24/2019, 11:00:49 AM">2019-06-24</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约302个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/06/24/%E5%A4%9A%E4%B8%AAGithub%E8%B4%A6%E5%8F%B7%E6%97%B6%EF%BC%8C%E6%80%8E%E4%B9%88%E9%85%8D%E7%BD%AEsshkey/">多个Github账号时，怎么配置sshkey</a></h1><div class="content"><p>我有两个Github账号，在配置sshkey的时候是会提示<code>Key is already in use</code>。因为github无法将相同的sshkey配置到不同的账号下，那么就要考虑同一台机器如何配置两个sshkey了。</p>
<h2 id="生成第二个sshkey"><a href="#生成第二个sshkey" class="headerlink" title="生成第二个sshkey"></a>生成第二个sshkey</h2><p>因为之前已经存在<code>~/.ssh/id_rsa</code>文件，所以这次生成的时候我们指定输出的文件名为<code>id_rsa2</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;example@example.com&quot; -f ~/.ssh/id_rsa2</span><br></pre></td></tr></table></figure>

<h2 id="创建config配置文件"><a href="#创建config配置文件" class="headerlink" title="创建config配置文件"></a>创建config配置文件</h2><p>在<code>~/.ssh/</code>目录下创建config配置文件，内容如下，里面有详细的解释。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 原有的配置</span><br><span class="line">Host github.com</span><br><span class="line">HostName github.com</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile ~&#x2F;.ssh&#x2F;id_rsa</span><br><span class="line"></span><br><span class="line"># 第二个配置</span><br><span class="line">Host github_2.com</span><br><span class="line">HostName github.com</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile ~&#x2F;.ssh&#x2F;id_rsa2  # 这里指定下所使用的公钥文件名，就是我们上一步新生成的那个。</span><br></pre></td></tr></table></figure>

<h2 id="使用第二个sshkey配置"><a href="#使用第二个sshkey配置" class="headerlink" title="使用第二个sshkey配置"></a>使用第二个sshkey配置</h2><p>假如我们的仓库地址为：<code>git@github.com:name/project.git</code> ，那么按照上面<code>config</code>文件中<code>Host</code>的配置，需要将仓库地址修改为：<code>git@github_2.com:name/project.git</code>，修改git沧湖远程url的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote set-url origin git@github_2.com:name/project.git</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-06-06T10:10:22.000Z" title="6/6/2019, 10:10:22 AM">2019-06-06</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约267个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/06/06/%E6%90%AD%E5%BB%BAShadowsocks-Server/">搭建Shadowsocks-Server</a></h1><div class="content"><p>之前一直使用的搬瓦工的vps搭建的shadowsocks，但是最近被封掉了。正好手里还有一台阿里云香港服务器，所以就自己搭建了一个，下面是搭建流程。</p>
<p>我是使用<code>shadowsocks-go</code>进行搭建的，是基于golang编写的，所以先需要安装golang环境，请自行安装。</p>
<p>shadowsocks-go项目地址：<a target="_blank" rel="noopener" href="https://github.com/shadowsocks/shadowsocks-go">https://github.com/shadowsocks/shadowsocks-go</a></p>
<p>安装方式：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get github.com/shadowsocks/shadowsocks-<span class="keyword">go</span>/cmd/shadowsocks-server</span><br></pre></td></tr></table></figure>

<p>安装完成之后请在：<code>$GOPATH/bin</code> 目录下找到：<code>shadowsocks-server</code> 文件。</p>
<p>然后在该文件同文件夹下创建配置文件：<code>config.json</code>，密码端口请自行修改，我们这里使用的服务端端口为：<code>8388</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;server&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;server_port&quot;</span>:<span class="number">8388</span>,</span><br><span class="line">    <span class="attr">&quot;local_port&quot;</span>:<span class="number">1080</span>,</span><br><span class="line">    <span class="attr">&quot;local_address&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;password&quot;</span>:<span class="string">&quot;helloworld&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;aes-128-cfb&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span>:<span class="number">600</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外阿里云默认情况下8388端口是不对外开放的，请去阿里云控制到，找到对应的ecs实例，找到该实例的安全组，将<code>8388</code>端口添加到白名单。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-06-05T14:04:59.000Z" title="6/5/2019, 2:04:59 PM">2019-06-05</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约102个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/06/05/%E4%BF%AE%E6%94%B9mariadb%E7%9A%84datadir/">修改mariadb的datadir</a></h1><div class="content"><blockquote>
<p>目标：将mariadb默认的datadir（/var/lib/mysql）迁移到<code>/data/mysql</code></p>
</blockquote>
<h3 id="停止mariadb服务"><a href="#停止mariadb服务" class="headerlink" title="停止mariadb服务"></a>停止mariadb服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mariadb</span><br></pre></td></tr></table></figure>

<h3 id="创建新datadir"><a href="#创建新datadir" class="headerlink" title="创建新datadir"></a>创建新datadir</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/mysql</span><br><span class="line">chown -R mysql:mysql /data/mysql</span><br></pre></td></tr></table></figure>

<h3 id="将数据文件复制过来"><a href="#将数据文件复制过来" class="headerlink" title="将数据文件复制过来"></a>将数据文件复制过来</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -a /var/lib/mysql    /data/mysql</span><br></pre></td></tr></table></figure>

<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> datadir=/var/lib/mysql</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注释掉之前的，将datadir设置成新目录</span></span><br><span class="line">datadir=/data/mysql</span><br></pre></td></tr></table></figure>

<h3 id="重新启动mariadb服务"><a href="#重新启动mariadb服务" class="headerlink" title="重新启动mariadb服务"></a>重新启动mariadb服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-06-05T13:57:52.000Z" title="6/5/2019, 1:57:52 PM">2019-06-05</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约249个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/06/05/Centos7%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%89%E8%A3%85mariadb/">Centos7初始化安装mariadb</a></h1><div class="content"><h2 id="安装MariaDB"><a href="#安装MariaDB" class="headerlink" title="安装MariaDB"></a>安装MariaDB</h2><p>安装命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb mariadb-server</span><br></pre></td></tr></table></figure>

<p>安装完成MariaDB，首先启动MariaDB</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure>

<p>设置开机启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable mariadb</span><br></pre></td></tr></table></figure>

<p>接下来进行MariaDB的相关简单配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure>

<p>首先是设置密码，会提示先输入密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter current password for root (enter for none):&lt;–初次运行直接回车</span><br></pre></td></tr></table></figure>

<p>设置密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Set root password? [Y/n] &lt;– 是否设置root用户密码，输入y并回车或直接回车</span><br><span class="line">New password: &lt;– 设置root用户的密码</span><br><span class="line">Re-enter new password: &lt;– 再输入一次你设置的密码</span><br></pre></td></tr></table></figure>

<p>其他配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Remove anonymous users? [Y/n] &lt;– 是否删除匿名用户，回车</span><br><span class="line"></span><br><span class="line">Disallow root login remotely? [Y/n] &lt;–是否禁止root远程登录,回车,</span><br><span class="line"></span><br><span class="line">Remove test database and access to it? [Y/n] &lt;– 是否删除test数据库，回车</span><br><span class="line"></span><br><span class="line">Reload privilege tables now? [Y/n] &lt;– 是否重新加载权限表，回车</span><br></pre></td></tr></table></figure>

<p>初始化MariaDB完成，接下来测试登录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -ppassword</span><br></pre></td></tr></table></figure>

<p>完成。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-05-14T18:48:30.000Z" title="5/14/2019, 6:48:30 PM">2019-05-14</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">27 分钟读完 (大约4024个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/05/14/JavaScript%E8%AE%A1%E7%AE%97%E5%86%9C%E5%8E%86/">JavaScript计算农历</a></h1><div class="content"><p>产品最近需要花一个万年历的图片用于分享使用，找了Java的很多库都不好用，于是在其他万年历的网页中找到了下面的代码，然后用Java调用JavaScript将万年历计算出来。</p>
<h2 id="最终生成的图片"><a href="#最终生成的图片" class="headerlink" title="最终生成的图片"></a>最终生成的图片</h2><p><img src="/images/2019/05/23/a401a000-7d01-11e9-935d-af314d4a877d.png" alt="image.png"></p>
<h2 id="JavaScript代码"><a href="#JavaScript代码" class="headerlink" title="JavaScript代码"></a>JavaScript代码</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Calendar<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> getData = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">//公历农历转换</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> calendar = &#123;</span></span><br><span class="line">                    lunarInfo: [0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2,</span><br><span class="line">                        0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977,</span><br><span class="line">                        0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970,</span><br><span class="line">                        0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950,</span><br><span class="line">                        0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557,</span><br><span class="line">                        0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5b0, 0x14573, 0x052b0, 0x0a9a8, 0x0e950, 0x06aa0,</span><br><span class="line">                        0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0,</span><br><span class="line">                        0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b6a0, 0x195a6,</span><br><span class="line">                        0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570,</span><br><span class="line">                        0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0,</span><br><span class="line">                        0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5,</span><br><span class="line">                        0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930,</span><br><span class="line">                        0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530,</span><br><span class="line">                        0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45,</span><br><span class="line">                        0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0,</span><br><span class="line">                        0x14b63, 0x09370, 0x049f8, 0x04970, 0x064b0, 0x168a6, 0x0ea50, 0x06b20, 0x1a6c4, 0x0aae0,</span><br><span class="line">                        0x0a2e0, 0x0d2e3, 0x0c960, 0x0d557, 0x0d4a0, 0x0da50, 0x05d55, 0x056a0, 0x0a6d0, 0x055d4,</span><br><span class="line">                        0x052d0, 0x0a9b8, 0x0a950, 0x0b4a0, 0x0b6a6, 0x0ad50, 0x055a0, 0x0aba4, 0x0a5b0, 0x052b0,</span><br><span class="line">                        0x0b273, 0x06930, 0x07337, 0x06aa0, 0x0ad50, 0x14b55, 0x04b60, 0x0a570, 0x054e4, 0x0d160,</span><br><span class="line">                        0x0e968, 0x0d520, 0x0daa0, 0x16aa6, 0x056d0, 0x04ae0, 0x0a9d4, 0x0a2d0, 0x0d150, 0x0f252,</span><br><span class="line">                        0x0d520],</span><br><span class="line">                    solarMonth: [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31],</span><br><span class="line"><span class="javascript">                    Gan: [<span class="string">&quot;\u7532&quot;</span>, <span class="string">&quot;\u4e59&quot;</span>, <span class="string">&quot;\u4e19&quot;</span>, <span class="string">&quot;\u4e01&quot;</span>, <span class="string">&quot;\u620a&quot;</span>, <span class="string">&quot;\u5df1&quot;</span>, <span class="string">&quot;\u5e9a&quot;</span>, <span class="string">&quot;\u8f9b&quot;</span>, <span class="string">&quot;\u58ec&quot;</span>, <span class="string">&quot;\u7678&quot;</span>],</span></span><br><span class="line"><span class="javascript">                    Zhi: [<span class="string">&quot;\u5b50&quot;</span>, <span class="string">&quot;\u4e11&quot;</span>, <span class="string">&quot;\u5bc5&quot;</span>, <span class="string">&quot;\u536f&quot;</span>, <span class="string">&quot;\u8fb0&quot;</span>, <span class="string">&quot;\u5df3&quot;</span>, <span class="string">&quot;\u5348&quot;</span>, <span class="string">&quot;\u672a&quot;</span>, <span class="string">&quot;\u7533&quot;</span>, <span class="string">&quot;\u9149&quot;</span>, <span class="string">&quot;\u620c&quot;</span>, <span class="string">&quot;\u4ea5&quot;</span>],</span></span><br><span class="line"><span class="javascript">                    Animals: [<span class="string">&quot;\u9f20&quot;</span>, <span class="string">&quot;\u725b&quot;</span>, <span class="string">&quot;\u864e&quot;</span>, <span class="string">&quot;\u5154&quot;</span>, <span class="string">&quot;\u9f99&quot;</span>, <span class="string">&quot;\u86c7&quot;</span>, <span class="string">&quot;\u9a6c&quot;</span>, <span class="string">&quot;\u7f8a&quot;</span>, <span class="string">&quot;\u7334&quot;</span>, <span class="string">&quot;\u9e21&quot;</span>, <span class="string">&quot;\u72d7&quot;</span>, <span class="string">&quot;\u732a&quot;</span>],</span></span><br><span class="line"><span class="javascript">                    solarTerm: [<span class="string">&quot;\u5c0f\u5bd2&quot;</span>, <span class="string">&quot;\u5927\u5bd2&quot;</span>, <span class="string">&quot;\u7acb\u6625&quot;</span>, <span class="string">&quot;\u96e8\u6c34&quot;</span>, <span class="string">&quot;\u60ca\u86f0&quot;</span>, <span class="string">&quot;\u6625\u5206&quot;</span>, <span class="string">&quot;\u6e05\u660e&quot;</span>, <span class="string">&quot;\u8c37\u96e8&quot;</span>, <span class="string">&quot;\u7acb\u590f&quot;</span>, <span class="string">&quot;\u5c0f\u6ee1&quot;</span>, <span class="string">&quot;\u8292\u79cd&quot;</span>, <span class="string">&quot;\u590f\u81f3&quot;</span>, <span class="string">&quot;\u5c0f\u6691&quot;</span>, <span class="string">&quot;\u5927\u6691&quot;</span>, <span class="string">&quot;\u7acb\u79cb&quot;</span>, <span class="string">&quot;\u5904\u6691&quot;</span>, <span class="string">&quot;\u767d\u9732&quot;</span>, <span class="string">&quot;\u79cb\u5206&quot;</span>, <span class="string">&quot;\u5bd2\u9732&quot;</span>, <span class="string">&quot;\u971c\u964d&quot;</span>, <span class="string">&quot;\u7acb\u51ac&quot;</span>, <span class="string">&quot;\u5c0f\u96ea&quot;</span>, <span class="string">&quot;\u5927\u96ea&quot;</span>, <span class="string">&quot;\u51ac\u81f3&quot;</span>],</span></span><br><span class="line"><span class="javascript">                    sTermInfo: [<span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>, <span class="string">&#x27;97bcf97c3598082c95f8c965cc920f&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97bd0b06bdb0722c965ce1cfcc920f&#x27;</span>, <span class="string">&#x27;b027097bd097c36b0b6fc9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97bcf97c359801ec95f8c965cc920f&#x27;</span>, <span class="string">&#x27;97bd0b06bdb0722c965ce1cfcc920f&#x27;</span>, <span class="string">&#x27;b027097bd097c36b0b6fc9274c91aa&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>, <span class="string">&#x27;97bcf97c359801ec95f8c965cc920f&#x27;</span>, <span class="string">&#x27;97bd0b06bdb0722c965ce1cfcc920f&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;b027097bd097c36b0b6fc9274c91aa&#x27;</span>, <span class="string">&#x27;9778397bd19801ec9210c965cc920e&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec95f8c965cc920f&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97bd09801d98082c95f8e1cfcc920f&#x27;</span>, <span class="string">&#x27;97bd097bd097c36b0b6fc9210c8dc2&#x27;</span>, <span class="string">&#x27;9778397bd197c36c9210c9274c91aa&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97b6b97bd19801ec95f8c965cc920e&#x27;</span>, <span class="string">&#x27;97bd09801d98082c95f8e1cfcc920f&#x27;</span>, <span class="string">&#x27;97bd097bd097c36b0b6fc9210c8dc2&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;9778397bd097c36c9210c9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec95f8c965cc920e&#x27;</span>, <span class="string">&#x27;97bcf97c3598082c95f8e1cfcc920f&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97bd097bd097c36b0b6fc9210c8dc2&#x27;</span>, <span class="string">&#x27;9778397bd097c36c9210c9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97bcf97c3598082c95f8c965cc920f&#x27;</span>, <span class="string">&#x27;97bd097bd097c35b0b6fc920fb0722&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>, <span class="string">&#x27;97bcf97c3598082c95f8c965cc920f&#x27;</span>, <span class="string">&#x27;97bd097bd097c35b0b6fc920fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>, <span class="string">&#x27;97bcf97c359801ec95f8c965cc920f&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97bd097bd097c35b0b6fc920fb0722&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97bcf97c359801ec95f8c965cc920f&#x27;</span>, <span class="string">&#x27;97bd097bd097c35b0b6fc920fb0722&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>, <span class="string">&#x27;97bcf97c359801ec95f8c965cc920f&#x27;</span>, <span class="string">&#x27;97bd097bd07f595b0b6fc920fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;9778397bd097c36b0b6fc9210c8dc2&#x27;</span>, <span class="string">&#x27;9778397bd19801ec9210c9274c920e&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec95f8c965cc920f&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97bd07f5307f595b0b0bc920fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd097c36b0b6fc9210c8dc2&#x27;</span>, <span class="string">&#x27;9778397bd097c36c9210c9274c920e&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97b6b97bd19801ec95f8c965cc920f&#x27;</span>, <span class="string">&#x27;97bd07f5307f595b0b0bc920fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd097c36b0b6fc9210c8dc2&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;9778397bd097c36c9210c9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>, <span class="string">&#x27;97bd07f1487f595b0b0bc920fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e397bd097c36b0b6fc9210c8dc2&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97bcf7f1487f595b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd097c35b0b6fc920fb0722&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>, <span class="string">&#x27;97bcf7f1487f595b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd097c35b0b6fc920fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>, <span class="string">&#x27;97bcf7f1487f531b0b0bb0b6fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e397bd097c35b0b6fc920fb0722&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b97bd19801ec9210c965cc920e&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97bcf7f1487f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd07f595b0b6fc920fb0722&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97b6b97bd19801ec9210c9274c920e&#x27;</span>, <span class="string">&#x27;97bcf7f0e47f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd07f595b0b0bc920fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;9778397bd097c36b0b6fc9210c91aa&#x27;</span>, <span class="string">&#x27;97b6b97bd197c36c9210c9274c920e&#x27;</span>, <span class="string">&#x27;97bcf7f0e47f531b0b0bb0b6fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e397bd07f595b0b0bc920fb0722&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9210c8dc2&#x27;</span>, <span class="string">&#x27;9778397bd097c36c9210c9274c920e&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97b6b7f0e47f531b0723b0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e37f5307f595b0b0bc920fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd097c36b0b6fc9210c8dc2&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;9778397bd097c36b0b70c9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b7f0e47f531b0723b0b6fb0721&#x27;</span>, <span class="string">&#x27;7f0e37f1487f595b0b0bb0b6fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e397bd097c35b0b6fc9210c8dc2&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b7f0e47f531b0723b0b6fb0721&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e27f1487f595b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd097c35b0b6fc920fb0722&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97b6b7f0e47f531b0723b0b6fb0721&#x27;</span>, <span class="string">&#x27;7f0e27f1487f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd097c35b0b6fc920fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b7f0e47f531b0723b0b6fb0721&#x27;</span>, <span class="string">&#x27;7f0e27f1487f531b0b0bb0b6fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e397bd097c35b0b6fc920fb0722&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>, <span class="string">&#x27;97b6b7f0e47f531b0723b0b6fb0721&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e27f1487f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd07f595b0b0bc920fb0722&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9274c91aa&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;97b6b7f0e47f531b0723b0787b0721&#x27;</span>, <span class="string">&#x27;7f0e27f0e47f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd07f595b0b0bc920fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;9778397bd097c36b0b6fc9210c91aa&#x27;</span>, <span class="string">&#x27;97b6b7f0e47f149b0723b0787b0721&#x27;</span>, <span class="string">&#x27;7f0e27f0e47f531b0723b0b6fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e397bd07f595b0b0bc920fb0722&#x27;</span>, <span class="string">&#x27;9778397bd097c36b0b6fc9210c8dc2&#x27;</span>, <span class="string">&#x27;977837f0e37f149b0723b0787b0721&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e37f5307f595b0b0bc920fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd097c35b0b6fc9210c8dc2&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;977837f0e37f14998082b0787b0721&#x27;</span>, <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0721&#x27;</span>, <span class="string">&#x27;7f0e37f1487f595b0b0bb0b6fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e397bd097c35b0b6fc9210c8dc2&#x27;</span>, <span class="string">&#x27;977837f0e37f14998082b0787b06bd&#x27;</span>, <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0721&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e27f1487f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd097c35b0b6fc920fb0722&#x27;</span>, <span class="string">&#x27;977837f0e37f14998082b0787b06bd&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0721&#x27;</span>, <span class="string">&#x27;7f0e27f1487f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd097c35b0b6fc920fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;977837f0e37f14998082b0787b06bd&#x27;</span>, <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0721&#x27;</span>, <span class="string">&#x27;7f0e27f1487f531b0b0bb0b6fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e397bd07f595b0b0bc920fb0722&#x27;</span>, <span class="string">&#x27;977837f0e37f14998082b0787b06bd&#x27;</span>, <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0721&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e27f1487f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd07f595b0b0bc920fb0722&#x27;</span>, <span class="string">&#x27;977837f0e37f14998082b0787b06bd&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f07e7f0e47f149b0723b0787b0721&#x27;</span>, <span class="string">&#x27;7f0e27f0e47f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e397bd07f595b0b0bc920fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;977837f0e37f14998082b0723b06bd&#x27;</span>, <span class="string">&#x27;7f07e7f0e37f149b0723b0787b0721&#x27;</span>, <span class="string">&#x27;7f0e27f0e47f531b0723b0b6fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e397bd07f595b0b0bc920fb0722&#x27;</span>, <span class="string">&#x27;977837f0e37f14898082b0723b02d5&#x27;</span>, <span class="string">&#x27;7ec967f0e37f14998082b0787b0721&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e37f1487f595b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e37f0e37f14898082b0723b02d5&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7ec967f0e37f14998082b0787b0721&#x27;</span>, <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e37f1487f531b0b0bb0b6fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e37f0e37f14898082b0723b02d5&#x27;</span>, <span class="string">&#x27;7ec967f0e37f14998082b0787b06bd&#x27;</span>, <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0721&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e37f1487f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e37f0e37f14898082b072297c35&#x27;</span>, <span class="string">&#x27;7ec967f0e37f14998082b0787b06bd&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0721&#x27;</span>, <span class="string">&#x27;7f0e27f1487f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e37f0e37f14898082b072297c35&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7ec967f0e37f14998082b0787b06bd&#x27;</span>, <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0721&#x27;</span>, <span class="string">&#x27;7f0e27f1487f531b0b0bb0b6fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e37f0e366aa89801eb072297c35&#x27;</span>, <span class="string">&#x27;7ec967f0e37f14998082b0787b06bd&#x27;</span>, <span class="string">&#x27;7f07e7f0e47f149b0723b0787b0721&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e27f1487f531b0b0bb0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e37f0e366aa89801eb072297c35&#x27;</span>, <span class="string">&#x27;7ec967f0e37f14998082b0723b06bd&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f07e7f0e47f149b0723b0787b0721&#x27;</span>, <span class="string">&#x27;7f0e27f0e47f531b0723b0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e37f0e366aa89801eb072297c35&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7ec967f0e37f14998082b0723b06bd&#x27;</span>, <span class="string">&#x27;7f07e7f0e37f14998083b0787b0721&#x27;</span>, <span class="string">&#x27;7f0e27f0e47f531b0723b0b6fb0722&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e37f0e366aa89801eb072297c35&#x27;</span>, <span class="string">&#x27;7ec967f0e37f14898082b0723b02d5&#x27;</span>, <span class="string">&#x27;7f07e7f0e37f14998082b0787b0721&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e36665b66aa89801e9808297c35&#x27;</span>, <span class="string">&#x27;665f67f0e37f14898082b0723b02d5&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7ec967f0e37f14998082b0787b0721&#x27;</span>, <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0722&#x27;</span>, <span class="string">&#x27;7f0e36665b66a449801e9808297c35&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;665f67f0e37f14898082b0723b02d5&#x27;</span>, <span class="string">&#x27;7ec967f0e37f14998082b0787b06bd&#x27;</span>, <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0721&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f0e36665b66a449801e9808297c35&#x27;</span>, <span class="string">&#x27;665f67f0e37f14898082b072297c35&#x27;</span>, <span class="string">&#x27;7ec967f0e37f14998082b0787b06bd&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0721&#x27;</span>, <span class="string">&#x27;7f0e26665b66a449801e9808297c35&#x27;</span>, <span class="string">&#x27;665f67f0e37f1489801eb072297c35&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;7ec967f0e37f14998082b0787b06bd&#x27;</span>, <span class="string">&#x27;7f07e7f0e47f531b0723b0b6fb0721&#x27;</span>, <span class="string">&#x27;7f0e27f1487f531b0b0bb0b6fb0722&#x27;</span>],</span></span><br><span class="line"><span class="javascript">                    nStr1: [<span class="string">&quot;\u65e5&quot;</span>, <span class="string">&quot;\u4e00&quot;</span>, <span class="string">&quot;\u4e8c&quot;</span>, <span class="string">&quot;\u4e09&quot;</span>, <span class="string">&quot;\u56db&quot;</span>, <span class="string">&quot;\u4e94&quot;</span>, <span class="string">&quot;\u516d&quot;</span>, <span class="string">&quot;\u4e03&quot;</span>, <span class="string">&quot;\u516b&quot;</span>, <span class="string">&quot;\u4e5d&quot;</span>, <span class="string">&quot;\u5341&quot;</span>],</span></span><br><span class="line"><span class="javascript">                    nStr2: [<span class="string">&quot;\u521d&quot;</span>, <span class="string">&quot;\u5341&quot;</span>, <span class="string">&quot;\u5eff&quot;</span>, <span class="string">&quot;\u5345&quot;</span>],</span></span><br><span class="line"><span class="javascript">                    nStr3: [<span class="string">&quot;\u6b63&quot;</span>, <span class="string">&quot;\u4e8c&quot;</span>, <span class="string">&quot;\u4e09&quot;</span>, <span class="string">&quot;\u56db&quot;</span>, <span class="string">&quot;\u4e94&quot;</span>, <span class="string">&quot;\u516d&quot;</span>, <span class="string">&quot;\u4e03&quot;</span>, <span class="string">&quot;\u516b&quot;</span>, <span class="string">&quot;\u4e5d&quot;</span>, <span class="string">&quot;\u5341&quot;</span>, <span class="string">&quot;\u51ac&quot;</span>, <span class="string">&quot;\u814a&quot;</span>],</span></span><br><span class="line"><span class="javascript">                    lYearDays: <span class="function"><span class="keyword">function</span> (<span class="params">y</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> i, sum = <span class="number">348</span>;</span></span><br><span class="line">                        for (i = 0x8000; i &gt; 0x8; i &gt;&gt;= 1) &#123; sum += (calendar.lunarInfo[y - 1900] &amp; i) ? 1 : 0; &#125;</span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> (sum + calendar.leapDays(y));</span></span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="javascript">                    leapMonth: <span class="function"><span class="keyword">function</span> (<span class="params">y</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> (calendar.lunarInfo[y - <span class="number">1900</span>] &amp; <span class="number">0xf</span>);</span></span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="javascript">                    leapDays: <span class="function"><span class="keyword">function</span> (<span class="params">y</span>) </span>&#123;</span></span><br><span class="line">                        if (calendar.leapMonth(y)) &#123;</span><br><span class="line"><span class="javascript">                            <span class="keyword">return</span> ((calendar.lunarInfo[y - <span class="number">1900</span>] &amp; <span class="number">0x10000</span>) ? <span class="number">30</span> : <span class="number">29</span>);</span></span><br><span class="line">                        &#125;</span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> (<span class="number">0</span>);</span></span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="javascript">                    monthDays: <span class="function"><span class="keyword">function</span> (<span class="params">y, m</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (m &gt; <span class="number">12</span> || m &lt; <span class="number">1</span>) &#123; <span class="keyword">return</span> -<span class="number">1</span> &#125;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> ((calendar.lunarInfo[y - <span class="number">1900</span>] &amp; (<span class="number">0x10000</span> &gt;&gt; m)) ? <span class="number">30</span> : <span class="number">29</span>);</span></span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="javascript">                    solarDays: <span class="function"><span class="keyword">function</span> (<span class="params">y, m</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (m &gt; <span class="number">12</span> || m &lt; <span class="number">1</span>) &#123; <span class="keyword">return</span> -<span class="number">1</span> &#125;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> ms = m - <span class="number">1</span>;</span></span><br><span class="line">                        if (ms == 1) &#123;</span><br><span class="line"><span class="javascript">                            <span class="keyword">return</span> (((y % <span class="number">4</span> == <span class="number">0</span>) &amp;&amp; (y % <span class="number">100</span> != <span class="number">0</span>) || (y % <span class="number">400</span> == <span class="number">0</span>)) ? <span class="number">29</span> : <span class="number">28</span>);</span></span><br><span class="line"><span class="javascript">                        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">return</span> (calendar.solarMonth[ms]);</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="javascript">                    toGanZhi: <span class="function"><span class="keyword">function</span> (<span class="params">offset</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> (calendar.Gan[offset % <span class="number">10</span>] + calendar.Zhi[offset % <span class="number">12</span>]);</span></span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="javascript">                    getTerm: <span class="function"><span class="keyword">function</span> (<span class="params">y, n</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (y &lt; <span class="number">1900</span> || y &gt; <span class="number">2100</span>) &#123; <span class="keyword">return</span> -<span class="number">1</span>; &#125;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (n &lt; <span class="number">1</span> || n &gt; <span class="number">24</span>) &#123; <span class="keyword">return</span> -<span class="number">1</span>; &#125;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> _table = calendar.sTermInfo[y - <span class="number">1900</span>];</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> _info = [</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">parseInt</span>(<span class="string">&#x27;0x&#x27;</span> + _table.substr(<span class="number">0</span>, <span class="number">5</span>)).toString(),</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">parseInt</span>(<span class="string">&#x27;0x&#x27;</span> + _table.substr(<span class="number">5</span>, <span class="number">5</span>)).toString(),</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">parseInt</span>(<span class="string">&#x27;0x&#x27;</span> + _table.substr(<span class="number">10</span>, <span class="number">5</span>)).toString(),</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">parseInt</span>(<span class="string">&#x27;0x&#x27;</span> + _table.substr(<span class="number">15</span>, <span class="number">5</span>)).toString(),</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">parseInt</span>(<span class="string">&#x27;0x&#x27;</span> + _table.substr(<span class="number">20</span>, <span class="number">5</span>)).toString(),</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">parseInt</span>(<span class="string">&#x27;0x&#x27;</span> + _table.substr(<span class="number">25</span>, <span class="number">5</span>)).toString()</span></span><br><span class="line">                        ];</span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> _calday = [</span></span><br><span class="line">                            _info[0].substr(0, 1),</span><br><span class="line">                            _info[0].substr(1, 2),</span><br><span class="line">                            _info[0].substr(3, 1),</span><br><span class="line">                            _info[0].substr(4, 2),</span><br><span class="line">                            _info[1].substr(0, 1),</span><br><span class="line">                            _info[1].substr(1, 2),</span><br><span class="line">                            _info[1].substr(3, 1),</span><br><span class="line">                            _info[1].substr(4, 2),</span><br><span class="line">                            _info[2].substr(0, 1),</span><br><span class="line">                            _info[2].substr(1, 2),</span><br><span class="line">                            _info[2].substr(3, 1),</span><br><span class="line">                            _info[2].substr(4, 2),</span><br><span class="line">                            _info[3].substr(0, 1),</span><br><span class="line">                            _info[3].substr(1, 2),</span><br><span class="line">                            _info[3].substr(3, 1),</span><br><span class="line">                            _info[3].substr(4, 2),</span><br><span class="line">                            _info[4].substr(0, 1),</span><br><span class="line">                            _info[4].substr(1, 2),</span><br><span class="line">                            _info[4].substr(3, 1),</span><br><span class="line">                            _info[4].substr(4, 2),</span><br><span class="line">                            _info[5].substr(0, 1),</span><br><span class="line">                            _info[5].substr(1, 2),</span><br><span class="line">                            _info[5].substr(3, 1),</span><br><span class="line">                            _info[5].substr(4, 2),</span><br><span class="line">                        ];</span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> <span class="built_in">parseInt</span>(_calday[n - <span class="number">1</span>]);</span></span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="javascript">                    toChinaMonth: <span class="function"><span class="keyword">function</span> (<span class="params">m</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (m &gt; <span class="number">12</span> || m &lt; <span class="number">1</span>) &#123; <span class="keyword">return</span> -<span class="number">1</span> &#125;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> s = calendar.nStr3[m - <span class="number">1</span>];</span></span><br><span class="line"><span class="javascript">                        s += <span class="string">&quot;\u6708&quot;</span>;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> s;</span></span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="javascript">                    toChinaDay: <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> s;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">switch</span> (d) &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">case</span> <span class="number">10</span>:</span></span><br><span class="line"><span class="javascript">                                s = <span class="string">&#x27;\u521d\u5341&#x27;</span>;</span></span><br><span class="line"><span class="javascript">                                <span class="keyword">break</span>;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">case</span> <span class="number">20</span>:</span></span><br><span class="line"><span class="javascript">                                s = <span class="string">&#x27;\u4e8c\u5341&#x27;</span>;</span></span><br><span class="line"><span class="javascript">                                <span class="keyword">break</span>;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">case</span> <span class="number">30</span>:</span></span><br><span class="line"><span class="javascript">                                s = <span class="string">&#x27;\u4e09\u5341&#x27;</span>;</span></span><br><span class="line"><span class="javascript">                                <span class="keyword">break</span>;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">default</span>:</span></span><br><span class="line"><span class="javascript">                                s = calendar.nStr2[<span class="built_in">Math</span>.floor(d / <span class="number">10</span>)];</span></span><br><span class="line">                                s += calendar.nStr1[d % 10];</span><br><span class="line">                        &#125;</span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> (s);</span></span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="javascript">                    getAnimal: <span class="function"><span class="keyword">function</span> (<span class="params">y</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> calendar.Animals[(y - <span class="number">4</span>) % <span class="number">12</span>]</span></span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="javascript">                    solar2lunar: <span class="function"><span class="keyword">function</span> (<span class="params">y, m, d</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (y &lt; <span class="number">1900</span> || y &gt; <span class="number">2100</span>) &#123; <span class="keyword">return</span> -<span class="number">1</span>; &#125;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (y == <span class="number">1900</span> &amp;&amp; m == <span class="number">1</span> &amp;&amp; d &lt; <span class="number">31</span>) &#123; <span class="keyword">return</span> -<span class="number">1</span>; &#125;</span></span><br><span class="line">                        if (!y) &#123;</span><br><span class="line"><span class="javascript">                            <span class="keyword">var</span> objDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span></span><br><span class="line"><span class="javascript">                        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">var</span> objDate = <span class="keyword">new</span> <span class="built_in">Date</span>(y, <span class="built_in">parseInt</span>(m) - <span class="number">1</span>, d)</span></span><br><span class="line">                        &#125;</span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> i, leap = <span class="number">0</span>, temp = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> y = objDate.getFullYear(), m = objDate.getMonth() + <span class="number">1</span>, d = objDate.getDate();</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> offset = (<span class="built_in">Date</span>.UTC(objDate.getFullYear(), objDate.getMonth(), objDate.getDate()) - <span class="built_in">Date</span>.UTC(<span class="number">1900</span>, <span class="number">0</span>, <span class="number">31</span>)) / <span class="number">86400000</span>;</span></span><br><span class="line">                        for (i = 1900; i &lt; 2101 &amp;&amp; offset &gt; 0; i++) &#123; temp = calendar.lYearDays(i); offset -= temp; &#125;</span><br><span class="line">                        if (offset &lt; 0) &#123; offset += temp; i--; &#125;</span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> isTodayObj = <span class="keyword">new</span> <span class="built_in">Date</span>(), isToday = <span class="literal">false</span>;</span></span><br><span class="line">                        if (isTodayObj.getFullYear() == y &amp;&amp; isTodayObj.getMonth() + 1 == m &amp;&amp; isTodayObj.getDate() == d) &#123;</span><br><span class="line"><span class="javascript">                            isToday = <span class="literal">true</span>;</span></span><br><span class="line">                        &#125;</span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> nWeek = objDate.getDay(), cWeek = calendar.nStr1[nWeek];</span></span><br><span class="line">                        if (nWeek == 0) &#123; nWeek = 7; &#125;</span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> year = i;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> leap = calendar.leapMonth(i);</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> isLeap = <span class="literal">false</span>;</span></span><br><span class="line">                        for (i = 1; i &lt; 13 &amp;&amp; offset &gt; 0; i++) &#123;</span><br><span class="line"><span class="javascript">                            <span class="keyword">if</span> (leap &gt; <span class="number">0</span> &amp;&amp; i == (leap + <span class="number">1</span>) &amp;&amp; isLeap == <span class="literal">false</span>) &#123;</span></span><br><span class="line">                                --i;</span><br><span class="line"><span class="javascript">                                isLeap = <span class="literal">true</span>; temp = calendar.leapDays(year);</span></span><br><span class="line"><span class="javascript">                            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line">                                temp = calendar.monthDays(year, i);</span><br><span class="line">                            &#125;</span><br><span class="line"><span class="javascript">                            <span class="keyword">if</span> (isLeap == <span class="literal">true</span> &amp;&amp; i == (leap + <span class="number">1</span>)) &#123; isLeap = <span class="literal">false</span>; &#125;</span></span><br><span class="line">                            offset -= temp;</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (offset == 0 &amp;&amp; leap &gt; 0 &amp;&amp; i == leap + 1) &#123;</span><br><span class="line">                            if (isLeap) &#123;</span><br><span class="line"><span class="javascript">                                isLeap = <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">                            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                                isLeap = <span class="literal">true</span>; --i;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (offset &lt; 0) &#123; offset += temp; --i; &#125;</span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> month = i;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> day = offset + <span class="number">1</span>;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> sm = m - <span class="number">1</span>;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> term3 = calendar.getTerm(year, <span class="number">3</span>);</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> gzY = calendar.toGanZhi(year - <span class="number">4</span>);</span></span><br><span class="line"><span class="javascript">                        gzY = calendar.toGanZhi(year - <span class="number">4</span>); <span class="comment">//modify</span></span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> firstNode = calendar.getTerm(y, (m * <span class="number">2</span> - <span class="number">1</span>));</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> secondNode = calendar.getTerm(y, (m * <span class="number">2</span>));</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> gzM = calendar.toGanZhi((y - <span class="number">1900</span>) * <span class="number">12</span> + m + <span class="number">11</span>);</span></span><br><span class="line">                        if (d &gt;= firstNode) &#123;</span><br><span class="line">                            gzM = calendar.toGanZhi((y - 1900) * 12 + m + 12);</span><br><span class="line">                        &#125;</span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> isTerm = <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> Term = <span class="literal">null</span>;</span></span><br><span class="line">                        if (firstNode == d) &#123;</span><br><span class="line"><span class="javascript">                            isTerm = <span class="literal">true</span>;</span></span><br><span class="line">                            Term = calendar.solarTerm[m * 2 - 2];</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (secondNode == d) &#123;</span><br><span class="line"><span class="javascript">                            isTerm = <span class="literal">true</span>;</span></span><br><span class="line">                            Term = calendar.solarTerm[m * 2 - 1];</span><br><span class="line">                        &#125;</span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> dayCyclical = <span class="built_in">Date</span>.UTC(y, sm, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) / <span class="number">86400000</span> + <span class="number">25567</span> + <span class="number">10</span>;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> gzD = calendar.toGanZhi(dayCyclical + d - <span class="number">1</span>);</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> &#123; <span class="string">&#x27;lYear&#x27;</span>: year, <span class="string">&#x27;lMonth&#x27;</span>: month, <span class="string">&#x27;lDay&#x27;</span>: day, <span class="string">&#x27;Animal&#x27;</span>: calendar.getAnimal(year), <span class="string">&#x27;IMonthCn&#x27;</span>: (isLeap ? <span class="string">&quot;\u95f0&quot;</span> : <span class="string">&#x27;&#x27;</span>) + calendar.toChinaMonth(month), <span class="string">&#x27;IDayCn&#x27;</span>: calendar.toChinaDay(day), <span class="string">&#x27;cYear&#x27;</span>: y, <span class="string">&#x27;cMonth&#x27;</span>: m, <span class="string">&#x27;cDay&#x27;</span>: d, <span class="string">&#x27;gzYear&#x27;</span>: gzY, <span class="string">&#x27;gzMonth&#x27;</span>: gzM, <span class="string">&#x27;gzDay&#x27;</span>: gzD, <span class="string">&#x27;isToday&#x27;</span>: isToday, <span class="string">&#x27;isLeap&#x27;</span>: isLeap, <span class="string">&#x27;nWeek&#x27;</span>: nWeek, <span class="string">&#x27;ncWeek&#x27;</span>: <span class="string">&quot;\u661f\u671f&quot;</span> + cWeek, <span class="string">&#x27;isTerm&#x27;</span>: isTerm, <span class="string">&#x27;Term&#x27;</span>: Term &#125;;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line"><span class="javascript">                <span class="comment">//公历节日</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> _festival1 = &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0101&#x27;</span>: <span class="string">&#x27;元旦节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0202&#x27;</span>: <span class="string">&#x27;世界湿地日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0210&#x27;</span>: <span class="string">&#x27;国际气象节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0214&#x27;</span>: <span class="string">&#x27;情人节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0301&#x27;</span>: <span class="string">&#x27;国际海豹日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0303&#x27;</span>: <span class="string">&#x27;全国爱耳日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0305&#x27;</span>: <span class="string">&#x27;学雷锋纪念日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0308&#x27;</span>: <span class="string">&#x27;妇女节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0312&#x27;</span>: <span class="string">&#x27;植树节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0314&#x27;</span>: <span class="string">&#x27;国际警察日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0315&#x27;</span>: <span class="string">&#x27;消费者权益日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0317&#x27;</span>: <span class="string">&#x27;中国国医节 国际航海日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0321&#x27;</span>: <span class="string">&#x27;世界森林日 消除种族歧视国际日 世界儿歌日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0322&#x27;</span>: <span class="string">&#x27;世界水日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0323&#x27;</span>: <span class="string">&#x27;世界气象日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0324&#x27;</span>: <span class="string">&#x27;世界防治结核病日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0325&#x27;</span>: <span class="string">&#x27;全国中小学生安全教育日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0401&#x27;</span>: <span class="string">&#x27;愚人节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0407&#x27;</span>: <span class="string">&#x27;世界卫生日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0422&#x27;</span>: <span class="string">&#x27;世界地球日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0423&#x27;</span>: <span class="string">&#x27;世界图书和版权日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0424&#x27;</span>: <span class="string">&#x27;亚非新闻工作者日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0501&#x27;</span>: <span class="string">&#x27;劳动节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0504&#x27;</span>: <span class="string">&#x27;青年节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0515&#x27;</span>: <span class="string">&#x27;防治碘缺乏病日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0508&#x27;</span>: <span class="string">&#x27;世界红十字日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0512&#x27;</span>: <span class="string">&#x27;国际护士节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0515&#x27;</span>: <span class="string">&#x27;国际家庭日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0517&#x27;</span>: <span class="string">&#x27;世界电信日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0518&#x27;</span>: <span class="string">&#x27;国际博物馆日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0520&#x27;</span>: <span class="string">&#x27;全国学生营养日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0522&#x27;</span>: <span class="string">&#x27;国际生物多样性日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0531&#x27;</span>: <span class="string">&#x27;世界无烟日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0601&#x27;</span>: <span class="string">&#x27;国际儿童节 世界牛奶日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0605&#x27;</span>: <span class="string">&#x27;世界环境日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0606&#x27;</span>: <span class="string">&#x27;全国爱眼日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0617&#x27;</span>: <span class="string">&#x27;防治荒漠化和干旱日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0623&#x27;</span>: <span class="string">&#x27;国际奥林匹克日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0625&#x27;</span>: <span class="string">&#x27;全国土地日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0626&#x27;</span>: <span class="string">&#x27;国际禁毒日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0701&#x27;</span>: <span class="string">&#x27;建党节 香港回归纪念日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0702&#x27;</span>: <span class="string">&#x27;国际体育记者日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0711&#x27;</span>: <span class="string">&#x27;世界人口日 航海日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0801&#x27;</span>: <span class="string">&#x27;建军节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0808&#x27;</span>: <span class="string">&#x27;中国男子节(爸爸节)&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0903&#x27;</span>: <span class="string">&#x27;抗日战争胜利纪念日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0908&#x27;</span>: <span class="string">&#x27;国际扫盲日 国际新闻工作者日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0910&#x27;</span>: <span class="string">&#x27;教师节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0916&#x27;</span>: <span class="string">&#x27;国际臭氧层保护日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0918&#x27;</span>: <span class="string">&#x27;九·一八事变纪念日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0920&#x27;</span>: <span class="string">&#x27;国际爱牙日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0927&#x27;</span>: <span class="string">&#x27;世界旅游日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1001&#x27;</span>: <span class="string">&#x27;国庆节 国际音乐日 国际老人节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1002&#x27;</span>: <span class="string">&#x27;国际非暴力日 国际和平与民主自由斗争日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1004&#x27;</span>: <span class="string">&#x27;世界动物日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1006&#x27;</span>: <span class="string">&#x27;老人节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1008&#x27;</span>: <span class="string">&#x27;全国高血压日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1005&#x27;</span>: <span class="string">&#x27;国际教师节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1009&#x27;</span>: <span class="string">&#x27;世界邮政日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1010&#x27;</span>: <span class="string">&#x27;辛亥革命纪念日 世界精神卫生日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1013&#x27;</span>: <span class="string">&#x27;世界保健日 国际减灾日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1014&#x27;</span>: <span class="string">&#x27;世界标准日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1015&#x27;</span>: <span class="string">&#x27;国际盲人节(白手杖节)&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1016&#x27;</span>: <span class="string">&#x27;世界粮食日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1017&#x27;</span>: <span class="string">&#x27;世界消除贫困日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1022&#x27;</span>: <span class="string">&#x27;世界传统医药日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1024&#x27;</span>: <span class="string">&#x27;联合国日 世界发展信息日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1031&#x27;</span>: <span class="string">&#x27;世界勤俭日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1107&#x27;</span>: <span class="string">&#x27;十月社会主义革命纪念日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1108&#x27;</span>: <span class="string">&#x27;中国记者日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1109&#x27;</span>: <span class="string">&#x27;全国消防安全宣传教育日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1110&#x27;</span>: <span class="string">&#x27;世界青年节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1111&#x27;</span>: <span class="string">&#x27;国际科学与和平周(本日所属的一周)&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1112&#x27;</span>: <span class="string">&#x27;孙中山诞辰纪念日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1114&#x27;</span>: <span class="string">&#x27;联合国糖尿病日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1117&#x27;</span>: <span class="string">&#x27;国际大学生节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1121&#x27;</span>: <span class="string">&#x27;世界问候日 世界电视日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1129&#x27;</span>: <span class="string">&#x27;国际声援巴勒斯坦人民国际日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1201&#x27;</span>: <span class="string">&#x27;世界艾滋病日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1203&#x27;</span>: <span class="string">&#x27;世界残疾人日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1204&#x27;</span>: <span class="string">&#x27;宪法日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1205&#x27;</span>: <span class="string">&#x27;国际志愿人员日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1209&#x27;</span>: <span class="string">&#x27;世界足球日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1210&#x27;</span>: <span class="string">&#x27;世界人权日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1212&#x27;</span>: <span class="string">&#x27;西安事变纪念日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1213&#x27;</span>: <span class="string">&#x27;南京大屠杀纪念日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1220&#x27;</span>: <span class="string">&#x27;澳门回归纪念&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1221&#x27;</span>: <span class="string">&#x27;国际篮球日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1224&#x27;</span>: <span class="string">&#x27;平安夜&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1225&#x27;</span>: <span class="string">&#x27;圣诞节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1226&#x27;</span>: <span class="string">&#x27;毛泽东诞辰纪念日&#x27;</span></span></span><br><span class="line">                &#125;;</span><br><span class="line"><span class="javascript">                <span class="comment">//某月的第几个星期几,第3位为5表示最后一星期</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> _festival2 = &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0110&#x27;</span>: <span class="string">&#x27;黑人日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0150&#x27;</span>: <span class="string">&#x27;世界麻风日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0440&#x27;</span>: <span class="string">&#x27;世界儿童日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0520&#x27;</span>: <span class="string">&#x27;国际母亲节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0532&#x27;</span>: <span class="string">&#x27;国际牛奶日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0530&#x27;</span>: <span class="string">&#x27;全国助残日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0630&#x27;</span>: <span class="string">&#x27;父亲节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0711&#x27;</span>: <span class="string">&#x27;世界建筑日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0730&#x27;</span>: <span class="string">&#x27;被奴役国家周&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0936&#x27;</span>: <span class="string">&#x27;世界清洁地球日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0932&#x27;</span>: <span class="string">&#x27;国际和平日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0940&#x27;</span>: <span class="string">&#x27;国际聋人节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1011&#x27;</span>: <span class="string">&#x27;国际住房日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1024&#x27;</span>: <span class="string">&#x27;世界视觉日&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1144&#x27;</span>: <span class="string">&#x27;感恩节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1220&#x27;</span>: <span class="string">&#x27;国际儿童电视广播日&#x27;</span></span></span><br><span class="line">                &#125;;</span><br><span class="line"><span class="javascript">                <span class="comment">//农历节日</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> _festival3 = &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0101&#x27;</span>: <span class="string">&#x27;春节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0102&#x27;</span>: <span class="string">&#x27;初二&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0103&#x27;</span>: <span class="string">&#x27;初三&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0115&#x27;</span>: <span class="string">&#x27;元宵节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0202&#x27;</span>: <span class="string">&#x27;龙抬头节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0323&#x27;</span>: <span class="string">&#x27;妈祖生辰&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0505&#x27;</span>: <span class="string">&#x27;端午节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0707&#x27;</span>: <span class="string">&#x27;七夕节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0715&#x27;</span>: <span class="string">&#x27;中元节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0815&#x27;</span>: <span class="string">&#x27;中秋节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0909&#x27;</span>: <span class="string">&#x27;重阳节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1208&#x27;</span>: <span class="string">&#x27;腊八节&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;1223&#x27;</span>: <span class="string">&#x27;小年&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;0100&#x27;</span>: <span class="string">&#x27;除夕&#x27;</span></span></span><br><span class="line">                &#125;;</span><br><span class="line"><span class="javascript">                <span class="comment">//假日安排数据</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> _holiday = &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;2011&#x27;</span>: &#123; <span class="string">&#x27;0402&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0403&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0404&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0405&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0430&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0501&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0502&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0604&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0605&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0606&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0910&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0911&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0912&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1001&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1002&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1003&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1004&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1005&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1006&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1007&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1008&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1009&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1231&#x27;</span>: <span class="number">0</span> &#125;,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;2012&#x27;</span>: &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;0101&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0102&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0103&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0121&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0122&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0123&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0124&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0125&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0126&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0127&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0128&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0129&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0331&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0401&#x27;</span></span></span><br><span class="line"><span class="javascript">                            : <span class="number">0</span>, <span class="string">&#x27;0402&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0403&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0404&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0428&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0429&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0430&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0501&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0622&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0623&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0624&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0929&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0930&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1001&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1002&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1003&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1004&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1005&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1006&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1007&#x27;</span>: <span class="number">1</span></span></span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;2013&#x27;</span>: &#123; <span class="string">&#x27;0101&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0102&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0103&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0105&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0106&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0209&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0210&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0211&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0212&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0213&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0214&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0215&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0216&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0217&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0404&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0405&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0406&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0407&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0427&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0428&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0429&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0430&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0501&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0608&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0609&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0610&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0611&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0612&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0919&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0920&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0921&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0922&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0929&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1001&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1002&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1003&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1004&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1005&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1006&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1007&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1012&#x27;</span>: <span class="number">0</span> &#125;,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;2014&#x27;</span>: &#123; <span class="string">&#x27;0101&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0126&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0131&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0201&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0202&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0203&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0203&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0204&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0205&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0206&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0208&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0405&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0406&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0407&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0501&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0502&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0503&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0504&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0531&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0601&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0602&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0908&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0928&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1001&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1002&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1003&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1004&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1005&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1006&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1007&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1011&#x27;</span>: <span class="number">0</span> &#125;,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;2015&#x27;</span>: &#123; <span class="string">&#x27;0101&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0102&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0103&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0104&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0215&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0218&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0219&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0220&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0221&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0222&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0223&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0224&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0228&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0404&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0405&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0406&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0501&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0502&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0503&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0620&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0621&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0622&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0903&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0904&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0905&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0906&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0927&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1001&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1002&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1003&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1004&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1005&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1006&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1007&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1010&#x27;</span>: <span class="number">0</span> &#125;,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;2016&#x27;</span>: &#123; <span class="string">&#x27;0101&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0102&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0103&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0206&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0207&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0208&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0209&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0210&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0211&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0212&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0213&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0214&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0402&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0403&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0404&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0430&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0501&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0502&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0609&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0610&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0611&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0612&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0915&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0916&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0917&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0918&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1001&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1002&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1003&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1004&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1005&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1006&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1007&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1008&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1009&#x27;</span>: <span class="number">0</span> &#125;,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;2017&#x27;</span>: &#123; <span class="string">&#x27;0101&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0102&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0122&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0127&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0128&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0129&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0130&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0131&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0201&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0202&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0204&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0401&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0402&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0403&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0404&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0429&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0430&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0501&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0527&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0528&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0529&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0530&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0930&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1001&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1002&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1003&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1004&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1005&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1006&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1007&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1008&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1230&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1231&#x27;</span>: <span class="number">1</span> &#125;,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;2018&#x27;</span>: &#123; <span class="string">&#x27;0101&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0211&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0215&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0216&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0217&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0218&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0219&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0220&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0221&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0224&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0405&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0406&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0407&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0408&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0428&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0429&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0430&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0501&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0616&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0617&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0618&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0922&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0923&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0924&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0929&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0930&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1001&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1002&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1003&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1004&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1005&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1006&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1007&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1229&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1230&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1231&#x27;</span>: <span class="number">1</span> &#125;,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;2019&#x27;</span>: &#123; <span class="string">&#x27;0101&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0202&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0203&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0204&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0205&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0206&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0207&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0208&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0209&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0210&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0405&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0406&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0407&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0428&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0501&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0502&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0503&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0504&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0505&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;0607&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0608&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0609&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0913&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0914&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0915&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;0929&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1001&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1002&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1003&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1004&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1005&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1006&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1007&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;1012&#x27;</span>: <span class="number">0</span> &#125;</span></span><br><span class="line">                &#125;;</span><br><span class="line"><span class="javascript">                <span class="comment">//获取日期数据</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> getDateObj = <span class="function"><span class="keyword">function</span> (<span class="params">year, month, day</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> date = <span class="built_in">arguments</span>.length &amp;&amp; year ? <span class="keyword">new</span> <span class="built_in">Date</span>(year, month - <span class="number">1</span>, day) : <span class="keyword">new</span> <span class="built_in">Date</span>();</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;year&#x27;</span>: date.getFullYear(),</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;month&#x27;</span>: date.getMonth() + <span class="number">1</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;day&#x27;</span>: date.getDate(),</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;week&#x27;</span>: date.getDay()</span></span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;;</span><br><span class="line"><span class="javascript">                <span class="comment">//当天</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> _today = getDateObj();</span></span><br><span class="line"><span class="javascript">                <span class="comment">//获取当月天数</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> getMonthDays = <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> day = <span class="keyword">new</span> <span class="built_in">Date</span>(obj.year, obj.month, <span class="number">0</span>);</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span> day.getDate();</span></span><br><span class="line">                &#125;;</span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (!<span class="built_in">String</span>.prototype.trim) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">String</span>.prototype.trim = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> <span class="built_in">this</span>.replace(<span class="regexp">/^\s+|\s+$/g</span>, <span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="comment">//获取某天日期信息</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> getDateInfo = <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> info = calendar.solar2lunar(obj.year, obj.month, obj.day);</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> cMonth = info.cMonth &gt; <span class="number">9</span> ? <span class="string">&#x27;&#x27;</span> + info.cMonth : <span class="string">&#x27;0&#x27;</span> + info.cMonth;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> cDay = info.cDay &gt; <span class="number">9</span> ? <span class="string">&#x27;&#x27;</span> + info.cDay : <span class="string">&#x27;0&#x27;</span> + info.cDay;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> lMonth = info.lMonth &gt; <span class="number">9</span> ? <span class="string">&#x27;&#x27;</span> + info.lMonth : <span class="string">&#x27;0&#x27;</span> + info.lMonth;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> lDay = info.lDay &gt; <span class="number">9</span> ? <span class="string">&#x27;&#x27;</span> + info.lDay : <span class="string">&#x27;0&#x27;</span> + info.lDay;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> code1 = cMonth + cDay;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> code2 = cMonth + <span class="built_in">Math</span>.ceil(info.cDay / <span class="number">7</span>) + info.nWeek % <span class="number">7</span>;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> code3 = lMonth + lDay;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> days = getMonthDays(obj);</span></span><br><span class="line"><span class="javascript">                    <span class="comment">//节日信息</span></span></span><br><span class="line"><span class="javascript">                    info[<span class="string">&#x27;festival&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line">                    if (_festival3[code3]) &#123;</span><br><span class="line"><span class="javascript">                        info[<span class="string">&#x27;festival&#x27;</span>] += _festival3[code3];</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    if (_festival1[code1]) &#123;</span><br><span class="line"><span class="javascript">                        info[<span class="string">&#x27;festival&#x27;</span>] += <span class="string">&#x27; &#x27;</span> + _festival1[code1];</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    if (_festival2[code2]) &#123;</span><br><span class="line"><span class="javascript">                        info[<span class="string">&#x27;festival&#x27;</span>] += <span class="string">&#x27; &#x27;</span> + _festival2[code2];</span></span><br><span class="line">                    &#125;</span><br><span class="line"><span class="javascript">                    <span class="keyword">if</span> (obj[<span class="string">&#x27;day&#x27;</span>] + <span class="number">7</span> &gt; days) &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> code4 = cMonth + <span class="number">5</span> + info.nWeek % <span class="number">7</span>;</span></span><br><span class="line">                        if (code4 != code2 &amp;&amp; _festival2[code4]) &#123;</span><br><span class="line"><span class="javascript">                            info[<span class="string">&#x27;festival&#x27;</span>] += <span class="string">&#x27; &#x27;</span> + _festival2[code4];</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="javascript">                    info[<span class="string">&#x27;festival&#x27;</span>] = info[<span class="string">&#x27;festival&#x27;</span>].trim();</span></span><br><span class="line"><span class="javascript">                    <span class="comment">//放假、调休等标记</span></span></span><br><span class="line"><span class="javascript">                    info[<span class="string">&#x27;sign&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line">                    if (_holiday[info.cYear]) &#123;</span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> holiday = _holiday[info.cYear];</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (<span class="keyword">typeof</span> holiday[code1] != <span class="string">&#x27;undefined&#x27;</span>) &#123;</span></span><br><span class="line"><span class="javascript">                            info[<span class="string">&#x27;sign&#x27;</span>] = holiday[code1] ? <span class="string">&#x27;holiday&#x27;</span> : <span class="string">&#x27;work&#x27;</span>;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (info.cYear == _today.year &amp;&amp; info.cMonth == _today.month &amp;&amp; info.cDay == _today.day) &#123;</span><br><span class="line"><span class="javascript">                        info[<span class="string">&#x27;sign&#x27;</span>] = <span class="string">&#x27;today&#x27;</span>;</span></span><br><span class="line">                    &#125;</span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span> info;</span></span><br><span class="line">                &#125;;</span><br><span class="line"><span class="javascript">                <span class="comment">//获取日历信息</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> (<span class="function"><span class="keyword">function</span> (<span class="params">date</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> date = date || _today;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> first = getDateObj(date[<span class="string">&#x27;year&#x27;</span>], date[<span class="string">&#x27;month&#x27;</span>], <span class="number">1</span>);		<span class="comment">//当月第一天</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> days = getMonthDays(date);							<span class="comment">//当月天数</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> data = [];										<span class="comment">//日历信息</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> obj = &#123;&#125;;</span></span><br><span class="line"><span class="javascript">                    <span class="comment">//上月日期</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = first[<span class="string">&#x27;week&#x27;</span>]; i &gt; <span class="number">0</span>; i--) &#123;</span></span><br><span class="line"><span class="javascript">                        obj = getDateObj(first[<span class="string">&#x27;year&#x27;</span>], first[<span class="string">&#x27;month&#x27;</span>], first[<span class="string">&#x27;day&#x27;</span>] - i);</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> info = getDateInfo(obj);</span></span><br><span class="line"><span class="javascript">                        info[<span class="string">&#x27;disabled&#x27;</span>] = <span class="number">1</span>;</span></span><br><span class="line">                        data.push(info);</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="javascript">                    <span class="comment">//当月日期</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; days; i++) &#123;</span></span><br><span class="line">                        obj = &#123;</span><br><span class="line"><span class="javascript">                            <span class="string">&#x27;year&#x27;</span>: first[<span class="string">&#x27;year&#x27;</span>],</span></span><br><span class="line"><span class="javascript">                            <span class="string">&#x27;month&#x27;</span>: first[<span class="string">&#x27;month&#x27;</span>],</span></span><br><span class="line"><span class="javascript">                            <span class="string">&#x27;day&#x27;</span>: first[<span class="string">&#x27;day&#x27;</span>] + i,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&#x27;week&#x27;</span>: (first[<span class="string">&#x27;week&#x27;</span>] + i) % <span class="number">7</span></span></span><br><span class="line">                        &#125;;</span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> info = getDateInfo(obj);</span></span><br><span class="line"><span class="javascript">                        info[<span class="string">&#x27;disabled&#x27;</span>] = <span class="number">0</span>;</span></span><br><span class="line">                        data.push(info);</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="javascript">                    <span class="comment">//下月日期</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> last = obj;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; last[<span class="string">&#x27;week&#x27;</span>] + i &lt; <span class="number">7</span>; i++) &#123;</span></span><br><span class="line"><span class="javascript">                        obj = getDateObj(last[<span class="string">&#x27;year&#x27;</span>], last[<span class="string">&#x27;month&#x27;</span>], last[<span class="string">&#x27;day&#x27;</span>] + i);</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> info = getDateInfo(obj);</span></span><br><span class="line"><span class="javascript">                        info[<span class="string">&#x27;disabled&#x27;</span>] = <span class="number">1</span>;</span></span><br><span class="line">                        data.push(info);</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;date&#x27;</span>: getDateInfo(date),				<span class="comment">//当前日历选中日期</span></span></span><br><span class="line"><span class="javascript">                        <span class="string">&#x27;data&#x27;</span>: data</span></span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;)();</span><br><span class="line"></span><br><span class="line"><span class="javascript">            <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(getData(&#123; <span class="string">&#x27;year&#x27;</span>: <span class="number">2019</span>, <span class="string">&#x27;month&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;day&#x27;</span>: <span class="number">14</span> &#125;))</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;test()&quot;</span>&gt;</span>日历信息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-04-28T18:04:24.000Z" title="4/28/2019, 6:04:24 PM">2019-04-28</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">3 分钟读完 (大约474个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/04/28/markdown-help/">Markdown 语法指南</a></h1><div class="content"><h1 id="Markdown-语法指南"><a href="#Markdown-语法指南" class="headerlink" title="Markdown 语法指南"></a>Markdown 语法指南</h1><blockquote>
<p><a target="_blank" rel="noopener" href="http://commonmark.org/help/">语法详解</a></p>
</blockquote>
<h2 id="粗体"><a href="#粗体" class="headerlink" title="粗体"></a><strong>粗体</strong></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">**粗体**</span><br><span class="line">__粗体__</span><br></pre></td></tr></table></figure>
<h2 id="斜体"><a href="#斜体" class="headerlink" title="斜体"></a><em>斜体</em></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*斜体*</span><br><span class="line">_斜体_</span><br></pre></td></tr></table></figure>
<h2 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 一级标题 #</span><br><span class="line">一级标题</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">## 二级标题 ##</span><br><span class="line">二级标题</span><br><span class="line">----</span><br><span class="line">### 三级标题 ###</span><br><span class="line">#### 四级标题 ####</span><br><span class="line">##### 五级标题 #####</span><br><span class="line">###### 六级标题 ######</span><br></pre></td></tr></table></figure>
<h2 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">***</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="上-角下标"><a href="#上-角下标" class="headerlink" title="^上^角下标"></a>^上^角<del>下</del>标</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">上角标 x^2^</span><br><span class="line">下角标 H~2~0</span><br></pre></td></tr></table></figure>
<h2 id="下划线-中划线"><a href="#下划线-中划线" class="headerlink" title="++下划线++ 中划线"></a>++下划线++ <del>中划线</del></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">++下划线++</span><br><span class="line">~~中划线~~</span><br></pre></td></tr></table></figure>
<h2 id="标记"><a href="#标记" class="headerlink" title="==标记=="></a>==标记==</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;标记&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>
<h2 id="段落引用"><a href="#段落引用" class="headerlink" title="段落引用"></a>段落引用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; 一级</span><br><span class="line">&gt;&gt; 二级</span><br><span class="line">&gt;&gt;&gt; 三级</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">有序列表</span><br><span class="line">1.</span><br><span class="line">2.</span><br><span class="line">3.</span><br><span class="line">...</span><br><span class="line">无序列表</span><br><span class="line">-</span><br><span class="line">-</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="任务列表"><a href="#任务列表" class="headerlink" title="任务列表"></a>任务列表</h2><ul>
<li><input checked="" disabled="" type="checkbox"> 已完成任务</li>
<li><input disabled="" type="checkbox"> 未完成任务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- [x] 已完成任务</span><br><span class="line">- [ ] 未完成任务</span><br></pre></td></tr></table></figure>

<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[链接](www.baidu.com)</span><br><span class="line">![图片描述](http:&#x2F;&#x2F;www.image.com)</span><br></pre></td></tr></table></figure>
<h2 id="代码段落"><a href="#代码段落" class="headerlink" title="代码段落"></a>代码段落</h2><p>``` type</p>
<p>代码段落</p>
<p>```</p>
<p>` 代码块 `</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello world!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>code</code></p>
<h2 id="表格-table"><a href="#表格-table" class="headerlink" title="表格(table)"></a>表格(table)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| 标题1 | 标题2 | 标题3 |</span><br><span class="line">| :--  | :--: | ----: |</span><br><span class="line">| 左对齐 | 居中 | 右对齐 |</span><br><span class="line">| ---------------------- | ------------- | ----------------- |</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">标题1</th>
<th align="center">标题2</th>
<th align="right">标题3</th>
</tr>
</thead>
<tbody><tr>
<td align="left">左对齐</td>
<td align="center">居中</td>
<td align="right">右对齐</td>
</tr>
<tr>
<td align="left">———————-</td>
<td align="center">————-</td>
<td align="right">—————–</td>
</tr>
</tbody></table>
<h2 id="脚注-footnote"><a href="#脚注-footnote" class="headerlink" title="脚注(footnote)"></a>脚注(footnote)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello[^hello]</span><br></pre></td></tr></table></figure>

<p>见底部脚注<a href="%E4%B8%80%E4%B8%AA%E6%B3%A8%E8%84%9A">^hello</a></p>
<h2 id="表情-emoji"><a href="#表情-emoji" class="headerlink" title="表情(emoji)"></a>表情(emoji)</h2><p><a target="_blank" rel="noopener" href="https://www.webpagefx.com/tools/emoji-cheat-sheet/">参考网站: https://www.webpagefx.com/tools/emoji-cheat-sheet/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:laughing:</span><br><span class="line">:blush:</span><br><span class="line">:smiley:</span><br><span class="line">:)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>:laughing::blush::smiley::)</p>
<h2 id="KaTeX-公式"><a href="#KaTeX-公式" class="headerlink" title="$\KaTeX$公式"></a>$\KaTeX$公式</h2><p>我们可以渲染公式例如：$x_i + y_i = z_i$和$\sum_{i=1}^n a_i=0$<br>我们也可以单行渲染<br>$$\sum_{i=1}^n a_i=0$$<br>具体可参照<a target="_blank" rel="noopener" href="http://www.intmath.com/cg5/katex-mathjax-comparison.php">katex文档</a>和<a target="_blank" rel="noopener" href="https://github.com/Khan/KaTeX/wiki/Function-Support-in-KaTeX">katex支持的函数</a>以及<a target="_blank" rel="noopener" href="https://math.meta.stackexchange.com/questions/5020/mathjax-basic-tutorial-and-quick-reference">latex文档</a></p>
<h2 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h2><p>::: hljs-left<br><code>::: hljs-left</code><br><code>居左</code><br><code>:::</code><br>:::</p>
<p>::: hljs-center<br><code>::: hljs-center</code><br><code>居中</code><br><code>:::</code><br>:::</p>
<p>::: hljs-right<br><code>::: hljs-right</code><br><code>居右</code><br><code>:::</code><br>:::</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>术语一</p>
<p>:   定义一</p>
<p>包含有<em>行内标记</em>的术语二</p>
<p>:   定义二</p>
<pre><code>    &#123;一些定义二的文字或代码&#125;

定义二的第三段
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">术语一</span><br><span class="line"></span><br><span class="line">:   定义一</span><br><span class="line"></span><br><span class="line">包含有*行内标记*的术语二</span><br><span class="line"></span><br><span class="line">:   定义二</span><br><span class="line"></span><br><span class="line">        &#123;一些定义二的文字或代码&#125;</span><br><span class="line"></span><br><span class="line">    定义二的第三段</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="abbr"><a href="#abbr" class="headerlink" title="abbr"></a>abbr</h2><p>*[HTML]: Hyper Text Markup Language<br>*[W3C]:  World Wide Web Consortium<br>HTML 规范由 W3C 维护</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*[HTML]: Hyper Text Markup Language</span><br><span class="line">*[W3C]:  World Wide Web Consortium</span><br><span class="line">HTML 规范由 W3C 维护</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-04-28T12:15:05.000Z" title="4/28/2019, 12:15:05 PM">2019-04-28</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 小时读完 (大约22289个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/04/28/the-little-go-book/">Go 简易教程</a></h1><div class="content"><h1 id="关于本书"><a href="#关于本书" class="headerlink" title="关于本书"></a>关于本书</h1><h2 id="授权许可"><a href="#授权许可" class="headerlink" title="授权许可"></a>授权许可</h2><p>本书中的内容使用 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>（署名 - 非商业性使用 - 相同方式共享4.0许可协议）授权。你不必为此书付费。<br>你可以免费的复制、发布、修改或者展示此书。但是，这本书的版权归原作者Karl Seguin所有，不要将此书用于商业目的。</p>
<p>关于许可证的全部内容你可以浏览以下网站：</p>
<p><a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">http://creativecommons.org/licenses/by-nc-sa/4.0/</a></p>
<h2 id="最新版本"><a href="#最新版本" class="headerlink" title="最新版本"></a>最新版本</h2><p>这本书的最新版本可以在以下网站获得:<br><a target="_blank" rel="noopener" href="http://github.com/karlseguin/the-little-go-book">http://github.com/karlseguin/the-little-go-book</a></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>每次提起学习一门新语言，我真的是又爱又恨。一方面，语言是我们的行事之本，即使一些小的变化都会对事情有重大的影响。可能有时一闪而过的 <em>灵感</em> 就会对你如何编程产生长久的影响力，并重新定义你对其他语言的期望。而头疼的是，语言的设计是呈增量式的，要学习新的关键字、类型系统、代码风格以及新的库、社区和范例真的是难言其苦。相比于所有其他必须学习的事情，花时间在一门新的语言上貌似真的是很糟糕的投资。</p>
<p>即便如此，我们还是得走下去。我们 <em>必须</em> 得乐于每天一点点地进步，因为“语言是我们的行事之本”。虽然语言的变化往往会是循序渐进的，但它影响范围仍然很广，包括了有生产率、可读性、性能、可测试性、依赖性管理、错误处理、文档、简要、社区、标准库等等。所以，有好点的说法来形容 <em>千刀万剐</em> 么？</p>
<p> 留给我们一个重要问题就是：为什么选择 <strong>Go?</strong> 。对于我来说，有两条原因。第一条，它是一种相对简单的语言，且具有相对简单的标准库。在很多方面，Go 的特性语法是为了简化我们在过去几十年中添加到编程语言中的一些复杂特性。另外一条原因就是对于许多开发者来说，它将补充您的知识面。</p>
<p>Go 是作为系统语言（例如：操作系统，设备驱动程序）创建的，因此它针对的是 C 和 C++ 开发人员。按照 Go 团队的说法，应用程序开发人员已经成为 Go 的主要用户而不是系统开发人员了，这个说法我也是相信的。为什么？我不能权威的代表系统开发人员说话，但对于我们这些构建网站，服务，桌面应用程序等的人来说，它可以部分的归结为对一类系统的新兴需求，这类系统介于低级系统应用程序和更高级的应用程序之间。</p>
<p>可能 Go 语言有消息传递机制，缓存，重计算数据分析，命令行接口，体制和监控，我不知道给 Go 语言什么样的标签，但是在我的职业生涯中，随着系统的复杂性不断增加，以及动辄成千上万的并发，显然对定制基础类型系统的需求不断增加。你可以使用 Ruby 或者 Python 构建这样的系统（大多人都这样做），但这些类型的系统可以从更严格的类型系统和更高的性能中受益。类似地，你可以使用 Go 来构建网站（很多人都愿意这样做），但我仍然喜欢 Node 或者 Ruby 对这类系统展现出的表现力。</p>
<p>Go 语言还擅长其他领域。比如，当运行一个编译过的 Go 程序时，他没有依赖性。你不必担心用户是安装了 Ruby 或者 JVM，如果这样，你还要考虑版本。出于这个原因，Go  作为命令行程序以及其他并发类型的工具（日志收集器）的开发语言变得越来越流行。</p>
<p>坦白来说，学习 Go 可以有效利用你的时间。你不必担心会花费很长时间学习 Go 甚至掌握它，你最终会从你的努力中得到一些实用的东西。</p>
<h2 id="作者注解"><a href="#作者注解" class="headerlink" title="作者注解"></a>作者注解</h2><p>对于写这本书我犹豫再三，主要有两个原因。第一个是 Go 有自己的文档，特别是 <a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html">Effective Go</a>。</p>
<p>另一个是在写一本关于语言类的书的时候我会有点不安。当我们写 《 The Little MongoDB Book》 这本书的时候，我完全假设大多数读者已经理解了关系型数据库和建模的基本知识。在写 《The Little Redis Book》这本书的时候，你也可以同样假设读者已经熟悉键值存储。</p>
<p>在我考虑未来的某些章节的时候，我知道不能再做出同样的假设。你花多长时间学习并理解接口，这是个新的概念，我希望你从中学到的不仅仅是 <strong>Go 有提供接口</strong>，并且还有如何使用它们。最终，我希望你向我反馈本书的哪部分讲得太细或者太粗，我会感到很欣慰，也算是我对读者们的小小要求了。</p>
<h1 id="第一章-·-基础"><a href="#第一章-·-基础" class="headerlink" title="第一章 · 基础"></a>第一章 · 基础</h1><h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><p>如果你想去尝试运行 Go 的代码，你可以去看看  <a target="_blank" rel="noopener" href="https://play.golang.org/">Go Playground</a>  ,它可以在线运行你的代码并且不要安装任何东西。这也是你在 <a target="_blank" rel="noopener" href="https://groups.google.com/forum/#!forum/golang-nuts">Go 的论坛区</a>和 StackOverflow 等地方寻求帮助时分享 Go 代码的最常用方法。</p>
<p>Go 的安装很简单。你可以用源码去安装，但是我还是建议你使用其中一个预编译的二进制文件。当你 <a target="_blank" rel="noopener" href="https://golang.org/dl/">跳转到下载页面</a>，你将会看到 Go 语言的在各个平台上的安装包。我们会避免这些东西并且学会如何在自己的平台上安装好 Go。正如你所看到的的那样，安装 Go 并不是很难。</p>
<p>除了一些简单的例子， Go 被设计成代码在工作区内运行。工作区是一个文件夹，这个文件夹由 <code>bin</code> ，<code>pkg</code>，以及<code>src</code>子文件夹组成的。你可能会试图强迫 Go 遵循自己的风格-不要这么去做。</p>
<p>一般，我把我的项目放在 <code>~/code</code> 文件夹下。比如，<code>~/code/blog</code> 目录就包含了我的 blog 项目。对于 Go 来说，我的工作区域就是 <code>~/code/go</code> ，然后我的 Go 写的项目代码就在 <code>~/code/go/src/blog</code> 文件夹下。</p>
<p>简单来说，无论你希望把你的项目放在哪里，你最好创建一个 <code>go</code> 的文件夹，再在里面创建一个 <code>src</code> 的子文件夹。</p>
<h3 id="OSX-Linux-系统安装-Go"><a href="#OSX-Linux-系统安装-Go" class="headerlink" title="OSX / Linux 系统安装 Go"></a>OSX / Linux 系统安装 Go</h3><p>下载适合你自己电脑系统的 <code>tar.gz</code> 文件。对于 OSX 系统来说，你可能会对 <code>go#.#.#.darwin-amd64-osx10.8.tar.gz</code> 感兴趣，其中 <code>#.#.#</code> 代表 Go 的最新版本号。</p>
<p>通过  <code>tar -C /usr/local -xzf go#.#.#.darwin-amd64-osx10.8.tar.gz</code> 命令将文件加压缩到 <code>/usr/local</code> 目录下</p>
<p>设置两个环境变量：</p>
<p>1.<code>GOPATH</code> 指向的是你的工作目录，对我来说，那个目录就是 <code>$HOME/code/go</code><br>2.我们需要将 Go 的二进制文件添加到的 <code>PATH</code>变量中。 </p>
<p>你可以通过下面的 shell 去设置这两个环境变量：</p>
<pre><code>echo &#39;export GOPATH=$HOME/code/go&#39; &gt;&gt; $HOME/.profile
echo &#39;export PATH=$PATH:/usr/local/go/bin&#39; &gt;&gt; $HOME/.profile
</code></pre>
<p>你需要将这些环境变量激活。你可以关掉 shell 终端，然后在打开 shell 终端，或者你可以在 shell 终端运行 <code>source $HOME/.profile</code>。</p>
<p>在命令终端输入 <code>go version</code>，你将会得到一个 <code>go version go1.3.3 darwin / amd64</code> 的输出，Go 就安装完成了。</p>
<h3 id="Windows-系统"><a href="#Windows-系统" class="headerlink" title="Windows 系统"></a>Windows 系统</h3><p>下载最新的 zip 文件。如果你的电脑是 64 位的系统，你将需要 <code>go#.#.#.windows-amd64.zip</code> ，这里的  <code>#.#.#</code> 是 Go 的最新版本号。</p>
<p>解压缩  <code>go#.#.#.windows-amd64.zip</code> 文件到你选择的位置。 <code>c:\Go</code>这个位置是个不错的选择。</p>
<p>在系统中设置两个环境变量：</p>
<ol>
<li> <code>GOPATH</code> 同样的指向的是你的工作目录。这个变量看起来像<code>c:\users\goku\work\go</code> 这个样子。</li>
<li>添加 <code>c:\Go\bin</code>  到系统的 <code>PATH</code> 环境变量。</li>
</ol>
<p>你可以通过「系统」 控制面板的 「高级」 选项卡上的 「环境变量」按钮设置环境变量。 某些版本的 Windows 通过「系统」控制面板中的「高级系统选项」选项此控制面板。</p>
<p>打开一个 <code>cmd</code> 命令终端，输入 <code>go version</code>。 你会得到一个 <code>go version go1.3.3 windows/amd64</code> 的输出，即表示 Go 安装完成。</p>
<p>Go 是一门编译型，具有静态类型和类 C 语言语法的语言，并且有垃圾回收（GC）机制。这是什么意思？</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>编译是将源代码翻译为更加低级的语言的过程——翻译成汇编语言（例如 Go），或是翻译成其他中间语言（如 Java 和 C#）。</p>
<p>编译型语言可能会让你很不爽，因为编译过程实在是太慢了。如果每次都需要花好几分钟甚至好几个小时去等待代码编译的话，很难进行快速迭代。而编译速度是 Go 的主要优化目标之一。这对我们这些从事大型项目开发或者是习惯用解释型快速看到程序结果的人来说，确实是一件好事。</p>
<p>编译型语言注重于运行速度和无依赖执行程序（至少对于 C/C++ 和 Go 来说是这样的，直接将依赖编译到程序中）。</p>
<h2 id="静态类型"><a href="#静态类型" class="headerlink" title="静态类型"></a>静态类型</h2><p>静态类型意味着变量必须是特定的类型（如：int, string, bool, []byte 等等），这可以通过在声明变量的时候，指定变量的类型来实现，或者让编译器自行推断变量的类型（我们将很快可以看到实例）。</p>
<p>关于静态类型的东西，可以说的还有很多，但是我相信通过看代码能更好的理解静态类型是什么。如果你习惯于动态类型语言， 你可能会发现这很麻烦。这种想法没错，但是静态类型语言也有优点，特别是当你将静态类型和编译配对使用时。这两者经常混为一谈。确实当你有其中一个的时候，通常也会有另一个，但是这不是硬性规定的。使用强类型系统，编译器能够检测除语法错误之外的问题从而进一步优化。</p>
<h2 id="类-C-语法"><a href="#类-C-语法" class="headerlink" title="类 C 语法"></a>类 C 语法</h2><p>当说到一门语言是类 C 语法的时候，通常意味着如果你用过其他类 C 语言如：C，C++，Java，JavaScript 和 C#，你会觉得 Go 的语法很熟悉——最少表面上是这样的。举个例子，<code>&amp;&amp;</code> 用于逻辑 AND，<code>==</code> 用于判断是否相等，<code>&#123;</code> 和 <code>&#125;</code> 是块的开始和结束，数组下标的起始值为 0。</p>
<p>类 Ｃ 语法也倾向于用分号表示作为语句结束符，并将条件写在括号中。Go 不支持这些，但是仍然使用括号来控制优先级。例如，一个 <code>if</code> 语句是这样的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> name == <span class="string">&quot;Leto&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;the spice must flow&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在很多复杂系统中，括号符还是很有用的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (name == <span class="string">&quot;Goku&quot;</span> &amp;&amp; power &gt; <span class="number">9000</span>) || (name == <span class="string">&quot;gohan&quot;</span> &amp;&amp; power &lt; <span class="number">4000</span>)  &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;super Saiyan&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除此之外，Go 要比 C# 或 Java 更接近 C - 不仅是语法方面，还有目的方面。这反映在语言的简洁和简单上，希望你在学习它的时候能慢慢体会这一点。</p>
<h2 id="变量和申明"><a href="#变量和申明" class="headerlink" title="变量和申明"></a>变量和申明</h2><p>如果我们用 x = 4 来申明和赋值变量，那么我们就可以同时开始和结束对变量的查看了。遗憾的是，Go 更为复杂些。我们将通过简单的示例来开始我们的学习。然后，在下一章中，我们会在创建和使用结构体时，进一步扩展。尽管如此，你可能还得花一段时间来适应，才能感受到它带给你的舒适感。</p>
<p>你可能会想：“哇！这有什么复杂的？”。 让我们开始一个例子。</p>
<p>下面的例子是 Go 中，申明变量和赋值最为明确的方法，但也是最为冗长的方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> power <span class="keyword">int</span></span><br><span class="line">  power = <span class="number">9000</span></span><br><span class="line">  fmt.Printf(<span class="string">&quot;It&#x27;s over %d\n&quot;</span>, power)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们定义了一个 <code>int</code> 类型的变量 <code>power</code>。默认情况下，Go 会为变量分配默认值。Integers 的默认值是 <code>0</code>，booleans 默认值是 <code>false</code>，strings 默认值是 <code>&quot;&quot;</code> 等等。下面，我们创建一个值为 <code>9000</code> 的名为 <code>power</code> 的变量。我们可以将定义和赋值两行代码合并起来：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> power <span class="keyword">int</span> = <span class="number">9000</span></span><br></pre></td></tr></table></figure>

<p>不过，这么写太长了。Go 提供了一个方便的短变量声明运算符 <code>:=</code> ，它可以自动推断变量类型：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">power := <span class="number">9000</span></span><br></pre></td></tr></table></figure>

<p>这非常方便，它可以跟函数结合使用，就像这样：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  power := getPower()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getPower</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">9001</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>值得注意的是要用 <code>:=</code> 来声明变量以及给变量赋值。相同变量不能被声明两次（在相同作用域下），如果你尝试这样，会收到错误提示。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  power := <span class="number">9000</span></span><br><span class="line">  fmt.Printf(<span class="string">&quot;It&#x27;s over %d\n&quot;</span>, power)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编译器错误：</span></span><br><span class="line">  <span class="comment">//  := 左侧不是新的变量</span></span><br><span class="line">  power := <span class="number">9001</span></span><br><span class="line">  fmt.Printf(<span class="string">&quot;It&#x27;s also over %d\n&quot;</span>, power)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编辑器会告诉你 * := 左侧不是新的变量*。这就意味着当我们首次声明一个变量时应该使用 <code>:=</code> ，后面再给变量赋值时应该使用 <code>=</code>。这似乎很有道理，但是凭空来记忆且需要根据情况来切换却是很难的事。</p>
<p>如果你仔细阅读代码的错误信息，你会发现 <em>variables</em> 单词是个复数，即有多个变量，那是因为go支持多个变量同时赋值（使用 <code>=</code> 或者 <code>:=</code>）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  name, power := <span class="string">&quot;Goku&quot;</span>, <span class="number">9000</span></span><br><span class="line">  fmt.Printf(<span class="string">&quot;%s&#x27;s power is over %d\n&quot;</span>, name, power)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，多个变量赋值的时候，只要其中有一个变量是新的，就可以使用<code>:=</code>。例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  power := <span class="number">1000</span></span><br><span class="line">  fmt.Printf(<span class="string">&quot;default power is %d\n&quot;</span>, power)</span><br><span class="line"></span><br><span class="line">  name, power := <span class="string">&quot;Goku&quot;</span>, <span class="number">9000</span></span><br><span class="line">  fmt.Printf(<span class="string">&quot;%s&#x27;s power is over %d\n&quot;</span>, name, power)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尽管变量 <code>power</code> 使用了两次<code>:=</code>，但是编译器不会在第 2 次使用 <code>:=</code>时报错，因为这里有一个新的 <code>name</code>变量，它可以使用<code>:=</code>。然后你不能改变 <code>power</code> 变量的类型，它已经被声明成一个整型，所以只能赋值整数。</p>
<p>到目前为止，你最后需要了解的一件事是，Go 会像 import 一样，不允许你在程序中拥有未使用的变量。例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  name, power := <span class="string">&quot;Goku&quot;</span>, <span class="number">1000</span></span><br><span class="line">  fmt.Printf(<span class="string">&quot;default power is %d\n&quot;</span>, power)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这将不会通过编译，因为 <code>name</code> 是一个被申明但是未被使用的变量，就像 import 的包未被使用时，也将会导致编译失败，但总的来说，我认为这有助于提高代码的清洁度和可读性。</p>
<p>还有更多关于的申明和赋值的技巧。初始化一个变量时，请使用：<code> var NAME TYPE</code>；给变量申明及赋值时，请使用： <code>NAME := VALUE</code> ； 给之前已经申明过的变量赋值时，请使用： <code>NAME = VALUE</code> </p>
<h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><p>一些变量，在创建的时候，就拥有一个简单定义的生命周期。对于函数中的变量，会在函数执行完后进行销毁。在别的语言中，对于编译器而言，这不会很明显。例如：函数返回的变量，或者由其他变量和对象所调用的变量，它们的生命周期是很难确定的。 如果没有垃圾回收机制，那么开发人员就得知道有哪些不需要用到的变量，并将它们释放。就像 C 语言，你需要使用 <code>free(str);</code> 来释放变量。 </p>
<p>语言的垃圾回收机制（像：Ruby, Python, Java, JavaScript, C# , Go）是会对变量进行跟踪，并在没有使用它们的时候，进行释放。垃圾回收会增加一些额外的开销，但是也减少了一些致命性的 BUG。</p>
<h2 id="运行-go-代码"><a href="#运行-go-代码" class="headerlink" title="运行 go 代码"></a>运行 go 代码</h2><p>创建一个简单的程序然后学习如何编译和运行它。打开你的文本编辑器写入下面的代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="built_in">println</span>(<span class="string">&quot;it&#x27;s over 9000!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保存文件并命名为 <code>main.go</code> 。 你可以将文件保存在任何地方；不必将这些琐碎的例子放在 go 的工作空间内。</p>
<p>接下来，打开一个 shell 或者终端提示符，进入到文件保存的目录内， 对于我而言， 应该输入 <code>cd ~/code</code> 进入到文件保存目录。</p>
<p>最后，通过敲入以下命令来运行程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go</span><br></pre></td></tr></table></figure>

<p>如果一切正常(即你的 golang 环境配置的正确)，你将看到 <em>it’s over 9000!</em> 。</p>
<p>但是编译步骤是怎么样的呢？ <code>go run</code> 命令已经包含了<strong>编译</strong>和<strong>运行</strong>。它使用一个临时目录来构建程序，执行完然后清理掉临时目录。你可以执行以下命令来查看临时文件的位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run --work main.go</span><br></pre></td></tr></table></figure>

<p>明确要编译代码的话，使用 <code>go build</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go build main.go</span><br></pre></td></tr></table></figure>

<p>这将产生一个可执行文件，名为 <code>main</code> ，你可以执行该文件。如果是在 Linux / OSX 系统中，别忘了使用 <code>./</code> 前缀来执行，也就是输入 <code>./main</code>  。</p>
<p>在开发中，你既可以使用 <code>go run</code> 也可以使用 <code>go build</code> 。但当你正式部署代码的时候，你应该部署通过 <code>go build</code> 产生的二进制文件并且执行它。</p>
<h3 id="入口函数-Main"><a href="#入口函数-Main" class="headerlink" title="入口函数 Main"></a>入口函数 Main</h3><p>希望刚才执行的代码是可以理解的。我们刚刚创建了一个函数，并且使用内置函数 <code>println</code> 打印出了字符串。难道仅因为这里只有一个选择，所以 <code>go run</code> 知道执行什么吗？？不。在 go 中程序入口必须是 <code>main</code> 函数，并且在 <code>main</code> 包内。</p>
<p>我们将在后面的章节中详细介绍<code>包</code>。目前，我们将专注于理解 go 基础，一直会在 <code>main</code> 包中写代码。</p>
<p>如果你想尝试，你可以修改代码并且可以更改包名。使用 <code>go run</code> 执行程序将出现一个错误。 接着你可以将包名改回 <code>main</code> ，换一个不同的方法名，你会看到一个不同的错误。尝试使用 <code>go build</code> 代替 <code>go run</code> 来执行刚才的代码，注意代码编译时，没有入口点可以执行。但当你构建一个库时，确实完全正确的。</p>
<h2 id="导入包"><a href="#导入包" class="headerlink" title="导入包"></a>导入包</h2><p>Go 有很多内建函数，例如 <code>println</code>，可以在没有引用情况下直接使用。但是，如果不使用 Go 的标准库直接使用第三方库，我们就无法走的更远。<code>import</code> 关键字被用于去声明文件中代码要使用的包。</p>
<p>修改下我们的程序：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) != <span class="number">2</span> &#123;</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  fmt.Println(<span class="string">&quot;It&#x27;s over&quot;</span>, os.Args[<span class="number">1</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以这样运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go 9000</span><br></pre></td></tr></table></figure>

<p>我们现在用了 Go 的两个标准包：<code>fmt</code> 和 <code>os</code> 。我们也介绍了另一个内建函数  <code>len</code> 。<code>len</code>  返回字符串的长度，字典值的数量，或者我们这里看到的，它返回了数组元素的数量。如果你想知道我们这里为什么期望得到两个参数，它是因为第一个参数 – 索引0处 – 总是当前可运行程序的路径。（更改程序将它打印出来亲自看看就知道了）</p>
<p>你可能注意到了，我们在函数名称前加上了前缀包名，例如，<code>fmt.PrintLn</code>。这是不同于其他很多语言的。后续的章节中我们将学习到更多关于包的知识。现在，知道如何导入以及使用一个包就是一个好的开始。</p>
<p>在 Go 中，关于导包是很严格的。如果你导入了一个包却没有使用将会导致编译不通过。尝试运行下面的程序：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你应该会得到两个关于 <code>fmt</code> 和 <code>os</code> 被导入却没有被使用的错误。这很烦人的是不是呀？绝对是这样的，不过随着时间的推移，你将慢慢习惯它（虽然仍然烦人，不过要以 Go 的思维写 Go）。Go 如此严格是因为没用的导入会降低编译速度；诚然，我们大多数人不会关注这个问题。</p>
<p>另一个需要记住的事情是 Go 的标准库已经有了很好的文档。你可以访问 <a target="_blank" rel="noopener" href="https://golang.org/pkg/fmt/#Println">https://golang.org/pkg/fmt/#Println</a> 去看更多关于 <code>PrintLn</code> 函数的信息。你可以点击那个部分的头去看源代码。另外，也可以滚动到顶部查看关于 Go 格式化功能的更多消息。</p>
<p>如果没有互联网，你可以这样在本地获取文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">godoc -http&#x3D;:6060</span><br></pre></td></tr></table></figure>

<p>然后浏览器中访问  <code>http://localhost:6060</code></p>
<h2 id="函数声明"><a href="#函数声明" class="headerlink" title="函数声明"></a>函数声明</h2><p>这是个好时机指出函数是可以返回多个值的。让我们看三个函数：一个没有返回值，一个有一个返回值，一个有两个返回值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(message <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">power</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以像这样使用最后一个：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">value, exists := power(<span class="string">&quot;goku&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> exists == <span class="literal">false</span> &#123;</span><br><span class="line">  <span class="comment">// 处理错误情况</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有时候，你仅仅关注其中一个返回值。这个情况下，你可以将其他的返回值赋值给空白符<code>_</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_, exists := power(<span class="string">&quot;goku&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> exists == <span class="literal">false</span> &#123;</span><br><span class="line">  <span class="comment">// handle this error case</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这不仅仅是一个惯例。<code>_</code> ，空白标识符，特殊在于实际上返回值并没有赋值。这让你可以一遍又一遍地使用 <code>_</code> 而不用管它的类型。</p>
<p>最后，关于函数声明还有些要说的。如果参数有相同的类型，您可以用这样一个简洁的用法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回多个值可能是你经常使用的，你也可能会频繁地使用 <code>_</code> 丢弃一个值。命名返回值和稍微冗长的参数声明不太常用。尽管如此，你将很快遇到他们，所以了解他们很重要。</p>
<h2 id="继续之前"><a href="#继续之前" class="headerlink" title="继续之前"></a>继续之前</h2><p>我们之前看了很多小的独立片段，在这点上，可能会感到有点脱节。我们将慢慢地构建更大的例子，将这些小的片段组合在一起。</p>
<p>如果你之前用的是动态类型语言，那么类型和声明的复杂性看起来像是在倒退。我并没有不同意你，在某些系统中动态语言可能更加有效。</p>
<p>如果你来自静态类型的语言，你可能对 Go 感到满意。类型推断以及多值返回的设计非常棒?（尽管这不是 Go 独有）。希望随着我们了解更多，你将会慢慢爱上这干净简洁的语法。</p>
<h1 id="第二章-·-结构体"><a href="#第二章-·-结构体" class="headerlink" title="第二章 · 结构体"></a>第二章 · 结构体</h1><p>Go 不是像 C ++，Java，Ruby和C＃一样的面向对象的（OO）语言。它没有对象和继承的概念，也没有很多与面向对象相关的概念，例如多态和重载。</p>
<p>Go所具有的是结构体的概念，可以将一些方法和结构体关联。Go 还支持一种简单但有效的组合形式。  总的来说，它会使代码变的更简单，但在某一些场合，你会错过面向对象提供的一些特性。（值得指出的是，通过组合实现继承是一场古老的战斗呐喊，Go 是我用过的第一种坚定立场的语言，在这个问题上。）</p>
<p>虽然 Go 不会像你以前使用的面向对象语言一样，但是你会注意到结构的定义和类的定义之间有很多相似之处。下面的代码定义了一个简单的 <code>Saiyan</code> 结构体：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Saiyan <span class="keyword">struct</span> &#123;</span><br><span class="line">  Name <span class="keyword">string</span></span><br><span class="line">  Power <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们将看明白怎么往这个结构体添加一个方法，就像面向对象类，会有方法作为 它的一部分。在这之前，我们先要知道如何申明结构体。</p>
<h2 id="声明和初始化"><a href="#声明和初始化" class="headerlink" title="声明和初始化"></a>声明和初始化</h2><p>当我们第一次看到变量和声明时，我们只看了内置类型，比如整数和字符串。既然现在我们要讨论结构，那么我们需要扩展讨论范围到指针。</p>
<p>创建结构的值的最简单的方式是：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">goku := Saiyan&#123;</span><br><span class="line">  Name: <span class="string">&quot;Goku&quot;</span>,</span><br><span class="line">  Power: <span class="number">9000</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>注意：</em> 上述结构末尾的逗号 <code>,</code> 是必需的。没有它的话，编译器就会报错。你将会喜欢上这种必需的一致性，尤其当你使用一个与这种风格相反的语言或格式的时候。 </p>
<p>我们不必设置所有或哪怕一个字段。下面这些都是有效的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">goku := Saiyan&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"></span><br><span class="line">goku := Saiyan&#123;Name: <span class="string">&quot;Goku&quot;</span>&#125;</span><br><span class="line">goku.Power = <span class="number">9000</span></span><br></pre></td></tr></table></figure>

<p>就像未赋值的变量其值默认为 0 一样，字段也是如此。</p>
<p>此外，你可以不写字段名，依赖字段顺序去初始化结构体 （但是为了可读性，你应该把字段名写清楚）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goku := Saiyan&#123;<span class="string">&quot;Goku&quot;</span>, <span class="number">9000</span>&#125;</span><br></pre></td></tr></table></figure>

<p>以上所有的示例都是声明变量 <code>goku</code> 并赋值。</p>
<p>许多时候，我们并不想让一个变量直接关联到值，而是让它的值为一个指针，通过指针关联到值。一个指针就是内存中的一个地址；指针的值就是实际值的地址。这是间接地获取值的方式。形象地来说，指针和实际值的关系就相当于房子和指向该房子的方向之间的关系。</p>
<p>为什么我们想要一个指针指向值而不是直接包含该值呢？这归结为 Go 中传递参数到函数的方式：就像复制。知道了这个，尝试理解一下下面的代码呢？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  goku := Saiyan&#123;<span class="string">&quot;Goku&quot;</span>, <span class="number">9000</span>&#125;</span><br><span class="line">  Super(goku)</span><br><span class="line">  fmt.Println(goku.Power)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Super</span><span class="params">(s Saiyan)</span></span> &#123;</span><br><span class="line">  s.Power += <span class="number">10000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面程序运行的结果是 9000，而不是 19000,。为什么？因为 <code>Super</code> 修改了原始值 <code>goku</code> 的复制版本，而不是它本身，所以，<code>Super</code> 中的修改并不影响上层调用者。现在为了达到你的期望，我们可以传递一个指针到函数中： </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  goku := &amp;Saiyan&#123;<span class="string">&quot;Goku&quot;</span>, <span class="number">9000</span>&#125;</span><br><span class="line">  Super(goku)</span><br><span class="line">  fmt.Println(goku.Power)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Super</span><span class="params">(s *Saiyan)</span></span> &#123;</span><br><span class="line">  s.Power += <span class="number">10000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一次，我们修改了两处代码。第一个是使用了 <code>&amp;</code> 操作符以获取值的地址（它就是 <em>取地址</em> 操作符）。然后，我们修改了 <code>Super</code> 参数期望的类型。它之前期望一个 <code>Saiyan</code> 类型，但是现在期望一个地址类型 <code>*Saiyan</code>，这里 <code>*X</code> 意思是 <em>指向类型 X 值的指针</em> 。很显然类型 <code>Saiyan</code> 和 <code>*Saiyan</code> 是有关系的，但是他们是不同的类型。</p>
<p>这里注意到我们仍然传递了一个 <code>goku</code> 的值的副本给 <code>Super</code>，但这时 <code>goku</code> 的值其实是一个地址。所以这个副本值也是一个与原值相等的地址，这就是我们间接传值的方式。想象一下，就像复制一个指向饭店的方向牌。你所拥有的是一个方向牌的副本，但是它仍然指向原来的饭店。</p>
<p>我们可以证实一下这是一个地址的副本，通过修改其指向的值（尽管这可能不是你真正想做的事情）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  goku := &amp;Saiyan&#123;<span class="string">&quot;Goku&quot;</span>, <span class="number">9000</span>&#125;</span><br><span class="line">  Super(goku)</span><br><span class="line">  fmt.Println(goku.Power)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Super</span><span class="params">(s *Saiyan)</span></span> &#123;</span><br><span class="line">  s = &amp;Saiyan&#123;<span class="string">&quot;Gohan&quot;</span>, <span class="number">1000</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码，又一次地输出 9000。就像许多语言表现的那样，包括  Ruby，Python， Java 和 C#，Go 以及部分的 C#，只是让这个事实变得更明显一些。</p>
<p>同样很明显的是，复制一个指针比复制一个复杂的结构的消耗小多了。在 64 位的机器上面，一个指针占据 64 bit 的空间。如果我们有一个包含很多字段的结构，创建它的副本将会是一个很昂贵的操作。指针的真正价值在于能够分享它所指向的值。我们是想让 <code>Super</code> 修改 <code>goku</code> 的副本还是修改共享的 <code>goku</code> 值本身呢？</p>
<p>所有这些并不是说你总应该使用指针。这章末尾，在我们见识了结构的更多功能以后，我们将重新检视 指针与值这个问题。</p>
<h2 id="结构体上的函数"><a href="#结构体上的函数" class="headerlink" title="结构体上的函数"></a>结构体上的函数</h2><p>我们可以把一个方法关联在一个结构体上：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Saiyan <span class="keyword">struct</span> &#123;</span><br><span class="line">  Name <span class="keyword">string</span></span><br><span class="line">  Power <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Saiyan)</span> <span class="title">Super</span><span class="params">()</span></span> &#123;</span><br><span class="line">  s.Power += <span class="number">10000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们可以这么理解，<code>*Saiyan</code> 类型是 <code>Super</code> 方法的<em>接受者</em>。然后我们可以通过下面的代码去调用 <code>Super</code> 方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">goku := &amp;Saiyan&#123;<span class="string">&quot;Goku&quot;</span>, <span class="number">9001</span>&#125;</span><br><span class="line">goku.Super()</span><br><span class="line">fmt.Println(goku.Power) <span class="comment">// 将会打印出 19001</span></span><br></pre></td></tr></table></figure>



<h2 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h2><p>结构体没有构造器。但是，你可以创建一个返回所期望类型的实例的函数（类似于工厂）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSaiyan</span><span class="params">(name <span class="keyword">string</span>, power <span class="keyword">int</span>)</span> *<span class="title">Saiyan</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;Saiyan&#123;</span><br><span class="line">    Name: name,</span><br><span class="line">    Power: power,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种模式以错误的方式惹恼了很多开发人员。一方面，这里有一点轻微的语法变化；另一方面，它确实感觉有点不那么明显。</p>
<p>我们的工厂不必返回一个指针；下面的形式是完全有效的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSaiyan</span><span class="params">(name <span class="keyword">string</span>, power <span class="keyword">int</span>)</span> <span class="title">Saiyan</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> Saiyan&#123;</span><br><span class="line">    Name: name,</span><br><span class="line">    Power: power,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="结构体的字段"><a href="#结构体的字段" class="headerlink" title="结构体的字段"></a>结构体的字段</h2><p>到目前为止的例子中，<code>Saiyan</code> 有两个字段 <code>Name</code> 和 <code>Power</code>，其类型分别为 <code>string</code> 和 <code>int</code>。字段可以是任何类型 – 包括其他结构体类型以及目前我们还没有提及的 array，maps，interfaces 和 functions 等类型。</p>
<p>例如，我们可以扩展 <code>Saiyan</code> 的定义：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Saiyan <span class="keyword">struct</span> &#123;</span><br><span class="line">  Name <span class="keyword">string</span></span><br><span class="line">  Power <span class="keyword">int</span></span><br><span class="line">  Father *Saiyan</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们通过下面的方式初始化：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gohan := &amp;Saiyan&#123;</span><br><span class="line">  Name: <span class="string">&quot;Gohan&quot;</span>,</span><br><span class="line">  Power: <span class="number">1000</span>,</span><br><span class="line">  Father: &amp;Saiyan &#123;</span><br><span class="line">    Name: <span class="string">&quot;Goku&quot;</span>,</span><br><span class="line">    Power: <span class="number">9001</span>,</span><br><span class="line">    Father: <span class="literal">nil</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="New"><a href="#New" class="headerlink" title="New"></a>New</h2><p>尽管缺少构造器，Go 语言却有一个内置的 <code>new</code> 函数，使用它来分配类型所需要的内存。 <code>new(X)</code> 的结果与 <code>&amp;X&#123;&#125;</code> 相同。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">goku := <span class="built_in">new</span>(Saiyan)</span><br><span class="line"><span class="comment">// same as</span></span><br><span class="line">goku := &amp;Saiyan&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>如何使用取决于你，但是你会发现大多数人更偏爱后一种写法无论是否有字段需要初始化，因为这看起来更具可读性：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">goku := <span class="built_in">new</span>(Saiyan)</span><br><span class="line">goku.name = <span class="string">&quot;goku&quot;</span></span><br><span class="line">goku.power = <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//vs</span></span><br><span class="line"></span><br><span class="line">goku := &amp;Saiyan &#123;</span><br><span class="line">  Name: <span class="string">&quot;goku&quot;</span>,</span><br><span class="line">  Power: <span class="number">9000</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无论你选择哪一种，如果你遵循上述的工厂模式，就可以保护剩余的代码而不必知道或担心内存分配细节</p>
<h2 id="组合"><a href="#组合" class="headerlink" title="组合"></a>组合</h2><p>Go 支持组合， 这是将一个结构包含进另一个结构的行为。在某些语言中，这种行为叫做 特质 或者 混合。 没有明确的组合机制的语言总是可以做到这一点。在 Java 中， 可以使用 <em>继承</em> 来扩展结构。但是在脚本中并没有这种选项， 混合将会被写成如下形式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Saiyan</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Saiyan 中包含着 person 对象</span></span><br><span class="line">  <span class="keyword">private</span> Person person;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将请求转发到 person 中</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.person.getName();</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这可能会非常繁琐。<code>Person</code> 的每个方法都需要在 <code>Saiyan</code> 中重复。Go 避免了这种复杂性：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">  Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">Introduce</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Printf(<span class="string">&quot;Hi, I&#x27;m %s\n&quot;</span>, p.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Saiyan <span class="keyword">struct</span> &#123;</span><br><span class="line">  *Person</span><br><span class="line">  Power <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用它</span></span><br><span class="line">goku := &amp;Saiyan&#123;</span><br><span class="line">  Person: &amp;Person&#123;<span class="string">&quot;Goku&quot;</span>&#125;,</span><br><span class="line">  Power: <span class="number">9001</span>,</span><br><span class="line">&#125;</span><br><span class="line">goku.Introduce()</span><br></pre></td></tr></table></figure>

<p><code>Saiyan</code>  结构体有一个 <code>Person</code> 类型的字段。由于我们没有显示地给它一个字段名，所以我们可以隐式地访问组合类型的字段和函数。然而，Go 编译器确实给了它一个字段，下面这样完全有效：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">goku := &amp;Saiyan&#123;</span><br><span class="line">  Person: &amp;Person&#123;<span class="string">&quot;Goku&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(goku.Name)</span><br><span class="line">fmt.Println(goku.Person.Name)</span><br></pre></td></tr></table></figure>

<p>上面两个都打印 「Goku」。</p>
<p>组合比继承更好吗？许多人认为它是一种更好的组织代码的方式。当使用继承的时候，你的类和超类紧密耦合在一起，你最终专注于结构而不是行为。</p>
<h2 id="指针类型和值类型"><a href="#指针类型和值类型" class="headerlink" title="指针类型和值类型"></a>指针类型和值类型</h2><p>当你写 Go 代码的时候，很自然就会去问自己 <em>应该是值还是指向值的指针呢？</em> 这儿有两个好消息，首先，无论我们讨论下面哪一项，答案都是一样的：</p>
<ul>
<li>局部变量赋值</li>
<li> 结构体指针</li>
<li>函数返回值</li>
<li>函数参数</li>
<li>方法接收器</li>
</ul>
<p>第二，如果你不确定，那就用指针咯。</p>
<p>正如我们已经看到的，传值是一个使数据不可变的好方法（函数中改变它不会反映到调用代码中）。有时，这是你想要的行为，但是通常情况下，不是这样的。</p>
<p>即使你不打算改变数据，也要考虑创建大型结构体副本的成本。相反，你可能有一些小的结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Point <span class="keyword">struct</span> &#123;</span><br><span class="line">  X <span class="keyword">int</span></span><br><span class="line">  Y <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种情况下，复制结构的成本能够通过直接访问 <code>X</code> 和 <code>Y</code> 来抵消，而没有其它任何间接操作。</p>
<p>还有，这些案例都是很微妙的，除非你迭代成千上万个这样的指针，否则你不会注意到差异。</p>
<h2 id="继续之前-1"><a href="#继续之前-1" class="headerlink" title="继续之前"></a>继续之前</h2><p>从实际的角度看，这章介绍了结构体，如何使一个结构体的实例成为函数的接收者，以及添加指针到现有的 Go 类型系统知识中。下面的章节将建立在我们已经了解了什么是结构体以及其内部工作原理之上。</p>
<h1 id="第三章-·-映射、数组和切片"><a href="#第三章-·-映射、数组和切片" class="headerlink" title="第三章 · 映射、数组和切片"></a>第三章 · 映射、数组和切片</h1><p>至此，我们已经学了一部分简单的类型和结构。现在，让我们开始学习 Arrays （数组）, Slices （切片） 和 Maps （映射） 吧。</p>
<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><p>如果你学过 Python , Ruby , Perl , JavaScript 或者 PHP （或者更多其它的语言），那么你肯定习惯 <em>动态数组</em> 编程啦。这些数组的长度可以在添加数据的时候自行调整的。在 Go 中，像其它大部分语言一样，数据的长度是固定的。我们在声明一个数组时需要指定它的长度，一旦指定了长度，那么它的长度值是不可以改变的了：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> scores [<span class="number">10</span>]<span class="keyword">int</span></span><br><span class="line">scores[<span class="number">0</span>] = <span class="number">339</span></span><br></pre></td></tr></table></figure>

<p>上面的数组最多可以容纳 10 个元素，索引是从 <code>scores[0]</code> 到 <code>scores[9]</code> 。试图访问超过界限的索引系统将会抛出编译或运行时错误。</p>
<p>我们可以在初始化数组的时候指定值：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scores := [<span class="number">4</span>]<span class="keyword">int</span>&#123;<span class="number">9001</span>, <span class="number">9333</span>, <span class="number">212</span>, <span class="number">33</span>&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以使用 <code>len</code> 函数来获取数组的长度。<code>range</code> 函数在遍历迭代的时候使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> index, value := <span class="keyword">range</span> scores &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数组非常高效但是很死板。很多时候，我们在事前并不知道数组的长多是多少。针对这个情况，slices （切片） 出来了。</p>
<h2 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h2><p>在Go语言中，我们很少直接使用数组。取而代之的是使用切片。切片是轻量的包含并表示数组的一部分的结构。 这里有几种创建切片的方式，我们来看看什么情况下使用它们。首先在数组的基础之上进行一点点变化:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scores := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">293</span>,<span class="number">4</span>,<span class="number">9</span>&#125;</span><br></pre></td></tr></table></figure>

<p>和数组申明不同的是，我们的切片没有在方括号中定义长度。为了理解两者的不同，我们来看看另一种使用<code>make</code>来创建切片的方式:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scores := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>我们使用 <code>make</code> 关键字代替 <code>new</code>， 是因为创建一个切片不仅是只分配一段内存（这个是 <code>new</code>关键字的功能）。具体来讲，我们必须要为一个底层数组分配一段内存，同时也要初始化这个切片。在上面的代码中，我们初始化了一个长度是 10 ，容量是 10 的切片。长度是切片的长度，容量是底层数组的长度。在使用 <code>make</code> 创建切片时，我们可以分别的指定切片的长度和容量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scores := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>上面的代码创建了一个长度是 0 ，容量是 10 的切片。（如果你仔细观察的话，你会注意到 <code>make</code> 和 <code>len</code> <em>被</em>重载了。Go 的一些特性没有暴露出来给开发者使用，这也许会让你感到沮丧。）</p>
<p>为了更好的理解切片的长度和容量之间的关系，我们来看下面的的例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  scores := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">  scores[<span class="number">7</span>] = <span class="number">9033</span></span><br><span class="line">  fmt.Println(scores)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们上面的这个例子不能运行，为什么呢？因为切片的长度是 0 。没错，底层数组可以放 10 个元素，但是我们需要显式的扩展切片，才能访问到底层数组的元素。一种扩展切片的方式是通过 <code>append</code>的关键字来实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  scores := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">  scores = <span class="built_in">append</span>(scores, <span class="number">5</span>)</span><br><span class="line">  fmt.Println(scores) <span class="comment">// prints [5]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是那并没有改变原始代码的意图。追加一个值到长度为0的切片中将会设置第一个元素。无论什么原因，我们崩溃的代码想去设置索引为7的元素值。为了实现这个，我们可以重新切片：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  scores := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">  scores = scores[<span class="number">0</span>:<span class="number">8</span>]</span><br><span class="line">  scores[<span class="number">7</span>] = <span class="number">9033</span></span><br><span class="line">  fmt.Println(scores)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以调整的切片大小最大范围是多少呢？达到它的容量，这个例子中，是10。你可能在想 <em>这实际上并没有解决数组固定长度的问题</em>。但是 <code>append</code> 是相当特别的。如果底层数组满了，它将创建一个更大的数组并且复制所有原切片中的值（这个就很像动态语言 PHP，Python，Ruby，JavaScript 的工作方式）。这就是为什么上面的例子中我们必须重新将 <code>append</code> 返回的值赋值给 <code>scores</code> 变量：<code>append</code> 可能在原有底层数组空间不足的情况下创建了新值。</p>
<p>如果我告诉你 Go 使用 2x 算法来增加数组长度，你猜下面将会打印什么？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  scores := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">5</span>)</span><br><span class="line">  c := <span class="built_in">cap</span>(scores)</span><br><span class="line">  fmt.Println(c)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">25</span>; i++ &#123;</span><br><span class="line">    scores = <span class="built_in">append</span>(scores, i)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果容量改变了</span></span><br><span class="line">    <span class="comment">// Go 必须增加数组长度来容纳新的数据</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">cap</span>(scores) != c &#123;</span><br><span class="line">      c = <span class="built_in">cap</span>(scores)</span><br><span class="line">      fmt.Println(c)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始 <code>scores</code> 的容量是5。为了存储25个值，它必须扩展三次容量，分别是 10，20，最终是40。</p>
<p>最后一个例子，考虑这个：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  scores := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>)</span><br><span class="line">  scores = <span class="built_in">append</span>(scores, <span class="number">9332</span>)</span><br><span class="line">  fmt.Println(scores)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里输出是 <code>[0, 0, 0, 0, 0, 9332]</code>，可能你觉得是<code>[9332, 0, 0, 0, 0]</code>？对一个用户而言，这可能逻辑上是正确的。然而，对于一个编译器，你告诉他的是追加一个值到一个已经有5个值的切片。</p>
<p>最终，这有四种方式初始化一个切片：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">names := []<span class="keyword">string</span>&#123;<span class="string">&quot;leto&quot;</span>, <span class="string">&quot;jessica&quot;</span>, <span class="string">&quot;paul&quot;</span>&#125;</span><br><span class="line">checks := <span class="built_in">make</span>([]<span class="keyword">bool</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> names []<span class="keyword">string</span></span><br><span class="line">scores := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<p>什么时候该用哪个呢？第一个不用过多解释。当你事先知道数组中的值的时候，你可以使用这个方式。</p>
<p>当你想要写入切片具体的索引时，第二个方法很有用，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">extractPowers</span><span class="params">(saiyans []*Saiyans)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">  powers := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(saiyans))</span><br><span class="line">  <span class="keyword">for</span> index, saiyan := <span class="keyword">range</span> saiyans &#123;</span><br><span class="line">    powers[index] = saiyan.Power</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> powers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三个版本是指向空的切片，用于当元素数量未知时与 <code>append</code> 连接。</p>
<p>最后一个版本是让我们声明一个初始的容量。如果我们大概知道元素的数量将是很有用的。</p>
<p>即使当你知道大小的时候，<code>append</code> 也可以使用，取决于个人偏好：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">extractPowers</span><span class="params">(saiyans []*Saiyans)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">  powers := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="built_in">len</span>(saiyans))</span><br><span class="line">  <span class="keyword">for</span> _, saiyan := <span class="keyword">range</span> saiyans &#123;</span><br><span class="line">    powers = <span class="built_in">append</span>(powers, saiyan.Power)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> powers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>切片作为数组的包装是一个很强大的概念。许多语言有切片数组的概念。JavaScript 和 Ruby 数组都有一个  <code>slice</code> 方法。Ruby 中你可以使用 <code>[START..END]</code> 获取一个切片，或者 Python 中可以通过 <code>[START:END]</code> 实现。然而，在这些语言中，一个切片实际上是复制了原始值的新数组。如果我们使用 Ruby，下面这段代码的输出是什么呢？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scores = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">slice = scores[<span class="number">2.</span><span class="number">.4</span>]</span><br><span class="line">slice[<span class="number">0</span>] = <span class="number">999</span></span><br><span class="line">puts scores</span><br></pre></td></tr></table></figure>

<p>答案是  <code>[1, 2, 3, 4, 5]</code> 。那是因为 <code>slice</code> 是一个新数组，并且复制了原有的值。现在，考虑 Go 中的情况：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scores := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;</span><br><span class="line">slice := scores[<span class="number">2</span>:<span class="number">4</span>]</span><br><span class="line">slice[<span class="number">0</span>] = <span class="number">999</span></span><br><span class="line">fmt.Println(scores)</span><br></pre></td></tr></table></figure>

<p>输出是  <code>[1, 2, 999, 4, 5]</code>。</p>
<p>这改变了你编码的方式。例如，许多函数采用一个位置参数。JavaScript 中，如果你想去找到字符串中前五个字符后面的第一个空格（当然，在Go中切片也可以用于字符串），我们会这样写：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">haystack = <span class="string">&quot;the spice must flow&quot;</span>;</span><br><span class="line">console.log(haystack.indexOf(<span class="string">&quot; &quot;</span>, <span class="number">5</span>));</span><br></pre></td></tr></table></figure>

<p>在 Go 中，我们这样使用切片：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings.Index(haystack[<span class="number">5</span>:], <span class="string">&quot; &quot;</span>)</span><br></pre></td></tr></table></figure>

<p>我们可以从上面的例子中看到，<code>[X:]</code> 是 <em>从 X 到结尾</em> 的简写，然而 <code>[:X]</code> 是 <em>从开始到 X 的简写</em>。不像其他的语言，Go 不支持负数索引。如果我们想要切片中除了最后一个元素的所有值，可以这样写：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scores := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">scores = scores[:<span class="built_in">len</span>(scores)<span class="number">-1</span>]</span><br></pre></td></tr></table></figure>

<p>上面是从未排序的切片中移除元素的有效方法的开始：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  scores := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">  scores = removeAtIndex(scores, <span class="number">2</span>)</span><br><span class="line">  fmt.Println(scores) <span class="comment">// [1 2 5 4]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不会保持顺序</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">removeAtIndex</span><span class="params">(source []<span class="keyword">int</span>, index <span class="keyword">int</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">  lastIndex := <span class="built_in">len</span>(source) - <span class="number">1</span></span><br><span class="line">  <span class="comment">// 交换最后一个值和想去移除的值</span></span><br><span class="line">  source[index], source[lastIndex] = source[lastIndex], source[index]</span><br><span class="line">  <span class="keyword">return</span> source[:lastIndex]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，我们已经了解了切片，我们再看另一个通用的内建函数：<code>copy</code>。正常情况下，将值从一个数组复制到另一个数组的方法有5个参数，<code>source</code>， <code>sourceStart</code>，<code>count</code>,，<code>destination</code>  和 <code>destinationStart</code>。使用切片，我们仅仅需要两个：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;math/rand&quot;</span></span><br><span class="line">  <span class="string">&quot;sort&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  scores := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">100</span>)</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">    scores[i] = <span class="keyword">int</span>(rand.Int31n(<span class="number">1000</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  sort.Ints(scores)</span><br><span class="line"></span><br><span class="line">  worst := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>)</span><br><span class="line">  <span class="built_in">copy</span>(worst, scores[:<span class="number">5</span>])</span><br><span class="line">  fmt.Println(worst)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>花点时间试试上面的代码，并尝试改动。去看看如果你这么做  <code>copy(worst[2:4], scores[:5])</code> 或者复制多于或少于 <code>5</code> 个值给 <code>worst</code> 会发什么？</p>
<h2 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h2><p>Go语言中的映射，就好比其他语言中的hash表或者字典。它们的工作方式就是：定义键和值，并且可以获取，设置和删除其中的值。</p>
<p>映射和切片一样，使用 <code>make</code> 方法来创建。让我们来看看一个例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  lookup := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</span><br><span class="line">  lookup[<span class="string">&quot;goku&quot;</span>] = <span class="number">9001</span></span><br><span class="line">  power, exists := lookup[<span class="string">&quot;vegeta&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// prints 0, false</span></span><br><span class="line">  <span class="comment">// 0 is the default value for an integer</span></span><br><span class="line">  fmt.Println(power, exists)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们使用 <code>len</code>方法类获取映射的键的数量。使用<code>delete</code>方法来删除一个键对应的值：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// returns 1</span></span><br><span class="line">total := <span class="built_in">len</span>(lookup)</span><br><span class="line"></span><br><span class="line"><span class="comment">// has no return, can be called on a non-existing key</span></span><br><span class="line"><span class="built_in">delete</span>(lookup, <span class="string">&quot;goku&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>映射是动态变化的。然而我们可以通过传递第二个参数到 <code>make</code>方法来设置一个初始大小：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lookup := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>如果你事先知道映射会有多少键值，定义一个初始大小将会帮助改善性能。</p>
<p>当你需要将映射作为结构体字段的时候，你可以这样定义它：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Saiyan <span class="keyword">struct</span> &#123;</span><br><span class="line">  Name <span class="keyword">string</span></span><br><span class="line">  Friends <span class="keyword">map</span>[<span class="keyword">string</span>]*Saiyan</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始上述结构体的一种方式是：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">goku := &amp;Saiyan&#123;</span><br><span class="line">  Name: <span class="string">&quot;Goku&quot;</span>,</span><br><span class="line">  Friends: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*Saiyan),</span><br><span class="line">&#125;</span><br><span class="line">goku.Friends[<span class="string">&quot;krillin&quot;</span>] = ... <span class="comment">//加载或者创建 Krillin</span></span><br></pre></td></tr></table></figure>

<p>Go 还有一种定义和初始化值的方式。像 <code>make</code>，这种特定用于映射和数组。我们可以定义为复合方式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lookup := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;</span><br><span class="line">  <span class="string">&quot;goku&quot;</span>: <span class="number">9001</span>,</span><br><span class="line">  <span class="string">&quot;gohan&quot;</span>: <span class="number">2044</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以使用 <code>for</code> 组合 <code>range</code> 关键字迭代映射：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> lookup &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>迭代映射是没有顺序的。每次迭代查找将会随机返回键值对。</p>
<h2 id="指针和值"><a href="#指针和值" class="headerlink" title="指针和值"></a>指针和值</h2><p>第二章我们讨论了到底是传值还是传指针。现在我们有相同的问题在映射和数组上，到底该使用他们哪个？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="built_in">make</span>([]Saiyan, <span class="number">10</span>)</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">b := <span class="built_in">make</span>([]*Saiyan, <span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>许多开发者认为应该传递 <code>b</code> 或者返回它在一个函数中会更加高效。然而，传递/返回的是切片的副本，但是切片本身就是一个引用。所以传递返回切片本身，没有什么区别。</p>
<p>当你改变切片或者映射值的时候，你将看到不同。这一点上，和我们在第二章看到的逻辑相同。所以决定使用指针数组还是值数组归结为你如何使用单个值，而不是你用数组还是映射。</p>
<h2 id="继续之前-2"><a href="#继续之前-2" class="headerlink" title="继续之前"></a>继续之前</h2><p>Go 中数组和映射的工作方式类似于其他语言。如果你习惯了使用动态数组，这可能就有点小的调整，但是 <code>append</code> 应该能解决你大多的不适应。如果我们超越数组的表面语法，将会发现切片。切片功能强大，并且他们对代码的清晰度产生了巨大的影响。</p>
<p>还有一些边缘情况没有覆盖到，不过你不太可能遇到他们。即使遇到了，希望我们在这里建立的基础帮助你理解正在发生的事情。</p>
<h1 id="第四章-·-代码组织和接口"><a href="#第四章-·-代码组织和接口" class="headerlink" title="第四章 · 代码组织和接口"></a>第四章 · 代码组织和接口</h1><p>现在来看一下如何组织我们的代码。</p>
<h2 id="包管理"><a href="#包管理" class="headerlink" title="包管理"></a>包管理</h2><p>为了组织复杂的库和系统代码，我们需要学习关于包的知识。在 Go 语言中，包名遵循 Go 项目的目录结构。如果我们建立一个购物系统，我们可能以 “shopping” 包名作为一个开始，然后把所有源代码文件放到 <code>$GOPATH/src/shopping/</code> 目录中。</p>
<p>我们不会去想把所有东西都放在这个文件夹中。例如，我们可能想单独把数据库逻辑放在它自己的目录中。为了实现这个，我们创建一个子目录 <code>$GOPATH/src/shopping/db</code> 。子目录中文件的包名就是 <code>db</code>，但是为了从另一个包访问它，包括 <code>shopping</code> 包，我们需要导入 <code>shopping/db</code>。</p>
<p>换句话说，当你想去命名一个包的时候，可以通过 <code>package</code> 关键字，提供一个值，而不是完整的层次结构（例如：「shopping」或者 「db」）。当你想去导入一个包的时候，你需要指定完整路径。</p>
<p>接下来，我们去尝试下。在你的 Go 的工作目录 <code>src</code> 文件夹下（我们已经在<em>基础</em>那一章节中介绍了），创建一个新的文件夹叫做 <code>shopping</code> ，然后在 <code>shopping</code> 文件夹下创建一个 <code>db</code> 文件夹。</p>
<p>在 <code>shopping/db</code> 文件夹下，创建一个叫做 <code>db.go</code> 的文件，然后在 <code>db.go</code> 文件中添加如下的代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> db</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Item <span class="keyword">struct</span> &#123;</span><br><span class="line">  Price <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadItem</span><span class="params">(id <span class="keyword">int</span>)</span> *<span class="title">Item</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;Item&#123;</span><br><span class="line">    Price: <span class="number">9.001</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意包名和文件夹名是一样的。而且很明显我们实际并没有连接数据库。这里使用这个例子只是为了展示如何组织代码。</p>
<p>现在，创建在主目录 <code>shopping</code> 下创建一个叫 <code>pricecheck.go</code> 的文件。它的内容是：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> shopping</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;shopping/db&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PriceCheck</span><span class="params">(itemId <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">float64</span>, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">  item := db.LoadItem(itemId)</span><br><span class="line">  <span class="keyword">if</span> item == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> item.Price, <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很有可能认为导入  <code>shopping/db</code>  有点特别，因为我们已经在 <code>shopping</code> 包/目录中。实际上，我们正在导入 <code>$GOPATH/src/shopping/db</code>，这意味着只要你在你的工作区间  <code>src/test</code> 目录中有一个名为 <code>db</code>  的包，你就可以轻松导入它。</p>
<p>你正在构建一个包，除了我们看到的你不再需要任何东西。为了构建一个可执行程序，你仍然需要 <code>main</code> 包。我比较喜欢的方式是在 <code>shopping</code> 目录下创建一个 <code>main</code> 子目录，然后再创建一个叫 <code>main.go</code> 的文件，下面是它的内容：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;shopping&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(shopping.PriceCheck(<span class="number">4343</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，你可以进入你的 <code>shopping</code>  项目运行代码，输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main&#x2F;main.go</span><br></pre></td></tr></table></figure>

<h3 id="循环导入"><a href="#循环导入" class="headerlink" title="循环导入"></a>循环导入</h3><p>当你编写更复杂的系统的时，你必然会遇到循环导入。例如，当 <code>A</code> 包导入 <code>B</code> 包，<code>B</code> 包又导入 <code>A</code> 包（间接或者直接导入）。这是编译器不能允许的。</p>
<p>让我们改变我们的 <code>shopping</code> 结构以复现这个错误。</p>
<p>将  <code>Item</code> 定义从 <code>shopping/db/db.go</code> 移到 <code>shopping/pricecheck.go</code>。你的 <code>pricecheck.go</code> 文件像下面这样：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> shopping</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;shopping/db&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Item <span class="keyword">struct</span> &#123;</span><br><span class="line">  Price <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PriceCheck</span><span class="params">(itemId <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">float64</span>, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">  item := db.LoadItem(itemId)</span><br><span class="line">  <span class="keyword">if</span> item == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> item.Price, <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你尝试运行代码，你会从 <code>db/db.go</code> 得到两个关于 <code>Item</code>  未定义的错误。这看起来是说  <code>Item</code> 不存在  <code>db</code> 包中。它已经被移动到 <code>shopping</code> 包中，我们需要将 <code>shopping/db/db.go</code> 改变成：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> db</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;shopping&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadItem</span><span class="params">(id <span class="keyword">int</span>)</span> *<span class="title">shopping</span>.<span class="title">Item</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;shopping.Item&#123;</span><br><span class="line">    Price: <span class="number">9.001</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在但你尝试运行代码的时候，你将会得到 <em>不允许循环导入</em> 的错误。我们可以通过引入另一个包含共享结构体的包来解决这个问题。你的目录现在看起来像这个样子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$GOPATH&#x2F;src</span><br><span class="line">  - shopping</span><br><span class="line">    pricecheck.go</span><br><span class="line">    - db</span><br><span class="line">      db.go</span><br><span class="line">    - models</span><br><span class="line">      item.go</span><br><span class="line">    - main</span><br><span class="line">      main.go</span><br></pre></td></tr></table></figure>

<p><code>pricecheck.go</code> 将仍然导入 <code>shopping/db</code>，但是 <code>db.go</code> 现在导入  <code>shopping/models</code> 而不是 <code>shopping</code>，因此打破了循环。因为我们将共享的  <code>Item</code> 结构体移动到  <code>shopping/models/item.go</code>，我们现在需要去改变  <code>shopping/db/db.go</code> 从 <code>models</code> 包中引用  <code>Item</code>  结构体。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> db</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;shopping/models&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadItem</span><span class="params">(id <span class="keyword">int</span>)</span> *<span class="title">models</span>.<span class="title">Item</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;models.Item&#123;</span><br><span class="line">    Price: <span class="number">9.001</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你经常需要共享某些代码，不止 <code>models</code>，所以你可能有其他类似叫做 <code>utilities</code> 的目录，这些共享包的重要原则是他们不从 <code>shopping</code> 包或者任何子包中导入任何东西。在后面的章节中，我们将介绍可以帮助我们解决这些类型依赖关系的接口。</p>
<h3 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h3><p>Go 用了一个简单的规则去定义什么类型和函数可以包外可见。如果类型或者函数名称以一个大写字母开始，它就具有了包外可见性。如果以一个小写字母开始，它就不可以。</p>
<p>这也可以应用到结构体字段。如果一个字段名以一个小写字母开始，只有包内的代码可以访问他们。</p>
<p>例如，我们的 <code>items.go</code> 文件中有个这样的函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewItem</span><span class="params">()</span> *<span class="title">Item</span></span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它可以通过  <code>models.NewItem()</code> 这样被调用。但是如果函数命名为 <code>newItem</code>，我们将不能从不同的包访问它了。</p>
<p>去试试更改 <code>shopping</code> 代码中的函数，类型以及字段的名称。例如，如果你将 <code>Item</code> 的 <code>Price</code>  字段命名为 <code>price</code>，你应该会获得一个错误。</p>
<h3 id="包管理-1"><a href="#包管理-1" class="headerlink" title="包管理"></a>包管理</h3><p>我们用来 <code>build</code> 和 <code>run</code> 的 <code>go</code> 命令有一个 <code>get</code> 子命令，用于获取第三方库。<code>go get</code> 支持除了这个例子中的各种协议，我们可以从 Github 中获取一个库，意味着，你需要在你的电脑中安装 <code>git</code>。</p>
<p>假设你已经安装了 Git，在 shell 中输入命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com&#x2F;mattn&#x2F;go-sqlite3</span><br></pre></td></tr></table></figure>

<p><code>go get</code> 获取远端的文件并把它们存储在你的工作区间中。去看看你的 <code>$GOPATH/src</code> 目录，你会发现除了我们创建的 <code>shopping</code>  项目之外，还有一个 <code>github.com</code> 目录，在里面，你会看到一个包含了 <code>go-sqlite3</code> 目录的  <code>mattn</code> 目录。</p>
<p>我们刚才只是讨论了如何导入我们工作区间的包。为了导入新安装的 <code>go-sqlite3</code> 包，我们要这样导入：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;github.com/mattn/go-sqlite3&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>我知道这看起来像一个 URL，实际上，它只是希望导入在 <code>$GOPATH/src/github.com/mattn/go-sqlite3</code> 找到的 <code>go-sqlite3</code> 包。</p>
<h3 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h3><p><code>go get</code>  还有一些其他的技巧。如果我们在一个项目内使用 <code>go get</code>，它将浏览所有文件，查找 <code>imports</code> 的第三方库然后下载他们。某种程度上，我们的源代码变成了  <code>Gemfile</code> 或者  <code>package.json</code>。</p>
<p>如果你调用  <code>go get -u</code> ，它将更新所有包（或者你可以通过 <code>go get -u FULL_PACKAGE_NAME</code> 更新一个具体的包）。</p>
<p>最后，你可能发现了 <code>go get</code> 的不足。一方面，这儿没有办法指定一个版本。他总是指向 <code>master/head/trunk/default</code>。这是一个较大的问题如果你有两个项目需要同一个库的不同版本。</p>
<p>为了解决这个问题，你可以使用一个第三方的依赖管理工具。他们仍然很年轻，但 <a target="_blank" rel="noopener" href="https://github.com/nitrous-io/goop">goop</a> 和 <a target="_blank" rel="noopener" href="https://github.com/tools/godep">godep</a> 是可信的。更多完整的列表在 <a target="_blank" rel="noopener" href="https://code.google.com/p/go-wiki/wiki/PackageManagementTools">go-wiki</a>。</p>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><p>接口是定义了合约但并没有实现的类型。举个例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Logger <span class="keyword">interface</span> &#123;</span><br><span class="line">  Log(message <span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那这样做有什么作用呢？其实，接口有助于将代码与特定的实现进行分离。例如，我们可能有各种类型的日志记录器：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SqlLogger <span class="keyword">struct</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> ConsoleLogger <span class="keyword">struct</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> FileLogger <span class="keyword">struct</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>针对接口而不是具体实现的编程会使我们很轻松的修改（或者测试）任何代码都不会产生影响。</p>
<p>你会怎么用？就像任何其它类型一样，它结构可以这样：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">  logger Logger</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者是一个函数参数（或者返回值）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(logger Logger)</span></span> &#123;</span><br><span class="line">  logger.Log(<span class="string">&quot;hello!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在像 C# 或者 Java 这类语言中，当类实现接口时，我们必须显式的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class ConsoleLogger : Logger &#123;</span><br><span class="line">  public void Logger(message <span class="keyword">string</span>) &#123;</span><br><span class="line">    Console.WriteLine(message)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Go 中，下面的情况是隐式发生的。如果你的结构体有一个函数名为 <code>Log</code> 且它有一个 <code>string</code> 类型的参数并没有返回值，那么这个结构体被视为 <code>Logger</code> 。这减少了使用接口的冗长：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ConsoleLogger <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l ConsoleLogger)</span> <span class="title">Log</span><span class="params">(message <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  fmt.Println(message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Go 倾向于使用<strong>小</strong>且<strong>专注</strong>的接口。Go 的标准库基本上由接口组成。像 <code>io</code> 包有一些常用的接口诸如 <code>io.Reader</code> ， <code>io.Writer</code> ， <code>io.Closer</code> 等。如果你编写的函数只需要一个能调用 <code>Close()</code> 的参数，那么你应该接受一个 <code>io.Closer</code> 而不是像 <code>io</code> 这样的父类型。<br>接口可以成为其他接口的一部分，也就是说接口也可以与其他接口组成新的接口。例如， <code>io.ReadCLoser</code> 的接口是由 <code>io.Reader</code> 接口和 <code>io.Closer</code> 接口组成的。</p>
<p>最后，接口通常用于避免循环导入。由于它们没有具体的实现，因此它们的依赖是有限的。</p>
<h2 id="继续之前-3"><a href="#继续之前-3" class="headerlink" title="继续之前"></a>继续之前</h2><p>最后，如何围绕 Go 的工作区间构建你的代码，你只有在写了几个非测试的项目之后才会适应。最重要的是记着包名和目录结构之间的紧密关系（不仅仅在一个项目之内，而是整个工作区间）。</p>
<p>Go 处理类型可见性也是简单有效，而且也是一致的。有一些我们没看过的东西，比如常量和全局变量，但是放心，他们的可见性仍有相同的命名规则决定。</p>
<p>最后，如果你初次接触接口，你可能需要花点时间理解他们。然而，当你第一次看到一个期望类似  <code>io.Reader</code> 的函数时，你会发现自己很感谢作者没有要求他或者她需要的东西。</p>
<h1 id="第五章-·-花絮"><a href="#第五章-·-花絮" class="headerlink" title="第五章 · 花絮"></a>第五章 · 花絮</h1><p>这章中，我们将讨论 Go 功能杂记，放在其他地方都不太合适。</p>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>Go 首选错误处理方式是返回值，而不是异常。考虑 <code>strconv.Atoi</code> 函数，它将接受一个字符串然后将它转换为一个整数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">  <span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) != <span class="number">2</span> &#123;</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  n, err := strconv.Atoi(os.Args[<span class="number">1</span>])</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;not a valid number&quot;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fmt.Println(n)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以创建你自己的错误类型。唯一的要求是你必须实现内建 <code>error</code> 接口的契约：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</span><br><span class="line">  Error() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更一般地，我们可以通过导入 <code>error</code> 包然后使用它的 <code>New</code> 函数创建我们自己的错误：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;errors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(count <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> count &lt; <span class="number">1</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">&quot;Invalid count&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Go 标准库中有一个使用 error 变量的通用模式。例如， <code>io</code> 包中有一个 <code>EOF</code> 变量它是这样定义的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> EOF = errors.New(<span class="string">&quot;EOF&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这是一个包级别的变量（被定义在函数之外），可以被其他包访问（首字母大写）。各种函数可以返回这个错误，例如，当我们从一个文件或者 STDIN 读取时。如果它具有上下文意义，那么您应该使用此错误。作为调用者，我们可以这样使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;io&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> input <span class="keyword">int</span></span><br><span class="line">  _, err := fmt.Scan(&amp;input)</span><br><span class="line">  <span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;no more input!&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>作为最后一点，Go 确实有  <code>panic</code>  和  <code>recover</code>  函数。 <code>panic</code>  就像抛出异常，而 <code>recover</code> 就像 <code>catch</code>，它们很少使用。</p>
<h2 id="Defer"><a href="#Defer" class="headerlink" title="Defer"></a>Defer</h2><p>尽管 Go 有一个垃圾回收器，一些资源仍然需要我们显示地释放他们。例如，我们需要在使用完文件之后  <code>Close()</code>  他们。这种代码总是很危险。一方面来说，当我们在写一个函数的时候，很容易忘记关闭我们声明了 10 行的东西。另一方面，一个函数可能有多个返回点。Go 给出的解决方案是使用 <code>defer</code> 关键字：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  file, err := os.Open(<span class="string">&quot;a_file_to_read&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Println(err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">defer</span> file.Close()</span><br><span class="line">  <span class="comment">// 读取文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你尝试运行上面的代码，你将会得到错误（文件不存在）。这里只是演示 <code>defer</code> 如何工作。无论什么情况，在函数返回之后（本例中为 <code>main()</code> ），<code>defer</code> 将被执行。这使您可以在初始化的位置附近释放资源并处理多个返回点。</p>
<h2 id="go语言风格"><a href="#go语言风格" class="headerlink" title="go语言风格"></a>go语言风格</h2><p>大多数 Go 程序遵循相同的格式化规则，换句话说，一个 tab 键用于缩进，左括号和他们的声明语句在同一行。</p>
<p>我知道，你可能有自己的风格，并且想坚持它。这也是我长期以来所做的事情，但我很高兴我最终放弃了。一个大原因是  <code>go fmt</code> 命令。它易于使用而且具有权威性（所以就没有人争论无意义的偏好）。</p>
<p>当你在一个项目内的时候，你可以运用格式化规则到这个项目及其所有子目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go fmt .&#x2F;...</span><br></pre></td></tr></table></figure>

<p>试一试，它不仅缩进你的代码，也对齐了声明的字段和按字母书序导入。</p>
<h2 id="初始化的-if"><a href="#初始化的-if" class="headerlink" title="初始化的 if"></a>初始化的 if</h2><p>Go 对 <code>if</code> 语句做了稍微修改，支持在条件语句被求值之前先进行初始化：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> x := <span class="number">10</span>; count &gt; x &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个比较蠢的例子，更现实的是，你可能会像下面这样做：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := process(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有意思的是，虽然 <code>err</code> 不能在 <code>if</code> 语句之外使用，但他可以在任何  <code>else if</code>  或者  <code>else</code> 之内使用。</p>
<h2 id="空接口和转化"><a href="#空接口和转化" class="headerlink" title="空接口和转化"></a>空接口和转化</h2><p>在大多数面向对象的语言中，经常有一个内建的叫 <code>object</code> 的基类，是所有其他类的超类。Go 没有继承，也没有这样一个超类。不过他确实有一个没有任何方法的空接口： <code>interface&#123;&#125;</code>。因为空接口没有方法，可以说所有类型都实现了空接口，并且由于空接口是隐式实现的，因此每种类型都满足空接口契约。</p>
<p> 如果我们像，我们可以定义如下签名的 <code>add</code> 函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(a <span class="keyword">interface</span>&#123;&#125;, b <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了将一个接口变量转化为一个显式的类型，又可以用 <code>.(TYPE)</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> a.(<span class="keyword">int</span>) + b.(<span class="keyword">int</span>)</span><br></pre></td></tr></table></figure>

<p>提醒，如果底层类型不是 <code>int</code>，上面的结果将是 error。</p>
<p>你也可以访问强大的类型转换：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> a.(<span class="keyword">type</span>) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="keyword">int</span>:</span><br><span class="line">    fmt.Printf(<span class="string">&quot;a is now an int and equals %d\n&quot;</span>, a)</span><br><span class="line">  <span class="keyword">case</span> <span class="keyword">bool</span>, <span class="keyword">string</span>:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你将会看到，使用空接口可能超出了你的期望。但是虽然它将让代码看起来不那么好看，来回转换代码有时看起来也很丑陋并且危险，但在一个静态语言中，它是唯一的选择。</p>
<h2 id="字符串和字节数组"><a href="#字符串和字节数组" class="headerlink" title="字符串和字节数组"></a>字符串和字节数组</h2><p>字符串和字节数组是紧密相关的。我们可以轻松地在他们之间转换：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stra := <span class="string">&quot;the spice must flow&quot;</span></span><br><span class="line">byts := []<span class="keyword">byte</span>(stra)</span><br><span class="line">strb := <span class="keyword">string</span>(byts)</span><br></pre></td></tr></table></figure>

<p>实际上，这种转换方式在各种类型之间是通用的。一些函数显示地需要一个  <code>int32</code> 或者  <code>int64</code> 或者它们的无符号部分。你可能发现你必须这样做：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int64</span>(count)</span><br></pre></td></tr></table></figure>

<p>然而，当它涉及到字节和字符串时，这可能是你经常做的事情。一定记着当你使用 <code>[]byte(X)</code> 或者 <code>string(X)</code> 时，你实际上创建了数据的副本。这是必要的，因为字符串是不可变的。</p>
<p>那些由 Unicode 码点 <code>runes</code> 构成的字符串，如果你获取字符串的长度，你可能不能得到你期望的。下面的结果是3：</p>
<pre><code>fmt.Println(len(&quot;椒&quot;))
</code></pre>
<p>如果你用 <code>range</code> 迭代一个字符串，你将得到 runes，而不是字节。当然，当你将字符串转换为 <code>[]byte</code> 类型时，你将得到正确的数据。 </p>
<h2 id="函数类型"><a href="#函数类型" class="headerlink" title="函数类型"></a>函数类型</h2><p>函数是一种类型：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Add <span class="function"><span class="keyword">func</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="title">int</span></span></span><br></pre></td></tr></table></figure>

<p>它可以用在任何地方 – 作为字段类型，参数或者返回值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Add <span class="function"><span class="keyword">func</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="title">int</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(process(<span class="function"><span class="keyword">func</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="title">int</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> a + b</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(adder Add)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> adder(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样使用函数会帮助我们从具实现中解耦代码，更像在使用接口实现。</p>
<h2 id="继续之前-4"><a href="#继续之前-4" class="headerlink" title="继续之前"></a>继续之前</h2><p>我们研究了使用 Go 编程的各个方面，最值得注意的是，我们看到了错误的处理行为以及如何释放连接和打开的文件资源。许多人不喜欢 Go 的错误处理方法。这感觉像是倒退了一步。 有时，我同意。然而，我也发现这会让代码更容易理解。 <code>defer</code> 是一种不寻常但是实用的资源管理方法。事实上，它不仅限于资源管理。您可以将  <code>defer</code> 用于任何目的， 比如函数退出时的日志记录。</p>
<p>当然，我们还没有看到 Go 提供的所有花絮，但在你解决遇到的任何问题时你应该感到足够舒服。</p>
<h1 id="第六章-·-并发"><a href="#第六章-·-并发" class="headerlink" title="第六章 · 并发"></a>第六章 · 并发</h1><p>Go 通常被描述为一种并发友好的语言。 原因是它提供了两种强大机制的简单语法： <strong>协程</strong> 和 <strong>通道</strong></p>
<h2 id="Go协程"><a href="#Go协程" class="headerlink" title="Go协程"></a>Go协程</h2><p> <strong>协程</strong> 类似于一个线程，但是由 Go 而不是操作系统预定。在 <strong>协程</strong> 中运行的代码可以与其他代码同时运行。我们来看一个例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">  <span class="keyword">go</span> process()</span><br><span class="line">  time.Sleep(time.Millisecond * <span class="number">10</span>) <span class="comment">// this is bad, don&#x27;t do this!</span></span><br><span class="line">  fmt.Println(<span class="string">&quot;done&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;processing&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有一些有趣的事情， 但最重要的是我们如何开始一个 <strong>协程</strong> 。 我们只需使用 <code>go</code> 关键字，然后使用我们想要执行的函数。如果我们只想运行一部分代码， 如上所述， 我们可以使用匿名函数。需要注意的是，匿名函数不只是可以在 <strong>协程</strong> 中使用，其他地方也可以。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;processing&quot;</span>)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<p> <strong>协程</strong> 易于创建且开销很小。最终多个 <strong>协程</strong> 将会在同一个底层的操作系统线程上运行。这通常也称为 M:N 线程模型，因为我们有 M 个应用线程（ <strong>协程</strong> ）运行在 N 个操作系统线程上。结果就是，一个 <strong>协程</strong> 的开销和系统线程比起来相对很低（几KB）。在现代的硬件上，有可能拥有数百万个 <strong>协程</strong> 。</p>
<p>此外，这里还隐藏了映射和调度的复杂性。我们只需要说 <em>这段代码需要同时并发执行</em> 然后让 Go 自己去实现它。</p>
<p>如果我们回到我们的例子中，你将会注意到我们使用 <code>Sleep</code> 让程序等了几毫秒。这是因为主进程在退出前 <strong>协程</strong> 才会有机会去执行（主进程在退出前不会等待全部 <strong>协程</strong> 执行完毕）。要解决这个问题，我们需要协调我们的代码。</p>
<h2 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h2><p>创建一个协程是微不足道的， 它们开销很小我们可以启动很多； 但是，需要协调并发代码。为了解决这个问题， Go 提供了 <code>通道</code>。 在我们学习 <code>通道</code> 之前，我认为了解并发编程的基础知识非常重要。</p>
<p>编写并发代码要求您特别注意在哪里读取和写入一个值。 在某些方面， 例如没有垃圾回收的语言 – 它需要您从一个新的角度去考虑您的数据，始终警惕着可能存在的危险。 例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">20</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> incr()</span><br><span class="line">  &#125;</span><br><span class="line">  time.Sleep(time.Millisecond * <span class="number">10</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">incr</span><span class="params">()</span></span> &#123;</span><br><span class="line">  counter++</span><br><span class="line">  fmt.Println(counter)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你觉得将会输出什么呢？</p>
<p>如果你认为输出的是 <code>1, 2, ... 20</code> 这既不对也没错。如果你运行了以上的代码确实可能得到这个输出。可是，这个操作就很让人懵逼的。 啥？因为我们可能有多个 (这个情况下两个) 协程 同时写入一个相同变量 <code>counter</code> 。或者，同样糟糕的是，一个协程要读取  <code>counter</code> 时，另一个协程正在写入。</p>
<p>这个真的很危险吗？当然啦！ <code>counter++</code> 看起来可能是一行很简单的代码，但它是实际上被拆分为多个汇编语句 – 确切的性质依赖于你跑程序的平台。如果你运行这个例子，你将经常看到那些数字是以一种乱七八糟的顺序打印的，亦或数字是重复的/丢失的。别着急还会有更糟糕的情况， 比方说系统崩溃或者访问并增加任意区块的数据！</p>
<p>从变量中读取变量是唯一安全的并发处理变量的方式。 你可以有想要多少就多少的读取者， 但是写操作必须要得同步。 有太多的方法可以做到这个了，包括使用一些依赖于特殊的 CPU 指令集的真原子操作。然而, 常用的操作还是使用互斥量（译者注：mutex）:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">  <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  counter = <span class="number">0</span></span><br><span class="line">  lock sync.Mutex</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">20</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> incr()</span><br><span class="line">  &#125;</span><br><span class="line">  time.Sleep(time.Millisecond * <span class="number">10</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">incr</span><span class="params">()</span></span> &#123;</span><br><span class="line">  lock.Lock()</span><br><span class="line">  <span class="keyword">defer</span> lock.Unlock()</span><br><span class="line">  counter++</span><br><span class="line">  fmt.Println(counter)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>互斥量序列化会锁住锁下的代码访问。因为默认的的 <code>sync.Mutex</code> 是未锁定状态，这儿我们就得先定义  <code>lock sync.Mutex</code>。</p>
<p>这操作是不看着超简单？ 这个例子是具有欺骗性的。当我们进行并发编程时会产生一系列严重的 Bug。 首先，并不是经常能很明显知道什么代码需要保护。使用这样粗糙的锁操作（覆盖着大量代码的锁操作）确实很诱人，这就违背了我们当初进行并发编程的初心了。 我们肯定是需要个优雅的锁操作； 否则，我们最终会把多条快速通道走成单车道的。</p>
<p>另外一个问题是与死锁有关。 使用单个锁时，这没有问题，但是如果你在代码中使用两个或者更多的锁，很容易出现一种危险的情况，当协程A拥有锁 <strong>lockA **，想去访问锁 **lockB **，同时协程B拥有锁 **lockB</strong> 并需要访问锁 <strong>lockA</strong> 。</p>
<p>实际上我们使用一个锁时也有可能发生死锁的问题，就是当我们忘记释放它时。 但是这和多个锁引起的死锁行为相比起来，这并不像多锁死锁那样危险（因为这<em>真的</em> 很难发现），当你试着运行下面的代码时，您可以看见发生了什么：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">  <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  lock sync.Mutex</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; lock.Lock() &#125;()</span><br><span class="line">  time.Sleep(time.Millisecond * <span class="number">10</span>)</span><br><span class="line">  lock.Lock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到现在为止还有很多并发编程我们没有看到过。 首先，有一个常见的锁叫读写互斥锁。它主要提供了两种锁功能: 一个锁定读取和一个锁定写入。它的区别是允许多个同时读取，同时确保写入是独占的。在 Go 中， <code>sync.RWMutex</code> 就是这种锁。另外 <code>sync.Mutex</code> 结构不但提供了<code>Lock</code> 和 <code>Unlock</code> 方法 ，也提供了<code>RLock</code> 和 <code>RUnlock</code> 方法；其中 <code>R</code> 代表 <em>Read</em>.。虽然读写锁很常用，它也给开发人员带来了额外的负担：我们不但要关注我们正在访问的数据，还要注意如何访问。</p>
<p>此外，部分并发编程不只是通过为数不多的代码按顺序的访问变量； 它也需要协调多个协程。 例如，休眠10毫秒并不是一个特别优雅的解决方案。如果一个协程消耗的时间需要超过10毫秒怎么办？如果协程消耗更少的时间而我们浪费周期怎么办？又或者可以等待协程运行完毕， 我们想另外一个协程 <em>嗨， 我有新的数据需要你处理</em>?</p>
<p>这些事在没有 <code>通道</code> 的情况下都是可以完成的。当然对于更简单的情况，我相信你应该 <strong>应该</strong> 使用基本的功能比如 <code>sync.Mutex</code> 和 <code>sync.RWMutex</code>， 但正如我们将会在下一节中看到的那样， <code>通道</code> 旨在让并发编程更简洁和不容易出错。</p>
<h2 id="通道"><a href="#通道" class="headerlink" title="通道"></a>通道</h2><p>并发编程的最大调整源于数据的共享。如果你的协程间不存在数据共享，你完全没必要担心同步问题。但是并非所有系统都是如此简单。现实中，许多系统考虑了相反的目的：跨多个请求共享数据。内存缓存和数据库就是最好的例证。这种情况已经成为一个日趋增长的现实。</p>
<p>通道在共享不相关数据的情况下，让并发编程变得更健壮。通道是协程之间用于传递数据的共享管道。换而言之，一个协程可以通过一个通道向另外一个协程传递数据。因此，在任意时间点，只有一个协程可以访问数据。</p>
<p>一个通道，和其他任何变量一样，都有一个类型。这个类型是在通道中传递的数据的类型。例如，创建一个通道用于传递一个整数，我们要这样做：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br></pre></td></tr></table></figure>

<p>这个通道的类型是 <code>chan int</code>。因此，要将通道传递给函数，我们的函数签名看起来是这个样子的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>通道只支持两个操作：接收和发送。可以这样往通道发送一个数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHANNEL &lt;- DATA</span><br></pre></td></tr></table></figure>

<p>这样从通道接收数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VAR :&#x3D; &lt;-CHANNEL</span><br></pre></td></tr></table></figure>

<p>箭头预示着数据流向。当发送的时候，数据流向通道。接收的时候，数据流出通道。</p>
<p>在我们开始第一个例子之前还需要知道的是，接收和发送操作是阻塞的。也就是，当我们从一个通道接收的时候， goroutine 将会直到数据可用才会继续执行。类似地，当我们往通道发送数据的时候，goroutine 会等到数据接收到之后才会继续执行。</p>
<p>考虑这样一个系统，我们希望在各个 goroutine 中处理即将到来的数据。这是一个很平常的需求。如果我们在接收数据的 goroutine 上进行数据密集型处理，那么我们可能导致客户端超时。首先，我们先实现我们的 worker。这可能是一个简单的函数，但是我们让它成为结构的一部分，因此我们之前没有看到这样的 goroutines：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Worker <span class="keyword">struct</span> &#123;</span><br><span class="line">  id <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w Worker)</span> <span class="title">process</span><span class="params">(c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    data := &lt;-c</span><br><span class="line">    fmt.Printf(<span class="string">&quot;worker %d got %d\n&quot;</span>, w.id, data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的 worker 是简单的。他一直等到数据可用然后处理它。尽职尽责，它一直在一个循环中做这个，永远等待更多的数据去处理。</p>
<p>为了去用这个，第一件事情是启动一些 workers：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">  worker := &amp;Worker&#123;id: i&#125;</span><br><span class="line">  <span class="keyword">go</span> worker.process(c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，给这些 worker 一些活干：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  c &lt;- rand.Int()</span><br><span class="line">  time.Sleep(time.Millisecond * <span class="number">50</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有一个完整的可运行代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">  <span class="string">&quot;math/rand&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">    worker := &amp;Worker&#123;id: i&#125;</span><br><span class="line">    <span class="keyword">go</span> worker.process(c)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    c &lt;- rand.Int()</span><br><span class="line">    time.Sleep(time.Millisecond * <span class="number">50</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Worker <span class="keyword">struct</span> &#123;</span><br><span class="line">  id <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Worker)</span> <span class="title">process</span><span class="params">(c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    data := &lt;-c</span><br><span class="line">    fmt.Printf(<span class="string">&quot;worker %d got %d\n&quot;</span>, w.id, data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们不知道哪个 worker 将得到什么数据。但我们能确保的是 Go 保证了发送到通道的数据只会被一个接收器接收。</p>
<p>记着，唯一的共享状态时通道，我们可以安全地同时从它接收和发送数据。通道提供了所有我们需要的同步代码保证，在任何时间只有一个 goroutine 可以访问特定的数据。</p>
<h3 id="缓冲通道"><a href="#缓冲通道" class="headerlink" title="缓冲通道"></a>缓冲通道</h3><p>上面给出的代码中，如果有超过能处理的数据到来会发什么？你可以通过更改 worker 接收到数据之后的暂停时间来模拟这个。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  data := &lt;-c</span><br><span class="line">  fmt.Printf(<span class="string">&quot;worker %d got %d\n&quot;</span>, w.id, data)</span><br><span class="line">  time.Sleep(time.Millisecond * <span class="number">500</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的主代码中发生的是，接收用户数据的代码（刚刚使用随机数生成器模拟的）是阻塞，因为没有接收器可用。</p>
<p>在某些情况下，你可能需要担保数据被处理掉，这个时候就需要开始阻塞客户端。在某些情况下，你可能会降低这种担保。这有几种常用的策略实现它。第一个就是缓冲数据。如果没有worker可用，我们想去临时存储数据在某些队列中。通道内建这种缓冲容量，当我们使用 <code>make</code> 创建通道的时候，可以设置通道的长度：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>你可以对此更改进行更改，但你会注意到处理仍然不稳定。缓冲通道不会增加容量，他们只提供待处理工作的队列，以及处理突然飙升的任务量的好方法。在我们的示例中，我们不断推送比 worker 可以处理的数据更多的数据。</p>
<p>然而，我们实际上可以通过查看通道的 <code>len</code> 来理解缓冲通道是什么。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  c &lt;- rand.Int()</span><br><span class="line">  fmt.Println(<span class="built_in">len</span>(c))</span><br><span class="line">  time.Sleep(time.Millisecond * <span class="number">50</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以看到通道长度一直增加直到满了，这个时候往我们的通道发送数据将再一次阻塞。</p>
<h3 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h3><p>即使有缓冲，在某些时候我们需要开始删除消息。我们不能为了让 worker 轻松而耗尽所有内存。为了实现这个，我们使用 Go 的 <code>select</code>：</p>
<p>语法上，<code>select</code> 看起来有一点像 switch。使用它，我们提供当通道不能发送数据的时候处理代码。首先，让我们移除通道缓冲来看看  <code>select</code> 如何工作：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br></pre></td></tr></table></figure>

<p>接下来，改变我们的 <code>for</code> 循环：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> c &lt;- rand.Int():</span><br><span class="line">    <span class="comment">// 可选的代码在这里</span></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// 这里可以留空以静默删除数据</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;dropped&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  time.Sleep(time.Millisecond * <span class="number">50</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们将每秒推送20条消息，但是我们的 worker 每秒仅仅能处理10条。也就是说，一般的消息，将被丢掉。</p>
<p>这只是我们能使用 <code>select</code> 实现的一个开始。<code>select</code> 的主要目的是管理多个通道，<code>select</code> 将阻塞直到第一个通道可用。如果没有通道可用，如果提供了 <code>default</code> ，那么他就会被执行。如果多个通道都可用了，随机挑选一个。</p>
<p>很难用一个简单的例子来证明这个行为，因为它是一个相当高级的功能。下一节可能有助于证明这个。</p>
<h3 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h3><p>我们看过了缓冲消息以及简单地将他们丢弃。另一个通用的选择是去超时。我们将阻塞一段时间，但不会永远。这在 Go 中也是很容易实现的。虽然，语法很难遵循，但是这样一个简洁有用的功能我不能将它排除在外。</p>
<p>为了阻塞最长时间，我们可以用 <code>time.After</code> 函数。我们来一起看看它并试着超越魔法。为了去用这个，我们的发送器将变成：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> c &lt;- rand.Int():</span><br><span class="line">  <span class="keyword">case</span> &lt;-time.After(time.Millisecond * <span class="number">100</span>):</span><br><span class="line">    fmt.Println(<span class="string">&quot;timed out&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  time.Sleep(time.Millisecond * <span class="number">50</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>time.After</code> 返回了一个通道，所以我们在 <code>select</code> 中使用它。这个通道可以在指定时间之后被写入。就这样，没有其他魔法了。如果你比较好奇，这里有一个 <code>after</code> 的实现，看起来大概就是这个样子咯：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">after</span><span class="params">(d time.Duration)</span> <span class="title">chan</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">  c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    time.Sleep(d)</span><br><span class="line">    c &lt;- <span class="literal">true</span></span><br><span class="line">  &#125;()</span><br><span class="line">  <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到我们的 <code>select</code>，还有两个东西可以试试。首先，如果添加回 <code>default</code> 会发生什么？能猜到吗？试试它。如果你不确定，记着如果没有可用的通道，<code>default</code> 将会立即触发。</p>
<p>还有，<code>time.After</code> 是一个 <code>chan time.Time</code> 类型的通道。上面的例子中，我们仅仅是简单地丢弃掉了发送到通道的值。如果你想要，你可以接受它：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> t := &lt;-time.After(time.Millisecond * <span class="number">100</span>):</span><br><span class="line">  fmt.Println(<span class="string">&quot;timed out at&quot;</span>, t)</span><br></pre></td></tr></table></figure>

<p>注意力重新回到我们的 <code>select</code>，可以看到我们发送给 <code>c</code> 但是却从 <code>time.After</code> 接收。无论我们从哪里接收，发送给谁，或者任何通道的组合，<code>select</code> 工作方式是相同的：</p>
<ul>
<li>第一个可用的通道被选择。</li>
<li>如果多个通道可用，随机选择一个。</li>
<li>如果没有通道可用，default 情况将被执行。</li>
<li>如果没有 default，select 将会阻塞。</li>
</ul>
<p>最后，在 <code>for</code> 中看到一个 <code>select</code> 是很常见的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> data := &lt;-c:</span><br><span class="line">    fmt.Printf(<span class="string">&quot;worker %d got %d\n&quot;</span>, w.id, data)</span><br><span class="line">  <span class="keyword">case</span> &lt;-time.After(time.Millisecond * <span class="number">10</span>):</span><br><span class="line">    fmt.Println(<span class="string">&quot;Break time&quot;</span>)</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h2 id="继续之前-5"><a href="#继续之前-5" class="headerlink" title="继续之前"></a>继续之前</h2><p>如果你是并发编程的新手，那么看起来似乎都是压倒性的。 它绝对需要非常多的关注。Go旨在让它变得更容易。</p>
<p>Goroutines 有效的抽象了我们需要并发执行的代码。通道帮助消除数据共享时共享数据可能发生的一些严重错误。这不仅可以消除错误， 还可以改变并发编程的方式。你只用考虑通过信息传递实现并发编程，而不是危险的代码区域。</p>
<p>话虽如此，我仍然广泛使用 <code>sync</code> 和 <code>sync / atomic</code> 包中的各种同步原语。我觉得比较重要的是通过使用这两种方式比较舒适。我建议你首先关注通道，但是当你遇到一个需要短暂锁的简单示例时，请考虑使用互斥锁或读写互斥锁。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>我最近听说 Go 被描述为一个<em>枯燥</em>的语言。枯燥是因为很容易去学，很容易写，以及最重要的，易读。或许，我确实认为这个实现不太好，毕竟，我<em>确实</em>花了三章讨论类型和如何声明变量。</p>
<p>如果你有静态类型语言的工作经历，我们所看到的内容仅仅只是一个复习。Go 使得指针可用性增强，并且切片是数组的包装，对于经验丰富的 Java 或 C＃开发人员来说可能并不算是压倒性优势。</p>
<p>如果你曾经大多在使用动态语言，你可能会感到有点不同。它是一个值得学习的东西。其中最重要的是声明和各种初始化的语法。尽管我是 Go 的粉丝，Go 尽管也在简单性方面取得了一些进展，但它并不简单。不过，它归纳为一些基本的规则（比如你只能声明变量一次以及 <code>:=</code> 确实声明了变量）以及基本理解（比如 <code>new(X)</code>  或者 <code>&amp;X&#123;&#125;</code> 仅仅只是分配内存，但是切片，映射以及通道需要更多的初始化，所以用 <code>make</code>）。</p>
<p>除了这些，Go 给了我们简单但有效的方式组织我们的代码。接口，基于返回的错误处理，用于资源管理的 <code>defer</code>以及实现组合的简单方式。</p>
<p>最后但也最重要的是内置并发支持。关于 <strong>协程</strong> ，除了有效和简单（无论如何简单易用）之外，几乎没有什么可说的了。这是一个很好的抽象。 <strong>通道</strong> 更为复杂。我一直认为在使用高级包装器之前先理解最基本使用方法。我认为不通过 <strong>通道</strong> 学习并发编程是很有用的。但是，对我来说，我觉得 <strong>通道</strong> 的实现方式不像一个简单的抽象。它们几乎都是自己的基本构件。我这样说是因为它们改变了你编写和思考并发编程的方式。 鉴于并发编程有多么困难，这绝对是一件好事。 </p>
<p>以及实现组合的简单方式。</p>
<p>最后但也最重要的是内置并发支持。关于 <strong>协程</strong> ，除了有效和简单（无论如何简单易用）之外，几乎没有什么可说的了。这是一个很好的抽象。 <strong>通道</strong> 更为复杂。我一直认为在使用高级包装器之前先理解最基本使用方法。我认为不通过 <strong>通道</strong> 学习并发编程是很有用的。但是，对我来说，我觉得 <strong>通道</strong> 的实现方式不像一个简单的抽象。它们几乎都是自己的基本构件。我这样说是因为它们改变了你编写和思考并发编程的方式。 鉴于并发编程有多么困难，这绝对是一件好事。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-04-25T19:39:23.000Z" title="4/25/2019, 7:39:23 PM">2019-04-25</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约115个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/04/25/Git%E6%B8%85%E7%A9%BA%E6%89%80%E6%9C%89commit%E8%AE%B0%E5%BD%95%E6%96%B9%E6%B3%95/">Git清空所有commit记录方法</a></h1><div class="content"><p>说明：例如将代码提交到git仓库，将一些敏感信息提交，所以需要删除提交记录以彻底清除提交信息，以得到一个干净的仓库且代码不变</p>
<ol>
<li><p>Checkout</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout –orphan latest_branch</span><br></pre></td></tr></table></figure>
</li>
<li><p>Add all the files</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add -A</span><br></pre></td></tr></table></figure>
</li>
<li><p>Commit the changes</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -am &quot;commit message&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Delete the branch</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -D master</span><br></pre></td></tr></table></figure>
</li>
<li><p>Rename the current branch to master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -m master</span><br></pre></td></tr></table></figure>
</li>
<li><p>Finally, force update your repository</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push -f origin master</span><br></pre></td></tr></table></figure></li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-04-23T13:34:10.000Z" title="4/23/2019, 1:34:10 PM">2019-04-23</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约34个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/04/23/%E8%A7%A3%E5%86%B3%E9%85%8D%E7%BD%AEauthorized-keys%E6%97%A0%E6%B3%95%E7%99%BB%E9%99%86/">解决配置authorized_keys无法登陆</a></h1><div class="content"><p>因为权限问题才无法登陆，这里记录下，方便后面查用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 644 ~/.ssh/authorized_keys</span><br><span class="line">sudo chmod 700 ~/.ssh</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-04-03T15:59:17.000Z" title="4/3/2019, 3:59:17 PM">2019-04-03</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约120个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/04/03/pypi-%E9%95%9C%E5%83%8F%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/">pypi 镜像使用帮助</a></h1><div class="content"><p>pypi 镜像每 5 分钟同步一次。</p>
<h2 id="临时使用"><a href="#临时使用" class="headerlink" title="临时使用"></a>临时使用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple some-package</span><br></pre></td></tr></table></figure>
<p>注意，simple 不能少, 是 https 而不是 http</p>
<h2 id="设为默认"><a href="#设为默认" class="headerlink" title="设为默认"></a>设为默认</h2><p>升级 pip 到最新的版本 (&gt;=10.0.0) 后进行配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install pip -U</span><br><span class="line">pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>
<p>如果您到 pip 默认源的网络连接较差，临时使用本镜像站来升级 pip：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pip -U</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-04-03T15:40:01.000Z" title="4/3/2019, 3:40:01 PM">2019-04-03</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约186个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/04/03/%E5%8D%8A%E5%BE%84%E8%8C%83%E5%9B%B4%E5%86%85%E9%9A%8F%E6%9C%BA%E7%BB%8F%E7%BA%AC%E5%BA%A6/">半径范围内随机经纬度</a></h1><div class="content"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> EARTH_RADIUS = <span class="number">6372.796924</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GpsInfo <span class="title">getRandomLocation</span><span class="params">(GpsInfo center, <span class="keyword">double</span> distance)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (distance &lt;= <span class="number">0</span>) distance = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">double</span> lat, lon, brg;</span><br><span class="line">    distance = distance / <span class="number">1000</span>;</span><br><span class="line">    GpsInfo location = <span class="keyword">new</span> GpsInfo();</span><br><span class="line">    <span class="keyword">double</span> maxdist = distance;</span><br><span class="line">    maxdist = maxdist / EARTH_RADIUS;</span><br><span class="line">    <span class="keyword">double</span> startlat = rad(center.getLat());</span><br><span class="line">    <span class="keyword">double</span> startlon = rad(center.getLon());</span><br><span class="line">    <span class="keyword">double</span> cosdif = Math.cos(maxdist) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">double</span> sinstartlat = Math.sin(startlat);</span><br><span class="line">    <span class="keyword">double</span> cosstartlat = Math.cos(startlat);</span><br><span class="line">    <span class="keyword">double</span> dist;</span><br><span class="line">    <span class="keyword">double</span> rad360 = <span class="number">2</span> * Math.PI;</span><br><span class="line">    dist = Math.acos((<span class="keyword">new</span> Random().nextDouble() * cosdif + <span class="number">1</span>));</span><br><span class="line">    brg = rad360 * <span class="keyword">new</span> Random().nextDouble();</span><br><span class="line">    lat = Math.asin(sinstartlat * Math.cos(dist) + cosstartlat * Math.sin(dist) * Math.cos(brg));</span><br><span class="line">    lon = deg(normalizeLongitude(startlon * <span class="number">1</span> + Math.atan2(Math.sin(brg) * Math.sin(dist) * cosstartlat, Math.cos(dist) - sinstartlat * Math.sin(lat))));</span><br><span class="line">    lat = deg(lat);</span><br><span class="line"></span><br><span class="line">    location.setLat(padZeroRight(lat));</span><br><span class="line">    location.setLon(padZeroRight(lon));</span><br><span class="line">    <span class="keyword">return</span> location;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">rad</span><span class="params">(<span class="keyword">double</span> d)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> d * Math.PI / <span class="number">180.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">deg</span><span class="params">(<span class="keyword">double</span> rd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (rd * <span class="number">180</span> / Math.PI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">normalizeLongitude</span><span class="params">(<span class="keyword">double</span> lon)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> n = Math.PI;</span><br><span class="line">    <span class="keyword">if</span> (lon &gt; n) &#123;</span><br><span class="line">        lon = lon - <span class="number">2</span> * n;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lon &lt; -n) &#123;</span><br><span class="line">        lon = lon + <span class="number">2</span> * n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lon;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">padZeroRight</span><span class="params">(<span class="keyword">double</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> sigDigits = <span class="number">8</span>;</span><br><span class="line">    s = Math.round(s * Math.pow(<span class="number">10</span>, sigDigits)) / Math.pow(<span class="number">10</span>, sigDigits);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-18T19:00:26.000Z" title="3/18/2019, 7:00:26 PM">2019-03-18</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">4 分钟读完 (大约615个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/18/Golang-transaction-%E4%BA%8B%E5%8A%A1%E4%BD%BF%E7%94%A8%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF/">Golang transaction 事务使用的正确姿势</a></h1><div class="content"><h2 id="第一种写法"><a href="#第一种写法" class="headerlink" title="第一种写法"></a>第一种写法</h2><p>这种写法非常朴实，程序流程也非常明确，但是事务处理与程序流程嵌入太深，容易遗漏，造成严重的问题</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoSomething</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    tx, err := db.Begin()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> p := <span class="built_in">recover</span>(); p != <span class="literal">nil</span> &#123;</span><br><span class="line">            tx.Rollback()</span><br><span class="line">            <span class="built_in">panic</span>(p)  <span class="comment">// re-throw panic after Rollback</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _, err = tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Rollback()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> _, err = tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Rollback()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    err = tx.Commit()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="第二种写法"><a href="#第二种写法" class="headerlink" title="第二种写法"></a>第二种写法</h2><p>下面这种写法把事务处理从程序流程抽离了出来，不容易遗漏，但是作用域是整个函数，程序流程不是很清晰</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoSomething</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    tx, err := db.Begin()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> p := <span class="built_in">recover</span>(); p != <span class="literal">nil</span> &#123;</span><br><span class="line">            tx.Rollback()</span><br><span class="line">            <span class="built_in">panic</span>(p) <span class="comment">// re-throw panic after Rollback</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            tx.Rollback()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = tx.Commit()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _, err = tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> _, err = tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="第三种写法"><a href="#第三种写法" class="headerlink" title="第三种写法"></a>第三种写法</h2><p>写法三是对写法二的进一步封装，写法高级一点，缺点同上</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Transact</span><span class="params">(db *sql.DB, txFunc <span class="keyword">func</span>(*sql.Tx)</span> <span class="title">error</span>) <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    tx, err := db.Begin()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> p := <span class="built_in">recover</span>(); p != <span class="literal">nil</span> &#123;</span><br><span class="line">            tx.Rollback()</span><br><span class="line">            <span class="built_in">panic</span>(p) <span class="comment">// re-throw panic after Rollback</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            tx.Rollback()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = tx.Commit()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    err = txFunc(tx)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoSomething</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Transact(db, <span class="function"><span class="keyword">func</span> <span class="params">(tx *sql.Tx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> _, err := tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> _, err := tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="我的写法"><a href="#我的写法" class="headerlink" title="我的写法"></a>我的写法</h2><p>经过总结和实验，我采用了下面这种写法，defer tx.Rollback() 使得事务回滚始终得到执行。 当 tx.Commit() 执行后，tx.Rollback() 起到关闭事务的作用， 当程序因为某个错误中止，tx.Rollback() 起到回滚事务，同事关闭事务的作用。</p>
<h3 id="普通场景"><a href="#普通场景" class="headerlink" title="普通场景"></a>普通场景</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoSomething</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">  tx, _ := db.Begin()</span><br><span class="line">  <span class="keyword">defer</span> tx.Rollback()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> _, err = tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> _, err = tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  err = tx.Commit()</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="循环场景"><a href="#循环场景" class="headerlink" title="循环场景"></a>循环场景</h3><p>(1) 小事务 每次循环提交一次 在循环内部使用这种写法的时候，defer 不能使用，所以要把事务部分抽离到独立的函数当中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoSomething</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    tx, _ := db.Begin()</span><br><span class="line">    <span class="keyword">defer</span> tx.Rollback()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _, err = tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> _, err = tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    err = tx.Commit()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := DoSomething(); err != <span class="literal">nil</span>&#123;</span><br><span class="line">         <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(2) 大事务 批量提交 大事务的场景和普通场景是一样的，没有任何区别</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoSomething</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    tx, _ := db.Begin()</span><br><span class="line">    <span class="keyword">defer</span> tx.Rollback()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> _, err = tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> _, err = tx.Exec(...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = tx.Commit()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考链接:<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/16184238/database-sql-tx-detecting-commit-or-rollback">https://stackoverflow.com/questions/16184238/database-sql-tx-detecting-commit-or-rollback</a><br>原文地址：<br><a target="_blank" rel="noopener" href="http://hopehook.com/2017/08/21/golang_transaction/">http://hopehook.com/2017/08/21/golang_transaction/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-15T11:11:16.000Z" title="3/15/2019, 11:11:16 AM">2019-03-15</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约189个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/15/HexoClient1-2-6%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/">HexoClient1.2.6版本发布</a></h1><div class="content"><h2 id="本次更新内容"><a href="#本次更新内容" class="headerlink" title="本次更新内容"></a>本次更新内容</h2><ul>
<li>feature：支持hexo特性<code>front-matter</code> <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/32">#32</a> <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/38">#38</a></li>
<li>bugfix：修复一处RCE(任意代码执行)漏洞 <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/35">#35</a></li>
<li>升级<code>electron</code> 到最新版本</li>
<li>升级<code>webpack</code>到最新版本，解决老版本漏洞问题</li>
</ul>
<h2 id="功能预览"><a href="#功能预览" class="headerlink" title="功能预览"></a>功能预览</h2><p><img src="/images/2019/03/15/11117750-46d0-11e9-8878-0bcbaac2a347.png" alt="image.png"><br><img src="/images/2019/03/15/5fde8030-46d0-11e9-8878-0bcbaac2a347.png" alt="image.png"></p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>Github: <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client">https://github.com/gaoyoubo/hexo-client</a></li>
<li>Gitee: <a target="_blank" rel="noopener" href="https://gitee.com/gaoyoubo/hexo-client">https://gitee.com/gaoyoubo/hexo-client</a></li>
<li>下载地址：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.6">https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.6</a></li>
<li>使用帮助：<a href="https://www.mspring.org/tags/HexoClient/">https://www.mspring.org/tags/HexoClient/</a></li>
<li>提交问题：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/new">https://github.com/gaoyoubo/hexo-client/issues/new</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-15T10:56:22.000Z" title="3/15/2019, 10:56:22 AM">2019-03-15</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">4 分钟读完 (大约636个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/15/go-mod-%E7%9A%84%E4%BD%BF%E7%94%A8/">go mod 的使用</a></h1><div class="content"><p>从Go1.11开始，golang官方支持了新的依赖管理工具<code>go mod</code>。</p>
<h2 id="命令行说明"><a href="#命令行说明" class="headerlink" title="命令行说明"></a>命令行说明</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ go mod</span><br><span class="line">Go mod provides access to operations on modules.</span><br><span class="line"></span><br><span class="line">Note that support for modules is built into all the go commands,</span><br><span class="line">not just &#x27;go mod&#x27;. For example, day-to-day adding, removing, upgrading,</span><br><span class="line">and downgrading of dependencies should be done using &#x27;go get&#x27;.</span><br><span class="line">See &#x27;go help modules&#x27; for an overview of module functionality.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line"></span><br><span class="line">	go mod &lt;command&gt; [arguments]</span><br><span class="line"></span><br><span class="line">The commands are:</span><br><span class="line"></span><br><span class="line">	download    download modules to local cache</span><br><span class="line">	edit        edit go.mod from tools or scripts</span><br><span class="line">	graph       print module requirement graph</span><br><span class="line">	init        initialize new module in current directory</span><br><span class="line">	tidy        add missing and remove unused modules</span><br><span class="line">	vendor      make vendored copy of dependencies</span><br><span class="line">	verify      verify dependencies have expected content</span><br><span class="line">	why         explain why packages or modules are needed</span><br><span class="line"></span><br><span class="line">Use &quot;go help mod &lt;command&gt;&quot; for more information about a command.</span><br></pre></td></tr></table></figure>
<ul>
<li>go mod download: 下载依赖的module到本地cache</li>
<li>go mod edit: 编辑go.mod</li>
<li>go mod graph: 打印模块依赖图</li>
<li>go mod init: 在当前目录下初始化go.mod(就是会新建一个go.mod文件)</li>
<li>go mod tidy: 整理依赖关系，会添加丢失的module，删除不需要的module</li>
<li>go mod vender: 将依赖复制到vendor下</li>
<li>go mod verify: 校验依赖</li>
<li>go mod why: 解释为什么需要依赖</li>
</ul>
<h2 id="在新项目中使用"><a href="#在新项目中使用" class="headerlink" title="在新项目中使用"></a>在新项目中使用</h2><p>使用go mod并不要求你的项目源码放到$GOPATH下，所以你的新项目可以放到任意你喜欢的路径。在项目根目录下执行<code>go mod init</code>，会生成一个go.mod文件。然后你可以在其中增加你的依赖，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module github.com&#x2F;gaoyoubo&#x2F;xxx</span><br><span class="line"></span><br><span class="line">go 1.12</span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">	github.com&#x2F;go-sql-driver&#x2F;mysql v1.4.1</span><br><span class="line">        .... 你的依赖类似这样，添加到这里，一行一条。</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>然后执行<code>go mod download</code>，将依赖下载到本地。这些依赖并不是下载到你的项目目录下，而是会下载到<code>$GOPATH/pkg/mod</code>目录下，这样所有使用go mod的项目都可以共用。</p>
<h2 id="在旧项目中使用"><a href="#在旧项目中使用" class="headerlink" title="在旧项目中使用"></a>在旧项目中使用</h2><p>在旧项目中使用非常简单，只需要一下两个步骤：</p>
<ul>
<li><code>go mod init</code>: 在项目根目录下执行该命令，会在项目根目录下生成一个<code>go.mod</code>文件。</li>
<li><code>go mod tidy</code>: 在项目根目录下执行该命令，go mod会自动分析你当前项目所需要的依赖，并且将他们下载下来。</li>
</ul>
<h2 id="如何升级依赖"><a href="#如何升级依赖" class="headerlink" title="如何升级依赖"></a>如何升级依赖</h2><p>运行 <code>go get -u</code> 将会升级到最新的次要版本或者修订版本(x.y.z, z是修订版本号y是次要版本号)<br>运行 <code>go get -u=patch</code> 将会升级到最新的修订版本<br>运行 <code>go get package@version</code> 将会升级到指定的版本</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-11T14:28:19.000Z" title="3/11/2019, 2:28:19 PM">2019-03-11</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">3 分钟读完 (大约397个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/11/mysql5-x%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81/">mysql5.x重置密码</a></h1><div class="content"><p>This one is for all MySQL-DBA’s, which are working on macOS. Since the Apple OS has a rather peculiar way of starting and stopping MySQL, compared to Linux, you can run into some issues. These problems occur especially, if you have no access to the GUI.</p>
<h2 id="PREPARATION"><a href="#PREPARATION" class="headerlink" title="PREPARATION"></a>PREPARATION</h2><p>Put skip-grant-tables into the mysqld section of the my.cnf. A my.cnf can be found in /usr/local/mysql/support-files. You MUST work as root for all the following steps.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">shell&gt;</span><span class="bash"> sudo -s</span></span><br><span class="line"><span class="meta">shell&gt;</span><span class="bash"> vi /usr/<span class="built_in">local</span>/mysql/support-files/my-default.cnf</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">[mysqld]</span><br><span class="line">skip-grant-tables</span><br><span class="line">skip-networking</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Save the configuration file! (In vi this is “[ESC] + :x”)</p>
<p>Continue with stopping MySQL:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">launchctl unload /Library/LaunchDaemons/com.oracle.oss.mysql.mysqld.plist</span><br></pre></td></tr></table></figure>
<p>Restart MySQL, so skip-grant-tables becomes active:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">launchctl load /Library/LaunchDaemons/com.oracle.oss.mysql.mysqld.plist</span><br></pre></td></tr></table></figure>

<h2 id="RESET-THE-PASSWORD"><a href="#RESET-THE-PASSWORD" class="headerlink" title="RESET THE PASSWORD"></a>RESET THE PASSWORD</h2><p>After MySQL is started again, you can log into the CLI and reset the password:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">shell&gt;</span><span class="bash"> mysql -u root</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;super-secret-password&#x27;</span>;</span></span><br></pre></td></tr></table></figure>

<h2 id="PLAN-B"><a href="#PLAN-B" class="headerlink" title="PLAN B"></a>PLAN B</h2><p>If you are not capable of stopping MySQL in a civilised manner, you can use the more rough way. You can send a SIGTERM to the MySQL-Server:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">shell&gt;</span><span class="bash"> ps -aef | grep mysql | grep -v grep</span></span><br><span class="line">   74 28017     1   0 Fri10AM ??         5:59.50 /usr/local/mysql/bin/mysqld --user=_mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data --plugin-dir=/usr/local/mysql/lib/plugin --log-error=/usr/local/mysql/data/mysqld.local.err --pid-file=/usr/local/mysql/data/mysqld.local.pid</span><br></pre></td></tr></table></figure>
<p>You should receive one line. The second column from the left is the process id. Use this process id to stop the MySQL-Server.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">shell&gt;</span><span class="bash"> <span class="built_in">kill</span> -15 [process id]</span></span><br></pre></td></tr></table></figure>
<p>In this example, the command would look like this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">shell&gt;</span><span class="bash"> <span class="built_in">kill</span> -15 28017</span></span><br></pre></td></tr></table></figure>
<p>macOS will restart MySQL, since the process has not stopped correctly. The configuration will be read and the changes to the parameters will become effective. Continue with logging in to the CLI.</p>
<h2 id="CONCLUSION"><a href="#CONCLUSION" class="headerlink" title="CONCLUSION"></a>CONCLUSION</h2><p>No matter how secure your MySQL-Password is, it is a lot more important to secure access to the server it self. If your server is not secured by something that prevents access from the internet, it will only take a few minutes for someone with bad intentions to take over your database or worse, the entire server.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-11T10:45:07.000Z" title="3/11/2019, 10:45:07 AM">2019-03-11</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">4 分钟读完 (大约540个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/11/Golang%E5%92%8CJava%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%B0%83%E6%9F%A5/">Golang和Java构建工具调查</a></h1><div class="content"><p>Github：<a target="_blank" rel="noopener" href="https://github.com/blindpirate/report-of-build-tools-for-java-and-golang">https://github.com/blindpirate/report-of-build-tools-for-java-and-golang</a></p>
<h1 id="A-Survey-on-Build-Tools-of-Golang-and-Java"><a href="#A-Survey-on-Build-Tools-of-Golang-and-Java" class="headerlink" title="A Survey on Build Tools of Golang and Java"></a>A Survey on Build Tools of Golang and Java</h1><h1 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h1><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In January 2017, the usage of build tools in <a target="_blank" rel="noopener" href="http://github-rank.com/star?language=Java">Github’s top 1000 Java repositories</a> is as follows:</p>
<table>
<thead>
<tr>
<th>Tool Name</th>
<th align="center">Reference Count</th>
</tr>
</thead>
<tbody><tr>
<td>Gradle</td>
<td align="center">627</td>
</tr>
<tr>
<td>Maven</td>
<td align="center">264</td>
</tr>
<tr>
<td>Ant</td>
<td align="center">52</td>
</tr>
<tr>
<td>Npm</td>
<td align="center">4</td>
</tr>
<tr>
<td>Bazel</td>
<td align="center">3</td>
</tr>
<tr>
<td>Make</td>
<td align="center">1</td>
</tr>
</tbody></table>
<p>And the trending over the past 8 years is:</p>
<p><img src="/images/2019/03/11/c6a8a010-43a7-11e9-a68f-4fc47d059a0e.png" alt="trending"></p>
<h2 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h2><ul>
<li>Clone top 1000 Java repositories to local disk</li>
<li>Analyze the repositories by identity files:</li>
</ul>
<table>
<thead>
<tr>
<th>Tool Name</th>
<th align="center">Identity Files</th>
</tr>
</thead>
<tbody><tr>
<td>Gradle</td>
<td align="center">build.gradle</td>
</tr>
<tr>
<td>Maven</td>
<td align="center">pom.xml</td>
</tr>
<tr>
<td>Ant</td>
<td align="center">build.xml</td>
</tr>
<tr>
<td>Npm</td>
<td align="center">package.json</td>
</tr>
<tr>
<td>Bazel</td>
<td align="center">BUILD</td>
</tr>
<tr>
<td>Make</td>
<td align="center">Makefile/makefile</td>
</tr>
</tbody></table>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><ul>
<li>Make sure <a target="_blank" rel="noopener" href="https://git-scm.com/">Git</a>/<a target="_blank" rel="noopener" href="http://www.groovy-lang.org/download.html">Groovy 2.4+</a>/<a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">JDK 1.7+</a> are installed.</li>
<li>Run <code>groovy GithubTopRankCrawler.groovy -l java -d &lt;path to store the 1000 repos&gt;</code> to clone all repositories locally. </li>
<li>Run <code>groovy JavaBuildToolScanner.groovy -d &lt;path to store the 1000 repos&gt;</code> to analyze these repos.</li>
</ul>
<h1 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h1><h2 id="Conclusion-1"><a href="#Conclusion-1" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>There are various package management tools for golang as listed <a target="_blank" rel="noopener" href="https://github.com/golang/go/wiki/PackageManagementTools">here</a>. But which one is the most popular? </p>
<p>The usage of package manage tools in <a target="_blank" rel="noopener" href="http://github-rank.com/star?language=Go">Github’s top 1000 Go repositories</a> is as follows:</p>
<table>
<thead>
<tr>
<th>Tool Name</th>
<th align="center">Url</th>
<th align="center">Reference Count (Feb 2017)</th>
<th align="center">Reference Count (Nov 2017)</th>
</tr>
</thead>
<tbody><tr>
<td>Makefile</td>
<td align="center"><a href="">Makefile</a></td>
<td align="center">199</td>
<td align="center">181</td>
</tr>
<tr>
<td>dep</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/golang/dep">dep</a></td>
<td align="center">N/A</td>
<td align="center">94</td>
</tr>
<tr>
<td>godep</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/tools/godep">godep</a></td>
<td align="center">119</td>
<td align="center">90</td>
</tr>
<tr>
<td>govendor</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/kardianos/govendor">govendor</a></td>
<td align="center">65</td>
<td align="center">84</td>
</tr>
<tr>
<td>glide</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/Masterminds/glide">glide</a></td>
<td align="center">64</td>
<td align="center">77</td>
</tr>
<tr>
<td>gvt</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/FiloSottile/gvt">gvt</a></td>
<td align="center">25</td>
<td align="center">16</td>
</tr>
<tr>
<td>trash</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/rancher/trash">trash</a></td>
<td align="center">7</td>
<td align="center">13</td>
</tr>
<tr>
<td>submodule</td>
<td align="center"><a href="">submodule</a></td>
<td align="center">8</td>
<td align="center">6</td>
</tr>
<tr>
<td>gpm/johnny-deps</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/pote/gpm">gpm</a> <a target="_blank" rel="noopener" href="https://github.com/VividCortex/johnny-deps">johnny-deps</a></td>
<td align="center">7</td>
<td align="center">6</td>
</tr>
<tr>
<td>glock</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/robfig/glock">glock</a></td>
<td align="center">5</td>
<td align="center">4</td>
</tr>
<tr>
<td>gom</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/mattn/gom">gom</a></td>
<td align="center">4</td>
<td align="center">2</td>
</tr>
<tr>
<td>gopack</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/d2fn/gopack">gopack</a></td>
<td align="center">3</td>
<td align="center">2</td>
</tr>
<tr>
<td>gopm</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/gpmgo/gopm">gopm</a></td>
<td align="center">3</td>
<td align="center">1</td>
</tr>
<tr>
<td>goop</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/nitrous-io/goop">goop</a></td>
<td align="center">1</td>
<td align="center">1</td>
</tr>
<tr>
<td>gvend</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/govend/govend">gvend</a></td>
<td align="center">2</td>
<td align="center">0</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/dep">dep</a> had a first release in May 2017, did not exist for first stats.</p>
<p>Technically, <code>make</code> is not a package management tool, here it is just for comparison.</p>
<p>Submodule refers to a set of tools which use <a target="_blank" rel="noopener" href="https://git-scm.com/docs/git-submodule">git submodule</a> to manage dependencies such as <a target="_blank" rel="noopener" href="https://github.com/kovetskiy/manul">manul</a> and <a target="_blank" rel="noopener" href="https://github.com/dpw/vendetta">Vendetta</a> and so on.</p>
<h2 id="Algorithm-1"><a href="#Algorithm-1" class="headerlink" title="Algorithm"></a>Algorithm</h2><ul>
<li>Clone top 1000 Go repositories to local disk</li>
<li>Analyze the repositories by identity files:</li>
</ul>
<table>
<thead>
<tr>
<th>Tool Name</th>
<th align="center">Identity Files</th>
</tr>
</thead>
<tbody><tr>
<td>godep</td>
<td align="center">Godeps/Godeps.json</td>
</tr>
<tr>
<td>govendor</td>
<td align="center">vendor/vendor.json</td>
</tr>
<tr>
<td>gopm</td>
<td align="center">.gopmfile</td>
</tr>
<tr>
<td>gvt</td>
<td align="center">vendor/manifest</td>
</tr>
<tr>
<td>gvend</td>
<td align="center">vendor.yml</td>
</tr>
<tr>
<td>glide</td>
<td align="center">glide.yaml or glide.lock</td>
</tr>
<tr>
<td>trash</td>
<td align="center">vendor.conf</td>
</tr>
<tr>
<td>gom</td>
<td align="center">Gomfile</td>
</tr>
<tr>
<td>bunch</td>
<td align="center">bunchfile</td>
</tr>
<tr>
<td>goop</td>
<td align="center">Goopfile</td>
</tr>
<tr>
<td>goat</td>
<td align="center">.go.yaml</td>
</tr>
<tr>
<td>glock</td>
<td align="center">GLOCKFILE</td>
</tr>
<tr>
<td>gobs</td>
<td align="center">goproject.json</td>
</tr>
<tr>
<td>gopack</td>
<td align="center">gopack.config</td>
</tr>
<tr>
<td>nut</td>
<td align="center">Nut.toml</td>
</tr>
<tr>
<td>gpm/johnny-deps</td>
<td align="center">Godeps</td>
</tr>
<tr>
<td>Makefile</td>
<td align="center">makefile or Makefile</td>
</tr>
<tr>
<td>submodule</td>
<td align="center">.gitmodules</td>
</tr>
</tbody></table>
<h2 id="How-1"><a href="#How-1" class="headerlink" title="How"></a>How</h2><ul>
<li>Make sure <a target="_blank" rel="noopener" href="https://git-scm.com/">Git</a>/<a target="_blank" rel="noopener" href="http://www.groovy-lang.org/download.html">Groovy 2.4+</a>/<a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">JDK 1.7+</a> are installed.</li>
<li>Run <code>groovy GithubTopRankCrawler.groovy -l go -d &lt;path to store the 1000 repos&gt;</code> to clone all repositories locally. You can use <code>-s</code> to do the shallow clone and decrease disk usage.</li>
<li>Run <code>groovy GoBuildToolScanner.groovy &lt;path to store the 1000 repos&gt;</code> to analyze these repos.</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-01-29T16:46:59.000Z" title="1/29/2019, 4:46:59 PM">2019-01-29</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约30个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/01/29/HexoClient1-2-5%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/">HexoClient1.2.5版本发布</a></h1><div class="content"><h2 id="发布地址"><a href="#发布地址" class="headerlink" title="发布地址"></a>发布地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.5">https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.5</a></p>
<h2 id="功能预览"><a href="#功能预览" class="headerlink" title="功能预览"></a>功能预览</h2><p><img src="https://www.mspring.org/images/2019/01/29/9a633940-2384-11e9-a26e-272a27c47ef2.gif"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-01-24T11:15:07.000Z" title="1/24/2019, 11:15:07 AM">2019-01-24</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约65个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/01/24/hexo-client-1.2.4-release/">HexoClient1.2.4版本发布</a></h1><div class="content"><h2 id="发布地址"><a href="#发布地址" class="headerlink" title="发布地址"></a>发布地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.4">https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.4</a></p>
<h2 id="更新内容"><a href="#更新内容" class="headerlink" title="更新内容"></a>更新内容</h2><ul>
<li>新增分类标签导航</li>
<li>支持自定义文章路径</li>
<li>修复若干BUG</li>
</ul>
<h2 id="功能预览"><a href="#功能预览" class="headerlink" title="功能预览"></a>功能预览</h2><p><img src="http://file.mspring.org/images/blog/FpVFNRfqb1r8SL8WmWPwrZwNqE2M" alt="QQ20190124111534.png"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-01-15T18:09:01.000Z" title="1/15/2019, 6:09:01 PM">2019-01-15</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约100个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/01/15/Git%E4%BB%93%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/">Git仓库初始化</a></h1><div class="content"><h3 id="Create-a-new-repository"><a href="#Create-a-new-repository" class="headerlink" title="Create a new repository"></a>Create a new repository</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:gaoyoubo/hexo-client.git</span><br><span class="line">cd user-center-transfer</span><br><span class="line">touch README.md</span><br><span class="line">git add README.md</span><br><span class="line">git commit -m &quot;add README&quot;</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>

<h3 id="Existing-folder"><a href="#Existing-folder" class="headerlink" title="Existing folder"></a>Existing folder</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd existing_folder</span><br><span class="line">git init</span><br><span class="line">git remote add origin git@github.com:gaoyoubo/hexo-client.git</span><br><span class="line">git add .</span><br><span class="line">git commit -m &quot;Initial commit&quot;</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>

<h3 id="Existing-Git-repository"><a href="#Existing-Git-repository" class="headerlink" title="Existing Git repository"></a>Existing Git repository</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd existing_repo</span><br><span class="line">git remote rename origin old-origin</span><br><span class="line">git remote add origin git@github.com:gaoyoubo/hexo-client.git</span><br><span class="line">git push -u origin --all</span><br><span class="line">git push -u origin --tags</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-01-02T12:04:49.000Z" title="1/2/2019, 12:04:49 PM">2019-01-02</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约69个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/01/02/HexoClient1-2-3%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/">HexoClient1.2.3版本发布</a></h1><div class="content"><h2 id="发布地址"><a href="#发布地址" class="headerlink" title="发布地址"></a>发布地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.3">https://github.com/gaoyoubo/hexo-client/releases/tag/v1.2.3</a></p>
<h2 id="本次更新内容"><a href="#本次更新内容" class="headerlink" title="本次更新内容"></a>本次更新内容</h2><ul>
<li>支持i18n</li>
<li>新增sm.ms图床</li>
<li>支持上传粘贴板图片</li>
<li>优化设置页面布局</li>
<li>修复发布时仅支持master分支的问题</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-12-24T11:51:10.000Z" title="12/24/2018, 11:51:10 AM">2018-12-24</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">13 分钟读完 (大约1901个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/12/24/JWT%E4%BB%8B%E7%BB%8D/">JWT介绍</a></h1><div class="content"><p>JWT全称为：JSON Web Token是目前最流行的跨域认证的解决方案。</p>
<h2 id="跨域认证的问题"><a href="#跨域认证的问题" class="headerlink" title="跨域认证的问题"></a>跨域认证的问题</h2><p>互联网服务离不开用户认证。一般流程是下面这样。</p>
<ol>
<li>用户向服务器发送用户名和密码。</li>
<li>服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间等等。</li>
<li>服务器向用户返回一个 session_id，写入用户的 Cookie。</li>
<li>用户随后的每一次请求，都会通过 Cookie，将 session_id 传回服务器。</li>
<li>服务器收到 session_id，找到前期保存的数据，由此得知用户的身份。</li>
</ol>
<p><img src="http://file.mspring.org/images/blog/Fk90d0HAnG1mMX1hyG1WrOh6qjnl" alt="image.png"></p>
<p>这种模式的问题在于，扩展性不好。单机当然没有问题，如果是服务器集群，或者是跨域的服务导向架构，就要求 session 数据共享，每台服务器都能够读取 session。</p>
<p>举例来说，A 网站和 B 网站是同一家公司的关联服务。现在要求，用户只要在其中一个网站登录，再访问另一个网站就会自动登录，请问怎么实现？</p>
<p>一种解决方案是 session 数据持久化，写入数据库或别的持久层。各种服务收到请求后，都向持久层请求数据。这种方案的优点是架构清晰，缺点是工程量比较大。另外，持久层万一挂了，就会单点失败。</p>
<p><img src="http://file.mspring.org/images/blog/Fvvi55Uc24iyk-WIiB_D81JY7mTz" alt="image.png"></p>
<p>另一种方案是服务器索性不保存 session 数据了，所有数据都保存在客户端，每次请求都发回服务器。JWT 就是这种方案的一个代表。</p>
<h2 id="JWT的原理"><a href="#JWT的原理" class="headerlink" title="JWT的原理"></a>JWT的原理</h2><p>JWT的原则是在服务器身份验证之后，将生成一个JSON对象并将其发送回用户，如下所示。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;role&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;expire&quot;</span>: <span class="string">&quot;2018-12-24 20:15:56&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以后，用户与服务端通信的时候，都要发回这个 JSON 对象。服务器完全只靠这个对象认定用户身份。为了防止用户篡改数据，服务器在生成这个对象的时候，会加上签名（详见后文）。</p>
<p>服务器就不保存任何 session 数据了，也就是说，服务器变成无状态了，从而比较容易实现扩展。</p>
<h2 id="JWT的数据结构"><a href="#JWT的数据结构" class="headerlink" title="JWT的数据结构"></a>JWT的数据结构</h2><p>实际的 JWT 大概就像下面这样。<br><img src="http://file.mspring.org/images/blog/FmS-44Gi8Ys2j9KPAlhJCbxwBOff" alt="image.png"></p>
<p>它是一个很长的字符串，中间用点<code>.</code>分隔成三个部分。注意，JWT 内部是没有换行的，这里只是为了便于展示，将它写成了几行。</p>
<p>JWT 的三个部分依次如下。</p>
<ul>
<li>Header (头)</li>
<li>Payload (负载)</li>
<li>Signature (签名)<br>写成一行，就是下面的样子：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Header.Payload.Signature</span><br></pre></td></tr></table></figure>
<img src="http://file.mspring.org/images/blog/FvhP9xjo2LBg-e747BzPEYeteJ_2" alt="image.png"><br>下面依次介绍这三个部分。</li>
</ul>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Header 部分是一个 JSON 对象，描述 JWT 的元数据，通常是下面的样子。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中，alg属性表示签名的算法（algorithm），默认是 HMAC SHA256（写成 HS256）；typ属性表示这个令牌（token）的类型（type），JWT令牌统一写为JWT。<br>最后，将上面的 JSON 对象使用 Base64URL 算法（详见后文）转成字符串。</p>
<p>JWT里验证和签名使用的算法，可选择下面的:</p>
<table>
<thead>
<tr>
<th>JWS</th>
<th>算法名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>HS256</td>
<td>HMAC256</td>
<td>HMAC with SHA-256</td>
</tr>
<tr>
<td>HS384</td>
<td>HMAC384</td>
<td>HMAC with SHA-384</td>
</tr>
<tr>
<td>HS512</td>
<td>HMAC512</td>
<td>HMAC with SHA-512</td>
</tr>
<tr>
<td>RS256</td>
<td>RSA256</td>
<td>RSASSA-PKCS1-v1_5 with SHA-256</td>
</tr>
<tr>
<td>RS384</td>
<td>RSA384</td>
<td>RSASSA-PKCS1-v1_5 with SHA-384</td>
</tr>
<tr>
<td>RS512</td>
<td>RSA512</td>
<td>RSASSA-PKCS1-v1_5 with SHA-512</td>
</tr>
<tr>
<td>ES256</td>
<td>ECDSA256</td>
<td>ECDSA with curve P-256 and SHA-256</td>
</tr>
<tr>
<td>ES384</td>
<td>ECDSA384</td>
<td>ECDSA with curve P-384 and SHA-384</td>
</tr>
<tr>
<td>ES512</td>
<td>ECDSA512</td>
<td>ECDSA with curve P-521 and SHA-512</td>
</tr>
</tbody></table>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p>Payload 部分也是一个 JSON 对象，用来存放实际需要传递的数据。JWT 规定了7个官方字段，供选用。</p>
<ul>
<li>iss (issuer)：签发人</li>
<li>exp (expiration time)：过期时间</li>
<li>sub (subject)：主题</li>
<li>aud (audience)：受众</li>
<li>nbf (Not Before)：生效时间</li>
<li>iat (Issued At)：签发时间</li>
<li>jti (JWT ID)：编号<br>除了官方字段，你还可以在这个部分定义私有字段，下面就是一个例子。<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sub&quot;</span>: <span class="string">&quot;1234567890&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;admin&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
注意，JWT 默认是不加密的，任何人都可以读到，所以不要把秘密信息放在这个部分。<br>这个 JSON 对象也要使用 Base64URL 算法转成字符串。</li>
</ul>
<h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><p>Signature 部分是对前两部分的签名，防止数据篡改。</p>
<p>首先，需要指定一个密钥（secret）。这个密钥只有服务器才知道，不能泄露给用户。然后，使用 Header 里面指定的签名算法（默认是 HMAC SHA256），按照下面的公式产生签名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + <span class="string">&quot;.&quot;</span> +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line">  secret)</span><br></pre></td></tr></table></figure>
<p>算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用<code>.</code>分隔，就可以返回给用户。</p>
<h3 id="Base64URL"><a href="#Base64URL" class="headerlink" title="Base64URL"></a>Base64URL</h3><p>前面提到，Header 和 Payload 串型化的算法是 Base64URL。这个算法跟 Base64 算法基本类似，但有一些小的不同。</p>
<p>JWT 作为一个令牌（token），有些场合可能会放到 URL（比如 api.example.com/?token=xxx）。Base64 有三个字符<code>+</code>、<code>/</code>和<code>=</code>，在 URL 里面有特殊含义，所以要被替换掉：<code>=</code>被省略，<code>+</code>替换成<code>-</code>，<code>/</code>替换成<code>_</code>。这就是Base64URL 算法。</p>
<h2 id="JWT的使用方式"><a href="#JWT的使用方式" class="headerlink" title="JWT的使用方式"></a>JWT的使用方式</h2><p>客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage。</p>
<p>此后，客户端每次与服务器通信，都要带上这个 JWT。你可以把它放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求的头信息<code>Authorization</code>字段里面。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer &lt;token&gt;</span><br></pre></td></tr></table></figure>
<p>另一种做法是，跨域的时候，JWT 就放在 POST 请求的数据体里面。</p>
<h2 id="JWT-的几个特点"><a href="#JWT-的几个特点" class="headerlink" title="JWT 的几个特点"></a>JWT 的几个特点</h2><ul>
<li>JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。</li>
<li>JWT 不加密的情况下，不能将秘密数据写入 JWT。</li>
<li>JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。</li>
<li>JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。</li>
<li>JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。</li>
<li>为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输。</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>官方介绍页：<a target="_blank" rel="noopener" href="https://jwt.io/introduction/">https://jwt.io/introduction/</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-12-21T11:27:33.000Z" title="12/21/2018, 11:27:33 AM">2018-12-21</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约141个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/12/21/IDE-Goland-DEBUG%E6%8A%A5%E9%94%99/">IDE Goland DEBUG报错</a></h1><div class="content"><p>在升级GO版本到1.11后发现Goland的Debug报错，错误信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">could not launch process: decoding dwarf section info at offset 0x0: too short</span><br></pre></td></tr></table></figure>
<p>原因是Goland的dlv不是新版本，导致不能debug调试。</p>
<p>解决办法：</p>
<ol>
<li>更新dlv：go get -u github.com/derekparker/delve/cmd/dlv</li>
<li>修改goland配置，Help-&gt;Edit Custom Properties中增加新版dlv的路径配置：dlv.path=$GOPATH/bin/dlv</li>
<li>重启Goland，再次使用debug调试工具，就没有问题了。</li>
</ol>
<p>参考：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/43014884/mac-osx-jetbrains-gogland-delve-debugging-meet-could-not-launch-process-could/43014980#43014980">https://stackoverflow.com/questions/43014884/mac-osx-jetbrains-gogland-delve-debugging-meet-could-not-launch-process-could/43014980#43014980</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-11-29T19:18:29.000Z" title="11/29/2018, 7:18:29 PM">2018-11-29</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">15 分钟读完 (大约2291个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/29/HexoClient%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/">HexoClient使用帮助</a></h1><div class="content"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>HexoClient是一款跨平台的<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>管理工具。</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client">https://github.com/gaoyoubo/hexo-client</a></p>
<h1 id="QQ群"><a href="#QQ群" class="headerlink" title="QQ群"></a>QQ群</h1><p>欢迎加入HexoClient用户群交流。</p>
<ul>
<li>QQ群号：618213781</li>
<li>QQ群二维码</li>
</ul>
<p><img src="http://file.mspring.org/images/blog/FjPi6HPuOAQwwaNKKyJzIbybJfWE"></p>
<h1 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h1><p>我是从2011年开始写博客，在早期的时候<code>wordpress</code>、<code>zblog</code>、<code>emlog</code>等开源的博客程序都是用过。但是本着生命在于则疼的原则，后来我自己使用Java写了个简单的Blog程序( <a target="_blank" rel="noopener" href="https://gitee.com/gaoyoubo/mlog">https://gitee.com/gaoyoubo/mlog</a> ) 将其托管在阿里云服务器上。但是后面觉得为了一个博客单独买一台服务器成本比较高，所以后来改用<code>Hexo</code>+<code>Github Pages</code>，这样每年基本只需要几十块钱的域名费用即可。开始使用Hexo的时候也只是按照常规方式使用，后来了解到了<code>electron</code>框架，所以决定利用<code>electron</code>来为hexo写一个客户端。开始完全是为了自用，开源出去之后反响还不错，收到很多hexo博客党的反馈。</p>
<h1 id="使用帮助"><a href="#使用帮助" class="headerlink" title="使用帮助"></a>使用帮助</h1><h2 id="阅读前提"><a href="#阅读前提" class="headerlink" title="阅读前提"></a>阅读前提</h2><blockquote>
<p>本文不会讲解如何安装、配置、使用Hexo，所以阅读前请确保掌握以下技能。</p>
</blockquote>
<ul>
<li>能独立安装使用Hexo</li>
<li>能够正确的将Hexo部署到GitHub Pages</li>
<li>熟练掌握markdown语法</li>
<li>了解基本的Git用法</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><p>首先安装hexo</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-cli -g</span><br><span class="line">hexo init blog</span><br><span class="line">cd blog</span><br><span class="line">npm install</span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure>

<h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><p>去Hexo的产品发布页( <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases">https://github.com/gaoyoubo/hexo-client/releases</a>  )下载你对应平台的安装包进行安装。</p>
<h3 id="第三部"><a href="#第三部" class="headerlink" title="第三部"></a>第三部</h3><p>成功安装后打开程序会要求弹窗要求填写Hexo项目路径，该路径就是第一步通过<code>hexo init blog</code>创建的博客路径。正确配置路径之后即可愉快的使用HexoClient。</p>
<h2 id="利用Travis-CI实现自动部署"><a href="#利用Travis-CI实现自动部署" class="headerlink" title="利用Travis-CI实现自动部署"></a>利用Travis-CI实现自动部署</h2><h3 id="原理概述"><a href="#原理概述" class="headerlink" title="原理概述"></a>原理概述</h3><p>我在Github上创建以下两个项目：</p>
<ul>
<li>blog.mspring.org 该项目开启GitHub Pages用来存放<code>hexo deploy</code>之后的静态网页</li>
<li>blog-source 该项目用来存放我的hexo原始项目（也就是你通过hexo init创建的工程）<br>然后我们利用Trvais-ci，进行自动构建和发布。当Travis-ci监控到<code>blog-source</code>有新的提交记录，那么会自动执行脚本将更新发布到<code>blog.mspring.org</code>。</li>
</ul>
<h3 id="使用Travis-CI自动发布"><a href="#使用Travis-CI自动发布" class="headerlink" title="使用Travis-CI自动发布"></a>使用Travis-CI自动发布</h3><h4 id="第一步：生成access-token"><a href="#第一步：生成access-token" class="headerlink" title="第一步：生成access token"></a>第一步：生成access token</h4><p>进入Github个人主页，找到：Settings -&gt; Developer settings -&gt; Personal access tokens，然后取<code>Generate new token</code>，参照下图配置即可。<br><img src="http://file.mspring.org/images/blog/a43317347f11ba251d312d68697475ef!detail"><br>这里生成的Token，接下来会用到，请先妥善保存好。</p>
<h4 id="第二步：注册并开启Travis-CI项目构建"><a href="#第二步：注册并开启Travis-CI项目构建" class="headerlink" title="第二步：注册并开启Travis-CI项目构建"></a>第二步：注册并开启Travis-CI项目构建</h4><p>使用 <code>GitHub账户登录</code> <a target="_blank" rel="noopener" href="https://travis-ci.org/">Travis-CI官网</a> ，进去后能看到已经自动关联了 GitHub 上的仓库。这里我们选择需要启用的项目，即 <code>blog-source</code>。然后点击后面的<code>Settings</code>进入设置界面。<br><img src="http://file.mspring.org/images/blog/bb9afa5fd9a4c846fe8a53767931126d!detail"></p>
<h4 id="第三步：配置Travis-CI自动构建"><a href="#第三步：配置Travis-CI自动构建" class="headerlink" title="第三步：配置Travis-CI自动构建"></a>第三步：配置Travis-CI自动构建</h4><p>进入设置界面后可以参考我的配置：<br><img src="http://file.mspring.org/images/blog/33e9d652fa14373f0cf8cc1cef38270e!detail"></p>
<p>配置主要注意一下两点即可：</p>
<ul>
<li>Build pushed branches</li>
</ul>
<p>当分支收到新的push之后构建</p>
<ul>
<li>Environment Variables -&gt; GH_TOKEN</li>
</ul>
<p>GH_TOKEN，是我们第一步在github中生成的access token，因为要从github上将代码拉到travis-ci机器上进行构建，所以需要该token授权。</p>
<h4 id="第四步：配置hexo的-config-yml"><a href="#第四步：配置hexo的-config-yml" class="headerlink" title="第四步：配置hexo的_config.yml"></a>第四步：配置hexo的_config.yml</h4><p>因为我们的博客托管在github pages，所以我们是以git的方式进行deploy的，hexo如何配置使用git方式进行deploy，请自行Google。下面截取了我的<code>_config.yml</code>文件中关于git deploy配置的片段。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Deployment</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Docs: https://hexo.io/docs/deployment.html</span></span></span><br><span class="line">deploy:</span><br><span class="line">- type: git</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 下方的GH_TOKEN会被.travis.yml中sed命令替换</span></span><br><span class="line">  repo: https://GH_TOKEN@github.com/gaoyoubo/blog.mspring.org.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>

<h4 id="第五步：配置构建脚本-travis-yml"><a href="#第五步：配置构建脚本-travis-yml" class="headerlink" title="第五步：配置构建脚本.travis.yml"></a>第五步：配置构建脚本<code>.travis.yml</code></h4><p>在hexo项目的根目录创建<code>.travis.yml</code>文件，该文件就是travis的构建脚本，下面是我的脚本配置，我会在脚本中详细注释每一步的作用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 指定语言为node_js，nodejs版本stable</span></span><br><span class="line">language: node_js</span><br><span class="line">node_js: stable</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定构建的分支</span></span><br><span class="line">branches:</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定node_modules缓存</span></span><br><span class="line">cache:</span><br><span class="line">  directories:</span><br><span class="line">    - node_modules</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 构建之前安装hexo-cli，因为接下来会用到</span></span><br><span class="line">before_install:</span><br><span class="line">  - npm install -g hexo-cli</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装依赖</span></span><br><span class="line">install:</span><br><span class="line">  - npm install</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行脚本，先hexo clean 再 hexo generate，会使用hexo的同学应该不陌生。</span></span><br><span class="line">script:</span><br><span class="line">  - hexo clean</span><br><span class="line">  - hexo generate</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的脚本执行成功之后执行以下脚本进行deploy</span></span><br><span class="line">after_success:</span><br><span class="line">  - git init</span><br><span class="line">  - git config --global user.name &quot;GaoYoubo&quot;</span><br><span class="line">  - git config --global user.email &quot;gaoyoubo@foxmail.com&quot;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 替换同目录下的_config.yml文件中GH_TOKEN字符串为travis后台配置的变量</span></span><br><span class="line">  - sed -i &quot;s/GH_TOKEN/$&#123;GH_TOKEN&#125;/g&quot; ./_config.yml</span><br><span class="line">  - hexo deploy</span><br></pre></td></tr></table></figure>

<h3 id="使用HexoClient管理你的文章"><a href="#使用HexoClient管理你的文章" class="headerlink" title="使用HexoClient管理你的文章"></a>使用HexoClient管理你的文章</h3><ul>
<li>HexoClient在启动之后选择好hexo安装的目录，会自动读取Hexo目录中的文章。</li>
<li>HexoClient中支持新建、修改文章，新建修改文章之后点击发布按钮能够将文章更改提交到git，并自动通过travis自动发布。（前提是按照上面步骤配置好）</li>
<li>HexoClient支持七牛图片上传，七牛10G存储空间，每月10G流量免费，可以自行注册配置七牛，配置好后将七牛的ak、sk、bucket、域名配置到HexoClient中</li>
</ul>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><ul>
<li>出现莫名其妙的未知错误怎么办</li>
</ul>
<p>在菜单栏中找到：查看 -&gt; 切换开发者工具，将开发者工具打开，然后看控制台是否有错误，如果有错误将错误信息copy出来，点击这里提交问题：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/new">https://github.com/gaoyoubo/hexo-client/issues/new</a></p>
<ul>
<li>Hexo中有文章，但是打开之后却显示空白</li>
</ul>
<p>HexoClient的数据加载是完全依赖于Hexo的，所以在打开HexoClient之前要确保你的Hexo是install成功的。</p>
<h1 id="HexoClient更新记录"><a href="#HexoClient更新记录" class="headerlink" title="HexoClient更新记录"></a>HexoClient更新记录</h1><h2 id="v1-3-2-2019-08-26"><a href="#v1-3-2-2019-08-26" class="headerlink" title="v1.3.2 (2019-08-26)"></a>v1.3.2 (2019-08-26)</h2><ul>
<li>新增好博客导航功能，搜集和推荐优质技术博客（欢迎自荐和推荐优质博客）</li>
<li>添加QQ交流群（QQ群：618213781）</li>
</ul>
<h2 id="v1-3-1-2019-08-12"><a href="#v1-3-1-2019-08-12" class="headerlink" title="v1.3.1 (2019-08-12)"></a>v1.3.1 (2019-08-12)</h2><ul>
<li>修复检查更新提示错误。<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/64">#64</a></li>
<li>修复Windows系统下的一个样式错误。<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/65">#65</a></li>
</ul>
<h2 id="v1-3-0-2019-08-02"><a href="#v1-3-0-2019-08-02" class="headerlink" title="v1.3.0 (2019-08-02)"></a>v1.3.0 (2019-08-02)</h2><ul>
<li>修复阿里云oss图片上传后url不正确的问题。<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/60">#60</a></li>
<li>支持一键调用<code>hexo generate -d</code>命令发布文章，thanks <a target="_blank" rel="noopener" href="https://github.com/EVINK">EVINK</a><br><img src="http://file.mspring.org/images/blog/FkefJrKFFG3yQp6lumRbJujUgDlr" alt="image.png"></li>
</ul>
<h2 id="v1-2-9-2019-07-19"><a href="#v1-2-9-2019-07-19" class="headerlink" title="v1.2.9 (2019-07-19)"></a>v1.2.9 (2019-07-19)</h2><ul>
<li>支持草稿功能</li>
<li>支持检查更新功能</li>
<li>修复创建文章时<code>ctrl+s</code>多次保存会生成多篇文章的问题</li>
<li>修复选中分类、标签展示之后从其他页面切换回来选中状态丢失的问题</li>
</ul>
<h2 id="v1-2-8-2019-07-16"><a href="#v1-2-8-2019-07-16" class="headerlink" title="v1.2.8 (2019-07-16)"></a>v1.2.8 (2019-07-16)</h2><ul>
<li>feature：新增阿里云oss图床支持 <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/50">https://github.com/gaoyoubo/hexo-client/issues/50</a></li>
<li>feature：新增Google Analytics支持，只会搜集用户页面点击数据，请放心使用。代码更改详见：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/commit/2679449ab20fd04d094f238f0b6053bffdebdb3e">https://github.com/gaoyoubo/hexo-client/commit/2679449ab20fd04d094f238f0b6053bffdebdb3e</a></li>
</ul>
<h2 id="v1-2-7-2019-05-15"><a href="#v1-2-7-2019-05-15" class="headerlink" title="v1.2.7 (2019-05-15)"></a>v1.2.7 (2019-05-15)</h2><ul>
<li>bugfix：修复保存快捷键失效的问题  <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/44">https://github.com/gaoyoubo/hexo-client/issues/44</a></li>
<li>支持常用快捷键操作</li>
<li>升级markdown编辑器版本</li>
</ul>
<h2 id="v1-2-6-2019-03-15"><a href="#v1-2-6-2019-03-15" class="headerlink" title="v1.2.6 (2019-03-15)"></a>v1.2.6 (2019-03-15)</h2><ul>
<li>feature：支持hexo特性<code>front-matter</code> <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/32">#32</a> <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/38">#38</a></li>
<li>bugfix：修复一处RCE(任意代码执行)漏洞 <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/35">#35</a></li>
<li>升级<code>electron</code> 到最新版本</li>
<li>升级<code>webpack</code>到最新版本，解决老版本漏洞问题</li>
</ul>
<h2 id="v1-2-5-2019-01-29"><a href="#v1-2-5-2019-01-29" class="headerlink" title="v1.2.5 (2019-01-29)"></a>v1.2.5 (2019-01-29)</h2><ul>
<li>bugfix</li>
</ul>
<h2 id="v1-2-4-2019-01-24"><a href="#v1-2-4-2019-01-24" class="headerlink" title="v1.2.4 (2019-01-24)"></a>v1.2.4 (2019-01-24)</h2><ul>
<li>新增分类标签导航</li>
<li>支持自定义文章路径</li>
<li>修复若干BUG</li>
</ul>
<h2 id="v1-2-3-2019-01-02"><a href="#v1-2-3-2019-01-02" class="headerlink" title="v1.2.3 (2019-01-02)"></a>v1.2.3 (2019-01-02)</h2><ul>
<li>支持i18n</li>
<li>新增sm.ms图床</li>
<li>支持上传粘贴板图片</li>
<li>优化设置页面布局</li>
<li>修复发布时仅支持master分支的问题</li>
</ul>
<h2 id="v1-2-2-2018-12-04"><a href="#v1-2-2-2018-12-04" class="headerlink" title="v1.2.2 (2018-12-04)"></a>v1.2.2 (2018-12-04)</h2><ul>
<li>支持文章搜索</li>
<li>优化新建、编辑文章页布局</li>
<li>优化调整发布功能按钮</li>
<li>支持新建文章、发布快捷键操作</li>
<li>其他页面细节优化</li>
</ul>
<h2 id="v1-2-1"><a href="#v1-2-1" class="headerlink" title="v1.2.1"></a>v1.2.1</h2><ul>
<li>MacOS下无边框样式</li>
<li>调整菜单栏布局</li>
<li>修改UI配色和界面细节</li>
<li>修复初始化时选择hexo目录失败的问题</li>
<li>升级electron版本到3.x</li>
<li>其他细节修改</li>
</ul>
<h2 id="v1-1-3"><a href="#v1-1-3" class="headerlink" title="v1.1.3"></a>v1.1.3</h2><ul>
<li>升级markdown编辑器，使用mavonEditor编辑器（<a target="_blank" rel="noopener" href="https://github.com/hinesboy/mavonEditor%EF%BC%89%E3%80%82">https://github.com/hinesboy/mavonEditor）。</a></li>
<li>修复图片文章列表过长是，切换页面滚动位置丢失的问题。</li>
<li>重构代码，优化调用逻辑和布局层级关系。</li>
<li>升级electron版本到2.0.6。</li>
</ul>
<h2 id="v1-1-0"><a href="#v1-1-0" class="headerlink" title="v1.1.0"></a>v1.1.0</h2><ul>
<li>优化页面配色。</li>
<li>优化文章预览、详情页面展示样式。</li>
<li>文章内容修改后离开页面进行友好提示。</li>
<li>支持hexo generate 和 hexo deploy。</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-11-26T17:53:48.000Z" title="11/26/2018, 5:53:48 PM">2018-11-26</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约347个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/26/%E4%BD%BF%E7%94%A8AppVeyor%E5%92%8CTravis%E8%87%AA%E5%8A%A8%E7%BC%96%E8%AF%91Electron%E5%85%A8%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/">使用AppVeyor和Travis自动编译Electron全平台应用</a></h1><div class="content"><h2 id="package-json配置"><a href="#package-json配置" class="headerlink" title="package.json配置"></a>package.json配置</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;HexoClient&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.2.2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;......&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Hexo 桌面客户端&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;Apache License, Version 2.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;homepage&quot;</span>: <span class="string">&quot;https://github.com/gaoyoubo/hexo-client&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;repository&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;git&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/gaoyoubo/hexo-client.git&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;main&quot;</span>: <span class="string">&quot;./dist/electron/main.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;build&quot;</span>: <span class="string">&quot;node .electron-vue/build.js &amp;&amp; electron-builder --publish onTagOrDraft&quot;</span></span><br><span class="line">    ......</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;build&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;appId&quot;</span>: <span class="string">&quot;org.mspring.hexo.client&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;productName&quot;</span>: <span class="string">&quot;HexoClient&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;directories&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;output&quot;</span>: <span class="string">&quot;build&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;files&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;dist/electron/**/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;build/icons/*&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;publish&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;provider&quot;</span>: <span class="string">&quot;github&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;gaoyoubo&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;repo&quot;</span>: <span class="string">&quot;hexo-client&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;dmg&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;contents&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;x&quot;</span>: <span class="number">410</span>,</span><br><span class="line">          <span class="attr">&quot;y&quot;</span>: <span class="number">150</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;link&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/Applications&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;x&quot;</span>: <span class="number">130</span>,</span><br><span class="line">          <span class="attr">&quot;y&quot;</span>: <span class="number">150</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;file&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;mac&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;build/icons/icon.icns&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;win&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;nsis&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;build/icons/icon.ico&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;linux&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;category&quot;</span>: <span class="string">&quot;Utility&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;target&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;AppImage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;arch&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;x64&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ia32&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;deb&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;arch&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;x64&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ia32&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;rpm&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;arch&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;x64&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ia32&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;build/icons&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="build配置"><a href="#build配置" class="headerlink" title="build配置"></a>build配置</h3><p>electron-builder支持构建多个平台安装包，上面的配置中我配置了Windows、macos、linux，可以直接拷贝使用，如果想了解更多可以看这篇官方出品的文档：<a target="_blank" rel="noopener" href="https://www.electron.build/configuration/configuration">https://www.electron.build/configuration/configuration</a></p>
<h3 id="构建命令配置"><a href="#构建命令配置" class="headerlink" title="构建命令配置"></a>构建命令配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node .electron-vue/build.js &amp;&amp; electron-builder --publish onTagOrDraft</span><br></pre></td></tr></table></figure>
<p>可以看到后面的参数<code>--publish onTagOrDraft</code>他的意思是，当在标签中提交，或github中存在draft发布版本的时候触发publish操作，这个时候会自动将构建好的包上传到github releases中。publish配置的取值如下：</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>onTag</td>
<td>on tag push only</td>
</tr>
<tr>
<td>onTagOrDraft</td>
<td>on tag push or if draft release exists</td>
</tr>
<tr>
<td>always</td>
<td>always publish</td>
</tr>
<tr>
<td>never</td>
<td>never publish</td>
</tr>
</tbody></table>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.appveyor.com/">AppVeyor</a></li>
<li><a target="_blank" rel="noopener" href="https://travis-ci.org/">Travis</a></li>
<li><a target="_blank" rel="noopener" href="https://www.electron.build/configuration/configuration">electron-builder官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/issues/15">https://github.com/gaoyoubo/hexo-client/issues/15</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/5995599a6fb9a0249f6a131b">https://juejin.im/entry/5995599a6fb9a0249f6a131b</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-11-23T13:05:49.000Z" title="11/23/2018, 1:05:49 PM">2018-11-23</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约235个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/23/HexoClient1-2-1%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/">HexoClient1.2.1版本发布</a></h1><div class="content"><h2 id="更新内容"><a href="#更新内容" class="headerlink" title="更新内容"></a>更新内容</h2><ul>
<li>支持文章搜索</li>
<li>优化新建、编辑文章页布局</li>
<li>优化调整发布功能按钮 issues</li>
<li>支持新建文章、发布快捷键操作</li>
<li>其他页面细节优化</li>
</ul>
<h2 id="发布地址"><a href="#发布地址" class="headerlink" title="发布地址"></a>发布地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases">https://github.com/gaoyoubo/hexo-client/releases</a></p>
<p><strong>之前版本都只编译了Macos版本安装包，这次特意安装了一个虚拟机将Windows版本也编译了一份。</strong></p>
<ul>
<li>Mac版本下载地址：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases/download/v1.2.1/HexoClient-1.2.1.dmg">https://github.com/gaoyoubo/hexo-client/releases/download/v1.2.1/HexoClient-1.2.1.dmg</a></li>
<li>Windows版本下载地址：<a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client/releases/download/v1.2.1/HexoClient-1.2.1.exe">https://github.com/gaoyoubo/hexo-client/releases/download/v1.2.1/HexoClient-1.2.1.exe</a></li>
</ul>
<h2 id="功能预览"><a href="#功能预览" class="headerlink" title="功能预览"></a>功能预览</h2><p><img src="http://file.mspring.org/images/blog/8a3e66058442f2dd9821e7a54090bee7!detail"><br><img src="http://file.mspring.org/images/blog/f2daf058f76496f56277abc6ff6fbef1!detail"><br><img src="http://file.mspring.org/images/blog/92be1e0368bf5e9b07cdc48c19c85954!detail"><br><img src="http://file.mspring.org/images/blog/e86c878c2c7dc5e7234d6690864c52d3!detail"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-11-17T13:41:11.000Z" title="11/17/2018, 1:41:11 PM">2018-11-17</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约337个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/17/Ubuntu%E9%85%8D%E7%BD%AEShadownsocks%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AEpac%E8%A7%84%E5%88%99/">Ubuntu配置Shadownsocks以及配置pac规则</a></h1><div class="content"><p>周末没事将自己闲置的Thinkpad安装了最新的Ubuntu18.10版本，安装成功之后就想着将之前在自己的vps上配置的shadowsock服务使用上。</p>
<h3 id="第一步安装shadowsocks"><a href="#第一步安装shadowsocks" class="headerlink" title="第一步安装shadowsocks"></a>第一步安装shadowsocks</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install shadowsocks</span><br></pre></td></tr></table></figure>

<h3 id="第二步配置shadowsocks"><a href="#第二步配置shadowsocks" class="headerlink" title="第二步配置shadowsocks"></a>第二步配置shadowsocks</h3><p>安装完成之后默认的配置文件在<code>/etc/shadowsocks/local.json</code>，去将里面的配置修改成自己的即可。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;server&quot;</span>:<span class="string">&quot;xxx.xxx.xxx.xxx&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;server_port&quot;</span>:xxx,</span><br><span class="line">    <span class="attr">&quot;local_address&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;local_port&quot;</span>:<span class="number">1080</span>,</span><br><span class="line">    <span class="attr">&quot;password&quot;</span>:<span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span>:<span class="number">300</span>,</span><br><span class="line">    <span class="attr">&quot;method&quot;</span>:<span class="string">&quot;aes-256-cfb&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fast_open&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;workers&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;prefer_ipv6&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第三步启动shadowsocks"><a href="#第三步启动shadowsocks" class="headerlink" title="第三步启动shadowsocks"></a>第三步启动shadowsocks</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sslocal -c /etc/shadowsocks/local.json -d start</span><br></pre></td></tr></table></figure>

<h3 id="第四步配置pac规则"><a href="#第四步配置pac规则" class="headerlink" title="第四步配置pac规则"></a>第四步配置pac规则</h3><h4 id="1-安装GenPac"><a href="#1-安装GenPac" class="headerlink" title="1. 安装GenPac"></a>1. 安装GenPac</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install genpac</span><br><span class="line">pip install --upgrade genpac</span><br></pre></td></tr></table></figure>
<h4 id="2-新建pac配置存放目录"><a href="#2-新建pac配置存放目录" class="headerlink" title="2. 新建pac配置存放目录"></a>2. 新建pac配置存放目录</h4><p>用来存放用户自定义规则列表文件user-rules.txt和生成后的autoproxy.pac文件，例如我的放在home目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~&#x2F;soft&#x2F;pac</span><br><span class="line">cd ~.&#x2F;soft&#x2F;pac</span><br><span class="line">touch user-rules.txt</span><br></pre></td></tr></table></figure>

<h4 id="3-生成autoproxy-pac文件"><a href="#3-生成autoproxy-pac文件" class="headerlink" title="3. 生成autoproxy.pac文件"></a>3. 生成autoproxy.pac文件</h4><p>我使用的是github上托管的这份文件：<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt">https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt</a><br>执行一下命令来创建autoprox.pac</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">genpac --pac-proxy &quot;SOCKS5 127.0.0.1:1080&quot; --output=&quot;autoproxy.pac&quot; --gfwlist-url=&quot;https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt&quot; --user-rule-from=&quot;user-rules.txt&quot;</span><br></pre></td></tr></table></figure>

<h4 id="4-配置系统代理"><a href="#4-配置系统代理" class="headerlink" title="4. 配置系统代理"></a>4. 配置系统代理</h4><p>去Ubuntu<code>设置 -&gt; 网络 -&gt; 代理设置</code>设置代理，选择<code>自动</code>，配置url填写你本地的文件路径，例如：<code>file:///home/xxx/soft/pac/autoproxy.pac</code></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-11-17T13:35:03.000Z" title="11/17/2018, 1:35:03 PM">2018-11-17</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约163个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/17/Ubuntu18-10%E9%85%8D%E7%BD%AErc-local%E8%87%AA%E5%90%AF%E5%8A%A8/">Ubuntu18.10配置rc.local自启动</a></h1><div class="content"><p>Ubuntu新版本中已经不使用rc.local这种自启动方式了，熟悉旧版本的同学肯定是很不习惯的。那么新版本中如何配置rc.local呢。</p>
<ol>
<li><p>自行创建 /etc/rc.local 添加以下默认内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh -e</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># rc.local</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># This script is executed at the end of each multiuser runlevel.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Make sure that the script will <span class="string">&quot;exit 0&quot;</span> on success or any other</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> value on error.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># In order to enable or disable this script just change the execution</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bits.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># By default this script does nothing.</span></span></span><br><span class="line"></span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 exit 0 之前加入自定义内容</p>
</li>
<li><p>执行以下命令确保 rc.local 开机自启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo chown root:root /etc/rc.local</span><br><span class="line">sudo chmod 755 /etc/rc.local</span><br><span class="line">sudo systemctl enable rc-local.service</span><br></pre></td></tr></table></figure>

</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-11-10T16:41:24.000Z" title="11/10/2018, 4:41:24 PM">2018-11-10</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约249个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/10/Hexo1-2-0%E5%8F%91%E5%B8%83%EF%BC%8C%E5%85%A8%E6%96%B0%E7%9A%84UI%E5%B8%83%E5%B1%80/">Hexo1.2.0发布，全新的UI布局</a></h1><div class="content"><p>Hexo1.2.0发布，全新的UI布局。</p>
<blockquote>
<p>之前一直觉得HexoClient的ui太不像一个原生应用，一眼就能看出是网页做的。同样是基于electron，vscode、atom等应用的ui看起来就特别正规、好看，所以这次周末抽一天时间调整一下UI。</p>
</blockquote>
<h3 id="本次更新内容"><a href="#本次更新内容" class="headerlink" title="本次更新内容"></a>本次更新内容</h3><ul>
<li>MacOS下无边框样式</li>
<li>调整菜单栏布局</li>
<li>修改UI配色和界面细节</li>
<li>修复初始化时选择hexo目录失败的问题</li>
<li>升级electron版本到3.x</li>
<li>其他细节修改</li>
</ul>
<p><img src="http://file.mspring.org/images/blog/2a610b3b3e6a4dfc1132039145832472!detail"></p>
<p><img src="http://file.mspring.org/images/blog/0021d74d369085c91e861d483659fa32!detail"></p>
<h3 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h3><p>Mac版：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1E-5KrusoBuFGRTunTBqPJQ">https://pan.baidu.com/s/1E-5KrusoBuFGRTunTBqPJQ</a>   提取码：2v2q<br>Windows版本：请自行源码编译。<br>Linux版本：请自行源码编译。</p>
<h3 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h3><p>Github: <a target="_blank" rel="noopener" href="https://github.com/gaoyoubo/hexo-client">https://github.com/gaoyoubo/hexo-client</a><br>码云：<a target="_blank" rel="noopener" href="https://gitee.com/gaoyoubo/hexo-client">https://gitee.com/gaoyoubo/hexo-client</a></p>
<h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><ul>
<li>自动初始化hexo</li>
<li>文章筛选、搜索</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-11-07T14:48:31.000Z" title="11/7/2018, 2:48:31 PM">2018-11-07</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">3 分钟读完 (大约443个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/07/%E6%90%AC%E7%93%A6%E5%B7%A5%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/">搬瓦工使用笔记</a></h1><div class="content"><p>之前一直使用朋友的vpn进行翻墙，今天突然发现用不了了，同事强烈推荐使用<code>搬瓦工</code>（ <a target="_blank" rel="noopener" href="https://bwh8.net/">https://bwh8.net</a> ），他们反馈很稳定。于是就去官网上买了一个最低配的，配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SSD: 10 GB RAID-10</span><br><span class="line">RAM: 512 MB</span><br><span class="line">CPU: 1x Intel Xeon</span><br><span class="line">Transfer: 500 GB&#x2F;mo</span><br><span class="line">Link speed: 1 Gigabit</span><br><span class="line">Multiple locations</span><br></pre></td></tr></table></figure>
<p>价格：$19.99/year</p>
<p>购买的时候可以输入优惠码，优惠码自行百度去，有很多资源。我找了个优惠码，优惠了6.25%</p>
<p>接下来就是配置Shadowsocks Server了， 之前网上的教程中都会看到虚拟机vps的控制台会有一个Shadowsocks Server的选项，进去之后能够一键安装配置该服务，但是我的控制台却没有这个选项，在网上找到了下面一段话。</p>
<blockquote>
<p>注：最近很多新购买的服务器在VPS管理面板没有“Shadowsocks server”这一项，若是发生此原因，请按如下操作即可正常安装！若页面中没有Shadowsocks Server这一项，说明一键搭建SS功能被去掉了，这时候需要在当前浏览器的新标签中打开以下网址：<br><a target="_blank" rel="noopener" href="https://kiwivm.64clouds.com/main-exec.php?mode=extras_shadowsocks">https://kiwivm.64clouds.com/main-exec.php?mode=extras_shadowsocks</a>  打开以后就是安装页面，点击页面中的Install Shadowsocks Server安装即可(安装前提是服务器已打开已运行)。</p>
</blockquote>
<p>目前已经按照上面链接中的步骤搞定翻墙了。</p>
<p>另外附上Shadowsocks-NG下载地址：<a target="_blank" rel="noopener" href="https://github.com/shadowsocks/ShadowsocksX-NG/releases">https://github.com/shadowsocks/ShadowsocksX-NG/releases</a></p>
<p><img src="http://file.mspring.org/images/blog/6f8446dc093ef265589b488f926e5a7c"><br><img src="http://file.mspring.org/images/blog/12e4f270766776f570a24d33c45f56c1"><br><img src="http://file.mspring.org/images/blog/e9409572d6243e760faa218bd505f7b8"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-10-30T15:02:55.000Z" title="10/30/2018, 3:02:55 PM">2018-10-30</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">3 分钟读完 (大约516个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/10/30/Java%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/">Java学习资料</a></h1><div class="content"><blockquote>
<p>前几天突然有个姑娘加我的QQ（不知道哪儿来的我的QQ），让我参加他们免费的公开课，然后给我分享Java学习资料，我以为是会给我发几本书，就参加了，没想到是一个txt文件😂，内容如下：</p>
</blockquote>
<p>Allen-架构师必备技能-分库分表应对数据量过大<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1OF4RUHvRk98pBRdUiifH2g">https://pan.baidu.com/s/1OF4RUHvRk98pBRdUiifH2g</a> 密码：n4ev</p>
<p>Allen-互联网安全话题-使用https保障你的敏感数据不再裸奔<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1qz23y-3ahaGua4YH02KTyw">https://pan.baidu.com/s/1qz23y-3ahaGua4YH02KTyw</a> 密码：fgh0</p>
<p>Tony-多线程Future模式-写出支撑海量并发连接的服务端代码<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1NwzNRxUB0_DPNQo2IW_Xhg">https://pan.baidu.com/s/1NwzNRxUB0_DPNQo2IW_Xhg</a> 密码：0fpw</p>
<p>Tony-前后端分离架构分析与实现<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1b7XnTibtqW26YCHfuAXkyA">https://pan.baidu.com/s/1b7XnTibtqW26YCHfuAXkyA</a> 密码：ah24</p>
<p>Tony-高并发系统架构之负载均衡全方位解析<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1a87EH1Xe20O4XYZaNRo-hw">https://pan.baidu.com/s/1a87EH1Xe20O4XYZaNRo-hw</a> 密码：p52e</p>
<p>Tony-学会举一反三-从Redis看RPC原理<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1disSAbJo-01ESCu6_rTHYQ">https://pan.baidu.com/s/1disSAbJo-01ESCu6_rTHYQ</a> 密码：ih47</p>
<p>-Mike-分布式系统架构技能—zookeeper实现分布式锁<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1adhFuoUsz1sMQTnWNGoKPA">https://pan.baidu.com/s/1adhFuoUsz1sMQTnWNGoKPA</a> 密码：gjzh</p>
<p>Tony-数据库连接池原理源码分析<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1uBiBBt-tJVSz_5t5p4jG3A">https://pan.baidu.com/s/1uBiBBt-tJVSz_5t5p4jG3A</a> 密码：jqo6</p>
<p>Allen-深入SpringMVC原理老司机带你手写自己的MVC框架<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1rlhZCSqXaZpXWM_V5CA7EQ">https://pan.baidu.com/s/1rlhZCSqXaZpXWM_V5CA7EQ</a> 密码：vysj</p>
<p>Tony-JVM类加载机制之JAVA热部署实战开发<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1JSLGrG0k44um7weQcq5rvg">https://pan.baidu.com/s/1JSLGrG0k44um7weQcq5rvg</a> 密码：twn3</p>
<p>Tony-实战高并发系统缓存雪崩场景重现及解决方案<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1i8Q7sPNEcUIPYBuqFerRwQ">https://pan.baidu.com/s/1i8Q7sPNEcUIPYBuqFerRwQ</a> 密码：lwgj</p>
<p>Mike-解密spring-boot-starter<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/12-1N3RTb68l3QfUOxSG1jQ">https://pan.baidu.com/s/12-1N3RTb68l3QfUOxSG1jQ</a> 密码：sodb</p>
<p>Tony-细说springcloud微服务架构之客户端负载均衡<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1VK3mMTkKYzRU4G9YXwlOLg">https://pan.baidu.com/s/1VK3mMTkKYzRU4G9YXwlOLg</a> 密码：achq</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-10-25T18:35:18.000Z" title="10/25/2018, 6:35:18 PM">2018-10-25</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约102个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/10/25/%E8%B4%A6%E5%8F%B7%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1%E7%BA%BF%E4%B8%8A%E7%A8%B3%E5%AE%9A%E4%B8%80%E5%B9%B4%E7%BA%AA%E5%BF%B5/">账号中心服务线上稳定一年纪念</a></h1><div class="content"><p>这台服务由三台机器负载，每日处理一亿四千万+次请求，线上稳定运营一年多，未出现任何故障，如果不是这次需求变动还能继续稳定运行。在重启县截图纪念一下。</p>
<p><img src="http://file.mspring.org/images/blog/4cf2110bad00ed8f9b8e9726ddea7cc4"><br><img src="http://file.mspring.org/images/blog/c75ddcffe7c32f9d32816c421d08a63d"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-10-24T15:18:12.000Z" title="10/24/2018, 3:18:12 PM">2018-10-24</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">16 分钟读完 (大约2460个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/10/24/TOP-10%E5%BC%80%E6%BA%90%E7%9A%84%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E7%AE%80%E4%BB%8B/">TOP 10开源的推荐系统简介</a></h1><div class="content"><blockquote>
<p>转载自：<a target="_blank" rel="noopener" href="http://ibillxia.github.io/blog/2014/03/10/top-10-open-source-recommendation-systems/">http://ibillxia.github.io/blog/2014/03/10/top-10-open-source-recommendation-systems/</a></p>
</blockquote>
<p>最近这两年推荐系统特别火，本文搜集整理了一些比较好的开源推荐系统，即有轻量级的适用于做研究的SVDFeature、LibMF、LibFM等，也有重量级的适用于工业系统的 Mahout、Oryx、EasyRecd等</p>
<h1 id="SVDFeature"><a href="#SVDFeature" class="headerlink" title="SVDFeature"></a>SVDFeature</h1><p><img src="http://file.mspring.org/images/blog/b03f7c80c02987e7530f4d3b4e3aaa06"></p>
<p>主页：<a target="_blank" rel="noopener" href="http://svdfeature.apexlab.org/wiki/Main_Page">http://svdfeature.apexlab.org/wiki/Main_Page</a> 语言：C++<br>一个feature-based协同过滤和排序工具，由上海交大Apex实验室开发，代码质量较高。在KDD Cup 2012中获得第一名，KDD Cup 2011中获得第三名，相关论文 发表在2012的JMLR中，这足以说明它的高大上。<br>SVDFeature包含一个很灵活的Matrix Factorization推荐框架，能方便的实现SVD、SVD++等方法, 是单模型推荐算法中精度最高的一种。SVDFeature代码精炼，可以用 相对较少的内存实现较大规模的单机版矩阵分解运算。另外含有Logistic regression的model，可以很方便的用来进行ensemble。</p>
<h1 id="LibMF"><a href="#LibMF" class="headerlink" title="LibMF"></a>LibMF</h1><p><img src="http://file.mspring.org/images/blog/8fa6443aa809ba8fbc5e3c64915c521c"></p>
<p>主页：<a target="_blank" rel="noopener" href="http://www.csie.ntu.edu.tw/~cjlin/libmf/">http://www.csie.ntu.edu.tw/~cjlin/libmf/</a> 语言：C++<br>作者<a target="_blank" rel="noopener" href="http://www.csie.ntu.edu.tw/~cjlin/">Chih-Jen Lin</a>来自大名鼎鼎的台湾国立大学，他们在机器学习领域享有盛名，近年连续多届KDD Cup竞赛上均 获得优异成绩，并曾连续多年获得冠军。台湾大学的风格非常务实，业界常用的LibSVM， Liblinear等都是他们开发的，开源代码的效率和质量都非常高。<br>LibMF在矩阵分解的并行化方面作出了很好的贡献，针对SGD（随即梯度下降）优化方法在并行计算中存在的locking problem和memory discontinuity问题，提出了一种 矩阵分解的高效算法FPSGD（Fast Parallel SGD），根据计算节点的个数来划分评分矩阵block，并分配计算节点。系统介绍可以见这篇 <a target="_blank" rel="noopener" href="http://www.csie.ntu.edu.tw/~cjlin/papers/libmf.pdf">论文</a>（ACM Recsys 2013的 Best paper Award）。</p>
<h1 id="LibFM"><a href="#LibFM" class="headerlink" title="LibFM"></a>LibFM</h1><p><img src="http://file.mspring.org/images/blog/ea0bacfb8f5cbb8582c6da0d46b982ad"></p>
<p>主页：<a target="_blank" rel="noopener" href="http://www.libfm.org/">http://www.libfm.org/</a> 语言：C++<br>作者是德国Konstanz大学的Steffen Rendle，他用LibFM同时玩转KDD Cup 2012 Track1和Track2两个子竞赛单元，都取得了很好的成绩，说明LibFM是非常管用的利器。<br>LibFM是专门用于矩阵分解的利器，尤其是其中实现了MCMC（Markov Chain Monte Carlo）优化算法，比常见的SGD优化方法精度要高，但运算速度要慢一些。当然LibFM中还 实现了SGD、SGDA（Adaptive SGD）、ALS（Alternating Least Squares）等算法。</p>
<h1 id="Lenskit"><a href="#Lenskit" class="headerlink" title="Lenskit"></a>Lenskit</h1><p><img src="http://file.mspring.org/images/blog/0e22bf119d7f4c18f84186b45b5f349c"></p>
<p>主页：<a target="_blank" rel="noopener" href="http://lenskit.grouplens.org/">http://lenskit.grouplens.org/</a> 语言Java  </p>
<p>这个Java开发的开源推荐系统，来自美国的明尼苏达大学的GroupLens团队，也是推荐领域知名的测试数据集Movielens的作者。<br>该源码托管在GitHub上，<a target="_blank" rel="noopener" href="https://github.com/grouplens/lenskit">https://github.com/grouplens/lenskit</a>。主要包含lenskit-api,lenskit-core, lenskit-knn,lenskit-svd,lenskit-slopone,lenskit-parent,lenskit-data-structures,lenskit-eval,lenskit-test等模块，主要实现了k-NN，SVD，Slope-One等 典型的推荐系统算法。</p>
<h1 id="GraphLab"><a href="#GraphLab" class="headerlink" title="GraphLab"></a>GraphLab</h1><p><img src="http://file.mspring.org/images/blog/059a0e4f2135ef650c32dae1b2c0328e"></p>
<p>主页：<a target="_blank" rel="noopener" href="http://docs.graphlab.org/collaborative_filtering.html">GraphLab - Collaborative Filtering</a> 语言：C++<br>Graphlab是基于C++开发的一个高性能分布式graph处理挖掘系统，特点是对迭代的并行计算处理能力强（这方面是hadoop的弱项），由于功能独到，GraphLab在业界名声很响。 用GraphLab来进行大数据量的random walk或graph-based的推荐算法非常有效。Graphlab虽然名气比较响亮（CMU开发），但是对一般数据量的应用来说可能还用不上。<br>GraphLab主要实现了ALS，CCD++，SGD，Bias-SGD，SVD++，Weighted-ALS，Sparse-ALS，Non-negative Matrix Factorization，Restarted Lanczos Algorithm等算法。</p>
<h1 id="Mahout"><a href="#Mahout" class="headerlink" title="Mahout"></a>Mahout</h1><p><img src="http://file.mspring.org/images/blog/abc413f7e8465030364bf52af73e744c"></p>
<p>主页：<a target="_blank" rel="noopener" href="http://mahout.apache.org/">http://mahout.apache.org/</a> 语言：Java<br>Mahout 是 Apache Software Foundation (ASF) 开发的一个全新的开源项目，其主要目标是创建一些可伸缩的机器学习算法，供开发人员在 Apache 在许可下免费 使用。Mahout项目是由 Apache Lucene社区中对机器学习感兴趣的一些成员发起的，他们希望建立一个可靠、文档翔实、可伸缩的项目，在其中实现一些常见的用于 聚类和分类的机器学习算法。该社区最初基于 Ngetal. 的文章 “Map-Reduce for Machine Learning on Multicore”，但此后在发展中又并入了更多广泛的机器学习 方法，包括Collaborative Filtering（CF），Dimensionality Reduction，Topic Models等。此外，通过使用 Apache Hadoop 库，Mahout 可以有效地扩展到云中。<br>在Mahout的Recommendation类算法中，主要有User-Based CF，Item-Based CF，ALS，ALS on Implicit Feedback，Weighted MF，SVD++，Parallel SGD等。</p>
<h1 id="Myrrix"><a href="#Myrrix" class="headerlink" title="Myrrix"></a>Myrrix</h1><p><img src="http://file.mspring.org/images/blog/24015554dcd2411f4c2d9c2279e23c48"></p>
<p>主页：<a target="_blank" rel="noopener" href="http://myrrix.com/">http://myrrix.com/</a> 语言：Java<br>Myrrix最初是Mahout的作者之一Sean Owen基于Mahout开发的一个试验性质的推荐系统。目前Myrrix已经是一个完整的、实时的、可扩展的集群和推荐系统，主要 架构分为两部分：服务层：在线服务，响应请求、数据读入、提供实时推荐；计算层：用于分布式离线计算，在后台使用分布式机器学习算法为服务层更新机器学习 模型。Myrrix使用这两个层构建了一个完整的推荐系统，服务层是一个HTTP服务器，能够接收更新，并在毫秒级别内计算出更新结果。服务层可以单独使用，无需 计算层，它会在本地运行机器学习算法。计算层也可以单独使用，其本质是一系列的Hadoop jobs。目前Myrrix以被 Cloudera 并入Oryx项目。</p>
<h1 id="EasyRec"><a href="#EasyRec" class="headerlink" title="EasyRec"></a>EasyRec</h1><p><img src="http://file.mspring.org/images/blog/b2a52612d4c6244354a50e02b975f08c"></p>
<p>主页：<a target="_blank" rel="noopener" href="http://easyrec.org/">http://easyrec.org/</a> 语言：Java<br>EasyRec是一个易集成、易扩展、功能强大且具有可视化管理的推荐系统，更像一个完整的推荐产品，包括了数据录入模块、管理模块、推荐挖掘、离线分析等。 EasyRec可以同时给多个不同的网站提供推荐服务，通过tenant来区分不同的网站。架设EasyRec服务器，为网站申请tenant，通过tenant就可以很方便的集成到 网站中。通过各种不同的数据收集（view,buy.rating）API收集到网站的用户行为，EasyRec通过离线分析，就可以产生推荐信息，您的网站就可以通过 Recommendations和Community Rankings来进行推荐业务的实现。</p>
<h1 id="Waffles"><a href="#Waffles" class="headerlink" title="Waffles"></a>Waffles</h1><p><img src="http://file.mspring.org/images/blog/a2db4b985be8ea4bea49e0f178134233"></p>
<p>主页：<a target="_blank" rel="noopener" href="http://waffles.sourceforge.net/">http://waffles.sourceforge.net/</a> 语言：C++<br>Waffles英文原意是蜂蜜甜饼，在这里却指代一个非常强大的机器学习的开源工具包。Waffles里包含的算法特别多，涉及机器学习的方方面面，推荐系统位于 其中的Waffles_recommend tool，大概只占整个Waffles的1/10的内容，其它还有分类、聚类、采样、降维、数据可视化、音频处理等许许多多工具包，估计 能与之媲美的也就数Weka了。</p>
<h1 id="RapidMiner"><a href="#RapidMiner" class="headerlink" title="RapidMiner"></a>RapidMiner</h1><p><img src="http://file.mspring.org/images/blog/833465ed8f573c31de771cd5b504cec4"></p>
<p>主页：<a target="_blank" rel="noopener" href="http://rapidminer.com/">http://rapidminer.com/</a> 语言：Java<br>RapidMiner（前身是Yale）是一个比较成熟的数据挖掘解决方案，包括常见的机器学习、NLP、推荐、预测等方法（推荐只占其中很小一部分），而且带有GUI的 数据分析环境，数据ETL、预处理、可视化、评估、部署等整套系统都有。另外RapidMiner提供commercial license，提供R语言接口，感觉在向着一个商用的 数据挖掘公司的方向在前进。  </p>
<hr>
<p>开源的推荐系统大大小小的还有很多，以上只是介绍了一些在学术界和工业界比较流行的TOP 10，而且基本上都是用C++/Java实现的，在参考资料[1]、[2]中还提 到的有Crab（Python）、CofiRank（C++）、MyMediaLite（.NET/C#）、PREA（Java）、Python-recsys（Python）、Recommendable（Ruby）、Recommenderlab（R）、 Oryx（Java）、recommendify（Ruby）、RecDB（SQL）等等，当然GitHub上还有更多。。。即有适合单机运行的，也有适合集群的。虽然使用的编程语言不同，但实现 的算法都大同小异，主要是SVD、SGD、ALS、MF、CF及其改进算法等。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/cserchen/article/details/14231153">推荐系统开源软件列表汇总和点评</a>  </li>
<li><a target="_blank" rel="noopener" href="http://www.oschina.net/search?scope=project&tag1=0&tag2=0&lang=0&os=0&q=%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F">开源中国社区-搜索：推荐系统</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-09-28T15:23:38.000Z" title="9/28/2018, 3:23:38 PM">2018-09-28</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约243个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/09/28/How-to-build-tesseract-4-beta-on-macOS/">How to build tesseract 4 beta on macOS</a></h1><div class="content"><p>转载这篇文章之后找到了官方的文档，建议官方文档，官方文档描述更全面。官方文档地址：<a target="_blank" rel="noopener" href="https://github.com/tesseract-ocr/tesseract/wiki/Compiling">https://github.com/tesseract-ocr/tesseract/wiki/Compiling</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">brew info tesseract</span><br><span class="line"></span><br><span class="line">tesseract: stable 3.05.01 (bottled), HEAD</span><br><span class="line">OCR (Optical Character Recognition) engine</span><br></pre></td></tr></table></figure>
<p>The result of recognition on <code>Chinese - Simplified</code> is a little bit terrifying.</p>
<p>I noticed that it added a new neural network system based on LSTMs after 4.0.0+</p>
<p>But it need to be build from source code on macOS.</p>
<p>Thankfully, the manul is quit specify on their README.md</p>
<h2 id="Install-dependencies"><a href="#Install-dependencies" class="headerlink" title="Install dependencies"></a>Install dependencies</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">brew install automake autoconf autoconf-archive libtool</span><br><span class="line">brew install pkgconfig</span><br><span class="line">brew install icu4c</span><br><span class="line">brew install leptonica</span><br><span class="line">brew install gcc</span><br></pre></td></tr></table></figure>

<h2 id="Compile"><a href="#Compile" class="headerlink" title="Compile"></a>Compile</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/tesseract-ocr/tesseract/</span><br><span class="line">cd tesseract</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure CC=gcc CXX=g++ CPPFLAGS=-I/usr/local/opt/icu4c/include LDFLAGS=-L/usr/local/opt/icu4c/lib</span><br><span class="line">make -j</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>Their best trained <a target="_blank" rel="noopener" href="https://github.com/tesseract-ocr/tessdata_best">modes</a>, download the language chi_sim.traineddata and put it under tesseract/4.0.0.1/tessdata/</p>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tesseract image.png image -l chi_sim</span><br><span class="line">cat image.txt</span><br></pre></td></tr></table></figure>
<p>OK, it is still terrible under the <code>Song typeface</code> font. It need to be trained a new model by myself.</p>
<p>文章转载自：<a target="_blank" rel="noopener" href="http://artwalk.github.io/2018/05/06/How-to-build-tesseract-4-beta-on-macOS/">http://artwalk.github.io/2018/05/06/How-to-build-tesseract-4-beta-on-macOS/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-09-06T19:43:52.000Z" title="9/6/2018, 7:43:52 PM">2018-09-06</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约328个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/09/06/JavaCV%E5%88%86%E4%BA%AB/">JavaCV分享</a></h1><div class="content"><h2 id="JavaCV是什么"><a href="#JavaCV是什么" class="headerlink" title="JavaCV是什么"></a>JavaCV是什么</h2><blockquote>
<p>JavaCV 是一款开源的视觉处理库，基于GPLv2协议，对各种常用计算机视觉库封装后的一组jar包，封装了OpenCV、ffmpeg、videoInput…等计算机视觉编程人员常用库的接口。</p>
</blockquote>
<p><img src="http://file.mspring.org/images/blog/88730fba3d24588aa3747c56c3fa40a9"></p>
<h2 id="maven引用"><a href="#maven引用" class="headerlink" title="maven引用"></a>maven引用</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javacpp.version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">javacpp.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 这里要根据自己的平台选择不同的依赖 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;javacpp.platform.dependencies&gt;linux-x86_64&lt;/javacpp.platform.dependencies&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javacpp.platform.dependencies</span>&gt;</span>macosx-x86_64<span class="tag">&lt;/<span class="name">javacpp.platform.dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javacv<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>*<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opencv<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ffmpeg<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ffmpeg<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>$&#123;javacpp.platform.dependencies&#125;<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="提取视频中的图片"><a href="#提取视频中的图片" class="headerlink" title="提取视频中的图片"></a>提取视频中的图片</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从视频中将每一帧的图片提取出来</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> video</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> FrameGrabber.Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">grab</span><span class="params">(File video)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> (FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(video.getPath())) &#123;</span><br><span class="line">        grabber.start();</span><br><span class="line"></span><br><span class="line">        List&lt;BufferedImage&gt; images = Lists.newArrayList();</span><br><span class="line">        Frame frame;</span><br><span class="line">        <span class="keyword">while</span> ((frame = grabber.grabImage()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            images.add(Java2DFrameUtils.toBufferedImage(frame));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> images;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="图片合成视频"><a href="#图片合成视频" class="headerlink" title="图片合成视频"></a>图片合成视频</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoRecorder</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> FFmpegFrameRecorder recorder;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VideoRecorder</span><span class="params">(String output, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> <span class="keyword">throws</span> FrameRecorder.Exception </span>&#123;</span><br><span class="line">            recorder = <span class="keyword">new</span> FFmpegFrameRecorder(output, width, height);</span><br><span class="line">            recorder.setVideoCodec(avcodec.AV_CODEC_ID_H264);</span><br><span class="line">            recorder.setFormat(<span class="string">&quot;mp4&quot;</span>);</span><br><span class="line">            recorder.setFrameRate(FPS);</span><br><span class="line">            recorder.setAudioBitrate(<span class="number">192000</span>);</span><br><span class="line">            recorder.setSampleRate(<span class="number">44100</span>);</span><br><span class="line">            recorder.setAudioChannels(<span class="number">2</span>);</span><br><span class="line">            recorder.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFrame</span><span class="params">(BufferedImage image)</span> <span class="keyword">throws</span> FrameRecorder.Exception </span>&#123;</span><br><span class="line">            Frame frame = Java2DFrameUtils.toFrame(image);</span><br><span class="line">            recorder.record(frame, avutil.AV_PIX_FMT_ARGB);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAudio</span><span class="params">(File audioFile)</span> <span class="keyword">throws</span> FrameGrabber.Exception, FrameRecorder.Exception </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (audioFile == <span class="keyword">null</span> || !audioFile.exists()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> (FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(audioFile)) &#123;</span><br><span class="line">                grabber.start();</span><br><span class="line">                Frame frame;</span><br><span class="line">                <span class="keyword">while</span> ((frame = grabber.grabSamples()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    recorder.recordSamples(frame.sampleRate, frame.audioChannels, frame.samples);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            recorder.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-09-06T14:44:05.000Z" title="9/6/2018, 2:44:05 PM">2018-09-06</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">11 分钟读完 (大约1642个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/09/06/Java%E5%9B%BE%E7%89%87%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7%E7%B1%BB/">Java图片处理工具类</a></h1><div class="content"><blockquote>
<p>这段代码是我四年前写的，当时的使用场景为使用tesseract做图片的预处理。功能包含图片二值化、移除杂色、横向切分、水平切分等。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.awt.Color;</span><br><span class="line"><span class="keyword">import</span> java.awt.Image;</span><br><span class="line"><span class="keyword">import</span> java.awt.Toolkit;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.ColorModel;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.MemoryImageSource;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.PixelGrabber;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2014-05-29 14:34:13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitItem</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> x;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> w;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> y;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> h;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getX</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setX</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.x = x;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getW</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> w;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setW</span><span class="params">(<span class="keyword">int</span> w)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.w = w;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getY</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> y;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setY</span><span class="params">(<span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.y = y;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> h;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setH</span><span class="params">(<span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.h = h;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片纵向切分（切分为列）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> minWidth 每个汉字的最小宽度，如果汉字的最小宽度小于该参数，那么认为系统将一个汉字截断了</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">splitLengthwaysWithMinWidth</span><span class="params">(BufferedImage image, <span class="keyword">int</span> minWidth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (minWidth &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            minWidth = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;BufferedImage&gt; subImgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> width = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span> startX = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> endX = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> start = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> end = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> blank = isXBlank(image, x);</span><br><span class="line">            <span class="keyword">if</span> (!start) &#123; <span class="comment">//如果是白色</span></span><br><span class="line">                <span class="keyword">int</span> space = spaceX(image, x);</span><br><span class="line">                x = x + space;</span><br><span class="line">                startX = x;</span><br><span class="line">                endX = x;</span><br><span class="line">                start = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (start &amp;&amp; !blank) &#123;</span><br><span class="line">                endX = x;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> wordLength = endX - startX;</span><br><span class="line">            <span class="keyword">if</span> (start &amp;&amp; blank &amp;&amp; wordLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 汉字长度小于设定长度，那么认为这不是一个完成的汉字，而是将左右结构的汉字切分成了两份</span></span><br><span class="line">                <span class="keyword">if</span> (wordLength &lt; minWidth) &#123;</span><br><span class="line">                    <span class="keyword">int</span> space = spaceX(image, x);</span><br><span class="line">                    x = x + space;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    end = <span class="keyword">true</span>;</span><br><span class="line">                    endX = x;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (start &amp;&amp; end &amp;&amp; wordLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                BufferedImage subImage = image.getSubimage(startX, <span class="number">0</span>, (endX - startX), height);</span><br><span class="line">                subImgs.add(subImage);</span><br><span class="line">                start = <span class="keyword">false</span>;</span><br><span class="line">                end = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> subImgs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * x轴上的所有点是空白的（白色的）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isXBlank</span><span class="params">(BufferedImage image, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; height; y++) &#123;</span><br><span class="line">            <span class="keyword">int</span> rgb = image.getRGB(x, y);</span><br><span class="line">            <span class="keyword">if</span> (isBlack(rgb)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片纵向切分（切分为列）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> minGap 文字之间的最小间隙，如果间隙文字之间的间隙小于或等于该参数，那么认为该间隙为一个汉字上的正常间隙。主要处理左右结构的一些汉字，例如：”北、川、外...“</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">splitLengthways</span><span class="params">(BufferedImage image, <span class="keyword">int</span> minGap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (minGap &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            minGap = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;BufferedImage&gt; subImgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> width = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        List&lt;Integer&gt; weightlist = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; height; ++y) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (minGap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> space = spaceX(image, x);</span><br><span class="line">                <span class="keyword">if</span> (space &lt;= minGap) &#123;</span><br><span class="line">                    count = count + space;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            weightlist.add(count);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;SplitItem&gt; splitItems = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; weightlist.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; weightlist.size() &amp;&amp; weightlist.get(i) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                length++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> x = i - length;</span><br><span class="line">                <span class="keyword">int</span> w = length;</span><br><span class="line">                <span class="keyword">int</span> y = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> h = height;</span><br><span class="line">                SplitItem item = <span class="keyword">new</span> SplitItem();</span><br><span class="line">                item.setX(x);</span><br><span class="line">                item.setW(w);</span><br><span class="line">                item.setY(y);</span><br><span class="line">                item.setH(h);</span><br><span class="line">                splitItems.add(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (SplitItem splitItem : splitItems) &#123;</span><br><span class="line">            subImgs.add(image.getSubimage(splitItem.getX(), splitItem.getY(), splitItem.getW(), splitItem.getH()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> subImgs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * X轴上两个字之间的间距</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentX 当前索引所在的x坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">spaceX</span><span class="params">(BufferedImage image, <span class="keyword">int</span> currentX)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> w = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> h = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span> spaceLength = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = currentX; x &lt; w; x++) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> space = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; h; y++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123; <span class="comment">//有黑色的，表明非空白</span></span><br><span class="line">                    space = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (space) &#123;</span><br><span class="line">                spaceLength++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> spaceLength;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> spaceLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * y轴上两个字之间的间距</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentY 当前索引所在的y坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">spaceY</span><span class="params">(BufferedImage image, <span class="keyword">int</span> currentY)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> w = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> h = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span> spaceLength = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = currentY; y &lt; h; y++) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> space = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; w; x++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123; <span class="comment">//有黑色的，表明非空白</span></span><br><span class="line">                    space = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (space) &#123;</span><br><span class="line">                spaceLength++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> spaceLength;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> spaceLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片横向切分（切分为行）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> minGap 两行之间的最小间隙,如果间隙小于或等于该参数,那么认为没有折行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">splitCrosswise</span><span class="params">(BufferedImage image, <span class="keyword">int</span> minGap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (minGap &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            minGap = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;BufferedImage&gt; subImgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> w = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> h = image.getHeight();</span><br><span class="line">        List&lt;Integer&gt; heightlist = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; h; y++) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; w; x++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ImageUtils.isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (minGap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> space = spaceY(image, y);</span><br><span class="line">                <span class="keyword">if</span> (space &lt;= minGap) &#123;</span><br><span class="line">                    count = count + space;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            heightlist.add(count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; heightlist.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; heightlist.size() &amp;&amp; heightlist.get(i) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                length++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> y = i - length;</span><br><span class="line">                <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> height = length;</span><br><span class="line">                <span class="keyword">int</span> width = w;</span><br><span class="line">                BufferedImage bufferedImage = image.getSubimage(x, y, width, height);</span><br><span class="line">                subImgs.add(bufferedImage);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> subImgs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片横向切分（切分为行）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">splitCrosswise</span><span class="params">(BufferedImage image)</span> </span>&#123;</span><br><span class="line">        List&lt;BufferedImage&gt; subImgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> w = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> h = image.getHeight();</span><br><span class="line">        List&lt;Integer&gt; heightlist = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; h; y++) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; w; x++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ImageUtils.isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            heightlist.add(count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; heightlist.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; heightlist.size() &amp;&amp; heightlist.get(i) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                length++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> y = i - length;</span><br><span class="line">                <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> height = length;</span><br><span class="line">                <span class="keyword">int</span> width = w;</span><br><span class="line">                BufferedImage bufferedImage = image.getSubimage(x, y, width, height);</span><br><span class="line">                subImgs.add(bufferedImage);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> subImgs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除杂色(图片二值化)</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 默认图片中字体颜色为黑色，如果非黑色像素全部替换为白色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> java.lang.InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BufferedImage <span class="title">removeMotley</span><span class="params">(BufferedImage image)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> width = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span>[] pixels = <span class="keyword">new</span> <span class="keyword">int</span>[width * height];</span><br><span class="line">        <span class="keyword">int</span> grey = <span class="number">100</span>;</span><br><span class="line">        PixelGrabber pixelGrabber = <span class="keyword">new</span> PixelGrabber(image.getSource(), <span class="number">0</span>, <span class="number">0</span>, width, height, pixels, <span class="number">0</span>, width);</span><br><span class="line">        pixelGrabber.grabPixels();</span><br><span class="line">        ColorModel cm = ColorModel.getRGBdefault();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; width * height; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> red, green, blue;</span><br><span class="line">            <span class="keyword">int</span> alpha = cm.getAlpha(pixels[i]);</span><br><span class="line">            <span class="keyword">if</span> (cm.getRed(pixels[i]) &gt; grey) &#123;</span><br><span class="line">                red = <span class="number">255</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                red = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cm.getGreen(pixels[i]) &gt; grey) &#123;</span><br><span class="line">                green = <span class="number">255</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                green = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cm.getBlue(pixels[i]) &gt; grey) &#123;</span><br><span class="line">                blue = <span class="number">255</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                blue = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            pixels[i] = alpha &lt;&lt; <span class="number">24</span> | red &lt;&lt; <span class="number">16</span> | green &lt;&lt; <span class="number">8</span> | blue; <span class="comment">//通过移位重新构成某一点像素的RGB值</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将数组中的象素产生一个图像</span></span><br><span class="line">        Image tempImg = Toolkit.getDefaultToolkit().createImage(<span class="keyword">new</span> MemoryImageSource(width, height, pixels, <span class="number">0</span>, width));</span><br><span class="line">        image = <span class="keyword">new</span> BufferedImage(tempImg.getWidth(<span class="keyword">null</span>), tempImg.getHeight(<span class="keyword">null</span>), BufferedImage.TYPE_INT_BGR);</span><br><span class="line">        image.createGraphics().drawImage(tempImg, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> image;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清除空白部分</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BufferedImage <span class="title">removeSpace</span><span class="params">(BufferedImage image)</span> </span>&#123;</span><br><span class="line">        BufferedImage result = removeTBWhite(image);</span><br><span class="line">        <span class="keyword">return</span> removeLRWhite(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除上下白色部分（top bottom）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BufferedImage <span class="title">removeTBWhite</span><span class="params">(BufferedImage image)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> width = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> end = <span class="number">0</span>;</span><br><span class="line">        Label1:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; height; ++y) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (count &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    start = y;</span><br><span class="line">                    <span class="keyword">break</span> Label1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Label2:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = height - <span class="number">1</span>; y &gt;= <span class="number">0</span>; --y) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (count &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    end = y;</span><br><span class="line">                    <span class="keyword">break</span> Label2;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> image.getSubimage(<span class="number">0</span>, start, width, end - start + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除左右白色部分（left right）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BufferedImage <span class="title">removeLRWhite</span><span class="params">(BufferedImage image)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> width = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> end = <span class="number">0</span>;</span><br><span class="line">        Label1:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; height; ++y) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (count &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    start = x;</span><br><span class="line">                    <span class="keyword">break</span> Label1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Label2:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = width - <span class="number">1</span>; x &gt;= <span class="number">0</span>; --x) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> y = height - <span class="number">1</span>; y &gt;= <span class="number">0</span>; --y) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (count &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    end = x;</span><br><span class="line">                    <span class="keyword">break</span> Label2;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> image.getSubimage(start, <span class="number">0</span>, end - start + <span class="number">1</span>, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除黑色部分</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> img</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BufferedImage <span class="title">removeBlack</span><span class="params">(BufferedImage img)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> width = img.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = img.getHeight();</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> end = <span class="number">0</span>;</span><br><span class="line">        Label1:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; height; ++y) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(img.getRGB(x, y))) &#123;</span><br><span class="line">                    start = y;</span><br><span class="line">                    <span class="keyword">break</span> Label1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Label2:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = height - <span class="number">1</span>; y &gt;= <span class="number">0</span>; --y) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(img.getRGB(x, y))) &#123;</span><br><span class="line">                    end = y;</span><br><span class="line">                    <span class="keyword">break</span> Label2;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> img.getSubimage(<span class="number">0</span>, start, width, end - start + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是黑色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> colorInt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isBlack</span><span class="params">(<span class="keyword">int</span> colorInt)</span> </span>&#123;</span><br><span class="line">        Color color = <span class="keyword">new</span> Color(colorInt);</span><br><span class="line">        <span class="keyword">return</span> color.getRed() + color.getGreen() + color.getBlue() &lt;= <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是白色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> colorInt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isWhite</span><span class="params">(<span class="keyword">int</span> colorInt)</span> </span>&#123;</span><br><span class="line">        Color color = <span class="keyword">new</span> Color(colorInt);</span><br><span class="line">        <span class="keyword">return</span> color.getRed() + color.getGreen() + color.getBlue() &gt; <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-08-27T12:34:03.000Z" title="8/27/2018, 12:34:03 PM">2018-08-27</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约138个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/27/%E5%B0%8F%E7%B1%B3%E6%89%8B%E6%9C%BA%E5%AE%89%E8%A3%85Charles%E8%AF%81%E4%B9%A6/">小米手机安装Charles证书</a></h1><div class="content"><p>平时使用Charles进行接口抓包，新换小米手机之后发现按照之前的流程安装Charles ssl证书不好使，百度了好久才找到一下解决办法。</p>
<ul>
<li>使用第三方浏览器（我用的是QQ浏览器）下载.pem 格式的文件</li>
<li>将这个文件放入小米的<code>Download</code>文件夹下</li>
<li>将.pem文件修改为.crt 格式</li>
<li>设置—更多设置—系统安全—加密与凭据—从存储设备安装–选择<code>Download</code>文件夹下的文件</li>
<li>Finish~~</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-08-14T12:56:36.000Z" title="8/14/2018, 12:56:36 PM">2018-08-14</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">6 分钟读完 (大约865个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/14/javacv%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/">javacv使用笔记</a></h1><div class="content"><h2 id="使用过程中遇到的异常"><a href="#使用过程中遇到的异常" class="headerlink" title="使用过程中遇到的异常"></a>使用过程中遇到的异常</h2><h3 id="异常：Could-not-initialize-class-org-bytedeco-javacpp-avutil"><a href="#异常：Could-not-initialize-class-org-bytedeco-javacpp-avutil" class="headerlink" title="异常：Could not initialize class org.bytedeco.javacpp.avutil"></a>异常：Could not initialize class org.bytedeco.javacpp.avutil</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: Could not initialize class org.bytedeco.javacpp.avutil</span><br><span class="line">at java.lang.Class.forName0(Native Method)</span><br><span class="line">at java.lang.Class.forName(Class.java:274)</span><br><span class="line">at org.bytedeco.javacpp.Loader.load(Loader.java:385)</span><br><span class="line">at org.bytedeco.javacpp.Loader.load(Loader.java:353)</span><br><span class="line">at org.bytedeco.javacpp.avformat$AVFormatContext.&lt;clinit&gt;(avformat.java:2249)</span><br><span class="line">at org.bytedeco.javacv.FFmpegFrameGrabber.startUnsafe(FFmpegFrameGrabber.java:346)</span><br><span class="line">at org.bytedeco.javacv.FFmpegFrameGrabber.start(FFmpegFrameGrabber.java:340)</span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package exec:java -Dplatform.dependencies -Dexec.mainClass=Demo</span><br></pre></td></tr></table></figure>

<h3 id="警告：Warning-data-is-not-aligned-This-can-lead-to-a-speedloss"><a href="#警告：Warning-data-is-not-aligned-This-can-lead-to-a-speedloss" class="headerlink" title="警告：Warning: data is not aligned! This can lead to a speedloss"></a>警告：Warning: data is not aligned! This can lead to a speedloss</h3><p>出现这个警告是因为ffmpeg要求视频的宽度必须是32的倍数，高度必须是2的倍数，按要求修改下宽高就好了。</p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.math.NumberUtils;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.javacpp.avcodec;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.javacpp.opencv_core;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.javacpp.opencv_imgcodecs;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.javacv.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018-08-15 16:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenCVUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;BufferedImage&gt; images = grab(<span class="keyword">new</span> File(<span class="string">&quot;/data/opencv/test.mp4&quot;</span>));</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (BufferedImage image : images) &#123;</span><br><span class="line">            ImageIO.write(image, <span class="string">&quot;jpg&quot;</span>, <span class="keyword">new</span> File(<span class="string">&quot;/data/opencv/frame/&quot;</span> + i + <span class="string">&quot;.jpg&quot;</span>));</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// grabAudioFromVideo(new File(&quot;/data/opencv/test.mp4&quot;), new File(&quot;/data/opencv/test.aac&quot;));</span></span><br><span class="line"></span><br><span class="line">        List&lt;File&gt; files = Lists.newArrayList(FileUtils.listFiles(<span class="keyword">new</span> File(<span class="string">&quot;/data/opencv/frame/&quot;</span>), <span class="keyword">new</span> String[]&#123;<span class="string">&quot;jpg&quot;</span>&#125;, <span class="keyword">false</span>));</span><br><span class="line">        Collections.sort(files, (o1, o2) -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> i1 = NumberUtils.toInt(StringUtils.substringBefore(o1.getName(), <span class="string">&quot;.&quot;</span>));</span><br><span class="line">            <span class="keyword">int</span> i2 = NumberUtils.toInt(StringUtils.substringBefore(o2.getName(), <span class="string">&quot;.&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> Integer.compare(i1, i2);</span><br><span class="line">        &#125;);</span><br><span class="line">        record(<span class="string">&quot;/data/opencv/out.mp4&quot;</span>, files, <span class="keyword">new</span> File(<span class="string">&quot;/data/opencv/test.aac&quot;</span>), <span class="number">544</span>, <span class="number">960</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将多个图片文件合成视频</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> output    输出文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> images    序列帧图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> audioFile 音频</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> width     宽</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> height    高</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">(String output, List&lt;File&gt; images, File audioFile, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (FFmpegFrameRecorder recorder = <span class="keyword">new</span> FFmpegFrameRecorder(output, width, height);</span><br><span class="line">             FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(audioFile)) &#123;</span><br><span class="line">            recorder.setVideoCodec(avcodec.AV_CODEC_ID_H264);</span><br><span class="line">            recorder.setFormat(<span class="string">&quot;mp4&quot;</span>);</span><br><span class="line">            recorder.setFrameRate(<span class="number">30</span>);</span><br><span class="line">            recorder.setAudioBitrate(<span class="number">192000</span>);</span><br><span class="line">            recorder.setAudioQuality(<span class="number">0</span>);</span><br><span class="line">            recorder.setSampleRate(<span class="number">44100</span>);</span><br><span class="line">            recorder.setAudioChannels(<span class="number">2</span>);</span><br><span class="line">            recorder.start();</span><br><span class="line"></span><br><span class="line">            OpenCVFrameConverter.ToIplImage converter = <span class="keyword">new</span> OpenCVFrameConverter.ToIplImage();</span><br><span class="line">            <span class="keyword">for</span> (File file : images) &#123;</span><br><span class="line">                opencv_core.IplImage image = opencv_imgcodecs.cvLoadImage(file.getPath());</span><br><span class="line">                recorder.record(converter.convert(image));</span><br><span class="line">                opencv_core.cvReleaseImage(image);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            grabber.start();</span><br><span class="line">            Frame frame;</span><br><span class="line">            <span class="keyword">while</span> ((frame = grabber.grabSamples()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                recorder.setTimestamp(frame.timestamp);</span><br><span class="line">                recorder.recordSamples(frame.sampleRate, frame.audioChannels, frame.samples);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从视频中将每一帧的图片提取出来</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> video</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> FrameGrabber.Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">grab</span><span class="params">(File video)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(video.getPath())) &#123;</span><br><span class="line">            grabber.start();</span><br><span class="line"></span><br><span class="line">            List&lt;BufferedImage&gt; images = Lists.newArrayList();</span><br><span class="line">            Frame frame;</span><br><span class="line">            <span class="keyword">while</span> ((frame = grabber.grabImage()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                images.add(Java2DFrameUtils.toBufferedImage(frame));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> images;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从视频中提取出音频</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> video</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputAudio</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">grabAudioFromVideo</span><span class="params">(File video, File outputAudio)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(video);</span><br><span class="line">             FFmpegFrameRecorder recorder = <span class="keyword">new</span> FFmpegFrameRecorder(outputAudio, <span class="number">1</span>)) &#123;</span><br><span class="line">            grabber.start();</span><br><span class="line">            recorder.setAudioCodec(avcodec.AV_CODEC_ID_AAC);</span><br><span class="line">            recorder.start();</span><br><span class="line"></span><br><span class="line">            Frame frame;</span><br><span class="line">            <span class="keyword">while</span> ((frame = grabber.grab()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (frame.audioChannels == <span class="number">1</span>) &#123;</span><br><span class="line">                    recorder.recordSamples(frame.sampleRate, frame.audioChannels, frame.samples);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="图片合成视频简单的封装"><a href="#图片合成视频简单的封装" class="headerlink" title="图片合成视频简单的封装"></a>图片合成视频简单的封装</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoRecorder</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> FFmpegFrameRecorder recorder;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VideoRecorder</span><span class="params">(String output, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> <span class="keyword">throws</span> FrameRecorder.Exception </span>&#123;</span><br><span class="line">            recorder = <span class="keyword">new</span> FFmpegFrameRecorder(output, width, height);</span><br><span class="line">            recorder.setVideoCodec(avcodec.AV_CODEC_ID_H264);</span><br><span class="line">            recorder.setFormat(<span class="string">&quot;mp4&quot;</span>);</span><br><span class="line">            recorder.setFrameRate(FPS);</span><br><span class="line">            recorder.setAudioBitrate(<span class="number">192000</span>);</span><br><span class="line">            recorder.setAudioQuality(<span class="number">0</span>);</span><br><span class="line">            recorder.setSampleRate(<span class="number">44100</span>);</span><br><span class="line">            recorder.setAudioChannels(<span class="number">2</span>);</span><br><span class="line">            recorder.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFrame</span><span class="params">(BufferedImage image)</span> <span class="keyword">throws</span> FrameRecorder.Exception </span>&#123;</span><br><span class="line">            Frame frame = Java2DFrameUtils.toFrame(image);</span><br><span class="line">            recorder.record(frame, avutil.AV_PIX_FMT_ARGB);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAudio</span><span class="params">(File audioFile)</span> <span class="keyword">throws</span> FrameGrabber.Exception, FrameRecorder.Exception </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (audioFile == <span class="keyword">null</span> || !audioFile.exists()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> (FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(audioFile)) &#123;</span><br><span class="line">                grabber.start();</span><br><span class="line">                Frame frame;</span><br><span class="line">                <span class="keyword">while</span> ((frame = grabber.grabSamples()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    recorder.recordSamples(frame.sampleRate, frame.audioChannels, frame.samples);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            recorder.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="解决maven打包时将不必要的包引入进来的问题"><a href="#解决maven打包时将不必要的包引入进来的问题" class="headerlink" title="解决maven打包时将不必要的包引入进来的问题"></a>解决maven打包时将不必要的包引入进来的问题</h2><p>我在实际使用中只用到了<code>ffmpeg</code>，但是打包的时候却将flycapture、libdc1394、libfreenect、artoolkitplus、tesseract…等包都打进来了，这些都是我不需要的，下面贴出我的maven配置示例。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javacpp.version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">javacpp.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 这里要根据自己的平台选择不同的依赖 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;javacpp.platform.dependencies&gt;linux-x86_64&lt;/javacpp.platform.dependencies&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javacpp.platform.dependencies</span>&gt;</span>macosx-x86_64<span class="tag">&lt;/<span class="name">javacpp.platform.dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javacv<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>*<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opencv<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ffmpeg<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ffmpeg<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>$&#123;javacpp.platform.dependencies&#125;<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-08-11T17:53:46.000Z" title="8/11/2018, 5:53:46 PM">2018-08-11</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">5 分钟读完 (大约761个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/11/%E6%94%B6%E8%97%8F%E4%B8%A4%E9%A6%96%E7%A8%8B%E5%BA%8F%E5%91%98%E6%89%93%E6%B2%B9%E8%AF%97/">收藏两首程序员打油诗</a></h1><div class="content"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">商女不知亡国恨，一天到晚敲代码。</span><br><span class="line">举头望明月，低头敲代码。</span><br><span class="line">洛阳亲友如相问，就说我在敲代码。</span><br><span class="line">少壮不努力，老大敲代码。</span><br><span class="line">垂死病中惊坐起，今天还没敲代码。</span><br><span class="line">生当作人杰，死亦敲代码。</span><br><span class="line">人生自古谁无死，来生继续敲代码。</span><br><span class="line">众里寻他千百度，蓦然回首，那人正在敲代码。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">写字楼里写字间，写字间里程序员；程序人员写程序，又拿程序换酒钱。</span><br><span class="line">酒醒只在网上坐，酒醉还来网下眠；酒醉酒醒日复日，网上网下年复年。</span><br><span class="line">宁愿老死程序间，只要老板多发钱；小车大房不去想，撰个二千好过年。</span><br><span class="line">若要见识新世面，公务员比程序员；一个在天一在地，而且还比我们闲。</span><br><span class="line">别人看我穿白领，我看别人穿名牌；天生我才写程序，臀大近视肩周炎。</span><br><span class="line"></span><br><span class="line">年复一年春光度，度得他人做老板；老板扣我薄酒钱，没有酒钱怎过年。</span><br><span class="line">春光逝去皱纹起，作起程序也委靡；来到水源把水灌，打死不做程序员。</span><br><span class="line">别人笑我忒疯癫，我笑他人命太贱；状元三百六十行，偏偏来做程序员。</span><br><span class="line">但愿老死电脑间，不愿鞠躬老板前；奔驰宝马贵者趣，公交自行程序员。</span><br><span class="line">别人笑我忒疯癫，我笑自己命太贱；不见满街漂亮妹，哪个归得程序员。</span><br><span class="line"></span><br><span class="line">不想只挣打工钱，那个老板愿发钱；小车大房咱要想，任我享用多悠闲。</span><br><span class="line">比尔能搞个微软，我咋不能捞点钱；一个在天一在地，定有一日乾坤翻。</span><br><span class="line">我在天来他在地，纵横天下山水间；傲视武林豪杰墓，一樽还垒风月山。</span><br><span class="line">电脑面前眼发直，眼镜下面泪茫茫；做梦发财好几亿，从此不用手指忙。</span><br><span class="line">哪知梦醒手空空，老板看到把我训；待到老时眼发花，走路不知哪是家。</span><br><span class="line"></span><br><span class="line">小农村里小民房，小民房里小民工；小民工人写程序，又拿代码讨赏钱。</span><br><span class="line">钱空只在代码中，钱醉仍在代码间；有钱无钱日复日，码上码下年复年。</span><br><span class="line">但愿老死代码间，不愿鞠躬奥迪前，奥迪奔驰贵者趣，程序代码贫者缘。</span><br><span class="line">若将贫贱比贫者，一在平地一在天；若将贫贱比车马，他得驱驰我得闲。</span><br><span class="line">别人笑我忒疯癫，我笑他人看不穿；不见盖茨两手间，财权富贵世人鉴。</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-08-09T14:47:52.000Z" title="8/9/2018, 2:47:52 PM">2018-08-09</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">4 分钟读完 (大约528个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/09/DelayQueue%E4%BD%BF%E7%94%A8/">DelayQueue使用</a></h1><div class="content"><h2 id="DelayQueue特性"><a href="#DelayQueue特性" class="headerlink" title="DelayQueue特性"></a>DelayQueue特性</h2><ul>
<li>队列中的元素都必须实现Delayed，元素可以指定延迟消费时长。</li>
<li>实现了BlockingQueue接口，所以他是一个阻塞队列。</li>
<li>本质上是基于PriorityQueue实现的。</li>
</ul>
<h2 id="贴一段我在实际生产环境中使用到代码"><a href="#贴一段我在实际生产环境中使用到代码" class="headerlink" title="贴一段我在实际生产环境中使用到代码"></a>贴一段我在实际生产环境中使用到代码</h2><h3 id="队列管理"><a href="#队列管理" class="headerlink" title="队列管理"></a>队列管理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.DelayQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018-07-26 19:53</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayQueueManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(DelayQueueManager.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> ExecutorService executor;</span><br><span class="line">    <span class="keyword">private</span> Thread monitorThread;</span><br><span class="line">    <span class="keyword">private</span> DelayQueue&lt;DelayTask&lt;?&gt;&gt; delayQueue; <span class="comment">// 延时队列</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayQueueManager</span><span class="params">(String name, <span class="keyword">int</span> poolSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.executor = Executors.newFixedThreadPool(poolSize);</span><br><span class="line">        <span class="keyword">this</span>.delayQueue = <span class="keyword">new</span> DelayQueue&lt;&gt;();</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        monitorThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            execute();</span><br><span class="line">        &#125;, <span class="string">&quot;DelayQueueMonitor-&quot;</span> + name);</span><br><span class="line">        monitorThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;当前延时任务数量:&quot;</span> + delayQueue.size());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 从延时队列中获取任务</span></span><br><span class="line">                DelayTask&lt;?&gt; delayTask = delayQueue.take();</span><br><span class="line">                <span class="keyword">if</span> (delayTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Runnable task = delayTask.getTask();</span><br><span class="line">                    <span class="keyword">if</span> (task != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 提交到线程池执行task</span></span><br><span class="line">                        executor.execute(task);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOG.error(<span class="keyword">null</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id   任务编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task 任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 延时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit 时间单位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String id, Runnable task, <span class="keyword">long</span> time, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> timeout = TimeUnit.MILLISECONDS.convert(time, unit);</span><br><span class="line">        <span class="keyword">long</span> delayTimeMillis = System.currentTimeMillis() + timeout;</span><br><span class="line">        delayQueue.put(<span class="keyword">new</span> DelayTask&lt;&gt;(id, delayTimeMillis, task));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id              任务编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task            任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delayTimeMillis 延迟到什么时间点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putAt</span><span class="params">(String id, Runnable task, <span class="keyword">long</span> delayTimeMillis)</span> </span>&#123;</span><br><span class="line">        delayQueue.put(<span class="keyword">new</span> DelayTask&lt;&gt;(id, delayTimeMillis, task));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据任务编号删除任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeTaskById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        DelayTask task = <span class="keyword">new</span> DelayTask(id, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> delayQueue.remove(task);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeTask</span><span class="params">(DelayTask task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delayQueue.remove(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="延迟任务对象"><a href="#延迟任务对象" class="headerlink" title="延迟任务对象"></a>延迟任务对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Delayed;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018-07-26 19:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayTask</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Runnable</span>&gt; <span class="keyword">implements</span> <span class="title">Delayed</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> delayTimeMillis; <span class="comment">// 延迟到什么时间点执行</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T task; <span class="comment">// 任务</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayTask</span><span class="params">(String id, <span class="keyword">long</span> delayTimeMillis, T task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.delayTimeMillis = delayTimeMillis;</span><br><span class="line">        <span class="keyword">this</span>.task = task;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> task;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123;</span><br><span class="line">        DelayTask other = (DelayTask) o;</span><br><span class="line">        <span class="keyword">long</span> diff = delayTimeMillis - other.delayTimeMillis;</span><br><span class="line">        <span class="keyword">if</span> (diff &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (diff &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unit.convert(<span class="keyword">this</span>.delayTimeMillis - System.currentTimeMillis(), TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        DelayTask&lt;?&gt; delayTask = (DelayTask&lt;?&gt;) o;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(id, delayTask.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-08-07T11:15:51.000Z" title="8/7/2018, 11:15:51 AM">2018-08-07</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约109个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/07/hexo-client-1-1-3%E6%9B%B4%E6%96%B0/">hexo-client 1.1.3更新</a></h1><div class="content"><ul>
<li>升级markdown编辑器，使用mavonEditor编辑器（<a target="_blank" rel="noopener" href="https://github.com/hinesboy/mavonEditor%EF%BC%89%E3%80%82">https://github.com/hinesboy/mavonEditor）。</a></li>
<li>修复图片文章列表过长是，切换页面滚动位置丢失的问题。</li>
<li>重构代码，优化调用逻辑和布局层级关系。</li>
<li>升级electron版本到2.0.6。</li>
</ul>
<p>mac版本下载地址：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1VuJIOoltpsTwnurn9aVQXw">https://pan.baidu.com/s/1VuJIOoltpsTwnurn9aVQXw</a></p>
<p><img src="http://file.mspring.org/images/blog/8b299e7bad6e69b7612cdee592019bf9!detail"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-08-07T10:42:10.000Z" title="8/7/2018, 10:42:10 AM">2018-08-07</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约96个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/07/npm%E5%8F%91%E5%B8%83%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8C%85/">npm发布自己的包</a></h1><div class="content"><ol>
<li>如果没有账号，那么使用<code>npm adduser</code>去创建账号，中间会引导你输入用户名、密码、邮箱。</li>
<li>如果已经有账号，需要使用<code>npm login</code>去登录，同样会引导你输入正确的用户名、密码、邮箱。</li>
<li>登录成功之后使用<code>npm publish</code>将自己的包发不上去。</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-05-11T18:20:37.000Z" title="5/11/2018, 6:20:37 PM">2018-05-11</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约153个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/05/11/ffmpeg%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/">ffmpeg常用命令总结</a></h1><div class="content"><h2 id="音频格式转换"><a href="#音频格式转换" class="headerlink" title="音频格式转换"></a>音频格式转换</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -y  -i aidemo.mp3  -acodec pcm_s16le -f s16le -ac 1 -ar 16000 16k.pcm </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; -acodec pcm_s16le pcm_s16le 16bits 编码器 </span><br><span class="line">&#x2F;&#x2F; -f s16le 保存为16bits pcm格式</span><br><span class="line">&#x2F;&#x2F; -ac 1 单声道</span><br><span class="line">&#x2F;&#x2F;  -ar 16000  16000采样率</span><br></pre></td></tr></table></figure>

<h2 id="查看音频格式"><a href="#查看音频格式" class="headerlink" title="查看音频格式"></a>查看音频格式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">ffprobe -v quiet -print_format json -show_streams  aidemo.mp3</span><br><span class="line"></span><br><span class="line">输出如下：</span><br><span class="line"> &#123;</span><br><span class="line">    &quot;streams&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;index&quot;: 0,</span><br><span class="line">            &quot;codec_name&quot;: &quot;mp3&quot;, &#x2F;&#x2F; mp3 格式</span><br><span class="line">            &quot;codec_long_name&quot;: &quot;MP3 (MPEG audio layer 3)&quot;,</span><br><span class="line">            &quot;codec_type&quot;: &quot;audio&quot;,</span><br><span class="line">            &quot;codec_time_base&quot;: &quot;1&#x2F;16000&quot;, </span><br><span class="line">            &quot;codec_tag_string&quot;: &quot;[0][0][0][0]&quot;,</span><br><span class="line">            &quot;codec_tag&quot;: &quot;0x0000&quot;,</span><br><span class="line">            &quot;sample_fmt&quot;: &quot;s16p&quot;, </span><br><span class="line">            &quot;sample_rate&quot;: &quot;16000&quot;, &#x2F;&#x2F; 16000采样率</span><br><span class="line">            &quot;channels&quot;: 1, &#x2F;&#x2F; 单声道</span><br><span class="line">            &quot;channel_layout&quot;: &quot;mono&quot;,</span><br><span class="line">            &quot;bits_per_sample&quot;: 0,</span><br><span class="line">            &quot;r_frame_rate&quot;: &quot;0&#x2F;0&quot;,</span><br><span class="line">            &quot;avg_frame_rate&quot;: &quot;0&#x2F;0&quot;,</span><br><span class="line">            &quot;time_base&quot;: &quot;1&#x2F;14112000&quot;,</span><br><span class="line">            &quot;start_pts&quot;: 0,</span><br><span class="line">            &quot;start_time&quot;: &quot;0.000000&quot;,</span><br><span class="line">            &quot;duration_ts&quot;: 259096320,</span><br><span class="line">            &quot;duration&quot;: &quot;18.360000&quot;,</span><br><span class="line">            &quot;bit_rate&quot;: &quot;16000&quot;,</span><br><span class="line">            &quot;disposition&quot;: &#123;</span><br><span class="line">                &quot;default&quot;: 0,</span><br><span class="line">                &quot;dub&quot;: 0,</span><br><span class="line">                &quot;original&quot;: 0,</span><br><span class="line">                &quot;comment&quot;: 0,</span><br><span class="line">                &quot;lyrics&quot;: 0,</span><br><span class="line">                &quot;karaoke&quot;: 0,</span><br><span class="line">                &quot;forced&quot;: 0,</span><br><span class="line">                &quot;hearing_impaired&quot;: 0,</span><br><span class="line">                &quot;visual_impaired&quot;: 0,</span><br><span class="line">                &quot;clean_effects&quot;: 0,</span><br><span class="line">                &quot;attached_pic&quot;: 0,</span><br><span class="line">                &quot;timed_thumbnails&quot;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-05-09T09:49:37.000Z" title="5/9/2018, 9:49:37 AM">2018-05-09</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约82个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/05/09/Guava-Range%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/">Guava Range使用方法</a></h1><div class="content"><table>
<thead>
<tr>
<th><strong>概念</strong></th>
<th><strong>表示范围</strong></th>
<th><strong>guava对应功能方法</strong></th>
</tr>
</thead>
<tbody><tr>
<td>(a..b)</td>
<td>{x &#124; a &lt; x &lt; b}</td>
<td>open(C, C)</td>
</tr>
<tr>
<td>[a..b]</td>
<td>{x &#124; a &lt;= x &lt;= b}</td>
<td>closed(C, C)</td>
</tr>
<tr>
<td>[a..b)</td>
<td>{x &#124; a &lt;= x &lt; b}</td>
<td>closedOpen(C, C)</td>
</tr>
<tr>
<td>(a..b]</td>
<td>{x &#124; a &lt; x &lt;= b}</td>
<td>openClosed(C, C)</td>
</tr>
<tr>
<td>(a..+∞)</td>
<td>{x &#124; x &gt; a}</td>
<td>greaterThan(C)</td>
</tr>
<tr>
<td>[a..+∞)</td>
<td>{x &#124; x &gt;= a}</td>
<td>atLeast(C)</td>
</tr>
<tr>
<td>(-∞..b)</td>
<td>{x &#124; x &lt; b}</td>
<td>lessThan(C)</td>
</tr>
<tr>
<td>(-∞..b]</td>
<td>{x &#124; x &lt;= b}</td>
<td>atMost(C)</td>
</tr>
<tr>
<td>(-∞..+∞)</td>
<td>all values</td>
<td>all()</td>
</tr>
</tbody></table>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-04-27T10:07:13.000Z" title="4/27/2018, 10:07:13 AM">2018-04-27</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">8 分钟读完 (大约1236个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/04/27/%E5%BE%AE%E4%BF%A1%E7%BA%A2%E5%8C%85%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E7%AE%80%E4%BB%8B/">微信红包的架构设计简介</a></h1><div class="content"><p>转载自：<a target="_blank" rel="noopener" href="http://colobu.com/2015/05/04/weixin-red-packets-design-discussion/">http://colobu.com/2015/05/04/weixin-red-packets-design-discussion/</a></p>
<p>背景：有某个朋友在朋友圈咨询微信红包的架构，于是乎有了下面的文字（有误请提出，谢谢）<br>概况：2014年微信红包使用数据库硬抗整个流量，2015年使用cache抗流量。</p>
<h3 id="微信的金额什么时候算？"><a href="#微信的金额什么时候算？" class="headerlink" title="微信的金额什么时候算？"></a>微信的金额什么时候算？</h3><p>答：微信金额是拆的时候实时算出来，不是预先分配的，采用的是纯内存计算，不需要预算空间存储。<br>采取实时计算金额的考虑：预算需要占存储，实时效率很高，预算才效率低。</p>
<h3 id="实时性：为什么明明抢到红包，点开后发现没有？"><a href="#实时性：为什么明明抢到红包，点开后发现没有？" class="headerlink" title="实时性：为什么明明抢到红包，点开后发现没有？"></a>实时性：为什么明明抢到红包，点开后发现没有？</h3><p>答：2014年的红包一点开就知道金额，分两次操作，先抢到金额，然后再转账。<br>2015年的红包的拆和抢是分离的，需要点两次，因此会出现抢到红包了，但点开后告知红包已经被领完的状况。进入到第一个页面不代表抢到，只表示当时红包还有。</p>
<h3 id="分配：红包里的金额怎么算？为什么出现各个红包金额相差很大？"><a href="#分配：红包里的金额怎么算？为什么出现各个红包金额相差很大？" class="headerlink" title="分配：红包里的金额怎么算？为什么出现各个红包金额相差很大？"></a>分配：红包里的金额怎么算？为什么出现各个红包金额相差很大？</h3><p>答：随机，额度在0.01和剩余平均值 * 2之间。 例如：发100块钱，总共10个红包，那么平均值是10块钱一个，那么发出来的红包的额度在0.01元～20元之间波动。<br>当前面3个红包总共被领了40块钱时，剩下60块钱，总共7个红包，那么这7个红包的额度在：0.01～（60/7 * 2）=17.14之间。<br>注意：这里的算法是每被抢一个后，剩下的会再次执行上面的这样的算法（Tim老师也觉得上述算法太复杂，不知基于什么样的考虑）。</p>
<blockquote>
<p>这样算下去，会超过最开始的全部金额，因此到了最后面如果不够这么算，那么会采取如下算法：保证剩余用户能拿到最低1分钱即可。<br>如果前面的人手气不好，那么后面的余额越多，红包额度也就越多，因此实际概率一样的。</p>
</blockquote>
<h3 id="红包的设计"><a href="#红包的设计" class="headerlink" title="红包的设计"></a>红包的设计</h3><p>答：微信从财付通拉取金额数据过来，生成个数/红包类型/金额放到redis集群里，app端将红包ID的请求放入请求队列中，如果发现超过红包的个数，直接返回。根据红包的逻辑处理成功得到令牌请求，则由财付通进行一致性调用，通过像比特币一样，两边保存交易记录，交易后交给第三方服务审计，如果交易过程中出现不一致就强制回归。</p>
<h3 id="并发性处理：红包如何计算被抢完？"><a href="#并发性处理：红包如何计算被抢完？" class="headerlink" title="并发性处理：红包如何计算被抢完？"></a>并发性处理：红包如何计算被抢完？</h3><p>答：cache会抵抗无效请求，将无效的请求过滤掉，实际进入到后台的量不大。cache记录红包个数，原子操作进行个数递减，到0表示被抢光。财付通按照20万笔每秒入账准备，但实际还不到8万每秒。</p>
<h3 id="通如何保持8w每秒的写入？"><a href="#通如何保持8w每秒的写入？" class="headerlink" title="通如何保持8w每秒的写入？"></a>通如何保持8w每秒的写入？</h3><p>答：多主sharding，水平扩展机器。</p>
<h3 id="数据容量多少？"><a href="#数据容量多少？" class="headerlink" title="数据容量多少？"></a>数据容量多少？</h3><p>答：一个红包只占一条记录，有效期只有几天，因此不需要太多空间。</p>
<h3 id="查询红包分配，压力大不？"><a href="#查询红包分配，压力大不？" class="headerlink" title="查询红包分配，压力大不？"></a>查询红包分配，压力大不？</h3><p>答：抢到红包的人数和红包都在一条cache记录上，没有太大的查询压力。</p>
<h3 id="一个红包一个队列？"><a href="#一个红包一个队列？" class="headerlink" title="一个红包一个队列？"></a>一个红包一个队列？</h3><p>答：没有队列，一个红包一条数据，数据上有一个计数器字段。</p>
<h3 id="有没有从数据上证明每个红包的概率是不是均等？"><a href="#有没有从数据上证明每个红包的概率是不是均等？" class="headerlink" title="有没有从数据上证明每个红包的概率是不是均等？"></a>有没有从数据上证明每个红包的概率是不是均等？</h3><p>答：不是绝对均等，就是一个简单的拍脑袋算法。</p>
<h3 id="拍脑袋算法，会不会出现两个最佳？"><a href="#拍脑袋算法，会不会出现两个最佳？" class="headerlink" title="拍脑袋算法，会不会出现两个最佳？"></a>拍脑袋算法，会不会出现两个最佳？</h3><p>答：会出现金额一样的，但是手气最佳只有一个，先抢到的那个最佳。</p>
<h3 id="每领一个红包就更新数据么？"><a href="#每领一个红包就更新数据么？" class="headerlink" title="每领一个红包就更新数据么？"></a>每领一个红包就更新数据么？</h3><p>答：每抢到一个红包，就cas更新剩余金额和红包个数。</p>
<h3 id="红包如何入库入账？"><a href="#红包如何入库入账？" class="headerlink" title="红包如何入库入账？"></a>红包如何入库入账？</h3><p>数据库会累加已经领取的个数与金额，插入一条领取记录。入账则是后台异步操作。</p>
<h3 id="入帐出错怎么办？比如红包个数没了，但余额还有？"><a href="#入帐出错怎么办？比如红包个数没了，但余额还有？" class="headerlink" title="入帐出错怎么办？比如红包个数没了，但余额还有？"></a>入帐出错怎么办？比如红包个数没了，但余额还有？</h3><p>答：最后会有一个take all操作。另外还有一个对账来保障。</p>
<p>下面这张图是@周帆 同学的杰作！<br><img src="http://file.mspring.org/images/blog/29b9b3e981a63d78318a4d4ad472e71a"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-04-10T20:23:49.000Z" title="4/10/2018, 8:23:49 PM">2018-04-10</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约31个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/04/10/%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8E%A8%E9%80%81Jar%E5%8C%85%E5%88%B0nexus/">命令行推送Jar包到nexus</a></h1><div class="content"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn deploy:deploy-file -DgroupId&#x3D;com.tencent -DartifactId&#x3D;xinge -Dversion&#x3D;1.1.8 -Dpackaging&#x3D;jar -DrepositoryId&#x3D;nexus -Dfile&#x3D;&#x2F;Users&#x2F;gaoyoubo&#x2F;xinge-push.jar -Durl&#x3D;http:&#x2F;&#x2F;xxx.xxx.com:8081&#x2F;nexus&#x2F;content&#x2F;repositories&#x2F;thirdparty&#x2F; -DgeneratePom&#x3D;false</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-03-31T13:56:30.000Z" title="3/31/2018, 1:56:30 PM">2018-03-31</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">8 分钟读完 (大约1127个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/31/%E5%B9%B6%E5%8F%91%E9%98%9F%E5%88%97-%E6%97%A0%E7%95%8C%E9%98%BB%E5%A1%9E%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97DelayQueue%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/">并发队列-无界阻塞延迟队列DelayQueue原理探究</a></h1><div class="content"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">转载自：http:&#x2F;&#x2F;ifeve.com&#x2F;%E5%B9%B6%E5%8F%91%E9%98%9F%E5%88%97-%E6%97%A0%E7%95%8C%E9%98%BB%E5%A1%9E%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97delayqueue%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6&#x2F;</span><br><span class="line">最近在开发中正好有类似场景。</span><br></pre></td></tr></table></figure>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>DelayQueue队列中每个元素都有个过期时间，并且队列是个优先级队列，当从队列获取元素时候，只有过期元素才会出队列。</p>
<h2 id="DelayQueue类图结构"><a href="#DelayQueue类图结构" class="headerlink" title="DelayQueue类图结构"></a>DelayQueue类图结构</h2><p><img src="http://file.mspring.org/images/blog/2346ca43fe3c972b6bb4beab5edf1328"></p>
<p>如图DelayQueue中内部使用的是PriorityQueue存放数据，使用ReentrantLock实现线程同步，可知是阻塞队列。另外队列里面的元素要实现Delayed接口，一个是获取当前剩余时间的接口，一个是元素比较的接口，因为这个是有优先级的队列。</p>
<h2 id="offer操作"><a href="#offer操作" class="headerlink" title="offer操作"></a>offer操作</h2><p>插入元素到队列，主要插入元素要实现Delayed接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        q.offer(e);</span><br><span class="line">        <span class="keyword">if</span> (q.peek() == e) &#123;（<span class="number">2</span>）</span><br><span class="line">            leader = <span class="keyword">null</span>;</span><br><span class="line">            available.signal();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先获取独占锁，然后添加元素到优先级队列，由于q是优先级队列，所以添加元素后，peek并不一定是当前添加的元素，如果（2）为true，说明当前元素e的优先级最小也就即将过期的，这时候激活avaliable变量条件队列里面的线程，通知他们队列里面有元素了。</p>
<h2 id="take操作"><a href="#take操作" class="headerlink" title="take操作"></a>take操作</h2><p>获取并移除队列首元素，如果队列没有过期元素则等待。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="comment">//获取但不移除队首元素（1)</span></span><br><span class="line">                E first = q.peek();</span><br><span class="line">                <span class="keyword">if</span> (first == <span class="keyword">null</span>)</span><br><span class="line">                    available.await();<span class="comment">//(2)</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">long</span> delay = first.getDelay(TimeUnit.NANOSECONDS);</span><br><span class="line">                    <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)<span class="comment">//(3)</span></span><br><span class="line">                        <span class="keyword">return</span> q.poll();</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (leader != <span class="keyword">null</span>)<span class="comment">//(4)</span></span><br><span class="line">                        available.await();</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        Thread thisThread = Thread.currentThread();</span><br><span class="line">                        leader = thisThread;<span class="comment">//(5)</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            available.awaitNanos(delay);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (leader == thisThread)</span><br><span class="line">                                leader = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (leader == <span class="keyword">null</span> &amp;&amp; q.peek() != <span class="keyword">null</span>)<span class="comment">//(6)</span></span><br><span class="line">                available.signal();</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>第一次调用take时候由于队列空，所以调用（2）把当前线程放入available的条件队列等待，当执行offer并且添加的元素就是队首元素时候就会通知最先等待的线程激活，循环重新获取队首元素，这时候first假如不空，则调用getdelay方法看该元素海剩下多少时间就过期了，如果delay&lt;=0则说明已经过期，则直接出队返回。否者看leader是否为null，不为null则说明是其他线程也在执行take则把该线程放入条件队列，否者是当前线程执行的take方法，则调用(5)await直到剩余过期时间到（这期间该线程会释放锁，所以其他线程可以offer添加元素，也可以take阻塞自己），剩余过期时间到后，该线程会重新竞争得到锁，重新进入循环。</p>
<p>（6）说明当前take返回了元素，如果当前队列还有元素则调用singal激活条件队列里面可能有的等待线程。leader那么为null，那么是第一次调用take获取过期元素的线程，第一次调用的线程调用设置等待时间的await方法等待数据过期，后面调用take的线程则调用await直到signal。</p>
<h2 id="poll操作"><a href="#poll操作" class="headerlink" title="poll操作"></a>poll操作</h2><p>获取并移除队头过期元素，否者返回null</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        E first = q.peek();</span><br><span class="line">        <span class="comment">//如果队列为空，或者不为空但是队头元素没有过期则返回null</span></span><br><span class="line">        <span class="keyword">if</span> (first == <span class="keyword">null</span> || first.getDelay(TimeUnit.NANOSECONDS) &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> q.poll();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DelayedEle</span> <span class="keyword">implements</span> <span class="title">Delayed</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> delayTime; <span class="comment">//延迟时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> expire;  <span class="comment">//到期时间</span></span><br><span class="line">    <span class="keyword">private</span> String data;   <span class="comment">//数据</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayedEle</span><span class="params">(<span class="keyword">long</span> delay, String data)</span> </span>&#123;</span><br><span class="line">        delayTime = delay;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        expire = System.currentTimeMillis() + delay; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 剩余时间=到期时间-当前时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unit.convert(<span class="keyword">this</span>.expire - System.currentTimeMillis() , TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 优先队列里面优先级规则</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (<span class="keyword">this</span>.getDelay(TimeUnit.MILLISECONDS) -o.getDelay(TimeUnit.MILLISECONDS));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;DelayedElement&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;delay=&quot;</span>).append(delayTime);</span><br><span class="line">        sb.append(<span class="string">&quot;, expire=&quot;</span>).append(expire);</span><br><span class="line">        sb.append(<span class="string">&quot;, data=&#x27;&quot;</span>).append(data).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    DelayQueue&lt;DelayedEle&gt; delayQueue = <span class="keyword">new</span> DelayQueue&lt;DelayedEle&gt;();</span><br><span class="line"></span><br><span class="line">    DelayedEle element1 = <span class="keyword">new</span> DelayedEle(<span class="number">1000</span>,<span class="string">&quot;zlx&quot;</span>);</span><br><span class="line">    DelayedEle element2 = <span class="keyword">new</span> DelayedEle(<span class="number">1000</span>,<span class="string">&quot;gh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    delayQueue.offer(element1);</span><br><span class="line">    delayQueue.offer(element2);</span><br><span class="line"></span><br><span class="line">    element1 =  delayQueue.take();</span><br><span class="line">    System.out.println(element1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>TimerQueue的内部实现<br>ScheduledThreadPoolExecutor中DelayedWorkQueue是对其的优化使用</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-03-19T21:47:22.000Z" title="3/19/2018, 9:47:22 PM">2018-03-19</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约146个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/19/HexoClient-1-1-0%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/">HexoClient 1.1.0版本发布</a></h1><div class="content"><h2 id="升级说明"><a href="#升级说明" class="headerlink" title="升级说明"></a>升级说明</h2><ul>
<li>优化页面配色。</li>
<li>优化文章预览、详情页面展示样式。</li>
<li>文章内容修改后离开页面进行友好提示。</li>
<li>支持<code>hexo generate</code> 和 <code>hexo deploy</code>。</li>
</ul>
<h2 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h2><ul>
<li>Mac版本：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1s5czGqWk0JAkrvrEpYk4wQ">https://pan.baidu.com/s/1s5czGqWk0JAkrvrEpYk4wQ</a></li>
<li>Windows版本：请源码编译</li>
<li>Linux版本：请源码编译</li>
</ul>
<h2 id="最新截图"><a href="#最新截图" class="headerlink" title="最新截图"></a>最新截图</h2><p><img src="http://file.mspring.org/images/blog/75b72e173544f8d97bd439973e022f65"><br><img src="http://file.mspring.org/images/blog/af961ed25d01cceb2bb64855324c9cc9"><br><img src="http://file.mspring.org/images/blog/3376dc96e75b3719f1a40e65dd54b71e"><br><img src="http://file.mspring.org/images/blog/8a017cf3cb56561da107383ac21da2df"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-03-10T11:45:36.000Z" title="3/10/2018, 11:45:36 AM">2018-03-10</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约79个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/10/Android-studio-terminal-%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3/">Android studio terminal 中文乱码解决</a></h1><div class="content"><p>Android studio terminal中文乱码，如下图：<br><img src="http://file.mspring.org/images/blog/68c9e13df012b7ac702f5c98716c6225"></p>
<p>解决办法打开<code>~/.zshrc</code>找到如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># You may need to manually set your language environment</span><br><span class="line"># export LANG&#x3D;en_US.UTF-8</span><br></pre></td></tr></table></figure>
<p>将 <code>export LANG=en_US.UTF-8</code> 这一行解注。<br><img src="http://file.mspring.org/images/blog/b07a6381b955735cf8c2b72746b57e9b"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-03-09T15:49:01.000Z" title="3/9/2018, 3:49:01 PM">2018-03-09</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约127个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/09/Java%E5%9B%9B%E8%88%8D%E4%BA%94%E5%85%A5/">Java四舍五入</a></h1><div class="content"><p>之前写的，总结成代码片段，留备后用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2014-08-28 13:55:12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NumberUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 四舍五入取整数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">roundHalfUp</span><span class="params">(<span class="keyword">float</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(n).setScale(<span class="number">0</span>, BigDecimal.ROUND_HALF_UP).intValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 四舍五入</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n         数字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> precision 精度(保留几位小数)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">roundHalfUp</span><span class="params">(<span class="keyword">float</span> n, <span class="keyword">int</span> precision)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(n).setScale(precision, BigDecimal.ROUND_HALF_UP).floatValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4.11 -&gt; 4.2</span></span><br><span class="line"><span class="comment">     * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">     * 4.19 -&gt; 4.2</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n         数字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> precision 精度(保留几位小数)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">roundUp</span><span class="params">(<span class="keyword">float</span> n, <span class="keyword">int</span> precision)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(n).setScale(precision, BigDecimal.ROUND_UP).floatValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-02-24T14:53:10.000Z" title="2/24/2018, 2:53:10 PM">2018-02-24</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约189个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/02/24/HexoClient%E8%AF%B4%E6%98%8E/">HexoClient说明</a></h1><div class="content"><blockquote>
<p>Hexo桌面客户端</p>
</blockquote>
<p>联系我：<a href="http://www.mspring.org/">http://www.mspring.org</a></p>
<h3 id="功能简介"><a href="#功能简介" class="headerlink" title="功能简介"></a>功能简介</h3><ul>
<li>文章添加</li>
<li>文章修改</li>
<li>文章删除</li>
<li>文章支持七牛图片上传</li>
</ul>
<h3 id="截屏预览"><a href="#截屏预览" class="headerlink" title="截屏预览"></a>截屏预览</h3><p><img src="http://file.mspring.org/images/blog/66e3d556553c271fa6bbdd8ee6c02fe7!detail"><br><img src="http://file.mspring.org/images/blog/f2226b4d4256554c4b253af9f8b2e260!detail"><br><img src="http://file.mspring.org/images/blog/d24d7e4cbced83fa8d34268282dc8fb3!detail"></p>
<h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><ul>
<li>文章详情页优化</li>
<li>图片查看优化</li>
<li>自动Generate</li>
<li>自动Deploy</li>
</ul>
<h3 id="Build-Setup"><a href="#Build-Setup" class="headerlink" title="Build Setup"></a>Build Setup</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install dependencies</span></span><br><span class="line">npm install</span><br><span class="line"></span><br><span class="line"><span class="comment"># serve with hot reload at localhost:9080</span></span><br><span class="line">npm run dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># build electron application for production</span></span><br><span class="line">npm run build</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># lint all JS/Vue component files in `src/`</span></span><br><span class="line">npm run lint</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>This project was generated with <a target="_blank" rel="noopener" href="https://github.com/SimulatedGREG/electron-vue">electron-vue</a> using <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-cli">vue-cli</a>. Documentation about the original structure can be found <a target="_blank" rel="noopener" href="https://simulatedgreg.gitbooks.io/electron-vue/content/index.html">here</a>.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-09-26T19:52:00.000Z" title="9/26/2017, 7:52:00 PM">2017-09-26</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"> 雾非雾的情思 </span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约276个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/09/26/%E5%8C%85%E8%A3%85%E7%B1%BB%E5%80%BC%E5%88%A4%E6%96%AD/">包装类值判断异常</a></h1><div class="content"><h4 id="复现代码"><a href="#复现代码" class="headerlink" title="复现代码"></a>复现代码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        for (int i &#x3D; 120; i &lt; 130; i++) &#123;</span><br><span class="line">            Integer a &#x3D; i;</span><br><span class="line">            Integer b &#x3D; i;</span><br><span class="line">            System.out.println(&quot;a &#x3D;&#x3D; b: &quot; + (a &#x3D;&#x3D; b));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="输出结果"><a href="#输出结果" class="headerlink" title="输出结果"></a>输出结果</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a &#x3D;&#x3D; b: true</span><br><span class="line">a &#x3D;&#x3D; b: true</span><br><span class="line">a &#x3D;&#x3D; b: true</span><br><span class="line">a &#x3D;&#x3D; b: true</span><br><span class="line">a &#x3D;&#x3D; b: true</span><br><span class="line">a &#x3D;&#x3D; b: true</span><br><span class="line">a &#x3D;&#x3D; b: true</span><br><span class="line">a &#x3D;&#x3D; b: true</span><br><span class="line">a &#x3D;&#x3D; b: false</span><br><span class="line">a &#x3D;&#x3D; b: false</span><br></pre></td></tr></table></figure>

<h4 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;是用来比较两个基本数据类型的变量值是否相等，&#x3D;&#x3D;也用于判断两个对象引用名称是否参考至同一个对象。在自动装箱时对于值从–128到127之间的值，它们被装箱为Integer对象后，会存在内存中被重用(就是说内存指向相同)，所以造成 System.out.println(a &#x3D;&#x3D; b); 输出true</span><br><span class="line">如果超过了从–128到127之间的值，被装箱后的Integer对象并不会被重用（指向了新的内存地址），即相当于每次装箱时都新建一个Integer对象所以 System.out.println(&quot;a &#x3D;&#x3D; b: &quot; + (a &#x3D;&#x3D; b));输出false</span><br><span class="line">总结：–128到127之间的值内存空间引用的是同一个地址，超出则存在新的内存空间</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-09-24T15:52:00.000Z" title="9/24/2017, 3:52:00 PM">2017-09-24</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"> 雾非雾的情思 </span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约53个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/09/24/Ubuntu%E5%AE%89%E8%A3%85docker/">Ubuntu安装Docker</a></h1><div class="content"><p>安装命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y docker.io</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>等待安装完毕，现在我们使用下面的命令启动 Docker：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>
<p>运行系统引导时启用 docker，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-07-07T00:00:00.000Z" title="7/7/2017, 12:00:00 AM">2017-07-07</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"> 雾非雾的情思 </span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约327个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/07/07/Java%E5%88%86%E9%9A%94%E3%80%81%E5%90%88%E5%B9%B6%E5%A4%A7%E6%96%87%E4%BB%B6/">Java分隔、合并大文件</a></h1><div class="content"><p>今天网百度网盘上上传文件提示单个文件大小超限，让我升级VIP。作为一个有逼格的程序猿怎么可能被这点小事难倒呢。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">import com.google.common.collect.Lists;</span><br><span class="line">import org.apache.commons.io.FilenameUtils;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.RandomAccessFile;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Gao Youbo</span><br><span class="line"> * @since 2017-07-07 18:18</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class Files &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        int num &#x3D; 10;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 分割</span><br><span class="line">        cut(new File(&quot;&#x2F;Users&#x2F;gaoyoubo&#x2F;360sync&#x2F;数据迁移&#x2F;document&#x2F;a.zip&quot;), num);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 合并</span><br><span class="line">        List&lt;File&gt; files &#x3D; Lists.newArrayList();</span><br><span class="line">        for (int i &#x3D; 0; i &lt; num; i++) &#123;</span><br><span class="line">            files.add(new File(&quot;&#x2F;Users&#x2F;gaoyoubo&#x2F;360sync&#x2F;数据迁移&#x2F;document&#x2F;a-&quot; + i + &quot;.zip&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        File outFile &#x3D; new File(&quot;&#x2F;Users&#x2F;gaoyoubo&#x2F;360sync&#x2F;数据迁移&#x2F;document&#x2F;b.zip&quot;);</span><br><span class="line">        merge(files, outFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 分文件</span><br><span class="line">     *</span><br><span class="line">     * @param sourceFile</span><br><span class="line">     * @param num        分隔文件数量</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void cut(File sourceFile, int num) &#123;</span><br><span class="line">        long signMaxSize &#x3D; sourceFile.length() &#x2F; num + 1; &#x2F;&#x2F; 单个文件最大长度</span><br><span class="line">        try (RandomAccessFile source &#x3D; new RandomAccessFile(sourceFile, &quot;r&quot;)) &#123;</span><br><span class="line">            byte[] bytes &#x3D; new byte[1024];</span><br><span class="line">            int len;</span><br><span class="line">            for (int i &#x3D; 0; i &lt; num; i++) &#123;</span><br><span class="line">                File targetFile &#x3D; new File(sourceFile.getParent(),</span><br><span class="line">                        FilenameUtils.getBaseName(sourceFile.getName()) + &quot;-&quot; + i + &quot;.&quot; + FilenameUtils.getExtension(sourceFile.getName()));</span><br><span class="line">                try (RandomAccessFile target &#x3D; new RandomAccessFile(targetFile, &quot;rw&quot;)) &#123;</span><br><span class="line">                    while ((len &#x3D; source.read(bytes)) !&#x3D; -1) &#123;&#x2F;&#x2F;读到文件末尾时，len返回-1，结束循环</span><br><span class="line">                        target.write(bytes, 0, len);</span><br><span class="line">                        if (target.length() &gt; signMaxSize) &#123;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 合并文件</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void merge(List&lt;File&gt; files, File outFile) &#123;</span><br><span class="line">        try (RandomAccessFile out &#x3D; new RandomAccessFile(outFile, &quot;rw&quot;)) &#123;</span><br><span class="line">            for (File file : files) &#123;</span><br><span class="line">                try (RandomAccessFile src &#x3D; new RandomAccessFile(file, &quot;r&quot;)) &#123;</span><br><span class="line">                    byte[] bytes &#x3D; new byte[1024];&#x2F;&#x2F;每次读取字节数</span><br><span class="line">                    int len;</span><br><span class="line">                    while ((len &#x3D; src.read(bytes)) !&#x3D; -1) &#123;</span><br><span class="line">                        out.write(bytes, 0, len);&#x2F;&#x2F;循环赋值</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-06-14T00:00:00.000Z" title="6/14/2017, 12:00:00 AM">2017-06-14</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约290个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/06/14/Go%E8%AF%AD%E8%A8%80%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/">Go语言第二次实战应用</a></h1><div class="content"><p>使用场景，由于历史原因造成redis计数不准确，需要将数据从数据库中count一次，然后同步到redis。</p>
<h3 id="使用到的包"><a href="#使用到的包" class="headerlink" title="使用到的包"></a>使用到的包</h3><ul>
<li>github.com/go-sql-driver/mysql</li>
<li>github.com/go-redis/redis</li>
</ul>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;database/sql&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/go-redis/redis&quot;</span></span><br><span class="line">    _ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// redis 客户端</span></span><br><span class="line"><span class="keyword">var</span> client *redis.Client</span><br><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    dbUrl = <span class="string">&quot;username:password@tcp(localhost:3306)/dianping_new_db?charset=utf8&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 初始化redis客户端</span></span><br><span class="line">    client = redis.NewClient(&amp;redis.Options&#123;</span><br><span class="line">        Addr:     <span class="string">&quot;localhost:6379&quot;</span>,</span><br><span class="line">        Password: <span class="string">&quot;&quot;</span>, <span class="comment">// no password set</span></span><br><span class="line">        DB:       <span class="number">0</span>,  <span class="comment">// use default DB</span></span><br><span class="line">    &#125;)</span><br><span class="line">    db, _ = sql.Open(<span class="string">&quot;mysql&quot;</span>, dbUrl)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> dianpingMap <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">    dianpingMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">    listById(<span class="function"><span class="keyword">func</span><span class="params">(id <span class="keyword">string</span>, dianpingId <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">        _, ok := dianpingMap[dianpingId]</span><br><span class="line">        <span class="keyword">if</span> ok &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        count := getCount(dianpingId)</span><br><span class="line"></span><br><span class="line">        redisKey := <span class="string">&quot;dianping-count-&quot;</span> + dianpingId</span><br><span class="line">        client.HSet(redisKey, <span class="string">&quot;replyCount&quot;</span>, count)</span><br><span class="line"></span><br><span class="line">        dianpingMap[dianpingId] = dianpingId</span><br><span class="line"></span><br><span class="line">        fmt.Println(<span class="string">&quot;id&quot;</span>, id, <span class="string">&quot;dianpingId&quot;</span>, dianpingId, <span class="string">&quot;count&quot;</span>, count)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    client.Close()</span><br><span class="line">    db.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Handler <span class="function"><span class="keyword">func</span><span class="params">(id <span class="keyword">string</span>, dianpingId <span class="keyword">string</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">listById</span><span class="params">(handler Handler)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> cursor = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        sql := <span class="string">&quot;select id, dianping_id from t_dianping_reply &quot;</span></span><br><span class="line">        <span class="keyword">if</span> cursor &gt; <span class="number">0</span> &#123;</span><br><span class="line">            sql += <span class="string">&quot; where id &gt; &quot;</span> + strconv.Itoa(cursor)</span><br><span class="line">        &#125;</span><br><span class="line">        sql += <span class="string">&quot; order by id asc limit 10 &quot;</span></span><br><span class="line"></span><br><span class="line">        rows, err := db.Query(sql)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(err)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">                <span class="keyword">var</span> id, dianpingId <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">                rows.Scan(&amp;id, &amp;dianpingId)</span><br><span class="line"></span><br><span class="line">                handler(id, dianpingId)</span><br><span class="line"></span><br><span class="line">                cursor, _ = strconv.Atoi(id)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        rows.Close()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getCount</span><span class="params">(dianpingId <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    rows, err := db.Query(<span class="string">&quot;select count(*) from t_dianping_reply where dianping_id = ? and status = 0&quot;</span>, dianpingId)</span><br><span class="line">    count := <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> rows.Next() &#123;</span><br><span class="line">        rows.Scan(&amp;count)</span><br><span class="line">    &#125;</span><br><span class="line">    rows.Close()</span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-06-03T00:00:00.000Z" title="6/3/2017, 12:00:00 AM">2017-06-03</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约282个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/06/03/Go%E8%AF%AD%E8%A8%80%E7%9A%84%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/">Go语言的第一次实战应用</a></h1><div class="content"><p>最近开始在熟悉Go语言，正巧产品同学需要分析一些数据，数据是放在ElasticSearch中的，打算使用Go语言来进行分析。<br>Go语言的优势就是对linux兼容很好，可以直接成linux上的可执行文件，无需其他任何环境的支持。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    elastic <span class="string">&quot;gopkg.in/olivere/elastic.v3&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    url = <span class="string">&quot;http://xxx.xxx.xxx.xxx:9200&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">    Id         <span class="keyword">int</span></span><br><span class="line">    MucangId   <span class="keyword">string</span></span><br><span class="line">    Message    <span class="keyword">string</span></span><br><span class="line">    CreateTime <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    errorLog := log.New(os.Stdout, <span class="string">&quot;es &quot;</span>, log.LstdFlags)</span><br><span class="line"></span><br><span class="line">    client, err := elastic.NewClient(elastic.SetURL(url), elastic.SetErrorLog(errorLog))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> cursor <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(strconv.Itoa(cursor))</span><br><span class="line"></span><br><span class="line">        boolQuery := elastic.NewBoolQuery().Filter(</span><br><span class="line">            elastic.NewTermQuery(<span class="string">&quot;appinfoId&quot;</span>, <span class="number">1</span>),</span><br><span class="line">            elastic.NewRangeQuery(<span class="string">&quot;createTime&quot;</span>).Gt(<span class="string">&quot;2017-05-22 00:00:00 +0800&quot;</span>),</span><br><span class="line">            elastic.NewMatchPhraseQuery(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;向你求助&quot;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> cursor &gt; <span class="number">0</span> &#123;</span><br><span class="line">            boolQuery.Filter(elastic.NewRangeQuery(<span class="string">&quot;id&quot;</span>).Gt(cursor))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        searchResult, err := client.Search().</span><br><span class="line">            Index(<span class="string">&quot;push-record&quot;</span>).</span><br><span class="line">            Type(<span class="string">&quot;message&quot;</span>).</span><br><span class="line">            Query(boolQuery).</span><br><span class="line">            Sort(<span class="string">&quot;id&quot;</span>, <span class="literal">true</span>).</span><br><span class="line">            From(<span class="number">0</span>).Size(<span class="number">100</span>).</span><br><span class="line">            Pretty(<span class="literal">true</span>).</span><br><span class="line">            Do()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> searchResult.Hits.TotalHits &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> _, hit := <span class="keyword">range</span> searchResult.Hits.Hits &#123;</span><br><span class="line">                <span class="keyword">var</span> msg Message</span><br><span class="line">                json.Unmarshal(*hit.Source, &amp;msg)</span><br><span class="line"></span><br><span class="line">                cursor = msg.Id</span><br><span class="line"></span><br><span class="line">                b, _ := json.Marshal(hit.Source)</span><br><span class="line">                <span class="built_in">append</span>(<span class="string">&quot;/home/gaoyoubo/push.log&quot;</span>, <span class="keyword">string</span>(b))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 追加文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(path <span class="keyword">string</span>, content <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    file, _ := os.OpenFile(path, os.O_RDWR|os.O_CREATE|os.O_APPEND, <span class="number">0644</span>)</span><br><span class="line">    content = strings.Join([]<span class="keyword">string</span>&#123;content, <span class="string">&quot;\n&quot;</span>&#125;, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    buf := []<span class="keyword">byte</span>(content)</span><br><span class="line">    <span class="keyword">defer</span> file.Close()</span><br><span class="line">    file.Write(buf)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-06-02T00:00:00.000Z" title="6/2/2017, 12:00:00 AM">2017-06-02</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约23个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/06/02/Go%E8%AF%AD%E8%A8%80%E5%9C%A8mac%E4%B8%8B%E7%BC%96%E8%AF%91Linux%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6/">Go语言在mac下编译Linux可执行文件</a></h1><div class="content"><p>进入源码目录，执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build </span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-03-27T00:00:00.000Z" title="3/27/2017, 12:00:00 AM">2017-03-27</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约70个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/03/27/maven%E6%89%93%E5%8C%85%E5%8F%AF%E6%89%A7%E8%A1%8Cjar%E6%96%87%E4%BB%B6/">maven打包可执行jar文件</a></h1><div class="content"><p>需要打包有依赖第三方jar包的可执行jar会用到，他会帮你将所有的第三方的jar包都打到同一个jar中，这样就不用手动去设置classpath</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">transformers</span>&gt;</span></span><br><span class="line">                            &lt;transformer</span><br><span class="line">                                    implementation=&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;&gt;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>cn.mucang.saturn.transfer.Transfer<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">transformers</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-03-21T00:00:00.000Z" title="3/21/2017, 12:00:00 AM">2017-03-21</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"> 雾非雾的情思 </span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">41 分钟读完 (大约6146个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/03/21/Vue%E7%9B%B8%E5%85%B3%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%BA%93%E6%B1%87%E6%80%BB/">Vue相关开源项目库汇总</a></h1><div class="content"><p>awesome-github-vue 是由<a target="_blank" rel="noopener" href="http://www.opendigg.com/">OpenDigg</a>整理并维护的Vue相关开源项目库集合。我们会定期同步<a target="_blank" rel="noopener" href="http://www.opendigg.com/tags/front-vue">OpenDigg</a>上的项目到这里，也欢迎各位<a target="_blank" rel="noopener" href="https://github.com/opendigg/opending-share-projects">提交项目</a>给我们。 </p>
<p>如果收录的项目有错误，可以通过<a target="_blank" rel="noopener" href="https://github.com/opendigg/awesome-github-vue/issues">issue</a>反馈给我们。这里的项目Star数不是实时更新的，一般是一周更新一次。 </p>
<h1 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h1><ul>
<li><a href="#UI%E7%BB%84%E4%BB%B6">UI组件</a> </li>
<li><a href="#%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6">开发框架</a> </li>
<li><a href="#%E5%AE%9E%E7%94%A8%E5%BA%93">实用库</a> </li>
<li><a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF">服务端</a> </li>
<li><a href="#%E8%BE%85%E5%8A%A9%E5%B7%A5%E5%85%B7">辅助工具</a> </li>
<li><a href="#%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B">应用实例</a> </li>
<li><a href="#Demo%E7%A4%BA%E4%BE%8B">Demo示例</a> </li>
</ul>
<p>###UI组件 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ElemeFE/element">element</a> ★9689 - 饿了么出品的Vue2的web UI工具套件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/airyland/vux">Vux</a> ★6927 - 基于Vue和WeUI的组件库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ElemeFE/mint-ui">mint-ui</a> ★4870 - Vue 2的移动UI元素 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/iview/iview">iview</a> ★4782 - 基于 Vuejs 的开源 UI 组件库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/JosephusPaye/Keen-UI">Keen-UI</a> ★2401 - 轻量级的基本UI组件合集 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/marcosmoura/vue-material">vue-material</a> ★2294 - 通过Vue Material和Vue 2建立精美的app应用 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/museui/muse-ui">muse-ui</a> ★2052 - 三端样式一致的响应式 UI 库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vuetifyjs/vuetify">vuetify</a> ★1745 - 为移动而生的Vue JS 2组件框架 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/wangdahoo/vonic">vonic</a> ★1546 - 快速构建移动端单页应用 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/egoist/eme">eme</a> ★1402 - 优雅的Markdown编辑器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/monterail/vue-multiselect">vue-multiselect</a> ★1193 - Vue.js选择框解决方案 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ratiw/vue-table">vue-table</a> ★844 - 简化数据表格 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/OYsun/VueCircleMenu">VueCircleMenu</a> ★790 - 漂亮的vue圆环菜单 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Coffcer/vue-chat">vue-chat</a> ★755 - vuejs和vuex及webpack的聊天示例 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/luojilab/radon-ui">radon-ui</a> ★643 - 快速开发产品的Vue组件库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/MopTym/vue-waterfall">vue-waterfall</a> ★615 - Vue.js的瀑布布局组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/taylorchen709/vueAdmin">vueAdmin</a> ★612 - 基于vuejs2和element的简单的管理员模板 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/myronliu347/vue-carbon">vue-carbon</a> ★602 - 基于 vue 开发MD风格的移动端 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/FE-Driver/vue-beauty">vue-beauty</a> ★589 - 由vue和ant design创建的优美UI组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/chenz24/vue-blu">vue-blu</a> ★582 - 帮助你轻松创建web应用 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-syntax-highlight">vue-syntax-highlight</a> ★560 - Sublime Text语法高亮 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ElemeFE/vue-infinite-scroll">vue-infinite-scroll</a> ★544 - VueJS的无限滚动指令 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/David-Desmaisons/Vue.Draggable">Vue.Draggable</a> ★536 - 实现拖放和视图模型数组同步 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/pi0/bootstrap-vue">bootstrap-vue</a> ★525 - 应用于Vuejs2的Twitter的Bootstrap 4组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/surmon-china/vue-awesome-swiper">vue-awesome-swiper</a> ★524 - vue.js触摸滑动组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/jinzhe/vue-calendar">vue-calendar</a> ★468 - 日期选择插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ElemeFE/vue-amap">vue-amap</a> ★372 - 基于Vue 2和高德地图的地图组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ElemeFE/vue-swipe">vue-swipe</a> ★369 - VueJS触摸滑块 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/apertureless/vue-chartjs">vue-chartjs</a> ★362 - vue中的Chartjs的封装 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hilongjw/vue-datepicker">vue-datepicker</a> ★339 - 日历和日期选择组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Justineo/vue-echarts">vue-echarts</a> ★337 - VueJS的ECharts组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Zhangdroid/Gokotta">Gokotta</a> ★325 - 简单的音乐播放器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/jrainlau/markcook">markcook</a> ★319 - 好看的markdown编辑器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/sagalbot/vue-sortable">vue-sortable</a> ★299 - 轻松添加拖拽排序 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/GuillaumeLeclerc/vue-google-maps">vue-google-maps</a> ★289 - 带有双向数据绑定Google地图组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hilongjw/vue-progressbar">vue-progressbar</a> ★255 - vue轻量级进度条 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/alessiomaffeis/vue-picture-input">vue-picture-input</a> ★241 - 移动友好的图片文件输入组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/PeachScript/vue-infinite-loading">vue-infinite-loading</a> ★233 - VueJS的无限滚动插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/TahaSh/vue-paginate">vue-paginate</a> ★216 - 分页数据的简约VueJS插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/lian-yue/vue-upload-component">vue-upload-component</a> ★215 - Vuejs文件上传组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/wangdahoo/vue-scroller">vue-scroller</a> ★212 - Vonic UI的功能性组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/surmon-china/vue-quill-editor">vue-quill-editor</a> ★204 - 基于Quill适用于Vue2的富文本编辑器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Haixing-Hu/vue-datetime-picker">vue-datetime-picker</a> ★202 - 日期时间选择控件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/surmon-china/vue-video-player">vue-video-player</a> ★192 - VueJS视频及直播播放器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/icai/vue2-calendar">vue2-calendar</a> ★184 - 支持lunar和日期事件的日期选择器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Wanderxx/vue-fullcalendar">vue-fullcalendar</a> ★179 - 基于vue.js的全日历组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ccforward/rubik">rubik</a> ★178 - 基于Vuejs2的开源 UI 组件库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/egoist/vue-mugen-scroll">vue-mugen-scroll</a> ★175 - 无限滚动组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/matfish2/vue-tables-2">vue-tables-2</a> ★172 - 显示数据的bootstrap样式网格 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/OYsun/VueStar">VueStar</a> ★172 - 带星星动画的vue点赞按钮 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/mint-ui/mint-loadmore">mint-loadmore</a> ★171 - VueJS的双向下拉刷新组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Akryum/vue-virtual-scroller">vue-virtual-scroller</a> ★168 - 带任意数目数据的顺畅的滚动 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Vanthink-UED/vue-core-image-upload">vue-core-image-upload</a> ★166 - 轻量级的vue上传插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/SimonZhangITer/DataVisualization">DataVisualization</a> ★157 - 数据可视化 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hifarer/Vueditor">Vueditor</a> ★147 - 所见即所得的编辑器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/PeakTai/vue-html5-editor">vue-html5-editor</a> ★137 - html5所见即所得编辑器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/warpcgd/vue-slider">vue-slider</a> ★130 - vue 滑动组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ElemeFE/vue-msgbox">vue-msgbox</a> ★128 - vuejs的消息框 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hilongjw/vue-slide">vue-slide</a> ★127 - vue轻量级滑动组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/JALBAA/vue-lazyload-img">vue-lazyload-img</a> ★120 - 移动优化的vue图片懒加载插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Astray-git/vue-dragula">vue-dragula</a> ★117 - 使拖放变得简单 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Alex-fun/vue-drag-and-drop-list">vue-drag-and-drop-list</a> ★115 - 创建排序列表的Vue指令 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vuwe/vuwe">vuwe</a> ★111 - 基于微信WeUI所开发的专用于Vue2的组件库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/rowanwins/vue-dropzone">vue-dropzone</a> ★110 - 用于文件上传的Vue组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/MatteoGabriele/vue-progressive-image">vue-progressive-image</a> ★109 - Vue的渐进图像加载插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hchstera/vue-charts">vue-charts</a> ★106 - 轻松渲染一个图表 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Wlada/vue-carousel-3d">vue-carousel-3d</a> ★103 - VueJS的3D轮播组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/weilao/vue-swiper">vue-swiper</a> ★101 - 易于使用的滑块组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/coderdiaz/vue-datasource">vue-datasource</a> ★98 - 创建VueJS动态表格 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/littlewin-wang/vue-images">vue-images</a> ★94 - 显示一组图片的lightbox组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/QingWei-Li/vue-region-picker">vue-region-picker</a> ★94 - 选择中国的省份市和地区 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/NightCatSama/vue-slider-component">vue-slider-component</a> ★93 - 在vue1和vue2中使用滑块 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/NewDadaFE/vue-impression">vue-impression</a> ★92 - 移动Vuejs2 UI元素 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/cngu/vue-typer">vue-typer</a> ★89 - 模拟用户输入选择和删除文本的Vue组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Coffcer/vue-loading">vue-loading</a> ★89 - 元素中加载block的Vue指令 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/santiblanko/vue-instant">vue-instant</a> ★88 - 轻松创建自动提示的自定义搜索控件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hilongjw/vue-dragging">vue-dragging</a> ★87 - 使元素可以拖拽 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/galenyuan/vue-datatable">vue-datatable</a> ★87 - 使用Vuejs创建的DataTableView </li>
<li><a target="_blank" rel="noopener" href="https://github.com/BosNaufal/vue2-loading-bar">vue2-loading-bar</a> ★81 - 最简单的仿Youtube加载条视图 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/weifeiyue/vue-datepicker">vue-datepicker</a> ★76 - 漂亮的Vue日期选择器组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/weizhenye/vue-highcharts">vue-highcharts</a> ★73 - HighCharts组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hilongjw/vue-video">vue-video</a> ★73 - Vue.js的HTML5视频播放器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Akryum/vue-tooltip">vue-tooltip</a> ★71 - 带绑定信息提示的提示工具 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/dai-siki/vue-image-crop-upload">vue-image-crop-upload</a> ★70 - vue图片剪裁上传组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ElemeFE/vue-toast-mobile">vue-toast-mobile</a> ★68 - VueJS的toast插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/F-loat/vue-simplemde">vue-simplemde</a> ★66 - VueJS的Markdown编辑器组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/surmon-china/vue-touch-ripple">vue-touch-ripple</a> ★64 - vuejs的触摸ripple组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/MMF-FE/vue-svgicon">vue-svgicon</a> ★62 - 创建svg图标组件的工具 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/phoenixwong/vue2-timepicker">vue2-timepicker</a> ★61 - 下拉时间选择器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Kocisov/coffeebreak">coffeebreak</a> ★61 - 实时编辑CSS组件工具 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Bubblings/vue-date-picker">vue-date-picker</a> ★60 - VueJS日期选择器组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/BosNaufal/vue-scrollbar">vue-scrollbar</a> ★59 - 最简单的滚动区域组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/lithiumjake/vue-placeholders">vue-placeholders</a> ★57 - 处理占位符图片和乱码 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/phanan/vue-google-signin-button">vue-google-signin-button</a> ★56 - 导入谷歌登录按钮 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/CroudSupport/vue-quill">vue-quill</a> ★56 - vue组件构建quill编辑器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/bkzl/vue-float-label">vue-float-label</a> ★54 - VueJS浮动标签模式 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Dafrok/vue-baidu-map">vue-baidu-map</a> ★51 - 基于 Vue 2的百度地图组件库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/davidroyer/vue2-editor">vue2-editor</a> ★49 - HTML编辑器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/nicolasbeauvais/vue-social-sharing">vue-social-sharing</a> ★47 - 社交分享组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/shhdgit/vue-easy-slider">vue-easy-slider</a> ★43 - Vue 2.x的滑块组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/moip/awesome-mask">awesome-mask</a> ★43 - 拥有独一无二mask的表单 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Ginhing/vue-tagsinput">vue-tagsinput</a> ★41 - 基于VueJS的标签组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vue-bulma/datepicker">datepicker</a> ★38 - 基于flatpickr的时间选择组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/yunyi1895/vue-music-master">vue-music-master</a> ★38 - vue手机端网页音乐播放器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/miaolz123/vue-chart">vue-chart</a> ★37 - 强大的高速的vue图表解析 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vue-bulma/handsontable">handsontable</a> ★35 - 网页表格组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/myronliu347/vue-popup-mixin">vue-popup-mixin</a> ★35 - 用于管理弹出框的遮盖层 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/tianyong90/we-vue">we-vue</a> ★34 - Vue2及weui1开发的组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/fangyongbao/cubeex">cubeex</a> ★33 - 包含一套完整的移动UI </li>
<li><a target="_blank" rel="noopener" href="https://github.com/CroudSupport/vue-fullcalendar">vue-fullcalendar</a> ★33 - vue FullCalendar封装 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/staskjs/vue-slick">vue-slick</a> ★33 - 实现流畅轮播框的vue组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/bbonnin/vue-morris">vue-morris</a> ★32 - Vuejs组件封装Morrisjs库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/loujiayu/vue-material-design">vue-material-design</a> ★32 - Vue MD风格组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/jbaysolutions/vue-bootstrap-table">vue-bootstrap-table</a> ★31 - 可排序可检索的表格 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/waynecz/vue-img-inputer">vue-img-inputer</a> ★30 - 基于Vue2的图片输入框 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/wyzant-dev/vue-radial-progress">vue-radial-progress</a> ★29 - Vue.js放射性进度条组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/legeneek/vue-image-clip">vue-image-clip</a> ★29 - 基于vue的图像剪辑组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/matfish2/vue-form-2">vue-form-2</a> ★27 - 全面的HTML表单管理的解决方案 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/bajian/vue-pull-to-refresh">vue-pull-to-refresh</a> ★27 - Vue2的上拉下拉 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vue-comps/vue-side-nav">vue-side-nav</a> ★27 - 响应式的侧边导航 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/mint-ui/mint-indicator">mint-indicator</a> ★26 - VueJS移动加载指示器插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/BosNaufal/vue-ripple">vue-ripple</a> ★26 - 制作谷歌MD风格涟漪效果的Vue组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/darrynten/vue-lazy-background-images">vue-lazy-background-images</a> ★25 - 懒加载背景组件的Vue组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/icebob/vue-touch-keyboard">vue-touch-keyboard</a> ★24 - VueJS虚拟键盘组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vue-bulma/chartjs">chartjs</a> ★24 - Vue Bulma的chartjs组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/suguangwen/vue-scroll">vue-scroll</a> ★24 - vue滚动 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ankane/vue-chartkick">vue-chartkick</a> ★23 - VueJS一行代码实现优美图表 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/lisiyizu/vue-ztree">vue-ztree</a> ★22 - 用 vue 写的树层级组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/shiye515/vue-m-carousel">vue-m-carousel</a> ★21 - vue 移动端轮播组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/dai-siki/vue-datepicker-simple">vue-datepicker-simple</a> ★20 - 基于vue的日期选择器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/alexqdjay/vue-tabs">vue-tabs</a> ★20 - 多tab页轻型框架 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/aweiu/vue-verify-pop">vue-verify-pop</a> ★19 - 带气泡提示的vue校验插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Teddy-Zhu/vue-waves">vue-waves</a> ★17 - waves的VueJS版本 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vue-comps/vue-parallax">vue-parallax</a> ★15 - 整洁的视觉效果 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/xinxingyu/vue-city">vue-city</a> ★14 - 城市选择器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/JackGit/vue-img-loader">vue-img-loader</a> ★14 - 图片加载UI组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/eduardostuart/vue-typewriter">vue-typewriter</a> ★13 - vue组件类型 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Teddy-Zhu/vue-smoothscroll">vue-smoothscroll</a> ★12 - smoothscroll的VueJS版本 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/weibangtuo/vue-tree">vue-tree</a> ★11 - vue树视图组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/sinchang/vue-laypage">vue-laypage</a> ★9 - 简单的VueJS分页组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Treri/vue-ios-alertview">vue-ios-alertview</a> ★8 - iOS7+ 风格的alertview服务 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ibufu/dd-vue-component">dd-vue-component</a> ★7 - 订单来了的公共组件库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/yeseason/paco-ui-vue">paco-ui-vue</a> ★7 - PACOUI的vue组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/doodlewind/vue-cmap">vue-cmap</a> ★5 - Vue China map可视化组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/steven5538/vue-button">vue-button</a> ★4 - Vue按钮组件 </li>
</ul>
<p>###开发框架 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/vuejs/vue">vue.js</a> ★46256 - 流行的轻量高效的前端组件化方案 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/fundon/vue-admin">vue-admin</a> ★3340 - Vue管理面板框架 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/quasarframework/quasar">quasar</a> ★1476 - 响应式网站和混合移动应用程序 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/egoist/vuepack">vuepack</a> ★1365 - 现代VueJS启动器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/SimulatedGREG/electron-vue">electron-vue</a> ★1333 - Electron及VueJS快速启动样板 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/petervmeijgaard/vue-2.0-boilerplate">vue-2.0-boilerplate</a> ★247 - Vue2单页应用样板​ </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hanan198501/vue-spa-template">vue-spa-template</a> ★232 - 前后端分离后的单页应用开发 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/nolimits4web/Framework7-Vue">Framework7-Vue</a> ★217 - VueJS与Framework7结合 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/wangxg2016/vue-bulma">vue-bulma</a> ★139 - 轻量级高性能MVVM Admin UI框架 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/rodzzlessa24/vue-webgulp">vue-webgulp</a> ★101 - 仿VueJS Vue loader示例 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/erguotou520/vue-fullstack">vue-fullstack</a> ★84 - 实时的用户友好的后台系统 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Metnew/vue-element-starter">vue-element-starter</a> ★37 - vue启动页 </li>
</ul>
<p>###实用库 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex">vuex</a> ★6160 - 专为 Vue.js 应用程序开发的状态管理模式 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-validator">vue-validator</a> ★1612 - vue的验证器插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-loader">vue-loader</a> ★1484 - Vue.js 针对Webpack的组件装载插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hilongjw/vue-lazyload">vue-lazyload</a> ★821 - 用于懒加载的Vue模块 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/monterail/vuelidate">vuelidate</a> ★778 - 简单轻量级的基于模块的Vue.js验证 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/kazupon/vue-i18n">vue-i18n</a> ★716 - VueJS的多语言切换插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/zerqu/qingcheng">qingcheng</a> ★680 - qingcheng主题 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ElemeFE/vue-desktop">vue-desktop</a> ★464 - 创建管理面板网站的UI库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/MetinSeylan/Vue-Socket.io">Vue-Socketio</a> ★341 - VueJS的socketio实现 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ktquez/vue-head">vue-head</a> ★295 - head标签的meta信息操作 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/declandewet/vue-meta">vue-meta</a> ★269 - 管理app的meta信息 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Akryum/meteor-vue-component">meteor-vue-component</a> ★266 - vue和meteor整合 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/imcvampire/vue-axios">vue-axios</a> ★229 - 将axios整合到VueJS的封装 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/jrainlau/vue-flatpickr">vue-flatpickr</a> ★179 - 封装Flatpickr的Vue组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/eddyerburgh/avoriaz">avoriaz</a> ★135 - VueJS测试实用工具库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/cenkai88/vue-svg-icon">vue-svg-icon</a> ★116 - vue2的可变彩色svg图标方案 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/simplesmiler/vue-focus">vue-focus</a> ★107 - 可重用VueJS组件的焦点指令 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/haydenbbickerton/vue-animate">vue-animate</a> ★88 - 跨浏览器CSS3动画库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/lmk123/vue-framework7">vue-framework7</a> ★83 - 结合VueJS使用的Framework7组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Coffcer/vue-bootstrap-modal">vue-bootstrap-modal</a> ★82 - vue的Bootstrap样式组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/QingWei-Li/vuep">vuep</a> ★76 - 用实时编辑和预览来渲染Vue组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Sopamo/vue-online">vue-online</a> ★68 - reactive的在线和离线组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/yeyuqiudeng/vue-lazy-render">vue-lazy-render</a> ★68 - 用于Vue组件的延迟渲染 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/apertureless/vue-password-strength-meter">vue-password-strength-meter</a> ★67 - 交互式密码强度计 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/xiaokaike/vue-clipboard">vue-clipboard</a> ★64 - VueJS的剪贴板 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/lynzz/element-admin">element-admin</a> ★62 - 支持 vuecli 的 Element UI 的后台模板 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/LinusBorg/portal-vue">portal-vue</a> ★56 - 在组件外部渲染DOM </li>
<li><a target="_blank" rel="noopener" href="https://github.com/cklmercer/vue-events">vue-events</a> ★55 - 简化事件的VueJS插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/SimulatedGREG/vue-electron">vue-electron</a> ★55 - 将选择的API封装到Vue对象中的插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vue-bulma/cleave">cleave</a> ★55 - 基于cleave.js的Cleave组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/kartsims/vue-cordova">vue-cordova</a> ★54 - Cordova的VueJS插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/iFgR/vue-shortkey">vue-shortkey</a> ★53 - 应用于Vue.js的Vue-ShortKey 插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/weinot/vue-router-transition">vue-router-transition</a> ★52 - 页面过渡插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/mlyknown/vue-gesture">vue-gesture</a> ★50 - VueJS的手势事件插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/kaorun343/vue-property-decorator">vue-property-decorator</a> ★49 - VueJS和属性Decorator </li>
<li><a target="_blank" rel="noopener" href="https://github.com/superman66/vue-qart">vue-qart</a> ★49 - 用于qartjs的Vue2指令 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/xtongs/vue-recyclist">vue-recyclist</a> ★48 - vuejs无限滚动列表 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/FranckFreiburger/http-vue-loader">http-vue-loader</a> ★47 - 从html及js环境加载vue文件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/gocanto/vuemit">vuemit</a> ★47 - 处理VueJS事件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/icebob/vue-websocket">vue-websocket</a> ★46 - VueJS的Websocket插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/pinguinjkeke/vue-local-storage">vue-local-storage</a> ★45 - 具有类型支持的Vuejs本地储存插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Vuedeux/vuedeux">vuedeux</a> ★43 - 轻量级开源实用用层 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/rigor789/vue-scrollTo">vue-scrollTo</a> ★42 - 滚动到元素的VueJS指令 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/gocanto/lazy-vue">lazy-vue</a> ★42 - 懒加载图片 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/yangmingshan/vue-bus">vue-bus</a> ★39 - VueJS的事件总线 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ropbla9/vue-reactive-storage">vue-reactive-storage</a> ★35 - vue插件的Reactive层 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/miaolz123/vue-helmet">vue-helmet</a> ★34 - HTML标题管理器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/richardanaya/voir">voir</a> ★33 - 保持mutation与视图组件的分离 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Coffcer/vue-lazy-component">vue-lazy-component</a> ★33 - 懒加载组件或者元素的Vue指令 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/AStaroverov/v-media-query">v-media-query</a> ★33 - vue中添加用于配合媒体查询的方法 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/se-panfilov/vue-notifications">vue-notifications</a> ★32 - 非阻塞通知库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Akryum/vue-observe-visibility">vue-observe-visibility</a> ★32 - 当元素在页面上可见或隐藏时检测 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/HerringtonDarkholme/vue-ts-loader">vue-ts-loader</a> ★32 - 在Vue装载机检查脚本 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/matfish2/vue-pagination-2">vue-pagination-2</a> ★30 - 简单通用的分页组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/David-Desmaisons/Vue.resize">Vue.resize</a> ★27 - 检测HTML调整大小事件的vue指令 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/dkfbasel/vuex-i18n">vuex-i18n</a> ★26 - 定位插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/xanf/vuex-shared-mutations">vuex-shared-mutations</a> ★25 - 分享某种Vuex mutations </li>
<li><a target="_blank" rel="noopener" href="https://github.com/leonardovilarinho/vue-acl">vue-acl</a> ★24 - VueJS访问控制列表插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vue-bulma/modal">modal</a> ★17 - Vue Bulma的modal组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/BosNaufal/vue-file-base64">vue-file-base64</a> ★16 - 将文件转换为Base64的vue组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/surmon-china/vue-drag-zone">vue-drag-zone</a> ★15 - 适用于Vue2的dom拖动组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/irwansyahwii/Famous-Vue">Famous-Vue</a> ★15 - Famous库的vue组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/LeoHuiyi/leo-vue-validator">leo-vue-validator</a> ★13 - 异步的表单验证组件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/David-Desmaisons/Vue.ImagesLoaded">Vue.ImagesLoaded</a> ★12 - 检测图片加载的VueJS指令 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Haixing-Hu/vue-titlecase">vue-titlecase</a> ★12 - 用于字符串titlecased的VueJS过滤器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/MetinSeylan/Vue-Easy-Validator">Vue-Easy-Validator</a> ★11 - 简单的表单验证 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/imcvampire/vue-truncate-filter">vue-truncate-filter</a> ★9 - 截断字符串的VueJS过滤器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vue-comps/vue-zoombox">vue-zoombox</a> ★9 - 一个高级zoombox </li>
<li><a target="_blank" rel="noopener" href="https://github.com/syropian/vue-input-autosize">vue-input-autosize</a> ★5 - 基于内容自动调整文本输入的大小 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/yodfz/vue-lazyloadImg">vue-lazyloadImg</a> ★4 - 图片懒加载插件 </li>
</ul>
<p>###服务端 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/nuxt/nuxt.js">nuxt.js</a> ★2810 - 用于服务器渲染Vue app的最小化框架 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/danmademe/express-vue">express-vue</a> ★152 - 简单的使用服务器端渲染vue.js </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ccforward/vue-ssr">vue-ssr</a> ★70 - 非常简单的VueJS服务器端渲染模板 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hilongjw/vue-ssr">vue-ssr</a> ★57 - 结合Express使用Vue2服务端渲染 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/leaves4j/vue-easy-renderer">vue-easy-renderer</a> ★25 - Nodejs服务端渲染 </li>
</ul>
<p>###辅助工具 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/MiCottOn/DejaVue">DejaVue</a> ★559 - Vuejs可视化及压力测试 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vue-play/vue-play">vue-play</a> ★461 - 展示Vue组件的最小化框架 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/OYsun/vscode-VueHelper">vscode-VueHelper</a> ★194 - 目前vscode最好的vue代码提示插件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/NetanelBasal/vue-generate-component">vue-generate-component</a> ★40 - 轻松生成Vue js组件的CLI工具 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/xwpongithub/vue-multipage-cli">vue-multipage-cli</a> ★33 - 简单的多页CLI </li>
<li><a target="_blank" rel="noopener" href="https://github.com/MetinSeylan/VuejsStarterKit">VuejsStarterKit</a> ★26 - vuejs starter套件 </li>
</ul>
<p>###应用实例 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/phanan/koel">koel</a> ★7214 - 基于网络的个人音频流媒体服务 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/pagekit/pagekit">pagekit</a> ★4037 - 轻量级的CMS建站系统 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Vuedo/vuedo">vuedo</a> ★1059 - 博客平台 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/jackhutu/jackblog-vue">jackblog-vue</a> ★965 - 个人博客系统 </li>
<li>[PJ Blog](<a target="_blank" rel="noopener" href="https://github.com/jcc/PJ">https://github.com/jcc/PJ</a> Blog) ★732 - 开源博客 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/lzxb/vue-cnode">vue-cnode</a> ★628 - 重写vue版cnode社区 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ycwalker/CMS-of-Blog">CMS-of-Blog</a> ★415 - 博客内容管理器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/mrgodhani/rss-reader">rss-reader</a> ★328 - 简单的rss阅读器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/viko16/vue-ghpages-blog">vue-ghpages-blog</a> ★211 - 依赖GitHub Pages无需本地生成的静态博客 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/zhangxin840/tomato5">tomato5</a> ★112 - 实时的协作工具 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/wh469012917/swoole-vue-webim">swoole-vue-webim</a> ★99 - Web版的聊天应用 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/thelinuxlich/vue-dashing-js">vue-dashing-js</a> ★70 - nuvo-dashing-js的fork </li>
<li><a target="_blank" rel="noopener" href="https://github.com/sapjax/fewords">fewords</a> ★53 - 功能极其简单的笔记本 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/surmon-china/vue-blog">vue-blog</a> ★40 - 使用Vue2.0 和Vuex的vue-blog </li>
</ul>
<p>###Demo示例 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/bailicangdu/vue2-elm">vue2-elm</a> ★2965 - 重写饿了么webapp </li>
<li><a target="_blank" rel="noopener" href="https://github.com/shinygang/Vue-cnodejs">Vue-cnodejs</a> ★2156 - 基于vue重写Cnodejs.org的webapp </li>
<li><a target="_blank" rel="noopener" href="https://github.com/javaSwing/NeteaseCloudWebApp">NeteaseCloudWebApp</a> ★1208 - 高仿网易云音乐的webapp </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hilongjw/vue-zhihu-daily">vue-zhihu-daily</a> ★885 - 知乎日报 with Vuejs </li>
<li><a target="_blank" rel="noopener" href="https://github.com/useryangtao/vue-wechat">vue-wechat</a> ★777 - vue.js开发微信app界面 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/lzxb/vue2-demo">vue2-demo</a> ★725 - 从零构建vue2 + vue-router + vuex 开发环境 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/liangxiaojuan/eleme">eleme</a> ★639 - 高仿饿了么app商家详情 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/kenberkeley/vue-demo">vue-demo</a> ★590 - vue简易留言板 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/codecasts/spa-starter-kit">spa-starter-kit</a> ★514 - 单页应用启动套件 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/zhengguorong/maizuo">maizuo</a> ★511 - vue/vuex/redux仿卖座网 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Sioxas/vue-music">vue-music</a> ★502 - Vue 音乐搜索播放 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/liangxiaojuan/vue-Meizi">vue-Meizi</a> ★413 - vue最新实战项目 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/jiakeqi/douban">douban</a> ★403 - 模仿豆瓣前端 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/yatessss/zhihudaily-vue">zhihudaily-vue</a> ★391 - 知乎日报web版 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/andylei18/vue-shopping">vue-shopping</a> ★339 - 蘑菇街移动端 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/SimonZhangITer/VueDemo_Sell_Eleme">VueDemo_Sell_Eleme</a> ★332 - Vue2高仿饿了么外卖平台 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/lavyun/vue-demo-kugou">vue-demo-kugou</a> ★327 - vuejs仿写酷狗音乐webapp </li>
<li><a target="_blank" rel="noopener" href="https://github.com/canfoo/vue2.0-taopiaopiao">vue2.0-taopiaopiao</a> ★256 - vue2.0与express构建淘票票页面 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/jiangjiu/vue-leancloud-blog">vue-leancloud-blog</a> ★242 - 一个前后端完全分离的单页应用 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/yjj5855/node-vue-server-webpack">node-vue-server-webpack</a> ★241 - Node.js+Vue.js+webpack快速开发框架 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/wendaosanshou/mi-by-vue">mi-by-vue</a> ★227 - VueJS仿小米官网 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/TIGERB/easy-vue">easy-vue</a> ★216 - 使用Vue实现简易web </li>
<li><a target="_blank" rel="noopener" href="https://github.com/superman66/vue2.x-douban">vue2.x-douban</a> ★211 - Vue2实现简易豆瓣电影webApp </li>
<li><a target="_blank" rel="noopener" href="https://github.com/okoala/vue-fis3">vue-fis3</a> ★201 - 流行开源工具集成demo </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ChuckCZC/vue-demo-maizuo">vue-demo-maizuo</a> ★192 - 使用Vue2全家桶仿制卖座电影 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/iHaPBoy/vue-zhihudaily">vue-zhihudaily</a> ★171 - 知乎日报 Web 版本 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/superman66/vue-axios-github">vue-axios-github</a> ★170 - 登录拦截登出功能 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/liujians/vue-adminLte-vue-router">vue-adminLte-vue-router</a> ★167 - vue和adminLte整合应用 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hzzly/xyy-vue">xyy-vue</a> ★141 - 大学生交流平台 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/pomelo-chuan/Zhihu-Daily-Vue.js">Zhihu-Daily-Vue.js</a> ★139 - Vuejs单页网页应用 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/rokups/hello-vue-django">hello-vue-django</a> ★116 - 使用带有Django的vuejs的样板项目 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/zhixuanziben/gouyan-movie-vue">gouyan-movie-vue</a> ★107 - 基于vue的在线电影影讯网站 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/CommanderXL/x-blog">x-blog</a> ★105 - 开源的个人blog项目 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/xrr2016/vue-express-mongodb">vue-express-mongodb</a> ★104 - 简单的前后端分离案例 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/wszgxa/vue-cnode">vue-cnode</a> ★104 - vue单页应用demo </li>
<li><a target="_blank" rel="noopener" href="https://github.com/lin-xin/notepad">notepad</a> ★95 - 本地存储的记事本 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/secreter/websocket_chat">websocket_chat</a> ★95 - 基于vue和websocket的多人在线聊天室 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/beidan/photoShare">photoShare</a> ★90 - 基于图片分享的社交平台 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/elva2596/vueBlog">vueBlog</a> ★82 - 前后端分离博客 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/cs1707/vue-zhihudaily-2.0">vue-zhihudaily-2.0</a> ★82 - 使用Vue2.0+vue-router+vuex创建的zhihudaily </li>
<li><a target="_blank" rel="noopener" href="https://github.com/hql123/vue-ruby-china">vue-ruby-china</a> ★73 - VueJS框架搭建的rubychina平台 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/littlewin-wang/Zhihu_Daily">Zhihu_Daily</a> ★70 - 基于Vue和Nodejs的Web单页应用 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/vue-koa-demo">vue-koa-demo</a> ★64 - 使用Vue2和Koa1的全栈demo </li>
<li><a target="_blank" rel="noopener" href="https://github.com/vincentSea/vue2.x-Cnode">vue2.x-Cnode</a> ★55 - 基于vue全家桶的Cnode社区 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/wenye123/vue-trip">vue-trip</a> ★49 - vue2做的出行webapp </li>
<li><a target="_blank" rel="noopener" href="https://github.com/shaqihe/life-app-vue">life-app-vue</a> ★49 - 使用vue2完成多功能集合到小webapp </li>
<li><a target="_blank" rel="noopener" href="https://github.com/SidKwok/github-explorer">github-explorer</a> ★49 - 寻找最有趣的GitHub库 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/albertchan/vue-ssr-boilerplate">vue-ssr-boilerplate</a> ★47 - 精简版的ofvue-hackernews-2 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/nswbmw/vue-bushishiren">vue-bushishiren</a> ★46 - 不是诗人应用 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/peng1992/houtai">houtai</a> ★45 - 基于vue和Element的后台管理系统 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/QRL909109/ios7-vue">ios7-vue</a> ★38 - 使用vue2.0 vue-router vuex模拟ios7 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/tyllo/Framework7-VueJS">Framework7-VueJS</a> ★38 - 使用移动框架的示例 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/zhoou/vue-cli-multipage-bootstrap">vue-cli-multipage-bootstrap</a> ★37 - 将vue官方在线示例整合到组件中 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/BubblyPoker/cnode-vue">cnode-vue</a> ★37 - 基于vue和vue-router构建的cnodejs web网站SPA </li>
<li><a target="_blank" rel="noopener" href="https://github.com/jiananle/vue-cnode">vue-cnode</a> ★34 - 用 Vue 做的 CNode 官网 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Alex-xd/seeMusic">seeMusic</a> ★32 - 跨平台云音乐播放器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/GitaiQAQ/HyaReader">HyaReader</a> ★31 - 移动友好的阅读器 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/xrr2016/zhihu-daily">zhihu-daily</a> ★28 - 轻松查看知乎日报内容 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/pluto1114/vue-music163">vue-music163</a> ★26 - 音乐VueJS项目 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Damonlw/vue-cnode">vue-cnode</a> ★22 - 使用cNode社区提供的接口 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/sailengsi/sls-vuex2-demo">sls-vuex2-demo</a> ★21 - vuex2商城购物车demo </li>
<li><a target="_blank" rel="noopener" href="https://github.com/moonou/zhihu-daily-vue">zhihu-daily-vue</a> ★20 - 知乎日报 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/soulcm/vue-cnode-mobile">vue-cnode-mobile</a> ★20 - 搭建cnode社区 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/xandeer/gank">gank</a> ★18 - gankio资源的阅读应用 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ITCNZ/vue-dropload">vue-dropload</a> ★18 - 用以测试下拉加载与简单路由 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/fishenal/Vuejs-SalePlatform">Vuejs-SalePlatform</a> ★17 - vuejs搭建的售卖平台demo </li>
<li><a target="_blank" rel="noopener" href="https://github.com/fishenal/Todos_Vuejs">Todos_Vuejs</a> ★17 - vuejs2搭建的极简的todolist </li>
<li><a target="_blank" rel="noopener" href="https://github.com/Halfeld/v-notes">v-notes</a> ★17 - 简单美观的记事本 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/BosNaufal/vue-starter">vue-starter</a> ★16 - VueJs项目的简单启动页 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/youknowznm/vue-memo">vue-memo</a> ★10 - 用 vue写的记事本应用 </li>
<li><a target="_blank" rel="noopener" href="https://github.com/CaiYiLiang/simply-calculator-vuejs">simply-calculator-vuejs</a> ★7 - 用VueJS实现简易计算器 </li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-03-07T00:00:00.000Z" title="3/7/2017, 12:00:00 AM">2017-03-07</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">6 分钟读完 (大约932个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/03/07/Java%E8%A7%A3%E6%9E%90%E6%90%9C%E7%8B%97%E8%BE%93%E5%85%A5%E6%B3%95%E8%AF%8D%E5%BA%93/">Java解析搜狗输入法词库</a></h1><div class="content"><blockquote>
<p>解析算法摘自：<a target="_blank" rel="noopener" href="http://qindongliang.iteye.com/blog/2088416">http://qindongliang.iteye.com/blog/2088416</a></p>
</blockquote>
<p>最近在优化社区搜索结果，之前使用的词库比较老旧很多次都收录不全，所以想到了搜狗输入法词库。但是搜索输入法词库文件是加密之后的，去网上找了一个Java版的解析程序，经测试可用，这里搜藏一下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mucang.saturn.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.RandomAccessFile;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.LinkOption;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Map.Entry;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析sogou词库工具类</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SogouDictParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        sogou(<span class="string">&quot;/Users/gaoyoubo/Downloads/sougou.scel&quot;</span>, <span class="string">&quot;/Users/gaoyoubo/Downloads/sougou.txt&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取scel的词库文件</span></span><br><span class="line"><span class="comment">     * 生成txt格式的文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputPath  输入路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputPath 输出路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isAppend   是否拼接追加词库内容</span></span><br><span class="line"><span class="comment">     *                   true 代表追加,false代表重建</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sogou</span><span class="params">(String inputPath, String outputPath, <span class="keyword">boolean</span> isAppend)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(inputPath);</span><br><span class="line">        <span class="keyword">if</span> (!isAppend) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Files.exists(Paths.get(outputPath), LinkOption.values())) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;存储此文件已经删除&quot;</span>);</span><br><span class="line">                Files.deleteIfExists(Paths.get(outputPath));</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> (RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(outputPath, <span class="string">&quot;rw&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            SogouScelMdel model = <span class="keyword">new</span> SogouScelReader().read(file);</span><br><span class="line">            Map&lt;String, List&lt;String&gt;&gt; words = model.getWordMap(); <span class="comment">//词&lt;拼音,词&gt;</span></span><br><span class="line">            Set&lt;Entry&lt;String, List&lt;String&gt;&gt;&gt; set = words.entrySet();</span><br><span class="line">            Iterator&lt;Entry&lt;String, List&lt;String&gt;&gt;&gt; it = set.iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                Entry&lt;String, List&lt;String&gt;&gt; entry = it.next();</span><br><span class="line">                List&lt;String&gt; list = entry.getValue();</span><br><span class="line">                <span class="keyword">int</span> size = list.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                    String word = list.get(i);</span><br><span class="line"></span><br><span class="line">                    System.out.println(word);</span><br><span class="line"></span><br><span class="line">                    raf.seek(raf.getFilePointer());</span><br><span class="line">                    raf.write((word + <span class="string">&quot;\n&quot;</span>).getBytes());<span class="comment">//写入txt文件</span></span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;生成txt成功！,总计写入: &quot;</span> + count + <span class="string">&quot; 条数据！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.mucang.saturn.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.DataInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2017-03-07 19:26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SogouScelReader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> String encoding = <span class="string">&quot;UTF-16LE&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SogouScelMdel <span class="title">read</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> read(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> ByteArrayOutputStream output = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">readString</span><span class="params">(DataInputStream input, <span class="keyword">int</span> pos, <span class="keyword">int</span>[] reads)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> read = reads[<span class="number">0</span>];</span><br><span class="line">        input.skip(pos - read);</span><br><span class="line">        read = pos;</span><br><span class="line">        output.reset();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> c1 = input.read();</span><br><span class="line">            <span class="keyword">int</span> c2 = input.read();</span><br><span class="line">            read += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span> (c1 == <span class="number">0</span> &amp;&amp; c2 == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                output.write(c1);</span><br><span class="line">                output.write(c2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        reads[<span class="number">0</span>] = read;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(output.toByteArray(), encoding);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SogouScelMdel <span class="title">read</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SogouScelMdel model = <span class="keyword">new</span> SogouScelMdel();</span><br><span class="line">        DataInputStream input = <span class="keyword">new</span> DataInputStream(in);</span><br><span class="line">        <span class="keyword">int</span> read;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">            input.readFully(bytes);</span><br><span class="line">            <span class="keyword">assert</span> (bytes[<span class="number">0</span>] == <span class="number">0x40</span> &amp;&amp; bytes[<span class="number">1</span>] == <span class="number">0x15</span> &amp;&amp; bytes[<span class="number">2</span>] == <span class="number">0</span> &amp;&amp; bytes[<span class="number">3</span>] == <span class="number">0</span>);</span><br><span class="line">            input.readFully(bytes);</span><br><span class="line">            <span class="keyword">int</span> flag1 = bytes[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">assert</span> (bytes[<span class="number">1</span>] == <span class="number">0x43</span> &amp;&amp; bytes[<span class="number">2</span>] == <span class="number">0x53</span> &amp;&amp; bytes[<span class="number">3</span>] == <span class="number">0x01</span>);</span><br><span class="line">            <span class="keyword">int</span>[] reads = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">8</span>&#125;;</span><br><span class="line">            model.setName(readString(input, <span class="number">0x130</span>, reads));</span><br><span class="line">            model.setType(readString(input, <span class="number">0x338</span>, reads));</span><br><span class="line">            model.setDescription(readString(input, <span class="number">0x540</span>, reads));</span><br><span class="line">            model.setSample(readString(input, <span class="number">0xd40</span>, reads));</span><br><span class="line">            read = reads[<span class="number">0</span>];</span><br><span class="line">            input.skip(<span class="number">0x1540</span> - read);</span><br><span class="line">            read = <span class="number">0x1540</span>;</span><br><span class="line">            input.readFully(bytes);</span><br><span class="line">            read += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">assert</span> (bytes[<span class="number">0</span>] == (<span class="keyword">byte</span>) <span class="number">0x9D</span> &amp;&amp; bytes[<span class="number">1</span>] == <span class="number">0x01</span> &amp;&amp; bytes[<span class="number">2</span>] == <span class="number">0</span> &amp;&amp; bytes[<span class="number">3</span>] == <span class="number">0</span>);</span><br><span class="line">            bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">128</span>];</span><br><span class="line">            Map&lt;Integer, String&gt; pyMap = <span class="keyword">new</span> LinkedHashMap&lt;Integer, String&gt;();</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> mark = readUnsignedShort(input);</span><br><span class="line">                <span class="keyword">int</span> size = input.readUnsignedByte();</span><br><span class="line">                input.skip(<span class="number">1</span>);</span><br><span class="line">                read += <span class="number">4</span>;</span><br><span class="line">                <span class="keyword">assert</span> (size &gt; <span class="number">0</span> &amp;&amp; (size % <span class="number">2</span>) == <span class="number">0</span>);</span><br><span class="line">                input.readFully(bytes, <span class="number">0</span>, size);</span><br><span class="line">                read += size;</span><br><span class="line">                String py = <span class="keyword">new</span> String(bytes, <span class="number">0</span>, size, encoding);</span><br><span class="line">                <span class="comment">//System.out.println(py);</span></span><br><span class="line">                pyMap.put(mark, py);</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;zuo&quot;</span>.equals(py)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (flag1 == <span class="number">0x44</span>) &#123;</span><br><span class="line">                input.skip(<span class="number">0x2628</span> - read);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (flag1 == <span class="number">0x45</span>) &#123;</span><br><span class="line">                input.skip(<span class="number">0x26C4</span> - read);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;出现意外，联系作者&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            Map&lt;String, List&lt;String&gt;&gt; wordMap = <span class="keyword">new</span> LinkedHashMap&lt;String, List&lt;String&gt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> size = readUnsignedShort(input);</span><br><span class="line">                <span class="keyword">if</span> (size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span> count = readUnsignedShort(input);</span><br><span class="line">                <span class="keyword">int</span> len = count / <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">assert</span> (len * <span class="number">2</span> == count);</span><br><span class="line">                buffer.setLength(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                    <span class="keyword">int</span> key = readUnsignedShort(input);</span><br><span class="line">                    buffer.append(pyMap.get(key)).append(<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                buffer.setLength(buffer.length() - <span class="number">1</span>);</span><br><span class="line">                String py = buffer.toString();</span><br><span class="line">                List&lt;String&gt; list = wordMap.get(py);</span><br><span class="line">                <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                    wordMap.put(py, list);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                    count = readUnsignedShort(input);</span><br><span class="line">                    <span class="keyword">if</span> (count &gt; bytes.length) &#123;</span><br><span class="line">                        bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[count];</span><br><span class="line">                    &#125;</span><br><span class="line">                    input.readFully(bytes, <span class="number">0</span>, count);</span><br><span class="line">                    String word = <span class="keyword">new</span> String(bytes, <span class="number">0</span>, count, encoding);</span><br><span class="line">                    <span class="comment">//接下来12个字节可能是词频或者类似信息</span></span><br><span class="line">                    input.skip(<span class="number">12</span>);</span><br><span class="line">                    list.add(word);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//System.out.println(wordMap.size());</span></span><br><span class="line">            model.setWordMap(wordMap);</span><br><span class="line">            <span class="keyword">return</span> model;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            in.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">readUnsignedShort</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ch1 = in.read();</span><br><span class="line">        <span class="keyword">int</span> ch2 = in.read();</span><br><span class="line">        <span class="keyword">if</span> ((ch1 | ch2) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.MIN_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (ch2 &lt;&lt; <span class="number">8</span>) + (ch1 &lt;&lt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.mucang.saturn.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2017-03-07 19:26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SogouScelMdel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, List&lt;String&gt;&gt; wordMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="keyword">private</span> String sample;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; getWordMap() &#123;</span><br><span class="line">        <span class="keyword">return</span> wordMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setWordMap</span><span class="params">(Map&lt;String, List&lt;String&gt;&gt; wordMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.wordMap = wordMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDescription</span><span class="params">(String description)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSample</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sample;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSample</span><span class="params">(String sample)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sample = sample;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-03-13T23:03:11.000Z" title="3/13/2015, 11:03:11 PM">2015-03-13</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">4 分钟读完 (大约538个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/03/13/%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%8BJAVA%E8%BF%9B%E7%A8%8B%E9%AB%98CPU%E5%8D%A0%E7%94%A8%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/">生产环境下JAVA进程高CPU占用故障排查</a></h1><div class="content"><p>收藏一篇文章，这两天被驾校之家CPU占用过高的问题弄的寝食难安。马上用下面的方法监控一下。</p>
<p>参考文章：</p>
<p>    1. <a target="_blank" rel="noopener" href="http://blog.csdn.net/blade2001/article/details/9065985">http://blog.csdn.net/blade2001/article/details/9065985</a></p>
<p>    2. <a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangguilong2000/article/details/17971247">http://blog.csdn.net/jiangguilong2000/article/details/17971247</a></p>
<p>问题描述：<br>生产环境下的某台tomcat7服务器，在刚发布时的时候一切都很正常，在运行一段时间后就出现CPU占用很高的问题，基本上是负载一天比一天高。  </p>
<p>问题分析：<br>1，程序属于CPU密集型，和开发沟通过，排除此类情况。<br>2，程序代码有问题，出现死循环，可能性极大。  </p>
<p>问题解决：<br>1，开发那边无法排查代码某个模块有问题，从日志上也无法分析得出。<br>2，记得原来通过strace跟踪的方法解决了一台PHP服务器CPU占用高的问题，但是通过这种方法无效，经过google搜索，发现可以通过下面的方法进行解决，那就尝试下吧。  </p>
<p>解决过程：<br>1，根据top命令，发现PID为2633的Java进程占用CPU高达300%，出现故障。  </p>
<p>2，找到该进程后，如何定位具体线程或代码呢，首先显示线程列表,并按照CPU占用高的线程排序：<br>[root@localhost logs]# ps -mp 2633 -o THREAD,tid,time | sort -rn  </p>
<p>显示结果如下：<br>USER     %CPU PRI SCNT WCHAN  USER SYSTEM   TID     TIME<br>root     10.5  19    - -         -      -  3626 00:12:48<br>root     10.1  19    - -         -      -  3593 00:12:16  </p>
<p>找到了耗时最高的线程3626，占用CPU时间有12分钟了！  </p>
<p>将需要的线程ID转换为16进制格式：<br>[root@localhost logs]# printf “%x\n” 3626<br>e18  </p>
<p>最后打印线程的堆栈信息：<br>[root@localhost logs]# jstack 2633 |grep e18 -A 30  </p>
<p>将输出的信息发给开发部进行确认，这样就能找出有问题的代码。<br>通过最近几天的监控，CPU已经安静下来了。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-03-02T11:49:20.000Z" title="3/2/2015, 11:49:20 AM">2015-03-02</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">7 分钟读完 (大约996个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/03/02/FULL-GC%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B%E5%88%86%E4%BA%AB/">FULL GC分析过程分享</a></h1><div class="content"><p>转载-原文地址：<a target="_blank" rel="noopener" href="http://www.taobaotest.com/blogs/2294">http://www.taobaotest.com/blogs/2294</a></p>
<p>在性能测试过程中,FULL GC频繁是比较常见的问题，FULL GC 产生的原因有很多，这里主要针对meta压测过程中分析FULL GC问题的一些思路进行分享，供大家参考</p>
<p>1.如何发现是否发生FULL GC和FULL GC是否频繁</p>
<p>使用JDK自带的轻量级小工具jstat</p>
<p>     语法结构：</p>
<p>Usage: jstat -help|-options</p>
<p>             jstat -<option> [-t] [-h<lines>] <vmid> [<interval> [<count>]]</p>
<p> 参数解释：</p>
<p>Options — 选项，我们一般使用 -gcutil 查看gc情况</p>
<p>vmid    — VM的进程号，即当前运行的java进程号</p>
<p>interval– 间隔时间，单位为秒或者毫秒</p>
<p>count   — 打印次数，如果缺省则打印无数次</p>
<p>比如 /opt/taobao/java/bin/jstat –gcutil pid 5000</p>
<p> </p>
<p>输出结果：</p>
<p>        S0        S1         E          O          P        YGC      YGCT        FGC     FGCT        GCT</p>
<p>           0.00  90.63 100.00  58.82   3.51    183    2.059     0    0.000    2.059</p>
<p>    0.00  15.48   7.80  60.99   3.51    185    2.092     1    0.305    2.397</p>
<p>    0.00  15.48  18.10  47.90   3.51    185    2.092     2    0.348    2.440</p>
<p> S0  — Heap上的 Survivor space 0 区已使用空间的百分比<br> S1  — Heap上的 Survivor space 1 区已使用空间的百分比<br> E   — Heap上的 Eden space 区已使用空间的百分比<br> O   — Heap上的 Old space 区已使用空间的百分比<br> P   — Perm space 区已使用空间的百分比<br> YGC — 从应用程序启动到采样时发生 Young GC 的次数<br> YGCT– 从应用程序启动到采样时 Young GC 所用的时间(单位秒)<br> FGC — 从应用程序启动到采样时发生 Full GC 的次数<br> FGCT– 从应用程序启动到采样时 Full GC 所用的时间(单位秒)<br> GCT — 从应用程序启动到采样时用于垃圾回收的总时间(单位秒)</p>
<p>    通过FGC我们可以发现系统是否发生FULL GC和FULL GC的频率</p>
<p>2.  FULL GC分析和问题定位</p>
<p>    a.     GC log收集和分析</p>
<p>(1)在JVM启动参数增加：”-verbose:gc -Xloggc:&lt;file_name&gt;  -XX:+PrintGCDetails -XX:+PrintGCDateStamps”</p>
<p>    PrintGCTimeStamp只能获得相对时间，建议使用PrintGCDateStamps获得full gc 发生的绝对时间</p>
<p>      (2)如果采用CMS GC,仔细分析jstat FGC输出和GC 日志会发现， CMS的每个并发GC周期则有两个stop-the-world阶段——initial mark与final re-mark<strong>，</strong>使得CMS的每个并发GC周期总共会更新full GC计数器两次，initial mark与final re-mark各一次</p>
<p>    </p>
<p>    b.     Dump JVM 内存快照</p>
<p>/opt/taobao/java/bin/jmap -dump:format=b,file=dump.bin pid</p>
<p>这里有一个问题是什么时候进行dump?</p>
<p>一种方法是前面提到的用jstat工具观察，当OLD区到达比较高的比例如60%，一般会很快触发一次FULL GC,可以进行一次DUMP,在FULL GC发生以后再DUMP一次，这样比较就可以发现到底是哪些对象导致不停的FULL GC</p>
<p>另外一种方法是通过配置JVM参数</p>
<p> -XX:+HeapDumpBeforeFullGC -XX:+HeapDumpAfterFullGC分别用于指定在full GC之前与之后生成heap dump </p>
<p>    c.     利用MAT((Memory Analyzer Tool)工具分析dump文件</p>
<p>关于MAT具体使用方法网上有很多介绍，这里不做详细展开，这里需要注意的是：</p>
<p>(1)   MAT缺省只分析reachable的对象，unreachable的对象（将被收集掉的对象）被忽略，而分析FULL GC频繁原因时unreachable object也应该同时被重点关注。如果要显示unreachable的对象细节必须用mat 1.1以上版本并且打开选项“keep unreachable object”</p>
<p>(2)   通常dump文件会好几个G，无法在windows上直接进行分析，我们可以先把dump文件在linux上进行分析，再把分析好的文件拷贝到windows上，在windows上用MAT打开分析文件。</p>
<p>下面是Meta2.0压测曾遇到的FULL GC频繁问题的分析结果，比较明显，DispatchRequest对象有4千多万个，一共超过2G，并最终导致OOM</p>
<p><img src="http://file.mspring.org/images/blog/83f48d2a9de38682ed93018f08211d9e!detail" alt="83f48d2a9de38682ed93018f08211d9e_detail"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-02-04T12:37:28.000Z" title="2/4/2015, 12:37:28 PM">2015-02-04</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">9 分钟读完 (大约1277个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/02/04/%E7%94%A816G%E5%86%85%E5%AD%98%E5%9C%A8Java-Map%E4%B8%AD%E5%A4%84%E7%90%8630%E4%BA%BF%E5%AF%B9%E8%B1%A1/">用16G内存在Java Map中处理30亿对象</a></h1><div class="content"><p>在一个下雨的夜晚，我在思考Java中内存管理的问题，以及Java集合对内存使用的效率情况。我做了一个简单的实验，测试在16G内存条件下，Java的Map可以插入多少对象。</p>
<p>这个试验的目的是为了得出集合的内部上限。所以，我决定使用很小的key和value。所有的测试，都是在64w位linux环境下进行的，操作系统是ubuntu12.04。JVM版本为Oracle Java 1.7.0_09-bo5 (HotSpot 23.5-b02)。在这个JVM中，压缩指针(compressed pointers(-XX:+UseCompressedOops))的选项是默认打开的。</p>
<p>首先是简单的针对java.util.TreeMap的测试。不停向其中插入数字，直到其抛出内存溢出异常。JVM的设置是-xmx15G</p>
<pre><code>import java.util.*; 
Map m = new TreeMap();
for(long counter=0;;counter++)&#123;
  m.put(counter,&quot;&quot;);
  if(counter%1000000==0) System.out.println(&quot;&quot;+counter);
&#125;
</code></pre>
<p>这个用例插入了1 7200 0000条数据。在接近结束的时候，由于高负荷的GC插入效率开始降低。第二次，我用HashMap代替TreeMap，这次插入了182 000 000条数据。</p>
<p>Java默认的集合并不是最高效利用内存的。所以，这回我们尝试最后化内存的测试。我选择了MapDB中的LongHashMap，其使用原始的long key并且对封装的内存占用进行了优化。JVM的设置仍然是-Xmx15G。</p>
<pre><code>import org.mapdb.*
LongMap m = new LongHashMap();    
for(long counter=0;;counter++)&#123;
  m.put(counter,&quot;&quot;);
  if(counter%1000000==0) System.out.println(&quot;&quot;+counter);
&#125;
</code></pre>
<p>这次，计数器停止在了276 000 000。同样，在插入接近结束的时候，速度开始减慢。看起来这是基于堆的结合的限制所在。垃圾回收带来了瓶颈 。</p>
<p>现在是时候祭出杀手锏了:-)。我们可以采用非基于堆的方式存储，这样GC就不会发现我们的数据。我来介绍一下MapDB，它提供了基于数据库引擎的并发同步的TreeMap和HashMap。它提供了多样化的存储方式，其中一个就是非堆内存的方式。(声明：我是MapDB的作者)。</p>
<p>现在，让我们再跑一下之前的用例，这次采用的是非堆的Map。首先是配置并打开数据库，它打开的直接基于内存存储并且关闭事物的模式。接下来的代码是在这个db中创建一个新的map。</p>
<pre><code>import org.mapdb.*

DB db = DBMaker
   .newDirectMemoryDB()
   .transactionDisable()
   .make();

Map m = db.getTreeMap(&quot;test&quot;);
for(long counter=0;;counter++)&#123;
  m.put(counter,&quot;&quot;);
  if(counter%1000000==0) System.out.println(&quot;&quot;+counter);
&#125;
</code></pre>
<p>这是非堆的Map，所以我们需要不同的JVM配置： -XX:MaxDirectMemorySize=15G -Xmx128M。这次测试在达到980 000 000条记录的时候出现内存溢出。</p>
<p>但是，MapDB还可以优化。之前样例的问题在于记录的破碎分散，b-tree的节点每次插入都要调整它的容量。变通的方案是，将b-tree的节点在其插入前短暂的缓存起来。这使得记录的分散降到最低。所以，我们来改变一下DB的配置：</p>
<pre><code>DB db = DBMaker
     .newDirectMemoryDB()
     .transactionDisable()
     .asyncFlushDelay(100)
     .make();

Map m = db.getTreeMap(&quot;test&quot;);
</code></pre>
<p>这次记录数达到了 1 738 000 000。速度也是达到了惊人的31分钟完成了17亿数据的插入。</p>
<p>MapDB还能继续优化。我们把b-tree的节点容量从32提升到120并且打开透明(OneCoder理解为对用户不可见的)压缩：</p>
<pre><code>DB db = DBMaker
            .newDirectMemoryDB()
            .transactionDisable()
            .asyncFlushDelay(100)
            .compressionEnable()
            .make();

   Map m = db.createTreeMap(&quot;test&quot;,120, false, null, null, null);
</code></pre>
<p>这个用例在大约3 315 000 000条记录时出现内存溢出。由于压缩，他的速度 有所降低，不过还是在几个小时内完成。我还可以进行一些优化(自定义序列化等等) ，使得数据量达到大约40亿。</p>
<p>也许你好奇所有这些记录是怎么存储的。答案就是，delta-key压缩。当然，向B-Tree插入已经排好序的递增key是最佳的使用场景，并且MapDB也对此进行了一些小小的 优化。最差的情形就是key是随机的.</p>
<p>后续更新：很多朋友对压缩有一些困惑。在这些用例中，Delta-key 压缩默认都是启用的。在下面的用例中，我又额外开启了zlib方式的压缩：</p>
<pre><code>DB db = DBMaker
            .newDirectMemoryDB()
            .transactionDisable()
            .asyncFlushDelay(100)
            .make();

    Map m = db.getTreeMap(&quot;test&quot;);

    Random r = new Random();
    for(long counter=0;;counter++)&#123;
        m.put(r.nextLong(),&quot;&quot;);
        if(counter%1000000==0) System.out.println(&quot;&quot;+counter);
    &#125;
</code></pre>
<p>即使在随机序列情况下，MapDB也可以存储652 000 000条记录，大概4倍于基于堆的集合。</p>
<p>这个简单的试验没有太多的目的。这仅仅是我对MapDB的一种优化。也许，更多的惊喜在于插入效率确实不错并且MapDB可以抗衡基于内存的集合。</p>
<p>原文地址：<a target="_blank" rel="noopener" href="http://kotek.net/blog/3G_map">http://kotek.net/blog/3G_map</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2014-05-16T00:00:00.000Z" title="5/16/2014, 12:00:00 AM">2014-05-16</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约148个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2014/05/16/Java%E4%B8%BB%E7%BA%BF%E7%A8%8B%E7%AD%89%E5%BE%85%E5%AD%90%E7%BA%BF%E7%A8%8B%E5%AE%8C%E6%88%90/">Java主线程等待子线程完成</a></h1><div class="content"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@since</span> 2014-05-16 10:20:08</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SubThread thread = <span class="keyword">new</span> SubThread();</span><br><span class="line">        thread.start(); <span class="comment">//子线程开始</span></span><br><span class="line">        mainThreadWorking();<span class="comment">//主线程干活</span></span><br><span class="line">        System.out.println(<span class="string">&quot;main:等待子线程完成&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            thread.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;所有线程都完成！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mainThreadWorking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;main:主线程开始干活...&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000L</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;main:主线程干完了!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;sub:子线程开始干活...&quot;</span>);</span><br><span class="line">            sleep(<span class="number">6000L</span>); <span class="comment">//子线程花6秒钟时间干活</span></span><br><span class="line">            System.out.println(<span class="string">&quot;sub:子线程干完了!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="http://file.mspring.org/images/blog/avatar.jpg" alt="雾非雾的情思"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">雾非雾的情思</p><p class="is-size-6 is-block">爱折腾的老码农！</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Wuhan, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">150</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">29</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/gaoyoubo" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/gaoyoubo"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"><span class="level-start"><span class="level-item">碎碎念</span></span><span class="level-end"><span class="level-item tag">39</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/"><span class="level-start"><span class="level-item">程序员</span></span><span class="level-end"><span class="level-item tag">86</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-10T10:08:18.000Z">2021-06-10</time></p><p class="title"><a href="/2021/06/10/%E6%89%B9%E9%87%8F%E6%8B%89%E5%8F%96%E4%BB%A3%E7%A0%81/">批量拉取代码</a></p><p class="categories"><a href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-22T14:04:19.000Z">2021-03-22</time></p><p class="title"><a href="/2021/03/22/MacOS%E5%AE%89%E8%A3%85PHP/">MacOS安装PHP</a></p><p class="categories"><a href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-22T22:13:31.000Z">2021-01-22</time></p><p class="title"><a href="/2021/01/22/%E7%BE%A4%E8%BE%89QNAP%E4%BD%BF%E7%94%A8%E5%A4%87%E5%BF%98/">群辉QNAP使用备忘</a></p><p class="categories"><a href="/categories/%E7%A2%8E%E7%A2%8E%E5%BF%B5/">碎碎念</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-19T16:53:42.000Z">2021-01-19</time></p><p class="title"><a href="/2021/01/19/mac-iterm2-rz%E4%B8%8Esz%E7%9A%84%E5%8A%9F%E8%83%BD/">mac iterm2 rz与sz的功能</a></p><p class="categories"><a href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-11-25T11:18:00.000Z">2020-11-25</time></p><p class="title"><a href="/2020/11/25/Mac%E4%BD%BF%E7%94%A8%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/">Mac使用过程中的问题汇总</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">九月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/10/"><span class="level-start"><span class="level-item">十月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/11/"><span class="level-start"><span class="level-item">十一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/07/"><span class="level-start"><span class="level-item">七月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/06/"><span class="level-start"><span class="level-item">六月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/04/"><span class="level-start"><span class="level-item">四月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/11/"><span class="level-start"><span class="level-item">十一月 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/04/"><span class="level-start"><span class="level-item">四月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/03/"><span class="level-start"><span class="level-item">三月 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/02/"><span class="level-start"><span class="level-item">二月 2016</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/07/"><span class="level-start"><span class="level-item">七月 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/05/"><span class="level-start"><span class="level-item">五月 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/04/"><span class="level-start"><span class="level-item">四月 2015</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/03/"><span class="level-start"><span class="level-item">三月 2015</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/02/"><span class="level-start"><span class="level-item">二月 2015</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/10/"><span class="level-start"><span class="level-item">十月 2014</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/08/"><span class="level-start"><span class="level-item">八月 2014</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/06/"><span class="level-start"><span class="level-item">六月 2014</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/05/"><span class="level-start"><span class="level-item">五月 2014</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/03/"><span class="level-start"><span class="level-item">三月 2014</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/01/"><span class="level-start"><span class="level-item">一月 2014</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/12/"><span class="level-start"><span class="level-item">十二月 2013</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/10/"><span class="level-start"><span class="level-item">十月 2013</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/09/"><span class="level-start"><span class="level-item">九月 2013</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ElasticSearch/"><span class="tag">ElasticSearch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Electron/"><span class="tag">Electron</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hadoop/"><span class="tag">Hadoop</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HexoClient/"><span class="tag">HexoClient</span><span class="tag">17</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaCV/"><span class="tag">JavaCV</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nginx/"><span class="tag">Nginx</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ffmpeg/"><span class="tag">ffmpeg</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/js/"><span class="tag">js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mac/"><span class="tag">mac</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mariadb/"><span class="tag">mariadb</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/markdown/"><span class="tag">markdown</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ocr/"><span class="tag">ocr</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/php/"><span class="tag">php</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shadowsocks/"><span class="tag">shadowsocks</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/springboot/"><span class="tag">springboot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tesseract/"><span class="tag">tesseract</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/"><span class="tag">推荐系统</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"><span class="tag">碎碎念</span><span class="tag">38</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/"><span class="tag">程序员</span><span class="tag">44</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="http://file.mspring.org/images/blog/avatar.jpg" alt="雾非雾的情思" height="28"></a><p class="is-size-7"><span>&copy; 2021 雾非雾的情思</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Github" href="https://github.com/gaoyoubo"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>
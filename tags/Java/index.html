<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>标签: Java - 雾非雾的情思</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="雾非雾的情思"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="雾非雾的情思"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="雾非雾的情思"><meta property="og:url" content="http://www.mspring.org/"><meta property="og:site_name" content="雾非雾的情思"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://www.mspring.org/img/og_image.png"><meta property="article:author" content="雾非雾的情思"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.mspring.org"},"headline":"雾非雾的情思","image":["http://www.mspring.org/img/og_image.png"],"author":{"@type":"Person","name":"雾非雾的情思"},"description":null}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="雾非雾的情思" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="http://file.mspring.org/images/blog/avatar.jpg" alt="雾非雾的情思" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a><a class="navbar-item" href="/links">友链</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Github" href="https://github.com/gaoyoubo"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">标签</a></li><li class="is-active"><a href="#" aria-current="page">Java</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-15T16:20:11.000Z" title="7/15/2019, 4:20:11 PM">2019-07-15</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">13 分钟读完 (大约1908个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/15/Java%E7%A8%8B%E5%BA%8F%E5%91%98Go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8%E7%AE%80%E4%BB%8B/">Java程序员Go语言入门简介</a></h1><div class="content"><h2 id="为什么是Go语言"><a href="#为什么是Go语言" class="headerlink" title="为什么是Go语言"></a>为什么是Go语言</h2><ul>
<li>类C的语法，这意味着Java、C#、JavaScript程序员能很快的上手</li>
<li>有自己的垃圾回收机制</li>
<li>跨平台、编译即可执行无需安装依赖环境</li>
<li>支持反射</li>
</ul>
<h2 id="Go语言简介"><a href="#Go语言简介" class="headerlink" title="Go语言简介"></a>Go语言简介</h2><p>Go 语言（或 Golang）起源于 2007 年，并在 2009 年正式对外发布。Go 是非常年轻的一门语言，它的主要目标是“兼具Python等动态语言的开发速度和 C/C++ 等编译型语言的性能与安全性”。</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><table>
<thead>
<tr>
<th>数据类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>bool</td>
<td>布尔</td>
</tr>
<tr>
<td>string</td>
<td>字符串</td>
</tr>
<tr>
<td>int</td>
<td>uint8,uint16,uint32,uint64,int8,int16,int32,int64</td>
</tr>
<tr>
<td>float</td>
<td>float32,float64</td>
</tr>
<tr>
<td>byte</td>
<td>byte</td>
</tr>
</tbody></table>
<p>参考：<a target="_blank" rel="noopener" href="https://www.runoob.com/go/go-data-types.html">https://www.runoob.com/go/go-data-types.html</a></p>
<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><h3 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h3><p>在线运行示例：<a target="_blank" rel="noopener" href="https://play.golang.org/p/-4RylAqUV36">https://play.golang.org/p/-4RylAqUV36</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> name <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">  name = <span class="string">&quot;world&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;hello &quot;</span> + name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来执行一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go run main.go <span class="comment"># main.go 为刚刚创建的那个文件的名称</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hello world</span></span><br></pre></td></tr></table></figure>

<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><h4 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h4><p>在线运行示例：<a target="_blank" rel="noopener" href="https://play.golang.org/p/zPqCkRZgrgp">https://play.golang.org/p/zPqCkRZgrgp</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> name <span class="keyword">string</span>   <span class="comment">// 声明</span></span><br><span class="line">	name = <span class="string">&quot;gaoyoubo&quot;</span> <span class="comment">// 赋值</span></span><br><span class="line">	fmt.Println(name)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> age <span class="keyword">int</span> = <span class="number">18</span> <span class="comment">// 声明并赋值</span></span><br><span class="line">	fmt.Println(age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="类型推断"><a href="#类型推断" class="headerlink" title="类型推断"></a>类型推断</h4><p>在线运行示例：<a target="_blank" rel="noopener" href="https://play.golang.org/p/0My8veBvtJ8">https://play.golang.org/p/0My8veBvtJ8</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	name := <span class="string">&quot;gaoyoubo&quot;</span></span><br><span class="line">	fmt.Println(name)</span><br><span class="line"></span><br><span class="line">	age := <span class="number">18</span></span><br><span class="line">	fmt.Println(age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><ul>
<li>函数可以有多个返回值</li>
<li>隐式的指定函数是private还是public，函数首字母大写的为public、小写的为private</li>
<li>没有类似Java中的<code>try cache</code>、<code>throw</code>，Go语言是通过将<code>error</code>作为返回值来处理异常。</li>
<li>不支持重载</li>
</ul>
<p>下面我们通过一个示例来了解一下，在线运行示例：<a target="_blank" rel="noopener" href="https://play.golang.org/p/PYy3ueuPFS6">https://play.golang.org/p/PYy3ueuPFS6</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log1()</span><br><span class="line"></span><br><span class="line">	log2(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line"></span><br><span class="line">	ret1 := add1(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">	fmt.Println(<span class="string">&quot;add1 result:&quot;</span> + strconv.Itoa(ret1))</span><br><span class="line"></span><br><span class="line">	ret2, err := Add2(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Add2 result:&quot;</span> + strconv.Itoa(ret2))</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Add2 error&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 私有、无入参、无返回值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">log1</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;execute func log1&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 私有、入参、无返回值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">log2</span><span class="params">(msg <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;execute func log2:&quot;</span> + msg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 私有、两个入参、一个返回值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add1</span><span class="params">(count1, count2 <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	total := count1 + count2</span><br><span class="line">	fmt.Println(<span class="string">&quot;execute func add3, result=&quot;</span> + strconv.Itoa(total))</span><br><span class="line">	<span class="keyword">return</span> total</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Public、两个入参、多个返回值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add2</span><span class="params">(count1, count2 <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> count1 &lt; <span class="number">1</span> || count2 &lt; <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;数量不能小于1&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	total := count1 + count2</span><br><span class="line">	<span class="keyword">return</span> total, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该示例输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">execute func log1</span><br><span class="line">execute func log2:hello world</span><br><span class="line">execute func add3, result&#x3D;2</span><br><span class="line">add1 result:2</span><br><span class="line">Add2 error 数量不能小于1</span><br></pre></td></tr></table></figure>

<p>但函数有多个返回值的时候，有时你只关注其中一个返回值，这种情况下你可以将其他的返回值赋值给空白符：<code>_</code>，如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_, err := Add2(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  fmt.Println(err)</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>

<p>空白符特殊在于实际上返回值并没有赋值，所以你可以随意将不同类型的值赋值给他，而不会由于类型不同而报错。</p>
<h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><p>Go语言不是像Java那样的面向对象的语言，他没有对象和继承的概念。也没有<code>class</code>的概念。在Go语言中有个概念叫做结构体（<code>struct</code>），结构体和Java中的<code>class</code>比较类似。下面我们定义一个结构体：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name   <span class="keyword">string</span></span><br><span class="line">	Gender <span class="keyword">string</span></span><br><span class="line">	Age    <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面我们定义了一个结构体<code>User</code>，并为该结构体分别设置了三个公有属性：Name/Gender/Age，下面我们来创建一个User对象。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user := User&#123;</span><br><span class="line">	Name:   <span class="string">&quot;hahaha&quot;</span>,</span><br><span class="line">	Gender: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">	Age:    <span class="number">18</span>, <span class="comment">// 值得一提的是，最后的逗号是必须的，否则编译器会报错，这就是go的设计哲学之一，要求强一致性。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结构体的属性可以在结构体内直接声明，那么如何为结构体声明函数（即Java中的方法）呢，我们来看下下面的示例：在线运行示例：<a target="_blank" rel="noopener" href="https://play.golang.org/p/01_cTu0RzdH">https://play.golang.org/p/01_cTu0RzdH</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name   <span class="keyword">string</span></span><br><span class="line">	Gender <span class="keyword">string</span></span><br><span class="line">	Age    <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义User的成员方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">addAge</span><span class="params">()</span></span> &#123;</span><br><span class="line">	u.Age = u.Age + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	user := User&#123;</span><br><span class="line">		Name:   <span class="string">&quot;哈&quot;</span>, <span class="comment">// 名称</span></span><br><span class="line">		Gender: <span class="string">&quot;男&quot;</span>, <span class="comment">// 性别</span></span><br><span class="line">		Age:    <span class="number">18</span>,  <span class="comment">// 值得一提的是，最后的逗号是必须的，否则编译器会报错，这就是go的设计哲学之一，要求强一致性。</span></span><br><span class="line">	&#125;</span><br><span class="line">	user.addAge()</span><br><span class="line">	fmt.Println(user.Age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="指针类型和值类型"><a href="#指针类型和值类型" class="headerlink" title="指针类型和值类型"></a>指针类型和值类型</h3><p>Java中值类型和引用类型都是定死的，int、double、float、long、byte、short、char、boolean为值类型，其他的都是引用类型，而Go语言中却不是这样。</p>
<p>在Go语言中：</p>
<ul>
<li><code>&amp;</code>表示取地址，例如你有一个变量<code>a</code>那么<code>&amp;a</code>就是变量<code>a</code>在内存中的地址，对于Golang指针也是有类型的，比如a是一个string那么&amp;a是一个string的指针类型，在Go里面叫&amp;string。</li>
<li><code>*</code>表示取值，接上面的例子，假设你定义<code>b := &amp;a</code> 如果你打印<code>b</code>，那么输出的是<code>&amp;a</code>的内存地址，如果要取值，那么需要使用：<code>*b</code></li>
</ul>
<p>下面我们来看下例子，在线运行：<a target="_blank" rel="noopener" href="https://play.golang.org/p/jxAKyVMjnoy">https://play.golang.org/p/jxAKyVMjnoy</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	a := <span class="string">&quot;123&quot;</span></span><br><span class="line">	b := &amp;a</span><br><span class="line"></span><br><span class="line">	fmt.Println(a)</span><br><span class="line">	fmt.Println(b)</span><br><span class="line">	fmt.Println(*b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果为：</span><br><span class="line"><span class="number">123</span></span><br><span class="line"><span class="number">0x40c128</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>

<h3 id="并发编程"><a href="#并发编程" class="headerlink" title="并发编程"></a>并发编程</h3><p>Go语言的并发是基于 goroutine 的，goroutine 类似于线程，但并非线程。可以将 goroutine 理解为一种虚拟线程。Go语言运行时会参与调度 goroutine，并将 goroutine 合理地分配到每个 CPU 中，最大限度地使用CPU性能。</p>
<p>Go 程序从 main 包的 main() 函数开始，在程序启动时，Go 程序就会为 main() 函数创建一个默认的 goroutine。</p>
<p><img src="/images/2019/07/15/55b6ace0-a6d9-11e9-8437-8fc3aa44f6bd.jpg"></p>
<p>下面我们来看一个例子（在线演示：<a target="_blank" rel="noopener" href="https://play.golang.org/p/U9U-qjuY0t1%EF%BC%89">https://play.golang.org/p/U9U-qjuY0t1）</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建一个goroutine</span></span><br><span class="line">	<span class="keyword">go</span> runing()</span><br><span class="line">	<span class="comment">// 创建一个匿名的goroutine</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;喜特:&quot;</span> + time.Now().String())</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里sleep一下是因为main方法如果执行完了，main该程序创建的所有goroutine都会退出</span></span><br><span class="line">	time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runing</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;法克:&quot;</span> + time.Now().String())</span><br><span class="line">	time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">法克:<span class="number">2009</span><span class="number">-11</span><span class="number">-10</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">00</span> +<span class="number">0000</span> UTC m=+<span class="number">0.000000001</span></span><br><span class="line">喜特:<span class="number">2009</span><span class="number">-11</span><span class="number">-10</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">00</span> +<span class="number">0000</span> UTC m=+<span class="number">0.000000001</span></span><br></pre></td></tr></table></figure>

<p>执行结果说明fuck函数中的sleep三秒并没有影响<code>喜特</code>的输出。</p>
<p>如果说 goroutine 是Go语言程序的并发体的话，那么 channel 就是它们之间的通信机制。一个 channel 是一个通信机制，它可以让一个 goroutine 通过它给另一个 goroutine 发送值信息。每个 channel 都有一个特殊的类型，也就是 channel 可发送数据的类型。一个可以发送 int 类型数据的 channel 一般写为 chan int。</p>
<p>下面我们利用goroutine+channel来实现一个生产消费者模型，示例代码如下：（在线执行：<a target="_blank" rel="noopener" href="https://play.golang.org/p/lqUBugLdU-I%EF%BC%89">https://play.golang.org/p/lqUBugLdU-I）</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建一个通道</span></span><br><span class="line">	channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int64</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 异步去生产</span></span><br><span class="line">	<span class="keyword">go</span> producer(channel)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 数据消费</span></span><br><span class="line">	consumer(channel)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">producer</span><span class="params">(channel <span class="keyword">chan</span>&lt;- <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">// 将数据写入通道</span></span><br><span class="line">		channel &lt;- time.Now().Unix()</span><br><span class="line">		<span class="comment">// 睡1秒钟</span></span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consumer</span><span class="params">(channel &lt;-<span class="keyword">chan</span> <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		timestamp := &lt;-channel</span><br><span class="line">		fmt.Println(timestamp)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出为如下：(每秒钟打印一次)</span><br><span class="line"><span class="number">1257894000</span></span><br><span class="line"><span class="number">1257894001</span></span><br><span class="line"><span class="number">1257894002</span></span><br><span class="line"><span class="number">1257894003</span></span><br></pre></td></tr></table></figure>


<h2 id="Java程序员觉得不好用的地方"><a href="#Java程序员觉得不好用的地方" class="headerlink" title="Java程序员觉得不好用的地方"></a>Java程序员觉得不好用的地方</h2><ul>
<li>异常处理</li>
<li>没有泛型</li>
<li>不支持多态、重载</li>
<li>不支持注解（但是他的struct中的属性支持<code>tag</code>）</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/go/go-tutorial.html">https://www.runoob.com/go/go-tutorial.html</a></li>
<li><a target="_blank" rel="noopener" href="https://books.studygolang.com/the-little-go-book_ZH_CN/">https://books.studygolang.com/the-little-go-book_ZH_CN/</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-04-03T15:40:01.000Z" title="4/3/2019, 3:40:01 PM">2019-04-03</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约186个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/04/03/%E5%8D%8A%E5%BE%84%E8%8C%83%E5%9B%B4%E5%86%85%E9%9A%8F%E6%9C%BA%E7%BB%8F%E7%BA%AC%E5%BA%A6/">半径范围内随机经纬度</a></h1><div class="content"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> EARTH_RADIUS = <span class="number">6372.796924</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GpsInfo <span class="title">getRandomLocation</span><span class="params">(GpsInfo center, <span class="keyword">double</span> distance)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (distance &lt;= <span class="number">0</span>) distance = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">double</span> lat, lon, brg;</span><br><span class="line">    distance = distance / <span class="number">1000</span>;</span><br><span class="line">    GpsInfo location = <span class="keyword">new</span> GpsInfo();</span><br><span class="line">    <span class="keyword">double</span> maxdist = distance;</span><br><span class="line">    maxdist = maxdist / EARTH_RADIUS;</span><br><span class="line">    <span class="keyword">double</span> startlat = rad(center.getLat());</span><br><span class="line">    <span class="keyword">double</span> startlon = rad(center.getLon());</span><br><span class="line">    <span class="keyword">double</span> cosdif = Math.cos(maxdist) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">double</span> sinstartlat = Math.sin(startlat);</span><br><span class="line">    <span class="keyword">double</span> cosstartlat = Math.cos(startlat);</span><br><span class="line">    <span class="keyword">double</span> dist;</span><br><span class="line">    <span class="keyword">double</span> rad360 = <span class="number">2</span> * Math.PI;</span><br><span class="line">    dist = Math.acos((<span class="keyword">new</span> Random().nextDouble() * cosdif + <span class="number">1</span>));</span><br><span class="line">    brg = rad360 * <span class="keyword">new</span> Random().nextDouble();</span><br><span class="line">    lat = Math.asin(sinstartlat * Math.cos(dist) + cosstartlat * Math.sin(dist) * Math.cos(brg));</span><br><span class="line">    lon = deg(normalizeLongitude(startlon * <span class="number">1</span> + Math.atan2(Math.sin(brg) * Math.sin(dist) * cosstartlat, Math.cos(dist) - sinstartlat * Math.sin(lat))));</span><br><span class="line">    lat = deg(lat);</span><br><span class="line"></span><br><span class="line">    location.setLat(padZeroRight(lat));</span><br><span class="line">    location.setLon(padZeroRight(lon));</span><br><span class="line">    <span class="keyword">return</span> location;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">rad</span><span class="params">(<span class="keyword">double</span> d)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> d * Math.PI / <span class="number">180.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">deg</span><span class="params">(<span class="keyword">double</span> rd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (rd * <span class="number">180</span> / Math.PI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">normalizeLongitude</span><span class="params">(<span class="keyword">double</span> lon)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> n = Math.PI;</span><br><span class="line">    <span class="keyword">if</span> (lon &gt; n) &#123;</span><br><span class="line">        lon = lon - <span class="number">2</span> * n;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lon &lt; -n) &#123;</span><br><span class="line">        lon = lon + <span class="number">2</span> * n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lon;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">padZeroRight</span><span class="params">(<span class="keyword">double</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> sigDigits = <span class="number">8</span>;</span><br><span class="line">    s = Math.round(s * Math.pow(<span class="number">10</span>, sigDigits)) / Math.pow(<span class="number">10</span>, sigDigits);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-11T10:45:07.000Z" title="3/11/2019, 10:45:07 AM">2019-03-11</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">4 分钟读完 (大约540个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/11/Golang%E5%92%8CJava%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%B0%83%E6%9F%A5/">Golang和Java构建工具调查</a></h1><div class="content"><p>Github：<a target="_blank" rel="noopener" href="https://github.com/blindpirate/report-of-build-tools-for-java-and-golang">https://github.com/blindpirate/report-of-build-tools-for-java-and-golang</a></p>
<h1 id="A-Survey-on-Build-Tools-of-Golang-and-Java"><a href="#A-Survey-on-Build-Tools-of-Golang-and-Java" class="headerlink" title="A Survey on Build Tools of Golang and Java"></a>A Survey on Build Tools of Golang and Java</h1><h1 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h1><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In January 2017, the usage of build tools in <a target="_blank" rel="noopener" href="http://github-rank.com/star?language=Java">Github’s top 1000 Java repositories</a> is as follows:</p>
<table>
<thead>
<tr>
<th>Tool Name</th>
<th align="center">Reference Count</th>
</tr>
</thead>
<tbody><tr>
<td>Gradle</td>
<td align="center">627</td>
</tr>
<tr>
<td>Maven</td>
<td align="center">264</td>
</tr>
<tr>
<td>Ant</td>
<td align="center">52</td>
</tr>
<tr>
<td>Npm</td>
<td align="center">4</td>
</tr>
<tr>
<td>Bazel</td>
<td align="center">3</td>
</tr>
<tr>
<td>Make</td>
<td align="center">1</td>
</tr>
</tbody></table>
<p>And the trending over the past 8 years is:</p>
<p><img src="/images/2019/03/11/c6a8a010-43a7-11e9-a68f-4fc47d059a0e.png" alt="trending"></p>
<h2 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h2><ul>
<li>Clone top 1000 Java repositories to local disk</li>
<li>Analyze the repositories by identity files:</li>
</ul>
<table>
<thead>
<tr>
<th>Tool Name</th>
<th align="center">Identity Files</th>
</tr>
</thead>
<tbody><tr>
<td>Gradle</td>
<td align="center">build.gradle</td>
</tr>
<tr>
<td>Maven</td>
<td align="center">pom.xml</td>
</tr>
<tr>
<td>Ant</td>
<td align="center">build.xml</td>
</tr>
<tr>
<td>Npm</td>
<td align="center">package.json</td>
</tr>
<tr>
<td>Bazel</td>
<td align="center">BUILD</td>
</tr>
<tr>
<td>Make</td>
<td align="center">Makefile/makefile</td>
</tr>
</tbody></table>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><ul>
<li>Make sure <a target="_blank" rel="noopener" href="https://git-scm.com/">Git</a>/<a target="_blank" rel="noopener" href="http://www.groovy-lang.org/download.html">Groovy 2.4+</a>/<a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">JDK 1.7+</a> are installed.</li>
<li>Run <code>groovy GithubTopRankCrawler.groovy -l java -d &lt;path to store the 1000 repos&gt;</code> to clone all repositories locally. </li>
<li>Run <code>groovy JavaBuildToolScanner.groovy -d &lt;path to store the 1000 repos&gt;</code> to analyze these repos.</li>
</ul>
<h1 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h1><h2 id="Conclusion-1"><a href="#Conclusion-1" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>There are various package management tools for golang as listed <a target="_blank" rel="noopener" href="https://github.com/golang/go/wiki/PackageManagementTools">here</a>. But which one is the most popular? </p>
<p>The usage of package manage tools in <a target="_blank" rel="noopener" href="http://github-rank.com/star?language=Go">Github’s top 1000 Go repositories</a> is as follows:</p>
<table>
<thead>
<tr>
<th>Tool Name</th>
<th align="center">Url</th>
<th align="center">Reference Count (Feb 2017)</th>
<th align="center">Reference Count (Nov 2017)</th>
</tr>
</thead>
<tbody><tr>
<td>Makefile</td>
<td align="center"><a href="">Makefile</a></td>
<td align="center">199</td>
<td align="center">181</td>
</tr>
<tr>
<td>dep</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/golang/dep">dep</a></td>
<td align="center">N/A</td>
<td align="center">94</td>
</tr>
<tr>
<td>godep</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/tools/godep">godep</a></td>
<td align="center">119</td>
<td align="center">90</td>
</tr>
<tr>
<td>govendor</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/kardianos/govendor">govendor</a></td>
<td align="center">65</td>
<td align="center">84</td>
</tr>
<tr>
<td>glide</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/Masterminds/glide">glide</a></td>
<td align="center">64</td>
<td align="center">77</td>
</tr>
<tr>
<td>gvt</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/FiloSottile/gvt">gvt</a></td>
<td align="center">25</td>
<td align="center">16</td>
</tr>
<tr>
<td>trash</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/rancher/trash">trash</a></td>
<td align="center">7</td>
<td align="center">13</td>
</tr>
<tr>
<td>submodule</td>
<td align="center"><a href="">submodule</a></td>
<td align="center">8</td>
<td align="center">6</td>
</tr>
<tr>
<td>gpm/johnny-deps</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/pote/gpm">gpm</a> <a target="_blank" rel="noopener" href="https://github.com/VividCortex/johnny-deps">johnny-deps</a></td>
<td align="center">7</td>
<td align="center">6</td>
</tr>
<tr>
<td>glock</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/robfig/glock">glock</a></td>
<td align="center">5</td>
<td align="center">4</td>
</tr>
<tr>
<td>gom</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/mattn/gom">gom</a></td>
<td align="center">4</td>
<td align="center">2</td>
</tr>
<tr>
<td>gopack</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/d2fn/gopack">gopack</a></td>
<td align="center">3</td>
<td align="center">2</td>
</tr>
<tr>
<td>gopm</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/gpmgo/gopm">gopm</a></td>
<td align="center">3</td>
<td align="center">1</td>
</tr>
<tr>
<td>goop</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/nitrous-io/goop">goop</a></td>
<td align="center">1</td>
<td align="center">1</td>
</tr>
<tr>
<td>gvend</td>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/govend/govend">gvend</a></td>
<td align="center">2</td>
<td align="center">0</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/dep">dep</a> had a first release in May 2017, did not exist for first stats.</p>
<p>Technically, <code>make</code> is not a package management tool, here it is just for comparison.</p>
<p>Submodule refers to a set of tools which use <a target="_blank" rel="noopener" href="https://git-scm.com/docs/git-submodule">git submodule</a> to manage dependencies such as <a target="_blank" rel="noopener" href="https://github.com/kovetskiy/manul">manul</a> and <a target="_blank" rel="noopener" href="https://github.com/dpw/vendetta">Vendetta</a> and so on.</p>
<h2 id="Algorithm-1"><a href="#Algorithm-1" class="headerlink" title="Algorithm"></a>Algorithm</h2><ul>
<li>Clone top 1000 Go repositories to local disk</li>
<li>Analyze the repositories by identity files:</li>
</ul>
<table>
<thead>
<tr>
<th>Tool Name</th>
<th align="center">Identity Files</th>
</tr>
</thead>
<tbody><tr>
<td>godep</td>
<td align="center">Godeps/Godeps.json</td>
</tr>
<tr>
<td>govendor</td>
<td align="center">vendor/vendor.json</td>
</tr>
<tr>
<td>gopm</td>
<td align="center">.gopmfile</td>
</tr>
<tr>
<td>gvt</td>
<td align="center">vendor/manifest</td>
</tr>
<tr>
<td>gvend</td>
<td align="center">vendor.yml</td>
</tr>
<tr>
<td>glide</td>
<td align="center">glide.yaml or glide.lock</td>
</tr>
<tr>
<td>trash</td>
<td align="center">vendor.conf</td>
</tr>
<tr>
<td>gom</td>
<td align="center">Gomfile</td>
</tr>
<tr>
<td>bunch</td>
<td align="center">bunchfile</td>
</tr>
<tr>
<td>goop</td>
<td align="center">Goopfile</td>
</tr>
<tr>
<td>goat</td>
<td align="center">.go.yaml</td>
</tr>
<tr>
<td>glock</td>
<td align="center">GLOCKFILE</td>
</tr>
<tr>
<td>gobs</td>
<td align="center">goproject.json</td>
</tr>
<tr>
<td>gopack</td>
<td align="center">gopack.config</td>
</tr>
<tr>
<td>nut</td>
<td align="center">Nut.toml</td>
</tr>
<tr>
<td>gpm/johnny-deps</td>
<td align="center">Godeps</td>
</tr>
<tr>
<td>Makefile</td>
<td align="center">makefile or Makefile</td>
</tr>
<tr>
<td>submodule</td>
<td align="center">.gitmodules</td>
</tr>
</tbody></table>
<h2 id="How-1"><a href="#How-1" class="headerlink" title="How"></a>How</h2><ul>
<li>Make sure <a target="_blank" rel="noopener" href="https://git-scm.com/">Git</a>/<a target="_blank" rel="noopener" href="http://www.groovy-lang.org/download.html">Groovy 2.4+</a>/<a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">JDK 1.7+</a> are installed.</li>
<li>Run <code>groovy GithubTopRankCrawler.groovy -l go -d &lt;path to store the 1000 repos&gt;</code> to clone all repositories locally. You can use <code>-s</code> to do the shallow clone and decrease disk usage.</li>
<li>Run <code>groovy GoBuildToolScanner.groovy &lt;path to store the 1000 repos&gt;</code> to analyze these repos.</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-10-30T15:02:55.000Z" title="10/30/2018, 3:02:55 PM">2018-10-30</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">3 分钟读完 (大约516个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/10/30/Java%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/">Java学习资料</a></h1><div class="content"><blockquote>
<p>前几天突然有个姑娘加我的QQ（不知道哪儿来的我的QQ），让我参加他们免费的公开课，然后给我分享Java学习资料，我以为是会给我发几本书，就参加了，没想到是一个txt文件😂，内容如下：</p>
</blockquote>
<p>Allen-架构师必备技能-分库分表应对数据量过大<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1OF4RUHvRk98pBRdUiifH2g">https://pan.baidu.com/s/1OF4RUHvRk98pBRdUiifH2g</a> 密码：n4ev</p>
<p>Allen-互联网安全话题-使用https保障你的敏感数据不再裸奔<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1qz23y-3ahaGua4YH02KTyw">https://pan.baidu.com/s/1qz23y-3ahaGua4YH02KTyw</a> 密码：fgh0</p>
<p>Tony-多线程Future模式-写出支撑海量并发连接的服务端代码<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1NwzNRxUB0_DPNQo2IW_Xhg">https://pan.baidu.com/s/1NwzNRxUB0_DPNQo2IW_Xhg</a> 密码：0fpw</p>
<p>Tony-前后端分离架构分析与实现<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1b7XnTibtqW26YCHfuAXkyA">https://pan.baidu.com/s/1b7XnTibtqW26YCHfuAXkyA</a> 密码：ah24</p>
<p>Tony-高并发系统架构之负载均衡全方位解析<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1a87EH1Xe20O4XYZaNRo-hw">https://pan.baidu.com/s/1a87EH1Xe20O4XYZaNRo-hw</a> 密码：p52e</p>
<p>Tony-学会举一反三-从Redis看RPC原理<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1disSAbJo-01ESCu6_rTHYQ">https://pan.baidu.com/s/1disSAbJo-01ESCu6_rTHYQ</a> 密码：ih47</p>
<p>-Mike-分布式系统架构技能—zookeeper实现分布式锁<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1adhFuoUsz1sMQTnWNGoKPA">https://pan.baidu.com/s/1adhFuoUsz1sMQTnWNGoKPA</a> 密码：gjzh</p>
<p>Tony-数据库连接池原理源码分析<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1uBiBBt-tJVSz_5t5p4jG3A">https://pan.baidu.com/s/1uBiBBt-tJVSz_5t5p4jG3A</a> 密码：jqo6</p>
<p>Allen-深入SpringMVC原理老司机带你手写自己的MVC框架<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1rlhZCSqXaZpXWM_V5CA7EQ">https://pan.baidu.com/s/1rlhZCSqXaZpXWM_V5CA7EQ</a> 密码：vysj</p>
<p>Tony-JVM类加载机制之JAVA热部署实战开发<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1JSLGrG0k44um7weQcq5rvg">https://pan.baidu.com/s/1JSLGrG0k44um7weQcq5rvg</a> 密码：twn3</p>
<p>Tony-实战高并发系统缓存雪崩场景重现及解决方案<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1i8Q7sPNEcUIPYBuqFerRwQ">https://pan.baidu.com/s/1i8Q7sPNEcUIPYBuqFerRwQ</a> 密码：lwgj</p>
<p>Mike-解密spring-boot-starter<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/12-1N3RTb68l3QfUOxSG1jQ">https://pan.baidu.com/s/12-1N3RTb68l3QfUOxSG1jQ</a> 密码：sodb</p>
<p>Tony-细说springcloud微服务架构之客户端负载均衡<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1VK3mMTkKYzRU4G9YXwlOLg">https://pan.baidu.com/s/1VK3mMTkKYzRU4G9YXwlOLg</a> 密码：achq</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-09-06T19:43:52.000Z" title="9/6/2018, 7:43:52 PM">2018-09-06</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约328个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/09/06/JavaCV%E5%88%86%E4%BA%AB/">JavaCV分享</a></h1><div class="content"><h2 id="JavaCV是什么"><a href="#JavaCV是什么" class="headerlink" title="JavaCV是什么"></a>JavaCV是什么</h2><blockquote>
<p>JavaCV 是一款开源的视觉处理库，基于GPLv2协议，对各种常用计算机视觉库封装后的一组jar包，封装了OpenCV、ffmpeg、videoInput…等计算机视觉编程人员常用库的接口。</p>
</blockquote>
<p><img src="http://file.mspring.org/images/blog/88730fba3d24588aa3747c56c3fa40a9"></p>
<h2 id="maven引用"><a href="#maven引用" class="headerlink" title="maven引用"></a>maven引用</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javacpp.version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">javacpp.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 这里要根据自己的平台选择不同的依赖 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;javacpp.platform.dependencies&gt;linux-x86_64&lt;/javacpp.platform.dependencies&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javacpp.platform.dependencies</span>&gt;</span>macosx-x86_64<span class="tag">&lt;/<span class="name">javacpp.platform.dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javacv<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>*<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opencv<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ffmpeg<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ffmpeg<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>$&#123;javacpp.platform.dependencies&#125;<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="提取视频中的图片"><a href="#提取视频中的图片" class="headerlink" title="提取视频中的图片"></a>提取视频中的图片</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从视频中将每一帧的图片提取出来</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> video</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> FrameGrabber.Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">grab</span><span class="params">(File video)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> (FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(video.getPath())) &#123;</span><br><span class="line">        grabber.start();</span><br><span class="line"></span><br><span class="line">        List&lt;BufferedImage&gt; images = Lists.newArrayList();</span><br><span class="line">        Frame frame;</span><br><span class="line">        <span class="keyword">while</span> ((frame = grabber.grabImage()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            images.add(Java2DFrameUtils.toBufferedImage(frame));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> images;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="图片合成视频"><a href="#图片合成视频" class="headerlink" title="图片合成视频"></a>图片合成视频</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoRecorder</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> FFmpegFrameRecorder recorder;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VideoRecorder</span><span class="params">(String output, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> <span class="keyword">throws</span> FrameRecorder.Exception </span>&#123;</span><br><span class="line">            recorder = <span class="keyword">new</span> FFmpegFrameRecorder(output, width, height);</span><br><span class="line">            recorder.setVideoCodec(avcodec.AV_CODEC_ID_H264);</span><br><span class="line">            recorder.setFormat(<span class="string">&quot;mp4&quot;</span>);</span><br><span class="line">            recorder.setFrameRate(FPS);</span><br><span class="line">            recorder.setAudioBitrate(<span class="number">192000</span>);</span><br><span class="line">            recorder.setSampleRate(<span class="number">44100</span>);</span><br><span class="line">            recorder.setAudioChannels(<span class="number">2</span>);</span><br><span class="line">            recorder.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFrame</span><span class="params">(BufferedImage image)</span> <span class="keyword">throws</span> FrameRecorder.Exception </span>&#123;</span><br><span class="line">            Frame frame = Java2DFrameUtils.toFrame(image);</span><br><span class="line">            recorder.record(frame, avutil.AV_PIX_FMT_ARGB);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAudio</span><span class="params">(File audioFile)</span> <span class="keyword">throws</span> FrameGrabber.Exception, FrameRecorder.Exception </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (audioFile == <span class="keyword">null</span> || !audioFile.exists()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> (FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(audioFile)) &#123;</span><br><span class="line">                grabber.start();</span><br><span class="line">                Frame frame;</span><br><span class="line">                <span class="keyword">while</span> ((frame = grabber.grabSamples()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    recorder.recordSamples(frame.sampleRate, frame.audioChannels, frame.samples);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            recorder.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-09-06T14:44:05.000Z" title="9/6/2018, 2:44:05 PM">2018-09-06</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">11 分钟读完 (大约1642个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/09/06/Java%E5%9B%BE%E7%89%87%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7%E7%B1%BB/">Java图片处理工具类</a></h1><div class="content"><blockquote>
<p>这段代码是我四年前写的，当时的使用场景为使用tesseract做图片的预处理。功能包含图片二值化、移除杂色、横向切分、水平切分等。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.awt.Color;</span><br><span class="line"><span class="keyword">import</span> java.awt.Image;</span><br><span class="line"><span class="keyword">import</span> java.awt.Toolkit;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.ColorModel;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.MemoryImageSource;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.PixelGrabber;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2014-05-29 14:34:13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitItem</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> x;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> w;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> y;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> h;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getX</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setX</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.x = x;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getW</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> w;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setW</span><span class="params">(<span class="keyword">int</span> w)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.w = w;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getY</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> y;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setY</span><span class="params">(<span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.y = y;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> h;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setH</span><span class="params">(<span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.h = h;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片纵向切分（切分为列）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> minWidth 每个汉字的最小宽度，如果汉字的最小宽度小于该参数，那么认为系统将一个汉字截断了</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">splitLengthwaysWithMinWidth</span><span class="params">(BufferedImage image, <span class="keyword">int</span> minWidth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (minWidth &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            minWidth = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;BufferedImage&gt; subImgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> width = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span> startX = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> endX = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> start = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> end = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> blank = isXBlank(image, x);</span><br><span class="line">            <span class="keyword">if</span> (!start) &#123; <span class="comment">//如果是白色</span></span><br><span class="line">                <span class="keyword">int</span> space = spaceX(image, x);</span><br><span class="line">                x = x + space;</span><br><span class="line">                startX = x;</span><br><span class="line">                endX = x;</span><br><span class="line">                start = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (start &amp;&amp; !blank) &#123;</span><br><span class="line">                endX = x;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> wordLength = endX - startX;</span><br><span class="line">            <span class="keyword">if</span> (start &amp;&amp; blank &amp;&amp; wordLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 汉字长度小于设定长度，那么认为这不是一个完成的汉字，而是将左右结构的汉字切分成了两份</span></span><br><span class="line">                <span class="keyword">if</span> (wordLength &lt; minWidth) &#123;</span><br><span class="line">                    <span class="keyword">int</span> space = spaceX(image, x);</span><br><span class="line">                    x = x + space;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    end = <span class="keyword">true</span>;</span><br><span class="line">                    endX = x;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (start &amp;&amp; end &amp;&amp; wordLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                BufferedImage subImage = image.getSubimage(startX, <span class="number">0</span>, (endX - startX), height);</span><br><span class="line">                subImgs.add(subImage);</span><br><span class="line">                start = <span class="keyword">false</span>;</span><br><span class="line">                end = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> subImgs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * x轴上的所有点是空白的（白色的）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isXBlank</span><span class="params">(BufferedImage image, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; height; y++) &#123;</span><br><span class="line">            <span class="keyword">int</span> rgb = image.getRGB(x, y);</span><br><span class="line">            <span class="keyword">if</span> (isBlack(rgb)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片纵向切分（切分为列）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> minGap 文字之间的最小间隙，如果间隙文字之间的间隙小于或等于该参数，那么认为该间隙为一个汉字上的正常间隙。主要处理左右结构的一些汉字，例如：”北、川、外...“</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">splitLengthways</span><span class="params">(BufferedImage image, <span class="keyword">int</span> minGap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (minGap &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            minGap = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;BufferedImage&gt; subImgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> width = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        List&lt;Integer&gt; weightlist = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; height; ++y) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (minGap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> space = spaceX(image, x);</span><br><span class="line">                <span class="keyword">if</span> (space &lt;= minGap) &#123;</span><br><span class="line">                    count = count + space;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            weightlist.add(count);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;SplitItem&gt; splitItems = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; weightlist.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; weightlist.size() &amp;&amp; weightlist.get(i) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                length++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> x = i - length;</span><br><span class="line">                <span class="keyword">int</span> w = length;</span><br><span class="line">                <span class="keyword">int</span> y = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> h = height;</span><br><span class="line">                SplitItem item = <span class="keyword">new</span> SplitItem();</span><br><span class="line">                item.setX(x);</span><br><span class="line">                item.setW(w);</span><br><span class="line">                item.setY(y);</span><br><span class="line">                item.setH(h);</span><br><span class="line">                splitItems.add(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (SplitItem splitItem : splitItems) &#123;</span><br><span class="line">            subImgs.add(image.getSubimage(splitItem.getX(), splitItem.getY(), splitItem.getW(), splitItem.getH()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> subImgs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * X轴上两个字之间的间距</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentX 当前索引所在的x坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">spaceX</span><span class="params">(BufferedImage image, <span class="keyword">int</span> currentX)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> w = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> h = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span> spaceLength = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = currentX; x &lt; w; x++) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> space = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; h; y++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123; <span class="comment">//有黑色的，表明非空白</span></span><br><span class="line">                    space = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (space) &#123;</span><br><span class="line">                spaceLength++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> spaceLength;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> spaceLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * y轴上两个字之间的间距</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentY 当前索引所在的y坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">spaceY</span><span class="params">(BufferedImage image, <span class="keyword">int</span> currentY)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> w = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> h = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span> spaceLength = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = currentY; y &lt; h; y++) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> space = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; w; x++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123; <span class="comment">//有黑色的，表明非空白</span></span><br><span class="line">                    space = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (space) &#123;</span><br><span class="line">                spaceLength++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> spaceLength;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> spaceLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片横向切分（切分为行）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> minGap 两行之间的最小间隙,如果间隙小于或等于该参数,那么认为没有折行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">splitCrosswise</span><span class="params">(BufferedImage image, <span class="keyword">int</span> minGap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (minGap &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            minGap = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;BufferedImage&gt; subImgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> w = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> h = image.getHeight();</span><br><span class="line">        List&lt;Integer&gt; heightlist = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; h; y++) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; w; x++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ImageUtils.isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (minGap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> space = spaceY(image, y);</span><br><span class="line">                <span class="keyword">if</span> (space &lt;= minGap) &#123;</span><br><span class="line">                    count = count + space;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            heightlist.add(count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; heightlist.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; heightlist.size() &amp;&amp; heightlist.get(i) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                length++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> y = i - length;</span><br><span class="line">                <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> height = length;</span><br><span class="line">                <span class="keyword">int</span> width = w;</span><br><span class="line">                BufferedImage bufferedImage = image.getSubimage(x, y, width, height);</span><br><span class="line">                subImgs.add(bufferedImage);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> subImgs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片横向切分（切分为行）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">splitCrosswise</span><span class="params">(BufferedImage image)</span> </span>&#123;</span><br><span class="line">        List&lt;BufferedImage&gt; subImgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> w = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> h = image.getHeight();</span><br><span class="line">        List&lt;Integer&gt; heightlist = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; h; y++) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; w; x++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ImageUtils.isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            heightlist.add(count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; heightlist.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; heightlist.size() &amp;&amp; heightlist.get(i) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                length++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> y = i - length;</span><br><span class="line">                <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> height = length;</span><br><span class="line">                <span class="keyword">int</span> width = w;</span><br><span class="line">                BufferedImage bufferedImage = image.getSubimage(x, y, width, height);</span><br><span class="line">                subImgs.add(bufferedImage);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> subImgs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除杂色(图片二值化)</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 默认图片中字体颜色为黑色，如果非黑色像素全部替换为白色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> java.lang.InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BufferedImage <span class="title">removeMotley</span><span class="params">(BufferedImage image)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> width = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span>[] pixels = <span class="keyword">new</span> <span class="keyword">int</span>[width * height];</span><br><span class="line">        <span class="keyword">int</span> grey = <span class="number">100</span>;</span><br><span class="line">        PixelGrabber pixelGrabber = <span class="keyword">new</span> PixelGrabber(image.getSource(), <span class="number">0</span>, <span class="number">0</span>, width, height, pixels, <span class="number">0</span>, width);</span><br><span class="line">        pixelGrabber.grabPixels();</span><br><span class="line">        ColorModel cm = ColorModel.getRGBdefault();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; width * height; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> red, green, blue;</span><br><span class="line">            <span class="keyword">int</span> alpha = cm.getAlpha(pixels[i]);</span><br><span class="line">            <span class="keyword">if</span> (cm.getRed(pixels[i]) &gt; grey) &#123;</span><br><span class="line">                red = <span class="number">255</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                red = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cm.getGreen(pixels[i]) &gt; grey) &#123;</span><br><span class="line">                green = <span class="number">255</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                green = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cm.getBlue(pixels[i]) &gt; grey) &#123;</span><br><span class="line">                blue = <span class="number">255</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                blue = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            pixels[i] = alpha &lt;&lt; <span class="number">24</span> | red &lt;&lt; <span class="number">16</span> | green &lt;&lt; <span class="number">8</span> | blue; <span class="comment">//通过移位重新构成某一点像素的RGB值</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将数组中的象素产生一个图像</span></span><br><span class="line">        Image tempImg = Toolkit.getDefaultToolkit().createImage(<span class="keyword">new</span> MemoryImageSource(width, height, pixels, <span class="number">0</span>, width));</span><br><span class="line">        image = <span class="keyword">new</span> BufferedImage(tempImg.getWidth(<span class="keyword">null</span>), tempImg.getHeight(<span class="keyword">null</span>), BufferedImage.TYPE_INT_BGR);</span><br><span class="line">        image.createGraphics().drawImage(tempImg, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> image;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清除空白部分</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BufferedImage <span class="title">removeSpace</span><span class="params">(BufferedImage image)</span> </span>&#123;</span><br><span class="line">        BufferedImage result = removeTBWhite(image);</span><br><span class="line">        <span class="keyword">return</span> removeLRWhite(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除上下白色部分（top bottom）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BufferedImage <span class="title">removeTBWhite</span><span class="params">(BufferedImage image)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> width = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> end = <span class="number">0</span>;</span><br><span class="line">        Label1:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; height; ++y) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (count &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    start = y;</span><br><span class="line">                    <span class="keyword">break</span> Label1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Label2:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = height - <span class="number">1</span>; y &gt;= <span class="number">0</span>; --y) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (count &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    end = y;</span><br><span class="line">                    <span class="keyword">break</span> Label2;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> image.getSubimage(<span class="number">0</span>, start, width, end - start + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除左右白色部分（left right）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> image</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BufferedImage <span class="title">removeLRWhite</span><span class="params">(BufferedImage image)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> width = image.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> end = <span class="number">0</span>;</span><br><span class="line">        Label1:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; height; ++y) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (count &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    start = x;</span><br><span class="line">                    <span class="keyword">break</span> Label1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Label2:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = width - <span class="number">1</span>; x &gt;= <span class="number">0</span>; --x) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> y = height - <span class="number">1</span>; y &gt;= <span class="number">0</span>; --y) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(image.getRGB(x, y))) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (count &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    end = x;</span><br><span class="line">                    <span class="keyword">break</span> Label2;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> image.getSubimage(start, <span class="number">0</span>, end - start + <span class="number">1</span>, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除黑色部分</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> img</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BufferedImage <span class="title">removeBlack</span><span class="params">(BufferedImage img)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> width = img.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = img.getHeight();</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> end = <span class="number">0</span>;</span><br><span class="line">        Label1:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; height; ++y) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(img.getRGB(x, y))) &#123;</span><br><span class="line">                    start = y;</span><br><span class="line">                    <span class="keyword">break</span> Label1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Label2:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = height - <span class="number">1</span>; y &gt;= <span class="number">0</span>; --y) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBlack(img.getRGB(x, y))) &#123;</span><br><span class="line">                    end = y;</span><br><span class="line">                    <span class="keyword">break</span> Label2;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> img.getSubimage(<span class="number">0</span>, start, width, end - start + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是黑色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> colorInt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isBlack</span><span class="params">(<span class="keyword">int</span> colorInt)</span> </span>&#123;</span><br><span class="line">        Color color = <span class="keyword">new</span> Color(colorInt);</span><br><span class="line">        <span class="keyword">return</span> color.getRed() + color.getGreen() + color.getBlue() &lt;= <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是白色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> colorInt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isWhite</span><span class="params">(<span class="keyword">int</span> colorInt)</span> </span>&#123;</span><br><span class="line">        Color color = <span class="keyword">new</span> Color(colorInt);</span><br><span class="line">        <span class="keyword">return</span> color.getRed() + color.getGreen() + color.getBlue() &gt; <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-08-14T12:56:36.000Z" title="8/14/2018, 12:56:36 PM">2018-08-14</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">6 分钟读完 (大约865个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/14/javacv%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/">javacv使用笔记</a></h1><div class="content"><h2 id="使用过程中遇到的异常"><a href="#使用过程中遇到的异常" class="headerlink" title="使用过程中遇到的异常"></a>使用过程中遇到的异常</h2><h3 id="异常：Could-not-initialize-class-org-bytedeco-javacpp-avutil"><a href="#异常：Could-not-initialize-class-org-bytedeco-javacpp-avutil" class="headerlink" title="异常：Could not initialize class org.bytedeco.javacpp.avutil"></a>异常：Could not initialize class org.bytedeco.javacpp.avutil</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: Could not initialize class org.bytedeco.javacpp.avutil</span><br><span class="line">at java.lang.Class.forName0(Native Method)</span><br><span class="line">at java.lang.Class.forName(Class.java:274)</span><br><span class="line">at org.bytedeco.javacpp.Loader.load(Loader.java:385)</span><br><span class="line">at org.bytedeco.javacpp.Loader.load(Loader.java:353)</span><br><span class="line">at org.bytedeco.javacpp.avformat$AVFormatContext.&lt;clinit&gt;(avformat.java:2249)</span><br><span class="line">at org.bytedeco.javacv.FFmpegFrameGrabber.startUnsafe(FFmpegFrameGrabber.java:346)</span><br><span class="line">at org.bytedeco.javacv.FFmpegFrameGrabber.start(FFmpegFrameGrabber.java:340)</span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package exec:java -Dplatform.dependencies -Dexec.mainClass=Demo</span><br></pre></td></tr></table></figure>

<h3 id="警告：Warning-data-is-not-aligned-This-can-lead-to-a-speedloss"><a href="#警告：Warning-data-is-not-aligned-This-can-lead-to-a-speedloss" class="headerlink" title="警告：Warning: data is not aligned! This can lead to a speedloss"></a>警告：Warning: data is not aligned! This can lead to a speedloss</h3><p>出现这个警告是因为ffmpeg要求视频的宽度必须是32的倍数，高度必须是2的倍数，按要求修改下宽高就好了。</p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.math.NumberUtils;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.javacpp.avcodec;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.javacpp.opencv_core;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.javacpp.opencv_imgcodecs;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.javacv.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018-08-15 16:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenCVUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;BufferedImage&gt; images = grab(<span class="keyword">new</span> File(<span class="string">&quot;/data/opencv/test.mp4&quot;</span>));</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (BufferedImage image : images) &#123;</span><br><span class="line">            ImageIO.write(image, <span class="string">&quot;jpg&quot;</span>, <span class="keyword">new</span> File(<span class="string">&quot;/data/opencv/frame/&quot;</span> + i + <span class="string">&quot;.jpg&quot;</span>));</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// grabAudioFromVideo(new File(&quot;/data/opencv/test.mp4&quot;), new File(&quot;/data/opencv/test.aac&quot;));</span></span><br><span class="line"></span><br><span class="line">        List&lt;File&gt; files = Lists.newArrayList(FileUtils.listFiles(<span class="keyword">new</span> File(<span class="string">&quot;/data/opencv/frame/&quot;</span>), <span class="keyword">new</span> String[]&#123;<span class="string">&quot;jpg&quot;</span>&#125;, <span class="keyword">false</span>));</span><br><span class="line">        Collections.sort(files, (o1, o2) -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> i1 = NumberUtils.toInt(StringUtils.substringBefore(o1.getName(), <span class="string">&quot;.&quot;</span>));</span><br><span class="line">            <span class="keyword">int</span> i2 = NumberUtils.toInt(StringUtils.substringBefore(o2.getName(), <span class="string">&quot;.&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> Integer.compare(i1, i2);</span><br><span class="line">        &#125;);</span><br><span class="line">        record(<span class="string">&quot;/data/opencv/out.mp4&quot;</span>, files, <span class="keyword">new</span> File(<span class="string">&quot;/data/opencv/test.aac&quot;</span>), <span class="number">544</span>, <span class="number">960</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将多个图片文件合成视频</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> output    输出文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> images    序列帧图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> audioFile 音频</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> width     宽</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> height    高</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">(String output, List&lt;File&gt; images, File audioFile, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (FFmpegFrameRecorder recorder = <span class="keyword">new</span> FFmpegFrameRecorder(output, width, height);</span><br><span class="line">             FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(audioFile)) &#123;</span><br><span class="line">            recorder.setVideoCodec(avcodec.AV_CODEC_ID_H264);</span><br><span class="line">            recorder.setFormat(<span class="string">&quot;mp4&quot;</span>);</span><br><span class="line">            recorder.setFrameRate(<span class="number">30</span>);</span><br><span class="line">            recorder.setAudioBitrate(<span class="number">192000</span>);</span><br><span class="line">            recorder.setAudioQuality(<span class="number">0</span>);</span><br><span class="line">            recorder.setSampleRate(<span class="number">44100</span>);</span><br><span class="line">            recorder.setAudioChannels(<span class="number">2</span>);</span><br><span class="line">            recorder.start();</span><br><span class="line"></span><br><span class="line">            OpenCVFrameConverter.ToIplImage converter = <span class="keyword">new</span> OpenCVFrameConverter.ToIplImage();</span><br><span class="line">            <span class="keyword">for</span> (File file : images) &#123;</span><br><span class="line">                opencv_core.IplImage image = opencv_imgcodecs.cvLoadImage(file.getPath());</span><br><span class="line">                recorder.record(converter.convert(image));</span><br><span class="line">                opencv_core.cvReleaseImage(image);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            grabber.start();</span><br><span class="line">            Frame frame;</span><br><span class="line">            <span class="keyword">while</span> ((frame = grabber.grabSamples()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                recorder.setTimestamp(frame.timestamp);</span><br><span class="line">                recorder.recordSamples(frame.sampleRate, frame.audioChannels, frame.samples);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从视频中将每一帧的图片提取出来</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> video</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> FrameGrabber.Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BufferedImage&gt; <span class="title">grab</span><span class="params">(File video)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(video.getPath())) &#123;</span><br><span class="line">            grabber.start();</span><br><span class="line"></span><br><span class="line">            List&lt;BufferedImage&gt; images = Lists.newArrayList();</span><br><span class="line">            Frame frame;</span><br><span class="line">            <span class="keyword">while</span> ((frame = grabber.grabImage()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                images.add(Java2DFrameUtils.toBufferedImage(frame));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> images;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从视频中提取出音频</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> video</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputAudio</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">grabAudioFromVideo</span><span class="params">(File video, File outputAudio)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(video);</span><br><span class="line">             FFmpegFrameRecorder recorder = <span class="keyword">new</span> FFmpegFrameRecorder(outputAudio, <span class="number">1</span>)) &#123;</span><br><span class="line">            grabber.start();</span><br><span class="line">            recorder.setAudioCodec(avcodec.AV_CODEC_ID_AAC);</span><br><span class="line">            recorder.start();</span><br><span class="line"></span><br><span class="line">            Frame frame;</span><br><span class="line">            <span class="keyword">while</span> ((frame = grabber.grab()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (frame.audioChannels == <span class="number">1</span>) &#123;</span><br><span class="line">                    recorder.recordSamples(frame.sampleRate, frame.audioChannels, frame.samples);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="图片合成视频简单的封装"><a href="#图片合成视频简单的封装" class="headerlink" title="图片合成视频简单的封装"></a>图片合成视频简单的封装</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoRecorder</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> FFmpegFrameRecorder recorder;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VideoRecorder</span><span class="params">(String output, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> <span class="keyword">throws</span> FrameRecorder.Exception </span>&#123;</span><br><span class="line">            recorder = <span class="keyword">new</span> FFmpegFrameRecorder(output, width, height);</span><br><span class="line">            recorder.setVideoCodec(avcodec.AV_CODEC_ID_H264);</span><br><span class="line">            recorder.setFormat(<span class="string">&quot;mp4&quot;</span>);</span><br><span class="line">            recorder.setFrameRate(FPS);</span><br><span class="line">            recorder.setAudioBitrate(<span class="number">192000</span>);</span><br><span class="line">            recorder.setAudioQuality(<span class="number">0</span>);</span><br><span class="line">            recorder.setSampleRate(<span class="number">44100</span>);</span><br><span class="line">            recorder.setAudioChannels(<span class="number">2</span>);</span><br><span class="line">            recorder.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFrame</span><span class="params">(BufferedImage image)</span> <span class="keyword">throws</span> FrameRecorder.Exception </span>&#123;</span><br><span class="line">            Frame frame = Java2DFrameUtils.toFrame(image);</span><br><span class="line">            recorder.record(frame, avutil.AV_PIX_FMT_ARGB);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAudio</span><span class="params">(File audioFile)</span> <span class="keyword">throws</span> FrameGrabber.Exception, FrameRecorder.Exception </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (audioFile == <span class="keyword">null</span> || !audioFile.exists()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> (FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(audioFile)) &#123;</span><br><span class="line">                grabber.start();</span><br><span class="line">                Frame frame;</span><br><span class="line">                <span class="keyword">while</span> ((frame = grabber.grabSamples()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    recorder.recordSamples(frame.sampleRate, frame.audioChannels, frame.samples);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            recorder.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="解决maven打包时将不必要的包引入进来的问题"><a href="#解决maven打包时将不必要的包引入进来的问题" class="headerlink" title="解决maven打包时将不必要的包引入进来的问题"></a>解决maven打包时将不必要的包引入进来的问题</h2><p>我在实际使用中只用到了<code>ffmpeg</code>，但是打包的时候却将flycapture、libdc1394、libfreenect、artoolkitplus、tesseract…等包都打进来了，这些都是我不需要的，下面贴出我的maven配置示例。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javacpp.version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">javacpp.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 这里要根据自己的平台选择不同的依赖 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;javacpp.platform.dependencies&gt;linux-x86_64&lt;/javacpp.platform.dependencies&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javacpp.platform.dependencies</span>&gt;</span>macosx-x86_64<span class="tag">&lt;/<span class="name">javacpp.platform.dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javacv<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>*<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opencv<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ffmpeg<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco.javacpp-presets<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ffmpeg<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1-$&#123;javacpp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>$&#123;javacpp.platform.dependencies&#125;<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-08-09T14:47:52.000Z" title="8/9/2018, 2:47:52 PM">2018-08-09</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">4 分钟读完 (大约528个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/09/DelayQueue%E4%BD%BF%E7%94%A8/">DelayQueue使用</a></h1><div class="content"><h2 id="DelayQueue特性"><a href="#DelayQueue特性" class="headerlink" title="DelayQueue特性"></a>DelayQueue特性</h2><ul>
<li>队列中的元素都必须实现Delayed，元素可以指定延迟消费时长。</li>
<li>实现了BlockingQueue接口，所以他是一个阻塞队列。</li>
<li>本质上是基于PriorityQueue实现的。</li>
</ul>
<h2 id="贴一段我在实际生产环境中使用到代码"><a href="#贴一段我在实际生产环境中使用到代码" class="headerlink" title="贴一段我在实际生产环境中使用到代码"></a>贴一段我在实际生产环境中使用到代码</h2><h3 id="队列管理"><a href="#队列管理" class="headerlink" title="队列管理"></a>队列管理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.DelayQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018-07-26 19:53</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayQueueManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(DelayQueueManager.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> ExecutorService executor;</span><br><span class="line">    <span class="keyword">private</span> Thread monitorThread;</span><br><span class="line">    <span class="keyword">private</span> DelayQueue&lt;DelayTask&lt;?&gt;&gt; delayQueue; <span class="comment">// 延时队列</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayQueueManager</span><span class="params">(String name, <span class="keyword">int</span> poolSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.executor = Executors.newFixedThreadPool(poolSize);</span><br><span class="line">        <span class="keyword">this</span>.delayQueue = <span class="keyword">new</span> DelayQueue&lt;&gt;();</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        monitorThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            execute();</span><br><span class="line">        &#125;, <span class="string">&quot;DelayQueueMonitor-&quot;</span> + name);</span><br><span class="line">        monitorThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;当前延时任务数量:&quot;</span> + delayQueue.size());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 从延时队列中获取任务</span></span><br><span class="line">                DelayTask&lt;?&gt; delayTask = delayQueue.take();</span><br><span class="line">                <span class="keyword">if</span> (delayTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Runnable task = delayTask.getTask();</span><br><span class="line">                    <span class="keyword">if</span> (task != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 提交到线程池执行task</span></span><br><span class="line">                        executor.execute(task);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOG.error(<span class="keyword">null</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id   任务编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task 任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 延时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit 时间单位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String id, Runnable task, <span class="keyword">long</span> time, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> timeout = TimeUnit.MILLISECONDS.convert(time, unit);</span><br><span class="line">        <span class="keyword">long</span> delayTimeMillis = System.currentTimeMillis() + timeout;</span><br><span class="line">        delayQueue.put(<span class="keyword">new</span> DelayTask&lt;&gt;(id, delayTimeMillis, task));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id              任务编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task            任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delayTimeMillis 延迟到什么时间点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putAt</span><span class="params">(String id, Runnable task, <span class="keyword">long</span> delayTimeMillis)</span> </span>&#123;</span><br><span class="line">        delayQueue.put(<span class="keyword">new</span> DelayTask&lt;&gt;(id, delayTimeMillis, task));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据任务编号删除任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeTaskById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        DelayTask task = <span class="keyword">new</span> DelayTask(id, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> delayQueue.remove(task);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeTask</span><span class="params">(DelayTask task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delayQueue.remove(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="延迟任务对象"><a href="#延迟任务对象" class="headerlink" title="延迟任务对象"></a>延迟任务对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Delayed;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018-07-26 19:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayTask</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Runnable</span>&gt; <span class="keyword">implements</span> <span class="title">Delayed</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> delayTimeMillis; <span class="comment">// 延迟到什么时间点执行</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T task; <span class="comment">// 任务</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayTask</span><span class="params">(String id, <span class="keyword">long</span> delayTimeMillis, T task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.delayTimeMillis = delayTimeMillis;</span><br><span class="line">        <span class="keyword">this</span>.task = task;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> task;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123;</span><br><span class="line">        DelayTask other = (DelayTask) o;</span><br><span class="line">        <span class="keyword">long</span> diff = delayTimeMillis - other.delayTimeMillis;</span><br><span class="line">        <span class="keyword">if</span> (diff &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (diff &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unit.convert(<span class="keyword">this</span>.delayTimeMillis - System.currentTimeMillis(), TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        DelayTask&lt;?&gt; delayTask = (DelayTask&lt;?&gt;) o;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(id, delayTask.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-05-09T09:49:37.000Z" title="5/9/2018, 9:49:37 AM">2018-05-09</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约82个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/05/09/Guava-Range%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/">Guava Range使用方法</a></h1><div class="content"><table>
<thead>
<tr>
<th><strong>概念</strong></th>
<th><strong>表示范围</strong></th>
<th><strong>guava对应功能方法</strong></th>
</tr>
</thead>
<tbody><tr>
<td>(a..b)</td>
<td>{x &#124; a &lt; x &lt; b}</td>
<td>open(C, C)</td>
</tr>
<tr>
<td>[a..b]</td>
<td>{x &#124; a &lt;= x &lt;= b}</td>
<td>closed(C, C)</td>
</tr>
<tr>
<td>[a..b)</td>
<td>{x &#124; a &lt;= x &lt; b}</td>
<td>closedOpen(C, C)</td>
</tr>
<tr>
<td>(a..b]</td>
<td>{x &#124; a &lt; x &lt;= b}</td>
<td>openClosed(C, C)</td>
</tr>
<tr>
<td>(a..+∞)</td>
<td>{x &#124; x &gt; a}</td>
<td>greaterThan(C)</td>
</tr>
<tr>
<td>[a..+∞)</td>
<td>{x &#124; x &gt;= a}</td>
<td>atLeast(C)</td>
</tr>
<tr>
<td>(-∞..b)</td>
<td>{x &#124; x &lt; b}</td>
<td>lessThan(C)</td>
</tr>
<tr>
<td>(-∞..b]</td>
<td>{x &#124; x &lt;= b}</td>
<td>atMost(C)</td>
</tr>
<tr>
<td>(-∞..+∞)</td>
<td>all values</td>
<td>all()</td>
</tr>
</tbody></table>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-04-10T20:23:49.000Z" title="4/10/2018, 8:23:49 PM">2018-04-10</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">几秒读完 (大约31个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/04/10/%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8E%A8%E9%80%81Jar%E5%8C%85%E5%88%B0nexus/">命令行推送Jar包到nexus</a></h1><div class="content"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn deploy:deploy-file -DgroupId&#x3D;com.tencent -DartifactId&#x3D;xinge -Dversion&#x3D;1.1.8 -Dpackaging&#x3D;jar -DrepositoryId&#x3D;nexus -Dfile&#x3D;&#x2F;Users&#x2F;gaoyoubo&#x2F;xinge-push.jar -Durl&#x3D;http:&#x2F;&#x2F;xxx.xxx.com:8081&#x2F;nexus&#x2F;content&#x2F;repositories&#x2F;thirdparty&#x2F; -DgeneratePom&#x3D;false</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-03-31T13:56:30.000Z" title="3/31/2018, 1:56:30 PM">2018-03-31</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">8 分钟读完 (大约1127个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/31/%E5%B9%B6%E5%8F%91%E9%98%9F%E5%88%97-%E6%97%A0%E7%95%8C%E9%98%BB%E5%A1%9E%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97DelayQueue%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/">并发队列-无界阻塞延迟队列DelayQueue原理探究</a></h1><div class="content"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">转载自：http:&#x2F;&#x2F;ifeve.com&#x2F;%E5%B9%B6%E5%8F%91%E9%98%9F%E5%88%97-%E6%97%A0%E7%95%8C%E9%98%BB%E5%A1%9E%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97delayqueue%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6&#x2F;</span><br><span class="line">最近在开发中正好有类似场景。</span><br></pre></td></tr></table></figure>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>DelayQueue队列中每个元素都有个过期时间，并且队列是个优先级队列，当从队列获取元素时候，只有过期元素才会出队列。</p>
<h2 id="DelayQueue类图结构"><a href="#DelayQueue类图结构" class="headerlink" title="DelayQueue类图结构"></a>DelayQueue类图结构</h2><p><img src="http://file.mspring.org/images/blog/2346ca43fe3c972b6bb4beab5edf1328"></p>
<p>如图DelayQueue中内部使用的是PriorityQueue存放数据，使用ReentrantLock实现线程同步，可知是阻塞队列。另外队列里面的元素要实现Delayed接口，一个是获取当前剩余时间的接口，一个是元素比较的接口，因为这个是有优先级的队列。</p>
<h2 id="offer操作"><a href="#offer操作" class="headerlink" title="offer操作"></a>offer操作</h2><p>插入元素到队列，主要插入元素要实现Delayed接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        q.offer(e);</span><br><span class="line">        <span class="keyword">if</span> (q.peek() == e) &#123;（<span class="number">2</span>）</span><br><span class="line">            leader = <span class="keyword">null</span>;</span><br><span class="line">            available.signal();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先获取独占锁，然后添加元素到优先级队列，由于q是优先级队列，所以添加元素后，peek并不一定是当前添加的元素，如果（2）为true，说明当前元素e的优先级最小也就即将过期的，这时候激活avaliable变量条件队列里面的线程，通知他们队列里面有元素了。</p>
<h2 id="take操作"><a href="#take操作" class="headerlink" title="take操作"></a>take操作</h2><p>获取并移除队列首元素，如果队列没有过期元素则等待。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="comment">//获取但不移除队首元素（1)</span></span><br><span class="line">                E first = q.peek();</span><br><span class="line">                <span class="keyword">if</span> (first == <span class="keyword">null</span>)</span><br><span class="line">                    available.await();<span class="comment">//(2)</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">long</span> delay = first.getDelay(TimeUnit.NANOSECONDS);</span><br><span class="line">                    <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)<span class="comment">//(3)</span></span><br><span class="line">                        <span class="keyword">return</span> q.poll();</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (leader != <span class="keyword">null</span>)<span class="comment">//(4)</span></span><br><span class="line">                        available.await();</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        Thread thisThread = Thread.currentThread();</span><br><span class="line">                        leader = thisThread;<span class="comment">//(5)</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            available.awaitNanos(delay);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (leader == thisThread)</span><br><span class="line">                                leader = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (leader == <span class="keyword">null</span> &amp;&amp; q.peek() != <span class="keyword">null</span>)<span class="comment">//(6)</span></span><br><span class="line">                available.signal();</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>第一次调用take时候由于队列空，所以调用（2）把当前线程放入available的条件队列等待，当执行offer并且添加的元素就是队首元素时候就会通知最先等待的线程激活，循环重新获取队首元素，这时候first假如不空，则调用getdelay方法看该元素海剩下多少时间就过期了，如果delay&lt;=0则说明已经过期，则直接出队返回。否者看leader是否为null，不为null则说明是其他线程也在执行take则把该线程放入条件队列，否者是当前线程执行的take方法，则调用(5)await直到剩余过期时间到（这期间该线程会释放锁，所以其他线程可以offer添加元素，也可以take阻塞自己），剩余过期时间到后，该线程会重新竞争得到锁，重新进入循环。</p>
<p>（6）说明当前take返回了元素，如果当前队列还有元素则调用singal激活条件队列里面可能有的等待线程。leader那么为null，那么是第一次调用take获取过期元素的线程，第一次调用的线程调用设置等待时间的await方法等待数据过期，后面调用take的线程则调用await直到signal。</p>
<h2 id="poll操作"><a href="#poll操作" class="headerlink" title="poll操作"></a>poll操作</h2><p>获取并移除队头过期元素，否者返回null</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        E first = q.peek();</span><br><span class="line">        <span class="comment">//如果队列为空，或者不为空但是队头元素没有过期则返回null</span></span><br><span class="line">        <span class="keyword">if</span> (first == <span class="keyword">null</span> || first.getDelay(TimeUnit.NANOSECONDS) &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> q.poll();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DelayedEle</span> <span class="keyword">implements</span> <span class="title">Delayed</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> delayTime; <span class="comment">//延迟时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> expire;  <span class="comment">//到期时间</span></span><br><span class="line">    <span class="keyword">private</span> String data;   <span class="comment">//数据</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayedEle</span><span class="params">(<span class="keyword">long</span> delay, String data)</span> </span>&#123;</span><br><span class="line">        delayTime = delay;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        expire = System.currentTimeMillis() + delay; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 剩余时间=到期时间-当前时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unit.convert(<span class="keyword">this</span>.expire - System.currentTimeMillis() , TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 优先队列里面优先级规则</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (<span class="keyword">this</span>.getDelay(TimeUnit.MILLISECONDS) -o.getDelay(TimeUnit.MILLISECONDS));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;DelayedElement&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;delay=&quot;</span>).append(delayTime);</span><br><span class="line">        sb.append(<span class="string">&quot;, expire=&quot;</span>).append(expire);</span><br><span class="line">        sb.append(<span class="string">&quot;, data=&#x27;&quot;</span>).append(data).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    DelayQueue&lt;DelayedEle&gt; delayQueue = <span class="keyword">new</span> DelayQueue&lt;DelayedEle&gt;();</span><br><span class="line"></span><br><span class="line">    DelayedEle element1 = <span class="keyword">new</span> DelayedEle(<span class="number">1000</span>,<span class="string">&quot;zlx&quot;</span>);</span><br><span class="line">    DelayedEle element2 = <span class="keyword">new</span> DelayedEle(<span class="number">1000</span>,<span class="string">&quot;gh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    delayQueue.offer(element1);</span><br><span class="line">    delayQueue.offer(element2);</span><br><span class="line"></span><br><span class="line">    element1 =  delayQueue.take();</span><br><span class="line">    System.out.println(element1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>TimerQueue的内部实现<br>ScheduledThreadPoolExecutor中DelayedWorkQueue是对其的优化使用</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-03-09T15:49:01.000Z" title="3/9/2018, 3:49:01 PM">2018-03-09</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约127个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/09/Java%E5%9B%9B%E8%88%8D%E4%BA%94%E5%85%A5/">Java四舍五入</a></h1><div class="content"><p>之前写的，总结成代码片段，留备后用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2014-08-28 13:55:12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NumberUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 四舍五入取整数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">roundHalfUp</span><span class="params">(<span class="keyword">float</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(n).setScale(<span class="number">0</span>, BigDecimal.ROUND_HALF_UP).intValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 四舍五入</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n         数字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> precision 精度(保留几位小数)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">roundHalfUp</span><span class="params">(<span class="keyword">float</span> n, <span class="keyword">int</span> precision)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(n).setScale(precision, BigDecimal.ROUND_HALF_UP).floatValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4.11 -&gt; 4.2</span></span><br><span class="line"><span class="comment">     * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">     * 4.19 -&gt; 4.2</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n         数字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> precision 精度(保留几位小数)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">roundUp</span><span class="params">(<span class="keyword">float</span> n, <span class="keyword">int</span> precision)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(n).setScale(precision, BigDecimal.ROUND_UP).floatValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-12-28T14:32:00.000Z" title="12/28/2017, 2:32:00 PM">2017-12-28</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"> 雾非雾的情思 </span><span class="level-item">9 分钟读完 (大约1410个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/12/28/%E6%94%AF%E6%8C%81%E7%94%9F%E4%BA%A7%E9%98%BB%E5%A1%9E%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0/">支持生产阻塞的线程池</a></h1><div class="content"><p>在各种并发编程模型中，生产者-消费者模式大概是最常用的了。在实际工作中，对于生产消费的速度，通常需要做一下权衡。通常来说，生产任务的速度要大于消费的速度。一个细节问题是，队列长度，以及如何匹配生产和消费的速度。<br>一个典型的生产者-消费者模型如下：<br><img src="http://file.mspring.org/images/blog/d38e11ca783ad58ef6754f3ac77e6178.png" alt="producer-consumer"></p>
<p>在并发环境下利用J.U.C提供的Queue实现可以很方便地保证生产和消费过程中的线程安全。这里需要注意的是，Queue必须设置初始容量，防止生产者生产过快导致队列长度暴涨，最终触发OutOfMemory。</p>
<p>对于一般的生产快于消费的情况。当队列已满时，我们并不希望有任何任务被忽略或得不到执行，此时生产者可以等待片刻再提交任务，更好的做法是，把生产者阻塞在提交任务的方法上，待队列未满时继续提交任务，这样就没有浪费的空转时间了。阻塞这一点也很容易，BlockingQueue就是为此打造的，ArrayBlockingQueue和LinkedBlockingQueue在构造时都可以提供容量做限制，其中LinkedBlockingQueue是在实际操作队列时在每次拿到锁以后判断容量。</p>
<p>更进一步，当队列为空时，消费者拿不到任务，可以等一会儿再拿，更好的做法是，用BlockingQueue的take方法，阻塞等待，当有任务时便可以立即获得执行，建议调用take的带超时参数的重载方法，超时后线程退出。这样当生产者事实上已经停止生产时，不至于让消费者无限等待。</p>
<p>于是一个高效的支持阻塞的生产消费模型就实现了。</p>
<p>等一下，既然J.U.C已经帮我们实现了线程池，为什么还要采用这一套东西？直接用ExecutorService不是更方便？</p>
<p>我们来看一下ThreadPoolExecutor的基本结构：<br><img src="http://file.mspring.org/images/blog/5385fed13a96419e1f370f7cdb1dfa69.png" alt="ThreadPoolExecutor"></p>
<p>可以看到，在ThreadPoolExecutor中，BlockingQueue和Consumer部分已经帮我们实现好了，并且直接采用线程池的实现还有很多优势，例如线程数的动态调整等。</p>
<p>但问题在于，即便你在构造ThreadPoolExecutor时手动指定了一个BlockingQueue作为队列实现，事实上当队列满时，execute方法并不会阻塞，原因在于ThreadPoolExecutor调用的是BlockingQueue非阻塞的offer方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">if</span> (poolSize &amp;amp;gt;= corePoolSize || !addIfUnderCorePoolSize(command)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (runState == RUNNING &amp;amp;amp;&amp;amp;amp; workQueue.offer(command)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (runState != RUNNING || poolSize == <span class="number">0</span>)</span><br><span class="line">                ensureQueuedTaskHandled(command);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!addIfUnderMaximumPoolSize(command))</span><br><span class="line">            reject(command); <span class="comment">// is shutdown or saturated</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时候就需要做一些事情来达成一个结果：当生产者提交任务，而队列已满时，能够让生产者阻塞住，等待任务被消费。</p>
<p>关键在于，在并发环境下，队列满不能由生产者去判断，不能调用ThreadPoolExecutor.getQueue().size()来判断队列是否满。</p>
<p>线程池的实现中，当队列满时会调用构造时传入的RejectedExecutionHandler去拒绝任务的处理。默认的实现是AbortPolicy，直接抛出一个RejectedExecutionException。</p>
<p>几种拒绝策略在这里就不赘述了，这里和我们的需求比较接近的是CallerRunsPolicy，这种策略会在队列满时，让提交任务的线程去执行任务，相当于让生产者临时去干了消费者干的活儿，这样生产者虽然没有被阻塞，但提交任务也会被暂停。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CallerRunsPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a &amp;amp;lt;tt&amp;amp;gt;CallerRunsPolicy&amp;amp;lt;/tt&amp;amp;gt;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CallerRunsPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Executes task r in the caller&#x27;s thread, unless the executor</span></span><br><span class="line"><span class="comment">     * has been shut down, in which case the task is discarded.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">            r.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但这种策略也有隐患，当生产者较少时，生产者消费任务的时间里，消费者可能已经把任务都消费完了，队列处于空状态，当生产者执行完任务后才能再继续生产任务，这个过程中可能导致消费者线程的饥饿。</p>
<p>参考类似的思路，最简单的做法，我们可以直接定义一个RejectedExecutionHandler，当队列满时改为调用BlockingQueue.put来实现生产者的阻塞：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> RejectedExecutionHandler() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor executor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!executor.isShutdown()) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				executor.getQueue().put(r);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				<span class="comment">// should not be interrupted</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这样，我们就无需再关心Queue和Consumer的逻辑，只要把精力集中在生产者和消费者线程的实现逻辑上，只管往线程池提交任务就行了。</p>
<p>相比最初的设计，这种方式的代码量能减少不少，而且能避免并发环境的很多问题。当然，你也可以采用另外的手段，例如在提交时采用信号量做入口限制等，但是如果仅仅是要让生产者阻塞，那就显得复杂了。</p>
<p>转载自：<a target="_blank" rel="noopener" href="http://ifeve.com/blocking-threadpool-executor/">http://ifeve.com/blocking-threadpool-executor/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-07-07T00:00:00.000Z" title="7/7/2017, 12:00:00 AM">2017-07-07</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"> 雾非雾的情思 </span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">2 分钟读完 (大约327个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/07/07/Java%E5%88%86%E9%9A%94%E3%80%81%E5%90%88%E5%B9%B6%E5%A4%A7%E6%96%87%E4%BB%B6/">Java分隔、合并大文件</a></h1><div class="content"><p>今天网百度网盘上上传文件提示单个文件大小超限，让我升级VIP。作为一个有逼格的程序猿怎么可能被这点小事难倒呢。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">import com.google.common.collect.Lists;</span><br><span class="line">import org.apache.commons.io.FilenameUtils;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.RandomAccessFile;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Gao Youbo</span><br><span class="line"> * @since 2017-07-07 18:18</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class Files &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        int num &#x3D; 10;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 分割</span><br><span class="line">        cut(new File(&quot;&#x2F;Users&#x2F;gaoyoubo&#x2F;360sync&#x2F;数据迁移&#x2F;document&#x2F;a.zip&quot;), num);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 合并</span><br><span class="line">        List&lt;File&gt; files &#x3D; Lists.newArrayList();</span><br><span class="line">        for (int i &#x3D; 0; i &lt; num; i++) &#123;</span><br><span class="line">            files.add(new File(&quot;&#x2F;Users&#x2F;gaoyoubo&#x2F;360sync&#x2F;数据迁移&#x2F;document&#x2F;a-&quot; + i + &quot;.zip&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        File outFile &#x3D; new File(&quot;&#x2F;Users&#x2F;gaoyoubo&#x2F;360sync&#x2F;数据迁移&#x2F;document&#x2F;b.zip&quot;);</span><br><span class="line">        merge(files, outFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 分文件</span><br><span class="line">     *</span><br><span class="line">     * @param sourceFile</span><br><span class="line">     * @param num        分隔文件数量</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void cut(File sourceFile, int num) &#123;</span><br><span class="line">        long signMaxSize &#x3D; sourceFile.length() &#x2F; num + 1; &#x2F;&#x2F; 单个文件最大长度</span><br><span class="line">        try (RandomAccessFile source &#x3D; new RandomAccessFile(sourceFile, &quot;r&quot;)) &#123;</span><br><span class="line">            byte[] bytes &#x3D; new byte[1024];</span><br><span class="line">            int len;</span><br><span class="line">            for (int i &#x3D; 0; i &lt; num; i++) &#123;</span><br><span class="line">                File targetFile &#x3D; new File(sourceFile.getParent(),</span><br><span class="line">                        FilenameUtils.getBaseName(sourceFile.getName()) + &quot;-&quot; + i + &quot;.&quot; + FilenameUtils.getExtension(sourceFile.getName()));</span><br><span class="line">                try (RandomAccessFile target &#x3D; new RandomAccessFile(targetFile, &quot;rw&quot;)) &#123;</span><br><span class="line">                    while ((len &#x3D; source.read(bytes)) !&#x3D; -1) &#123;&#x2F;&#x2F;读到文件末尾时，len返回-1，结束循环</span><br><span class="line">                        target.write(bytes, 0, len);</span><br><span class="line">                        if (target.length() &gt; signMaxSize) &#123;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 合并文件</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void merge(List&lt;File&gt; files, File outFile) &#123;</span><br><span class="line">        try (RandomAccessFile out &#x3D; new RandomAccessFile(outFile, &quot;rw&quot;)) &#123;</span><br><span class="line">            for (File file : files) &#123;</span><br><span class="line">                try (RandomAccessFile src &#x3D; new RandomAccessFile(file, &quot;r&quot;)) &#123;</span><br><span class="line">                    byte[] bytes &#x3D; new byte[1024];&#x2F;&#x2F;每次读取字节数</span><br><span class="line">                    int len;</span><br><span class="line">                    while ((len &#x3D; src.read(bytes)) !&#x3D; -1) &#123;</span><br><span class="line">                        out.write(bytes, 0, len);&#x2F;&#x2F;循环赋值</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-03-13T23:03:11.000Z" title="3/13/2015, 11:03:11 PM">2015-03-13</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">4 分钟读完 (大约538个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/03/13/%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%8BJAVA%E8%BF%9B%E7%A8%8B%E9%AB%98CPU%E5%8D%A0%E7%94%A8%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/">生产环境下JAVA进程高CPU占用故障排查</a></h1><div class="content"><p>收藏一篇文章，这两天被驾校之家CPU占用过高的问题弄的寝食难安。马上用下面的方法监控一下。</p>
<p>参考文章：</p>
<p>    1. <a target="_blank" rel="noopener" href="http://blog.csdn.net/blade2001/article/details/9065985">http://blog.csdn.net/blade2001/article/details/9065985</a></p>
<p>    2. <a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangguilong2000/article/details/17971247">http://blog.csdn.net/jiangguilong2000/article/details/17971247</a></p>
<p>问题描述：<br>生产环境下的某台tomcat7服务器，在刚发布时的时候一切都很正常，在运行一段时间后就出现CPU占用很高的问题，基本上是负载一天比一天高。  </p>
<p>问题分析：<br>1，程序属于CPU密集型，和开发沟通过，排除此类情况。<br>2，程序代码有问题，出现死循环，可能性极大。  </p>
<p>问题解决：<br>1，开发那边无法排查代码某个模块有问题，从日志上也无法分析得出。<br>2，记得原来通过strace跟踪的方法解决了一台PHP服务器CPU占用高的问题，但是通过这种方法无效，经过google搜索，发现可以通过下面的方法进行解决，那就尝试下吧。  </p>
<p>解决过程：<br>1，根据top命令，发现PID为2633的Java进程占用CPU高达300%，出现故障。  </p>
<p>2，找到该进程后，如何定位具体线程或代码呢，首先显示线程列表,并按照CPU占用高的线程排序：<br>[root@localhost logs]# ps -mp 2633 -o THREAD,tid,time | sort -rn  </p>
<p>显示结果如下：<br>USER     %CPU PRI SCNT WCHAN  USER SYSTEM   TID     TIME<br>root     10.5  19    - -         -      -  3626 00:12:48<br>root     10.1  19    - -         -      -  3593 00:12:16  </p>
<p>找到了耗时最高的线程3626，占用CPU时间有12分钟了！  </p>
<p>将需要的线程ID转换为16进制格式：<br>[root@localhost logs]# printf “%x\n” 3626<br>e18  </p>
<p>最后打印线程的堆栈信息：<br>[root@localhost logs]# jstack 2633 |grep e18 -A 30  </p>
<p>将输出的信息发给开发部进行确认，这样就能找出有问题的代码。<br>通过最近几天的监控，CPU已经安静下来了。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-03-02T11:49:20.000Z" title="3/2/2015, 11:49:20 AM">2015-03-02</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.727Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">7 分钟读完 (大约996个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/03/02/FULL-GC%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B%E5%88%86%E4%BA%AB/">FULL GC分析过程分享</a></h1><div class="content"><p>转载-原文地址：<a target="_blank" rel="noopener" href="http://www.taobaotest.com/blogs/2294">http://www.taobaotest.com/blogs/2294</a></p>
<p>在性能测试过程中,FULL GC频繁是比较常见的问题，FULL GC 产生的原因有很多，这里主要针对meta压测过程中分析FULL GC问题的一些思路进行分享，供大家参考</p>
<p>1.如何发现是否发生FULL GC和FULL GC是否频繁</p>
<p>使用JDK自带的轻量级小工具jstat</p>
<p>     语法结构：</p>
<p>Usage: jstat -help|-options</p>
<p>             jstat -<option> [-t] [-h<lines>] <vmid> [<interval> [<count>]]</p>
<p> 参数解释：</p>
<p>Options — 选项，我们一般使用 -gcutil 查看gc情况</p>
<p>vmid    — VM的进程号，即当前运行的java进程号</p>
<p>interval– 间隔时间，单位为秒或者毫秒</p>
<p>count   — 打印次数，如果缺省则打印无数次</p>
<p>比如 /opt/taobao/java/bin/jstat –gcutil pid 5000</p>
<p> </p>
<p>输出结果：</p>
<p>        S0        S1         E          O          P        YGC      YGCT        FGC     FGCT        GCT</p>
<p>           0.00  90.63 100.00  58.82   3.51    183    2.059     0    0.000    2.059</p>
<p>    0.00  15.48   7.80  60.99   3.51    185    2.092     1    0.305    2.397</p>
<p>    0.00  15.48  18.10  47.90   3.51    185    2.092     2    0.348    2.440</p>
<p> S0  — Heap上的 Survivor space 0 区已使用空间的百分比<br> S1  — Heap上的 Survivor space 1 区已使用空间的百分比<br> E   — Heap上的 Eden space 区已使用空间的百分比<br> O   — Heap上的 Old space 区已使用空间的百分比<br> P   — Perm space 区已使用空间的百分比<br> YGC — 从应用程序启动到采样时发生 Young GC 的次数<br> YGCT– 从应用程序启动到采样时 Young GC 所用的时间(单位秒)<br> FGC — 从应用程序启动到采样时发生 Full GC 的次数<br> FGCT– 从应用程序启动到采样时 Full GC 所用的时间(单位秒)<br> GCT — 从应用程序启动到采样时用于垃圾回收的总时间(单位秒)</p>
<p>    通过FGC我们可以发现系统是否发生FULL GC和FULL GC的频率</p>
<p>2.  FULL GC分析和问题定位</p>
<p>    a.     GC log收集和分析</p>
<p>(1)在JVM启动参数增加：”-verbose:gc -Xloggc:&lt;file_name&gt;  -XX:+PrintGCDetails -XX:+PrintGCDateStamps”</p>
<p>    PrintGCTimeStamp只能获得相对时间，建议使用PrintGCDateStamps获得full gc 发生的绝对时间</p>
<p>      (2)如果采用CMS GC,仔细分析jstat FGC输出和GC 日志会发现， CMS的每个并发GC周期则有两个stop-the-world阶段——initial mark与final re-mark<strong>，</strong>使得CMS的每个并发GC周期总共会更新full GC计数器两次，initial mark与final re-mark各一次</p>
<p>    </p>
<p>    b.     Dump JVM 内存快照</p>
<p>/opt/taobao/java/bin/jmap -dump:format=b,file=dump.bin pid</p>
<p>这里有一个问题是什么时候进行dump?</p>
<p>一种方法是前面提到的用jstat工具观察，当OLD区到达比较高的比例如60%，一般会很快触发一次FULL GC,可以进行一次DUMP,在FULL GC发生以后再DUMP一次，这样比较就可以发现到底是哪些对象导致不停的FULL GC</p>
<p>另外一种方法是通过配置JVM参数</p>
<p> -XX:+HeapDumpBeforeFullGC -XX:+HeapDumpAfterFullGC分别用于指定在full GC之前与之后生成heap dump </p>
<p>    c.     利用MAT((Memory Analyzer Tool)工具分析dump文件</p>
<p>关于MAT具体使用方法网上有很多介绍，这里不做详细展开，这里需要注意的是：</p>
<p>(1)   MAT缺省只分析reachable的对象，unreachable的对象（将被收集掉的对象）被忽略，而分析FULL GC频繁原因时unreachable object也应该同时被重点关注。如果要显示unreachable的对象细节必须用mat 1.1以上版本并且打开选项“keep unreachable object”</p>
<p>(2)   通常dump文件会好几个G，无法在windows上直接进行分析，我们可以先把dump文件在linux上进行分析，再把分析好的文件拷贝到windows上，在windows上用MAT打开分析文件。</p>
<p>下面是Meta2.0压测曾遇到的FULL GC频繁问题的分析结果，比较明显，DispatchRequest对象有4千多万个，一共超过2G，并最终导致OOM</p>
<p><img src="http://file.mspring.org/images/blog/83f48d2a9de38682ed93018f08211d9e!detail" alt="83f48d2a9de38682ed93018f08211d9e_detail"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-02-04T12:37:28.000Z" title="2/4/2015, 12:37:28 PM">2015-02-04</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.735Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">9 分钟读完 (大约1277个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/02/04/%E7%94%A816G%E5%86%85%E5%AD%98%E5%9C%A8Java-Map%E4%B8%AD%E5%A4%84%E7%90%8630%E4%BA%BF%E5%AF%B9%E8%B1%A1/">用16G内存在Java Map中处理30亿对象</a></h1><div class="content"><p>在一个下雨的夜晚，我在思考Java中内存管理的问题，以及Java集合对内存使用的效率情况。我做了一个简单的实验，测试在16G内存条件下，Java的Map可以插入多少对象。</p>
<p>这个试验的目的是为了得出集合的内部上限。所以，我决定使用很小的key和value。所有的测试，都是在64w位linux环境下进行的，操作系统是ubuntu12.04。JVM版本为Oracle Java 1.7.0_09-bo5 (HotSpot 23.5-b02)。在这个JVM中，压缩指针(compressed pointers(-XX:+UseCompressedOops))的选项是默认打开的。</p>
<p>首先是简单的针对java.util.TreeMap的测试。不停向其中插入数字，直到其抛出内存溢出异常。JVM的设置是-xmx15G</p>
<pre><code>import java.util.*; 
Map m = new TreeMap();
for(long counter=0;;counter++)&#123;
  m.put(counter,&quot;&quot;);
  if(counter%1000000==0) System.out.println(&quot;&quot;+counter);
&#125;
</code></pre>
<p>这个用例插入了1 7200 0000条数据。在接近结束的时候，由于高负荷的GC插入效率开始降低。第二次，我用HashMap代替TreeMap，这次插入了182 000 000条数据。</p>
<p>Java默认的集合并不是最高效利用内存的。所以，这回我们尝试最后化内存的测试。我选择了MapDB中的LongHashMap，其使用原始的long key并且对封装的内存占用进行了优化。JVM的设置仍然是-Xmx15G。</p>
<pre><code>import org.mapdb.*
LongMap m = new LongHashMap();    
for(long counter=0;;counter++)&#123;
  m.put(counter,&quot;&quot;);
  if(counter%1000000==0) System.out.println(&quot;&quot;+counter);
&#125;
</code></pre>
<p>这次，计数器停止在了276 000 000。同样，在插入接近结束的时候，速度开始减慢。看起来这是基于堆的结合的限制所在。垃圾回收带来了瓶颈 。</p>
<p>现在是时候祭出杀手锏了:-)。我们可以采用非基于堆的方式存储，这样GC就不会发现我们的数据。我来介绍一下MapDB，它提供了基于数据库引擎的并发同步的TreeMap和HashMap。它提供了多样化的存储方式，其中一个就是非堆内存的方式。(声明：我是MapDB的作者)。</p>
<p>现在，让我们再跑一下之前的用例，这次采用的是非堆的Map。首先是配置并打开数据库，它打开的直接基于内存存储并且关闭事物的模式。接下来的代码是在这个db中创建一个新的map。</p>
<pre><code>import org.mapdb.*

DB db = DBMaker
   .newDirectMemoryDB()
   .transactionDisable()
   .make();

Map m = db.getTreeMap(&quot;test&quot;);
for(long counter=0;;counter++)&#123;
  m.put(counter,&quot;&quot;);
  if(counter%1000000==0) System.out.println(&quot;&quot;+counter);
&#125;
</code></pre>
<p>这是非堆的Map，所以我们需要不同的JVM配置： -XX:MaxDirectMemorySize=15G -Xmx128M。这次测试在达到980 000 000条记录的时候出现内存溢出。</p>
<p>但是，MapDB还可以优化。之前样例的问题在于记录的破碎分散，b-tree的节点每次插入都要调整它的容量。变通的方案是，将b-tree的节点在其插入前短暂的缓存起来。这使得记录的分散降到最低。所以，我们来改变一下DB的配置：</p>
<pre><code>DB db = DBMaker
     .newDirectMemoryDB()
     .transactionDisable()
     .asyncFlushDelay(100)
     .make();

Map m = db.getTreeMap(&quot;test&quot;);
</code></pre>
<p>这次记录数达到了 1 738 000 000。速度也是达到了惊人的31分钟完成了17亿数据的插入。</p>
<p>MapDB还能继续优化。我们把b-tree的节点容量从32提升到120并且打开透明(OneCoder理解为对用户不可见的)压缩：</p>
<pre><code>DB db = DBMaker
            .newDirectMemoryDB()
            .transactionDisable()
            .asyncFlushDelay(100)
            .compressionEnable()
            .make();

   Map m = db.createTreeMap(&quot;test&quot;,120, false, null, null, null);
</code></pre>
<p>这个用例在大约3 315 000 000条记录时出现内存溢出。由于压缩，他的速度 有所降低，不过还是在几个小时内完成。我还可以进行一些优化(自定义序列化等等) ，使得数据量达到大约40亿。</p>
<p>也许你好奇所有这些记录是怎么存储的。答案就是，delta-key压缩。当然，向B-Tree插入已经排好序的递增key是最佳的使用场景，并且MapDB也对此进行了一些小小的 优化。最差的情形就是key是随机的.</p>
<p>后续更新：很多朋友对压缩有一些困惑。在这些用例中，Delta-key 压缩默认都是启用的。在下面的用例中，我又额外开启了zlib方式的压缩：</p>
<pre><code>DB db = DBMaker
            .newDirectMemoryDB()
            .transactionDisable()
            .asyncFlushDelay(100)
            .make();

    Map m = db.getTreeMap(&quot;test&quot;);

    Random r = new Random();
    for(long counter=0;;counter++)&#123;
        m.put(r.nextLong(),&quot;&quot;);
        if(counter%1000000==0) System.out.println(&quot;&quot;+counter);
    &#125;
</code></pre>
<p>即使在随机序列情况下，MapDB也可以存储652 000 000条记录，大概4倍于基于堆的集合。</p>
<p>这个简单的试验没有太多的目的。这仅仅是我对MapDB的一种优化。也许，更多的惊喜在于插入效率确实不错并且MapDB可以抗衡基于内存的集合。</p>
<p>原文地址：<a target="_blank" rel="noopener" href="http://kotek.net/blog/3G_map">http://kotek.net/blog/3G_map</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2014-05-16T00:00:00.000Z" title="5/16/2014, 12:00:00 AM">2014-05-16</time>发表</span><span class="level-item"><time dateTime="2021-06-10T02:08:47.731Z" title="6/10/2021, 2:08:47 AM">2021-06-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></span><span class="level-item">1 分钟读完 (大约148个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2014/05/16/Java%E4%B8%BB%E7%BA%BF%E7%A8%8B%E7%AD%89%E5%BE%85%E5%AD%90%E7%BA%BF%E7%A8%8B%E5%AE%8C%E6%88%90/">Java主线程等待子线程完成</a></h1><div class="content"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> Gao Youbo</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@since</span> 2014-05-16 10:20:08</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SubThread thread = <span class="keyword">new</span> SubThread();</span><br><span class="line">        thread.start(); <span class="comment">//子线程开始</span></span><br><span class="line">        mainThreadWorking();<span class="comment">//主线程干活</span></span><br><span class="line">        System.out.println(<span class="string">&quot;main:等待子线程完成&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            thread.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;所有线程都完成！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mainThreadWorking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;main:主线程开始干活...&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000L</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;main:主线程干完了!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;sub:子线程开始干活...&quot;</span>);</span><br><span class="line">            sleep(<span class="number">6000L</span>); <span class="comment">//子线程花6秒钟时间干活</span></span><br><span class="line">            System.out.println(<span class="string">&quot;sub:子线程干完了!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="http://file.mspring.org/images/blog/avatar.jpg" alt="雾非雾的情思"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">雾非雾的情思</p><p class="is-size-6 is-block">爱折腾的老码农！</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Wuhan, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">150</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">29</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/gaoyoubo" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/gaoyoubo"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"><span class="level-start"><span class="level-item">碎碎念</span></span><span class="level-end"><span class="level-item tag">39</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/"><span class="level-start"><span class="level-item">程序员</span></span><span class="level-end"><span class="level-item tag">86</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-10T10:08:18.000Z">2021-06-10</time></p><p class="title"><a href="/2021/06/10/%E6%89%B9%E9%87%8F%E6%8B%89%E5%8F%96%E4%BB%A3%E7%A0%81/">批量拉取代码</a></p><p class="categories"><a href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-22T14:04:19.000Z">2021-03-22</time></p><p class="title"><a href="/2021/03/22/MacOS%E5%AE%89%E8%A3%85PHP/">MacOS安装PHP</a></p><p class="categories"><a href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-22T22:13:31.000Z">2021-01-22</time></p><p class="title"><a href="/2021/01/22/%E7%BE%A4%E8%BE%89QNAP%E4%BD%BF%E7%94%A8%E5%A4%87%E5%BF%98/">群辉QNAP使用备忘</a></p><p class="categories"><a href="/categories/%E7%A2%8E%E7%A2%8E%E5%BF%B5/">碎碎念</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-19T16:53:42.000Z">2021-01-19</time></p><p class="title"><a href="/2021/01/19/mac-iterm2-rz%E4%B8%8Esz%E7%9A%84%E5%8A%9F%E8%83%BD/">mac iterm2 rz与sz的功能</a></p><p class="categories"><a href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98/">程序员</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-11-25T11:18:00.000Z">2020-11-25</time></p><p class="title"><a href="/2020/11/25/Mac%E4%BD%BF%E7%94%A8%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/">Mac使用过程中的问题汇总</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">九月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/10/"><span class="level-start"><span class="level-item">十月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/11/"><span class="level-start"><span class="level-item">十一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/07/"><span class="level-start"><span class="level-item">七月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/06/"><span class="level-start"><span class="level-item">六月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/04/"><span class="level-start"><span class="level-item">四月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/11/"><span class="level-start"><span class="level-item">十一月 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/04/"><span class="level-start"><span class="level-item">四月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/03/"><span class="level-start"><span class="level-item">三月 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/02/"><span class="level-start"><span class="level-item">二月 2016</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/07/"><span class="level-start"><span class="level-item">七月 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/05/"><span class="level-start"><span class="level-item">五月 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/04/"><span class="level-start"><span class="level-item">四月 2015</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/03/"><span class="level-start"><span class="level-item">三月 2015</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/02/"><span class="level-start"><span class="level-item">二月 2015</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/10/"><span class="level-start"><span class="level-item">十月 2014</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/08/"><span class="level-start"><span class="level-item">八月 2014</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/06/"><span class="level-start"><span class="level-item">六月 2014</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/05/"><span class="level-start"><span class="level-item">五月 2014</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/03/"><span class="level-start"><span class="level-item">三月 2014</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/01/"><span class="level-start"><span class="level-item">一月 2014</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/12/"><span class="level-start"><span class="level-item">十二月 2013</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/10/"><span class="level-start"><span class="level-item">十月 2013</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/09/"><span class="level-start"><span class="level-item">九月 2013</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ElasticSearch/"><span class="tag">ElasticSearch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Electron/"><span class="tag">Electron</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hadoop/"><span class="tag">Hadoop</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HexoClient/"><span class="tag">HexoClient</span><span class="tag">17</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaCV/"><span class="tag">JavaCV</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nginx/"><span class="tag">Nginx</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ffmpeg/"><span class="tag">ffmpeg</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/js/"><span class="tag">js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mac/"><span class="tag">mac</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mariadb/"><span class="tag">mariadb</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/markdown/"><span class="tag">markdown</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ocr/"><span class="tag">ocr</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/php/"><span class="tag">php</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shadowsocks/"><span class="tag">shadowsocks</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/springboot/"><span class="tag">springboot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tesseract/"><span class="tag">tesseract</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/"><span class="tag">推荐系统</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"><span class="tag">碎碎念</span><span class="tag">38</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/"><span class="tag">程序员</span><span class="tag">44</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="http://file.mspring.org/images/blog/avatar.jpg" alt="雾非雾的情思" height="28"></a><p class="is-size-7"><span>&copy; 2021 雾非雾的情思</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Github" href="https://github.com/gaoyoubo"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>